<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bunny Budget">
    <meta name="theme-color" content="#f472b6">

    <link rel="manifest" href="./manifest.json">
    
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
    
    <title>Bunny Budget</title>
    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body,
        html {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3f8;
            /* Lighter bunny pink-white */
            color: #3f3c47;
            /* Bunny dark gray */
            overscroll-behavior: none;
        }

        /* Our Bunny Theme */
        :root {
            --bunny-pink-light: #fdf2f8;
            /* Light pink for backgrounds */
            --bunny-pink: #f472b6;
            /* Main pink for buttons */
            --bunny-pink-dark: #db2777;
            /* Pink for hover */
            --bunny-gray-light: #f7f3f8;
            /* Page background */
            --bunny-gray-medium: #e5e0e7;
            /* Borders */
            --bunny-gray-dark: #3f3c47;
            /* Text */
            --bunny-green: #34d399;
            /* Green for progress */
            --bunny-white: #ffffff;
            --bunny-red: #ef4444;
            /* Red for danger */
            --bunny-red-dark: #dc2626;
        }

        /* Helper class to hide elements */
        .hidden {
            display: none !important;
        }

        /* Page transitions (simple fade) */
        .page {
            display: none;
            /* All pages hidden by default */
            animation: fadeIn 0.3s ease-in-out;
        }

        .page.active {
            display: block;
            /* Active page is shown */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Active nav button style */
        .nav-button.active {
            color: var(--bunny-pink);
        }

        /* Bunny SVG Icon Styles */
        .bunny-icon {
            width: 1.5rem;
            height: 1.5rem;
            transition: all 0.2s ease;
        }

        .bunny-icon-sm {
            width: 1.25rem;
            height: 1.25rem;
        }

        /* Progress Bar */
        progress[value] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 99px;
            overflow: hidden;
            border: 0;
        }

        progress[value]::-webkit-progress-bar {
            background-color: var(--bunny-gray-medium);
        }

        progress[value]::-webkit-progress-value {
            background-color: var(--bunny-green);
            transition: all 0.3s ease;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        /* Onboarding Modal */
        #onboarding-modal {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .onboarding-step {
            display: none;
        }

        .onboarding-step.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Transaction History List */
        #tx-history-list li:nth-child(even) {
            background-color: #fdf2f8;
            /* --bunny-pink-light */
        }
    </style>
</head>

<body class="antialiased">

    <!-- ====== FULL SCREEN ONBOARDING MODAL ====== -->
    <div id="onboarding-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto overflow-hidden">

            <div id="onboarding-step-language" class="onboarding-step active p-6 md:p-8 space-y-6">
                <h2 class="text-2xl font-bold text-center text-gray-800" data-i18n="onboardingLanguageTitle">Select Language</h2>
                <p class="text-center text-gray-600" data-i18n="onboardingLanguageSubtitle">Choose your preferred language.</p>
                <div class="flex space-x-4 justify-center pt-4">
                    <button id="onboarding-lang-en"
                        class="lang-select-btn w-32 h-32 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-2xl text-base sm:text-lg transition-all flex flex-col items-center justify-center space-y-2 shadow hover:shadow-md border-2 border-transparent">
                        <span class="text-6xl">üá∫üá∏</span>
                        <span class="font-bold">English</span>
                    </button>
                    <button id="onboarding-lang-de"
                        class="lang-select-btn w-32 h-32 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-2xl text-base sm:text-lg transition-all flex flex-col items-center justify-center space-y-2 shadow hover:shadow-md border-2 border-transparent">
                        <span class="text-6xl">üá©üá™</span>
                        <span class="font-bold">Deutsch</span>
                    </button>
                </div>
            </div>

            <div id="onboarding-step-1" class="onboarding-step p-6 md:p-8">
                <div class="space-y-6"> <h2 class="text-2xl font-bold text-center text-gray-800" data-i18n="onboardingCurrencyTitle">Select
                    Currency</h2>
                <p class="text-center text-gray-600" data-i18n="onboardingCurrencySubtitle">Choose your default currency.
                </p>
                <div class="flex flex-col space-y-3">
                    <select id="currency-select"
                        class="w-full p-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                        <option value="‚Ç¨" data-symbol="‚Ç¨ EUR" data-locale="de-DE" data-digits="2">‚Ç¨ EUR (Euro)</option>
                        <option value="$" data-symbol="$ USD" data-locale="en-US" data-digits="2">$ USD (US Dollar)</option>
                        <option value="‚Çπ" data-symbol="‚Çπ INR" data-locale="en-IN" data-digits="2">‚Çπ INR (Indian Rupee)</option>
                        <option value="‚Ç±" data-symbol="‚Ç± PHP" data-locale="en-PH" data-digits="2">‚Ç± PHP (Philippine Peso)</option>
                        <option value="¬£" data-symbol="¬£ GBP" data-locale="en-GB" data-digits="2">¬£ GBP (British Pound)</option>
                        <option value="¬•" data-symbol="¬• JPY" data-locale="ja-JP" data-digits="0">¬• JPY (Japanese Yen)</option>
                        <option value="CHF" data-symbol="CHF" data-locale="de-CH" data-digits="2">CHF (Swiss Franc)</option>
                        <option value="C$" data-symbol="C$ CAD" data-locale="en-CA" data-digits="2">C$ CAD (Canadian Dollar)</option>
                        <option value="A$" data-symbol="A$ AUD" data-locale="en-AU" data-digits="2">A$ AUD (Australian Dollar)</option>
                    </select>
                    <button id="onboarding-next-step-1"
                        class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                        data-i18n="next">Next</button>
                </div>
                </div> <div class="w-full pt-6 mt-6 border-t border-gray-200"> <button id="onboarding-back-to-lang"
                        class="text-gray-500 hover:text-gray-800 font-medium transition-all"
                        data-i18n="back">Back</button>
                </div>
            </div>

            <!-- Step 2 (was 3): Template -->
            <div id="onboarding-step-2" class="onboarding-step p-6 md:p-8">
                <div class="space-y-6"> <h2 class="text-2xl font-bold text-center text-gray-800" data-i18n="onboardingTemplateTitle">Start Your
                    Budget</h2>
                <p class="text-center text-gray-600" data-i18n="onboardingTemplateSubtitle">You can start with our
                    template or from scratch.</p>
                <div class="flex flex-col space-y-3">
                    <button id="onboarding-use-template"
                        class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                        data-i18n="onboardingUseTemplate">Start with Template</button>
                    <button id="onboarding-start-fresh"
                        class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                        data-i18n="onboardingStartFresh">Start Fresh</button>
                    <button id="onboarding-go-to-help"
                        class="w-full text-pink-600 hover:text-pink-800 font-medium py-2 rounded-lg transition-all"
                        data-i18n="onboardingHelpButton">How does this work? Read the guide</button>
                </div>
                </div> <div class="w-full pt-6 mt-6 border-t border-gray-200"> <button id="onboarding-back-to-currency"
                        class="text-gray-500 hover:text-gray-800 font-medium transition-all"
                        data-i18n="back">Back</button>
                </div>
            </div>

            <div id="onboarding-step-help" class="onboarding-step p-6 md:p-8">
                <div class="space-y-6 max-h-[70vh] overflow-y-auto pr-2"> <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-center text-gray-800" data-i18n="helpHowToUseTitle">How to Use Bunny Budget</h2>
                    <div class="space-y-4 text-gray-700">
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep1Title">1. Setup Your
                                Budget</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpHowToUseStep1Desc">Go to the <strong
                                    class="text-pink-600">Manage</strong> tab.
                                First, enter your monthly **Salary**. Then, add all your monthly bills (like 'Rent' or
                                'Internet') as **Fixed Costs** and any monthly debt payments as **Debts (Fixed
                                Payment)**.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep2Title">2. Add Your
                                Categories</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpHowToUseStep2Desc">In <strong
                                    class="text-pink-600">Manage</strong>, add your spending
                                categories (like 'Groceries' or 'Gas') as **Variable Envelopes**. Add your savings goals
                                (like 'Vacation') as **Sinking Fund (Goals)** or **Debt (Paydown Goals)**.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep3Title">3. Assign Your
                                Money</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpHowToUseStep3Desc">Go to the <strong
                                    class="text-pink-600">Manage</strong> tab.
                                Add any **Other Income** you received this month. The app shows your "Money to Budget"
                                (your Total Income minus all Fixed Costs, Debts, and Annual Bills). Assign this money
                                into your Variable Envelopes and savings goals.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep4Title">4. Track Your
                                Spending</h3>
                            <p data-i18n="helpHowToUseStep4Desc">On the <strong
                                    class="text-pink-600">Dashboard</strong> tab, press
                                the big **pink '+' button** to add an expense. Select the envelope you spent from, and
                                watch the 'Remaining' amount go down.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep5Title">5. Fix Mistakes
                            </h3>
                            <p data-i18n="helpHowToUseStep5Desc">Made a typo? On the <strong
                                    class="text-pink-600">Dashboard</strong>, click the
                                **Variable Envelope** card (e.g., "Groceries"). A list of all transactions will appear.
                                Click a transaction to **Edit** or **Delete** it.</p>
                        </div>
                    </div>
                </div>
                </div> <div class="w-full pt-6 mt-6 border-t border-gray-200"> <button id="onboarding-help-back"
                        class="text-gray-500 hover:text-gray-800 font-medium transition-all"
                        data-i18n="back">Back</button>
                </div>
            </div>

        </div>
    </div>


    <!-- Main App Container -->
    <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-6 opacity-0">

        <!-- Header -->
        <header class="mb-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <!-- Bunny Head Icon -->
                    <svg class="bunny-icon text-pink-500" viewBox="0 0 24 24" fill="currentColor"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12.6,6.3c0-0.8-0.7-1.5-1.5-1.5H12c-0.8,0-1.5,0.7-1.5,1.5v0c0,0.8,0.7,1.5,1.5,1.5h-0.1C11.9,7.8,12.6,7.1,12.6,6.3zM15.6,6.3c0-0.8-0.7-1.5-1.5-1.5h-0.1c-0.8,0-1.5,0.7-1.5,1.5v0c0,0.8,0.7,1.5,1.5,1.5h0C14.9,7.8,15.6,7.1,15.6,6.3z M9,12c-0.8,0-1.5,0.7-1.5,1.5S7.7,15,8.5,15S10,14.3,10,13.5S9.8,12,9,12z M15.5,15c0.8,0,1.5-0.7,1.5-1.5s-0.7-1.5-1.5-1.5s-1.5,0.7-1.5,1.5S14.7,15,15.5,15z M21.4,11.5c-0.2-1.2-0.6-2.4-1.2-3.5c-1.2-2-3-3.2-5.1-3.7C14.3,2.9,13.2,2,12,2s-2.3,0.9-3.1,2.2c-2.1,0.5-3.9,1.7-5.1,3.7C3.1,8,2.7,9.1,2.6,10.4C2.5,10.9,2.5,11.4,2.5,12c0,4.1,2.7,7.7,6.4,8.7c1.1,0.3,2.2,0.4,3.1,0.4c1,0,2.1-0.1,3.1-0.4c3.8-1,6.4-4.5,6.4-8.7C21.5,11.9,21.5,11.7,21.4,11.5z M19.5,12c0,3.6-2.2,6.7-5.4,7.5c-0.9,0.2-1.8,0.3-2.1,0.3c-0.4,0-1.2-0.1-2.1-0.3C6.7,18.7,4.5,15.6,4.5,12c0-0.5,0-0.7,0.1-1.2c0.2-1,0.5-1.9,1-2.8c0.9-1.5,2.3-2.5,4-3c0.3,1,1.2,1.8,2.4,1.8s2.1-0.8,2.4-1.8c1.7,0.5,3.1,1.5,4,3c0.5,0.9,0.8,1.8,1,2.8C19.5,11.3,19.5,11.5,19.5,12z" />
                    </svg>
                    <h1 class="text-2xl font-bold" data-i18n="appTitle">Bunny Budget</h1>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="flex items-center space-x-1 bg-pink-100 text-pink-700 font-bold text-lg px-4 py-2 rounded-full">
                        <span>ü™ô</span>
                        <span id="bunny-coin-total">0</span>
                    </div>

                    <button id="show-settings-modal-btn" class="text-gray-500 hover:text-pink-500 p-2">
                        <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-.99h2.593c.55 0 1.02.448 1.11.99l.213 1.281c.063.374.313.686.64.87.317.174.69.24 1.065.21l1.28-.215c.53-.09 1.03.26 1.25.75l1.27 2.197c.22.38.22.86-.01 1.24l-1.08 1.08c-.29.29-.43.68-.43 1.08s.14 1.79.43 1.08l1.08 1.08c.23.38.23.86.01 1.24l-1.27 2.197c-.22.49-.72.84-1.25.75l-1.28-.215c-.375-.03-.748.036-1.065.21-.327.184-.577.496-.64.87l-.213 1.281c-.09.542-.56 1.007-1.11.99h-2.593c-.55 0-1.02-.448-1.11-.99l-.213-1.281c-.063-.374-.313-.686-.64-.87-.317-.174-.69-.24-1.065.21l-1.28.215c.53.09-1.03-.26-1.25-.75l-1.27-2.197c-.22-.38-.22-.86.01-1.24l1.08-1.08c.29-.29.43-.68.43-1.08s-.14-.79-.43-1.08L3.01 8.63c-.23-.38-.23-.86-.01-1.24l1.27-2.197c.22-.49.72.84 1.25.75l1.28.215c.375.03.748-.036 1.065.21.327-.184.577.496.64.87l.213-1.281z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- ====== Main Content Area ====== -->
        <main id="main-content">

            <!-- ====== Dashboard Page ====== -->
            <section id="dashboard-page" class="page active space-y-6">
                <!-- Money to Budget -->
                <div class="bg-white p-5 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm font-medium text-gray-500" data-i18n="dashboardMoneyToBudget">Money to
                                Budget</p>
                            <p id="dashboard-money-to-budget" class="text-3xl font-bold text-gray-800">‚Ç¨0.00</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-500" data-i18n="dashboardTotalBudgeted">Total
                                Budgeted</p>
                            <p id="dashboard-total-budgeted" class="text-lg font-semibold text-pink-600">‚Ç¨0.00</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-sm font-medium text-gray-500" data-i18n="dashboardTotalSpent">Total Spent
                            (Variable)</p>
                        <p id="dashboard-total-spent" class="text-3xl font-bold text-gray-800">‚Ç¨0.00</p>
                    </div>
                </div>

                <!-- Variable Envelopes -->
                <div>
                    <h2 class="text-xl font-semibold mb-3" data-i18n="dashboardVariableEnvelopes">Variable Envelopes
                    </h2>
                    <div id="variable-envelopes-list" class="space-y-3">
                        <!-- JS will render envelopes here -->
                    </div>
                    <p id="variable-envelopes-empty" class="text-gray-500" data-i18n="dashboardNoVariable">No variable
                        envelopes budgeted yet. Go to the 'Manage' page to add some!</p>
                </div>

                <!-- Sinking Funds (Goals) -->
                <div id="sinking-funds-container" class="hidden"> <h2 class="text-xl font-semibold mb-3" data-i18n="dashboardSinkingFunds">Sinking Fund Goals</h2>
                    <div id="sinking-fund-goals-list" class="space-y-3">
                        <!-- JS will render goals here -->
                    </div>
                    <p id="sinking-fund-goals-empty" class="text-gray-500" data-i18n="dashboardNoSinking">No sinking fund
                        goals. Go to the 'Manage' page to create one!</p>
                </div>

                <!-- Debt Paydown Goals -->
                <div id="debt-goals-container" class="hidden"> <h2 class="text-xl font-semibold mb-3" data-i18n="dashboardDebtGoals">Debt Paydown Goals</h2>
                    <div id="debt-goal-dashboard-list" class="space-y-3">
                        <!-- JS will render goals here -->
                    </div>
                    <p id="debt-goal-dashboard-empty" class="text-gray-500" data-i18n="dashboardNoDebtGoals">No debt
                        paydown goals. Go to 'Manage' to add one.</p>
                </div>
            </section>

            <!-- ====== NEW: Manage Page (Budget + Settings) ====== -->
            <section id="manage-page" class="page space-y-6">

                <div class="bg-white p-5 rounded-2xl shadow-lg space-y-4">
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-2" data-i18n="budgetIncomeTitle">Income</h3>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600" data-i18n="helpTermSalaryTitle">Salary</span>
                            <span id="budget-summary-salary" class="font-medium text-gray-800">‚Ç¨0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600" data-i18n="budgetOtherIncome">Other Income</span>
                            <span id="budget-summary-other-income" class="font-medium text-gray-800">‚Ç¨0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600" data-i18n="budgetRollover">Rollover Savings</span>
                            <span id="budget-summary-rollover" class="font-medium text-green-600">‚Ç¨0.00</span>
                        </div>
                        <div
                            class="flex justify-between items-center text-lg font-semibold border-t border-gray-200 pt-2 mt-2">
                            <span data-i18n="budgetTotalIncome">Total Income</span>
                            <span id="budget-summary-total-income" class="text-gray-900">‚Ç¨0.00</span>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="text-lg font-semibold mb-2" data-i18n="budgetOtherIncomeList">Other Income Items</h3>
                        <div id="other-income-list" class="space-y-2">
                            </div>
                        <p id="other-income-empty" class="text-gray-500 hidden" data-i18n="budgetNoOtherIncome">No other income added this month.</p>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold mb-2" data-i18n="budgetCostsTitle">Fixed Costs</h3>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600" data-i18n="budgetFixedCosts">Bills & Debts</span>
                            <span id="budget-summary-fixed-costs" class="font-medium text-gray-800">‚Ç¨0.00</span>
                        </div>
                    </div>
                    
                    <div
                        class="bg-pink-50 border-2 border-pink-200 p-4 rounded-lg space-y-3">
                        <div>
                            <p class="text-sm font-medium text-pink-700" data-i18n="budgetMoneyToBudget">Money to Budget
                            </p>
                            <p id="budget-money-to-budget" class="text-3xl font-bold text-pink-900">‚Ç¨0.00</p>
                        </div>
                        <div class="flex justify-between">
                            <p class="text-sm font-medium text-pink-700" data-i18n="budgetTotalAssigned">Total Assigned
                            </p>
                            <p id="budget-total-assigned" class="text-lg font-semibold text-pink-900">‚Ç¨0.00</p>
                        </div>
                        <div class="flex justify-between">
                            <p class="text-sm font-medium text-pink-700" data-i18n="budgetRemainingToAssign">Remaining
                            </p>
                            <p id="budget-remaining" class="text-lg font-semibold text-green-600">‚Ç¨0.00</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold p-5" data-i18n="assignTitle">Assign Your Money</h2>
                    <form id="budget-form" class="space-y-6 p-5 pt-0">
                        <div>
                            <h3 class="text-lg font-semibold mb-3" data-i18n="assignEnvelopes">Fill Your Envelopes</h3>
                            <div id="budget-variable-list" class="space-y-3">
                                </div>
                            <p id="budget-variable-empty" class="text-gray-500" data-i18n="budgetNoVariable">No variable
                                envelopes. Add one in 'Add New Category' below.</p>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold mb-3" data-i18n="assignSinking">Contribute to Savings Goals</h3>
                            <div id="budget-sinking-fund-list" class="space-y-3">
                                </div>
                            <p id="budget-sinking-fund-empty" class="text-gray-500" data-i18n="budgetNoSinking">No sinking
                                fund goals. Add one in 'Add New Category' below.</p>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold mb-3" data-i18n="assignDebt">Make Extra Debt Payments</h3>
                            <div id="budget-debt-goal-list" class="space-y-3">
                                </div>
                            <p id="budget-debt-goal-empty" class="text-gray-500" data-i18n="budgetNoDebtGoals">No debt
                                paydown goals. Add one in 'Add New Category' below.</p>
                        </div>
                    </form>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-lg space-y-6">
                    <h2 class="text-xl font-semibold" data-i18n="setupManageTitle">Setup & Manage</h2>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-3" data-i18n="settingsMonthlySalary">Monthly Salary</h3>
                        <form id="salary-form"
                            class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                            <div class="flex-1 flex items-center space-x-2">
                                <span id="salary-currency-symbol" class="text-2xl font-medium text-gray-500">‚Ç¨</span>
                                <input type="number" id="salary-input"
                                    class="flex-1 w-full p-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                    placeholder="2500" step="0.01" min="0">
                            </div>
                            <div id="auto-save-status" class="text-center text-gray-500 h-6"></div>
                        </form>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <h3 class="text-lg font-semibold mb-3" data-i18n="settingsAddCategory">Add New Category</h3>
                        <form id="add-category-form" class="space-y-3">
                            <div>
                                <label for="category-type" class="block text-sm font-medium text-gray-700"
                                    data-i18n="settingsCategoryType">Type</label>
                                <select id="category-type"
                                    class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                                    <option value="variable" data-i18n="settingsTypeVariable">Variable Envelope</option>
                                    <option value="fixed" data-i18n="settingsTypeFixed">Fixed Cost</option>
                                    <option value="debt-payment" data-i18n="settingsTypeDebtPayment">Debt (Fixed Payment)
                                    </option>
                                    <option value="sinking-bill" data-i18n="settingsTypeSinkingBill">Sinking Fund (Annual
                                        Bill)</option>
                                    <option value="sinking-goal" data-i18n="settingsTypeSinkingGoal">Sinking Fund (Goal)
                                    </option>
                                    <option value="debt-goal" data-i18n="settingsTypeDebtGoal">Debt (Paydown Goal)</option>
                                </select>
                            </div>
                            <div>
                                <label for="category-name" class="block text-sm font-medium text-gray-700"
                                    data-i18n="settingsCategoryName">Name</label>
                                <input type="text" id="category-name"
                                    class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                    required>
                            </div>
                            <div id="category-goal-amount-group" class="hidden">
                                <label for="category-goal-amount" class="block text-sm font-medium text-gray-700"
                                    data-i18n="settingsGoalAmount">Total Goal (Optional)</label>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span id="category-goal-currency-symbol" class="text-xl font-medium text-gray-500">‚Ç¨</span>
                                    <input type="number" id="category-goal-amount"
                                        class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                        placeholder="1000.00" step="0.01" min="0">
                                </div>
                            </div>
                            <div>
                                <label for="category-amount" class="block text-sm font-medium text-gray-700"
                                    data-i18n="settingsDefaultAmount">Monthly Payment (Optional)</label>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span id="category-currency-symbol" class="text-xl font-medium text-gray-500">‚Ç¨</span>
                                    <input type="number" id="category-amount"
                                        class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                        placeholder="50.00" step="0.01" min="0">
                                </div>
                            </div>
                            <button type="submit"
                                class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                                data-i18n="settingsAddCategoryButton">Add Category</button>
                        </form>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <button id="manage-categories-button"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                            data-i18n="manageCategoriesButton">Manage All Categories</button>
                    </div>

                </div>

            </section>
            
            <!-- ====== Help Page (Unchanged) ====== -->
            <section id="help-page" class="page space-y-6">
                <!-- How to Use -->
                <div class="bg-white p-5 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-3" data-i18n="helpHowToUseTitle">How to Use Bunny Budget</h2>
                    <div class="space-y-4 text-gray-700">
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep1Title">1. Setup Your
                                Budget</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpHowToUseStep1Desc">Go to the <strong
                                    class="text-pink-600">Manage</strong> tab.
                                First, enter your monthly **Salary**. Then, add all your monthly bills (like 'Rent' or
                                'Internet') as **Fixed Costs** and any monthly debt payments as **Debts (Fixed
                                Payment)**.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep2Title">2. Add Your
                                Categories</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpHowToUseStep2Desc">In <strong
                                    class="text-pink-600">Manage</strong>, add your spending
                                categories (like 'Groceries' or 'Gas') as **Variable Envelopes**. Add your savings goals
                                (like 'Vacation') as **Sinking Fund (Goals)** or **Debt (Paydown Goals)**.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep3Title">3. Assign Your
                                Money</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpHowToUseStep3Desc">Go to the <strong
                                    class="text-pink-600">Manage</strong> tab.
                                Add any **Other Income** you received this month. The app shows your "Money to Budget"
                                (your Total Income minus all Fixed Costs, Debts, and Annual Bills). Assign this money
                                into your Variable Envelopes and savings goals.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep4Title">4. Track Your
                                Spending</h3>
                            <p data-i18n="helpHowToUseStep4Desc">On the <strong
                                    class="text-pink-600">Dashboard</strong> tab, press
                                the big **pink '+' button** to add an expense. Select the envelope you spent from, and
                                watch the 'Remaining' amount go down.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep5Title">5. Fix Mistakes
                            </h3>
                            <p data-i18n="helpHowToUseStep5Desc">Made a typo? On the <strong
                                    class="text-pink-600">Dashboard</strong>, click the
                                **Variable Envelope** card (e.g., "Groceries"). A list of all transactions will appear.
                                Click a transaction to **Edit** or **Delete** it.</p>
                        </div>
                    </div>
                </div>

                <!-- Budgeting Terms Explained -->
                <div class="bg-white p-5 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-3" data-i18n="helpTermsTitle">Budgeting Terms Explained</h2>
                    <div class="space-y-4 text-gray-700">
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermSalaryTitle">Salary</h3>
                            <p data-i18n="helpTermSalaryDesc">Your total *recurring* monthly income. This is the baseline
                                for your budget.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermOtherIncomeTitle">Other Income
                            </h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpTermOtherIncomeDesc">One-time or variable income (like a side job or
                                selling an item). Add this on the <strong class="text-pink-600">Manage</strong> page.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermFixedCostTitle">Fixed Cost</h3>
                            <p data-i18n="helpTermFixedCostDesc">A bill that is the same amount every month, like Rent or
                                Internet. This is paid *before* you budget.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermDebtPaymentTitle">Debt (Fixed
                                Payment)</h3>
                            <p data-i18n="helpTermDebtPaymentDesc">A monthly payment for a debt (like a car loan). This
                                is treated like a Fixed Cost and is paid *before* you budget.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermSinkingBillTitle">Sinking Fund
                                (Annual Bill)</h3>
                            <p data-i18n="helpTermSinkingBillDesc">For non-monthly bills (like annual car insurance or a
                                quarterly tax). The app saves 1/12th of the cost every month, treating it like a Fixed
                                Cost so you're never surprised by the bill.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermMoneyToBudgetTitle">Money to
                                Budget</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpTermMoneyToBudgetDesc">This is your Total Income (Salary + Other) minus
                                all your Fixed Costs, Debts (Fixed Payments), and Sinking Fund (Bills). This is the
                                money you get to assign on the <strong class="text-pink-600">Manage</strong> page.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermVariableEnvelopeTitle">Variable
                                Envelope</h3>
                            <p data-i18n="helpTermVariableEnvelopeDesc">Your "digital envelope" for monthly spending that
                                changes, like Groceries, Gas, or Dining Out. You spend from these using the '+' button.
                            </p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermSinkingGoalTitle">Sinking Fund
                                (Goal)</h3>
                            <p data-i18n="helpTermSinkingGoalDesc">Your "digital savings envelope" for a big, optional
                                goal, like Vacation, Christmas, or an Emergency Fund. You assign money to it, but you
                                don't spend from it.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermDebtGoalTitle">Debt (Paydown
                                Goal)</h3>
                            <p data-i18n="helpTermDebtGoalDesc">A "digital envelope" to pay off a debt faster (like a
                                credit card). You assign extra money from your 'Money to Budget' to this goal.</p>
                        </div>
                    </div>
                </div>

            </section>

            <!-- ====== Stats Page (Unchanged) ====== -->
            <section id="stats-page" class="page space-y-6">
                <div class="bg-white p-5 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4" data-i18n="statsTitle">Stats & History</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm font-medium text-gray-500" data-i18n="statsTotalCoins">Total Bunny Coins</p>
                            <p id="stats-total-coins" class="text-3xl font-bold text-pink-600">ü™ô 0</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2" data-i18n="statsHistory">Rollover History</h3>
                            <ul id="stats-history-list" class="space-y-3">
                                </ul>
                            <p id="stats-history-empty" class="text-gray-500" data-i18n="statsNoHistory">No history yet. Save some money to earn coins!</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ====== NEW: Store Page ====== -->
            <section id="store-page" class="page space-y-6">
                <div class="bg-white p-5 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-3" data-i18n="storeTitle">Bunny Store</h2>
                    <div class="text-center py-10">
                        <span class="text-6xl">üõçÔ∏è</span>
                        <p class="text-gray-600 mt-4" data-i18n="storeComingSoon">The Bunny Store is coming soon! Spend your ü™ô on fun new themes and icons.</p>
                    </div>
                </div>
            </section>


            <div class="h-32"></div>

        </main>
    </div>

    <!-- ====== Bottom Navigation Bar (MODIFIED) ====== -->
    <nav
        class="fixed bottom-0 left-0 right-0 h-20 bg-white shadow-[0_-4px_12px_rgba(0,0,0,0.05)] flex justify-around items-center max-w-4xl mx-auto md:rounded-t-2xl">
        <!-- Dashboard -->
        <button id="nav-dashboard" class="nav-button active flex flex-col items-center justify-center text-gray-500 w-20">
            <!-- Dashboard Icon -->
            <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
            </svg>
            <span class="text-xs font-medium mt-1" data-i18n="navDashboard">Dashboard</span>
        </button>

        <!-- NEW: Manage (Budget + Settings) -->
        <button id="nav-manage" class="nav-button flex flex-col items-center justify-center text-gray-500 w-20">
            <!-- Settings Icon -->
            <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
            </svg>
            <span class="text-xs font-medium mt-1" data-i18n="navManage">Manage</span>
        </button>

        <!-- Add Expense Button (Stays in Center) -->
        <button id="add-expense-button"
            class="bg-pink-500 hover:bg-pink-600 text-white rounded-full h-16 w-16 flex items-center justify-center shadow-lg -mt-8">
            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd"
                    d="M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z"
                    clip-rule="evenodd" />
            </svg>
        </button>

        <!-- Stats (Was Help/Stats) -->
        <button id="nav-stats" class="nav-button flex flex-col items-center justify-center text-gray-500 w-20">
            <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3.75 3v11.25A2.25 2.25 0 006 16.5h12M3.75 3h16.5M3.75 3A2.25 2.25 0 016 5.25h12A2.25 2.25 0 0120.25 3M3.75 16.5h16.5m-16.5 0A2.25 2.25 0 006 14.25h12A2.25 2.25 0 0020.25 16.5m0 0v1.125c0 .621-.504 1.125-1.125 1.125H9.75l-4.06-4.06a.75.75 0 010-1.06l4.06-4.06a1.125 1.125 0 011.59 0l4.06 4.06c.3.3.434.7.434 1.06v6.375c0 .621-.504 1.125-1.125 1.125H3.75z" />
            </svg>
            <span class="text-xs font-medium mt-1" data-i18n="navStats">Stats</span>
        </button>

        <!-- NEW: Store -->
        <button id="nav-store" class="nav-button flex flex-col items-center justify-center text-gray-500 w-20">
            <!-- Storefront Icon -->
            <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" 
                stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 21v-7.5A.75.75 0 0 1 14.25 12h.01a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75Zm-3.75 0v-7.5A.75.75 0 0 1 10.5 12h.01a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75Zm-3.75 0v-7.5A.75.75 0 0 1 6.75 12h.01a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75ZM3 12h18M3 12c0-1.12 0-1.68.218-2.108a2.25 2.25 0 0 1 .874-.874C4.5 8.782 5.06 8.782 6.18 8.782h11.64c1.12 0 1.68 0 2.108.218a2.25 2.25 0 0 1 .874.874c.218.428.218.988.218 2.108M3 12v6.75A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V12M3 8.782c0-.622 0-.933.109-1.187a1.5 1.5 0 0 1 .6-.6C4.137 6.886 4.448 6.886 5.07 6.886h13.86c.622 0 .933 0 1.187.109a1.5 1.5 0 0 1 .6.6c.109.254.109.565.109 1.187M9.75 6.886V6a2.25 2.25 0 1 0-4.5 0v.886M18.75 6.886V6a2.25 2.25 0 1 0-4.5 0v.886" />
            </svg>
            <span class="text-xs font-medium mt-1" data-i18n="navStore">Store</span>
        </button>
    </nav>


    <!-- ====== Modals (Unchanged) ====== -->
    <!-- Add Expense Modal -->
    <div id="add-transaction-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-2xl font-bold text-gray-800" data-i18n="modalAddTransactionTitle">Add Transaction</h2>
                <button type="button" id="cancel-add-transaction-button"
                    class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>

            <div class="flex border-b border-gray-200">
                <button id="modal-tx-tab-expense"
                    class="tab-button active border-pink-500 text-pink-600 w-1/2 py-3 px-1 text-center border-b-2 font-medium"
                    data-i18n="modalAddExpenseButton">
                    Add Expense
                </button>
                <button id="modal-tx-tab-income"
                    class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 w-1/2 py-3 px-1 text-center border-b-2 font-medium"
                    data-i18n="modalAddIncomeButton">
                    Add Income
                </button>
            </div>

            <div id="expense-form-container" class="tab-panel active">
                <form id="add-expense-form" class="space-y-4">
                    <div>
                        <label for="expense-category" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseCategory">Category</label>
                        <select id="expense-category"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            required>
                            </select>
                    </div>
                    <div>
                        <label for="expense-notes" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseNotes">Notes (Optional)</label>
                        <textarea id="expense-notes"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            rows="2" placeholder="e.g. Birthday gift for mom"
                            data-i18n="modalAddExpenseNotesPlaceholder"></textarea>
                    </div>
                    <div>
                        <label for="expense-date" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseDate">Date</label>
                        <input type="date" id="expense-date"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            required>
                    </div>
                    <div>
                        <label for="expense-amount" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseAmount">Amount</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <span id="expense-currency-symbol" class="text-xl font-medium text-gray-500">‚Ç¨</span>
                            <input type="number" id="expense-amount"
                                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                placeholder="12.50" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="pt-2">
                        <button type="submit"
                            class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                            data-i18n="save">Save Expense</button>
                    </div>
                </form>
            </div>

            <div id="income-form-container" class="tab-panel hidden">
                <form id="add-income-form" class="space-y-4">
                    <div>
                        <label for="income-source" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddIncomeSource">Source</label>
                        <input type="text" id="income-source"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            placeholder="e.g. Side Job, Sold item" data-i18n="modalAddIncomeSourcePlaceholder" required>
                    </div>
                    <div>
                        <label for="income-amount" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseAmount">Amount</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <span id="income-currency-symbol" class="text-xl font-medium text-gray-500">‚Ç¨</span>
                            <input type="number" id="income-amount"
                                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                placeholder="50.00" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="pt-10"> </div>
                    <div class="pt-10"> </div>
                     <div class="pt-2">
                        <button type="submit"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                            data-i18n="save">Save Income</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="edit-income-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            <h2 class="text-2xl font-bold text-gray-800" data-i18n="modalEditIncomeTitle">Edit Income</h2>
            <form id="edit-income-form" class="space-y-4">
                <input type="hidden" id="edit-income-id">
                <div>
                    <label for="edit-income-source" class="block text-sm font-medium text-gray-700"
                        data-i18n="modalAddIncomeSource">Source</label>
                    <input type="text" id="edit-income-source"
                        class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                        placeholder="e.g. Side Job, Sold item" data-i18n="modalAddIncomeSourcePlaceholder" required>
                </div>
                <div>
                    <label for="edit-income-amount" class="block text-sm font-medium text-gray-700"
                        data-i18n="modalAddExpenseAmount">Amount</label>
                    <div class="flex items-center space-x-2 mt-1">
                        <span id="edit-income-currency-symbol" class="text-xl font-medium text-gray-500">‚Ç¨</span>
                        <input type="number" id="edit-income-amount"
                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            placeholder="50.00" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0">
                    <button type="button" id="cancel-edit-income-button"
                        class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition-all"
                        data-i18n="cancel">Cancel</button>
                    <button type="submit"
                        class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                        data-i18n="save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="transaction-history-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            <!-- View List -->
            <div id="tx-history-view">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800" id="tx-history-title">History</h2>
                    <button type="button" id="tx-history-close-btn"
                        class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <ul id="tx-history-list" class="max-h-60 overflow-y-auto divide-y divide-gray-200">
                    <!-- JS will render transactions here -->
                </ul>
                <p id="tx-history-empty" class="text-gray-500 hidden" data-i18n="modalTxHistoryEmpty">No transactions
                    found for this category.</p>
            </div>
            <!-- Edit Form (hidden by default) -->
            <div id="tx-edit-view" class="hidden space-y-4">
                <h2 class="text-2xl font-bold text-gray-800" data-i18n="modalEditTxTitle">Edit Transaction</h2>
                <form id="edit-transaction-form" class="space-y-4">
                    <input type="hidden" id="edit-tx-id">
                    <div>
                        <label for="edit-tx-notes" class="block text-sm font-medium text-gray-700" data-i18n="modalAddExpenseNotes">Notes (Optional)</label>
                        <textarea id="edit-tx-notes"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            rows="2" placeholder="e.g. Birthday gift for mom" data-i18n="modalEditTxNotesPlaceholder"></textarea>
                    </div>
                    <div>
                        <label for="edit-tx-date" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseDate">Date</label>
                        <input type="date" id="edit-tx-date"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            required>
                    </div>
                    <div>
                        <label for="edit-tx-amount" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseAmount">Amount</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <span id="edit-tx-currency-symbol" class="text-xl font-medium text-gray-500">‚Ç¨</span>
                            <input type="number" id="edit-tx-amount"
                                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                placeholder="1S2.50" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0">
                        <button type="button" id="edit-tx-cancel"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition-all"
                            data-i18n="cancel">Cancel</button>
                        <button type="submit"
                            class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                            data-i18n="save">Save</button>
                    </div>
                    <button type="button" id="edit-tx-delete"
                        class="w-full text-red-500 hover:text-red-700 font-medium py-2 rounded-lg transition-all"
                        data-i18n="modalDeleteTx">Delete Transaction</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirm Reset Modal -->
    <div id="confirm-reset-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            <h2 class="text-2xl font-bold text-red-600" data-i18n="modalResetTitle">Are you sure?</h2>
            <p class="text-gray-600" data-i18n="modalResetText">This action is permanent and will delete all your data.
                There is no undo.</p>
            <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0">
                <button type="button" id="cancel-reset-button"
                    class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition-all"
                    data-i18n="cancel">Cancel</button>
                <button type="button" id="confirm-reset-button"
                    class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                    data-i18n="modalResetConfirm">Yes, Reset App</button>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="edit-category-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            <h2 class="text-2xl font-bold text-gray-800" data-i18n="modalEditCategoryTitle">Edit Category</h2>
            <form id="edit-category-form" class="space-y-3">
                <input type="hidden" id="edit-category-id">
                <div>
                    <label for="edit-category-type" class="block text-sm font-medium text-gray-700"
                        data-i18n="settingsCategoryType">Type</label>
                    <select id="edit-category-type"
                        class="w-full p-3 border border-gray-300 rounded-lg mt-1 bg-gray-100 text-gray-500 cursor-not-allowed"
                        disabled>
                        <option value="variable" data-i18n="settingsTypeVariable">Variable Envelope</option>
                        <option value="fixed" data-i18n="settingsTypeFixed">Fixed Cost</option>
                        <option value="debt-payment" data-i18n="settingsTypeDebtPayment">Debt (Fixed Payment)</option>
                        <option value="sinking-bill" data-i18n="settingsTypeSinkingBill">Sinking Fund (Annual Bill)</option>
                        <option value="sinking-goal" data-i18n="settingsTypeSinkingGoal">Sinking Fund (Goal)</option>
                        <option value="debt-goal" data-i18n="settingsTypeDebtGoal">Debt (Paydown Goal)</option>
                    </select>
                </div>
                <div>
                    <label for="edit-category-name" class="block text-sm font-medium text-gray-700"
                        data-i18n="settingsCategoryName">Name</label>
                    <input type="text" id="edit-category-name"
                        class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                        required>
                </div>
                <div id="edit-category-goal-amount-group" class="hidden">
                    <label for="edit-category-goal-amount" class="block text-sm font-medium text-gray-700"
                        data-i18n="settingsGoalAmount">Total Goal (Optional)</label>
                    <div class="flex items-center space-x-2 mt-1">
                        <span id="edit-category-goal-currency-symbol" class="text-xl font-medium text-gray-500">‚Ç¨</span>
                        <input type="number" id="edit-category-goal-amount"
                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            placeholder="1000.00" step="0.01" min="0">
                    </div>
                </div>
                <div>
                    <label for="edit-category-amount" class="block text-sm font-medium text-gray-700"
                        data-i18n="settingsDefaultAmount">Monthly Payment (Optional)</label>
                    <div class="flex items-center space-x-2 mt-1">
                        <span id="edit-category-currency-symbol" class="text-xl font-medium text-gray-500">‚Ç¨</span>
                        <input type="number" id="edit-category-amount"
                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            placeholder="50.00" step="0.01" min="0">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0">
                    <button type="button" id="cancel-edit-category-button"
                        class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition-all"
                        data-i18n="cancel">Cancel</button>
                    <button type="submit"
                        class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                        data-i18n="save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app-settings-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800" data-i18n="settingsAppSettings">App Settings</h2>
                <button type="button" id="cancel-settings-button"
                    class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="language-select" class="block text-sm font-medium text-gray-700"
                        data-i18n="settingsLanguage">Language</label>
                    <select id="language-select"
                        class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                        <option value="en">English</option>
                        <option value="de">Deutsch (German)</option>
                    </select>
                </div>
                <div>
                    <label for="currency-select-settings" class="block text-sm font-medium text-gray-700"
                        data-i18n="settingsCurrency">Currency</label>
                    <select id="currency-select-settings"
                        class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                        <option value="‚Ç¨" data-symbol="‚Ç¨ EUR" data-locale="de-DE" data-digits="2">‚Ç¨ EUR (Euro)</option>
                        <option value="$" data-symbol="$ USD" data-locale="en-US" data-digits="2">$ USD (US Dollar)</option>
                        <option value="‚Çπ" data-symbol="‚Çπ INR" data-locale="en-IN" data-digits="2">‚Çπ INR (Indian Rupee)</option>
                        <option value="‚Ç±" data-symbol="‚Ç± PHP" data-locale="en-PH" data-digits="2">‚Ç± PHP (Philippine Peso)</option>
                        <option value="¬£" data-symbol="¬£ GBP" data-locale="en-GB" data-digits="2">¬£ GBP (British Pound)</option>
                        <option value="¬•" data-symbol="¬• JPY" data-locale="ja-JP" data-digits="0">¬• JPY (Japanese Yen)</option>
                        <option value="CHF" data-symbol="CHF" data-locale="de-CH" data-digits="2">CHF (Swiss Franc)</option>
                        <option value="C$" data-symbol="C$ CAD" data-locale="en-CA" data-digits="2">C$ CAD (Canadian Dollar)</option>
                        <option value="A$" data-symbol="A$ AUD" data-locale="en-AU" data-digits="2">A$ AUD (Australian Dollar)</option>
                    </select>
                </div>
            </div>

            <div id="install-pwa-section" class="hidden">
                <button id="install-pwa-button"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all flex items-center justify-center space-x-2">
                    <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    <span data-i18n="installPwaButton">Install App to Home Screen</span>
                </button>
            </div>

            <div>
                <h3 class="text-xl font-semibold mb-3" data-i18n="settingsHelpTitle">Get Help</h3>
                <p class="text-gray-600 mb-4" data-i18n="settingsHelpDesc">Learn how to use the app, what the terms mean, and how to budget.</p>
                <button id="go-to-help-button"
                    class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                    data-i18n="settingsHelpButton">View Help Guide</button>
            </div>

            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-xl font-semibold mb-3 text-red-600" data-i18n="settingsDangerZone">Danger Zone
                </h3>
                <p class="text-gray-600 mb-4" data-i18n="settingsResetSubtitle">This will permanently delete all your
                    data (salary, categories, transactions) and restart the app.</p>
                <button id="reset-app-button"
                    class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                    data-i18n="settingsResetButton">Reset App</button>
            </div>
            
        </div>
    </div>

    <div id="manage-categories-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800" data-i18n="modalManageCategoriesTitle">Manage Categories</h2>
                <button type="button" id="cancel-manage-categories-button"
                    class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>

            <div class="border-b border-gray-200">
                <nav class="flex -mb-px" aria-label="Tabs">
                    <button id="modal-manage-tab-bills" class="tab-button active border-pink-500 text-pink-600 w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm" data-i18n="modalManageTabBills">
                        Income & Bills
                    </button>
                    <button id="modal-manage-tab-envelopes" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm" data-i18n="modalManageTabEnvelopes">
                        Envelopes & Goals
                    </button>
                </nav>
            </div>

            <div class="space-y-4 max-h-80 overflow-y-auto pr-2">
                <div id="modal-manage-panel-bills" class="tab-panel active space-y-4">
                    <div id="modal-manage-container-fixed" class="hidden">
                        <h3 class="text-lg font-medium text-gray-800" data-i18n="settingsTypeFixed">Fixed Costs</h3>
                        <div id="modal-manage-fixed-list" class="space-y-2 mt-2"></div>
                    </div>
                    <div id="modal-manage-container-debt-payment" class="hidden">
                        <h3 class="text-lg font-medium text-gray-800" data-i18n="settingsTypeDebtPayment">Debts (Fixed Payments)</h3>
                        <div id="modal-manage-debt-payment-list" class="space-y-2 mt-2"></div>
                    </div>
                    <div id="modal-manage-container-sinking-bill" class="hidden">
                        <h3 class="text-lg font-medium text-gray-800" data-i18n="settingsTypeSinkingBill">Sinking Funds (Annual Bills)</h3>
                        <div id="modal-manage-sinking-bill-list" class="space-y-2 mt-2"></div>
                    </div>
                </div>

                <div id="modal-manage-panel-envelopes" class="tab-panel hidden space-y-4">
                    <div id="modal-manage-container-variable" class="hidden">
                        <h3 class="text-lg font-medium text-gray-800" data-i18n="settingsTypeVariable">Variable Envelopes</h3>
                        <div id="modal-manage-variable-list" class="space-y-2 mt-2"></div>
                    </div>
                    <div id="modal-manage-container-sinking-goal" class="hidden">
                        <h3 class="text-lg font-medium text-gray-800" data-i18n="settingsTypeSinkingGoal">Sinking Funds (Goals)</h3>
                        <div id="modal-manage-sinking-goal-list" class="space-y-2 mt-2"></div>
                    </div>
                    <div id="modal-manage-container-debt-goal" class="hidden">
                        <h3 class="text-lg font-medium text-gray-800" data-i18n="settingsTypeDebtGoal">Debt (Paydown Goals)</h3>
                        <div id="modal-manage-debt-goal-list" class="space-y-2 mt-2"></div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <div id="toast"
        class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 translate-y-4 transition-all duration-300 z-60">
        <span id="toast-message">Saved!</span>
    </div>

    <!-- Custom Bunny SVG Icons (used in JS) -->
    <svg width="0" height="0" class="hidden">
        <defs>
            <!-- Delete Icon -->
            <svg id="icon-delete" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="1.5" stroke="currentColor" class="bunny-icon-sm">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.518 0A48.108 48.108 0 017.5 5.392m0 0A48.068 48.068 0 0112 5.25c2.148 0 4.217.3 6.21.879m-6.21-.879C11.332 5.11 10.152 5 9 5c-1.152 0-2.332.11-3.478.397m12.518 0C16.92 5.71 15.688 6 14.25 6c-1.438 0-2.67-.11-3.75-.397" />
            </svg>
            <!-- Edit Icon -->
            <svg id="icon-edit" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="1.5" stroke="currentColor" class="bunny-icon-sm">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6.17 18a.75.75 0 01-.9- .9l.79-2.513a4.5 4.5 0 011.13-1.897l8.93-8.93z" />
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M19.5 12.572l-4.5-4.5" />
            </svg>
            <!-- Rabbit Icon for Sinking Fund -->
            <svg id="icon-sinking-goal" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                class="bunny-icon-sm">
                <path
                    d="M12.6,6.3c0-0.8-0.7-1.5-1.5-1.5H12c-0.8,0-1.5,0.7-1.5,1.5v0c0,0.8,0.7,1.5,1.5,1.5h-0.1C11.9,7.8,12.6,7.1,12.6,6.3z M15.6,6.3c0-0.8-0.7-1.5-1.5-1.5h-0.1c-0.8,0-1.5,0.7-1.5,1.5v0c0,0.8,0.7,1.5,1.5,1.5h0C14.9,7.8,15.6,7.1,15.6,6.3z M9,12c-0.8,0-1.5,0.7-1.5,1.5S7.7,15,8.5,15S10,14.3,10,13.5S9.8,12,9,12z M15.5,15c0.8,0,1.5-0.7,1.5-1.5s-0.7-1.5-1.5-1.5s-1.5,0.7-1.5,1.5S14.7,15,15.5,15z M21.4,11.5c-0.2-1.2-0.6-2.4-1.2-3.5c-1.2-2-3-3.2-5.1-3.7C14.3,2.9,13.2,2,12,2s-2.3,0.9-3.1,2.2c-2.1,0.5-3.9,1.7-5.1,3.7C3.1,8,2.7,9.1,2.6,10.4C2.5,10.9,2.5,11.4,2.5,12c0,4.1,2.7,7.7,6.4,8.7c1.1,0.3,2.2,0.4,3.1,0.4c1,0,2.1-0.1,3.1-0.4c3.8-1,6.4-4.5,6.4-8.7C21.5,11.9,21.5,11.7,21.4,11.5z M19.5,12c0,3.6-2.2,6.7-5.4,7.5c-0.9,0.2-1.8,0.3-2.1,0.3c-0.4,0-1.2-0.1-2.1-0.3C6.7,18.7,4.5,15.6,4.5,12c0-0.5,0-0.7,0.1-1.2c0.2-1,0.5-1.9,1-2.8c0.9-1.5,2.3-2.5,4-3c0.3,1,1.2,1.8,2.4,1.8s2.1-0.8,2.4-1.8c1.7,0.5,3.1,1.5,4,3c0.5,0.9,0.8,1.8,1,2.8C19.5,11.3,19.5,11.5,19.5,12z" />
            </svg>
            <!-- Bill Icon for Fixed Cost -->
            <svg id="icon-fixed" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                class="bunny-icon-sm">
                <path fill-rule="evenodd"
                    d="M3.75 4.5a.75.75 0 01.75-.75h.75c.414 0 .75.336.75.75v1.5c0 .414-.336.75-.75.75H4.5a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75c.414 0 .75.336.75.75v1.5c0 .414-.336.75-.75.75H4.5a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75c.414 0 .75.336.75.75v1.5c0 .414-.336.75-.75.75H4.5a.75.75 0 01-.75-.75v-1.5zM8.25 4.5a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v-1.5zM12.75 4.5a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-1.5zM17.25 4.5a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-1.5z"
                    clip-rule="evenodd" />
            </svg>
            <!-- Calendar Icon for Annual Bill -->
            <svg id="icon-sinking-bill" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                class="bunny-icon-sm">
                <path fill-rule="evenodd"
                    d="M6.75 2.25A.75.75 0 017.5 3v1.5h9V3A.75.75 0 0118 3v1.5h2.25a3 3 0 013 3v11.25a3 3 0 01-3 3H3.75a3 3 0 01-3-3V7.5a3 3 0 013-3H6V3a.75.75 0 01.75-.75zM3.75 7.5v11.25c0 .414.336.75.75.75h15a.75.75 0 00.75-.75V7.5h-16.5z"
                    clip-rule="evenodd" />
                <path
                    d="M10.5 10.5a.75.75 0 00-1.5 0v.75H7.5a.75.75 0 000 1.5h1.5V15a.75.75 0 001.5 0v-2.25H12a.75.75 0 000-1.5h-1.5v-.75zM16.5 10.5a.75.75 0 00-1.5 0v.75h-1.5a.75.75 0 000 1.5h1.5V15a.75.75 0 001.5 0v-2.25h1.5a.75.75 0 000-1.5h-1.5v-.75z" />
            </svg>
            <!-- Shopping Bag Icon for Variable -->
            <svg id="icon-variable" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                class="bunny-icon-sm">
                <path fill-rule="evenodd"
                    d="M7.5 6v.75H5.513c-.96 0-1.763.746-1.858 1.705L3.22 19.516A3 3 0 006.18 22.5h11.64a3 3 0 002.96-2.984l-.433-11.057a1.875 1.875 0 00-1.858-1.705H16.5V6a4.5 4.5 0 10-9 0zM12 3a3 3 0 00-3 3v.75h6V6a3 3 0 00-3-3zM9 15v-3.75a.75.75 0 011.5 0V15a.75.75 0 01-1.5 0zm4.5-3.75a.75.75 0 00-1.5 0V15a.75.75 0 001.5 0v-3.75z"
                    clip-rule="evenodd" />
            </svg>
            <!-- Debt Icon (Credit Card) -->
            <svg id="icon-debt-payment" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                class="bunny-icon-sm">
                <path
                    d="M18 10a.75.75 0 01-.75.75H6.75a.75.75 0 010-1.5h10.5a.75.75 0 01.75.75z" />
                <path fill-rule="evenodd"
                    d="M2.25 5.25A3 3 0 015.25 2.25h13.5A3 3 0 0121.75 5.25v13.5a3 3 0 01-3 3H5.25a3 3 0 01-3-3V5.25zM5.25 3.75a1.5 1.5 0 00-1.5 1.5v13.5a1.5 1.5 0 001.5 1.5h13.5a1.5 1.5 0 001.5-1.5V5.25a1.5 1.5 0 00-1.5-1.5H5.25z"
                    clip-rule="evenodd" />
                <path
                    d="M12.75 15a.75.75 0 01-.75.75H8.25a.75.75 0 010-1.5h3.75a.75.75 0 01.75.75z" />
            </svg>
            <!-- Debt Goal Icon (similar to sinking) -->
            <svg id="icon-debt-goal" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                class="bunny-icon-sm">
                <path
                    d="M18.364 18.364a9 9 0 00-12.728 0" />
                <path fill-rule="evenodd"
                    d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6.19l-2.47-2.47a.75.75 0 00-1.06 1.06l3.75 3.75a.75.75 0 001.06 0l3.75-3.75a.75.75 0 10-1.06-1.06l-2.47 2.47V6z"
                    clip-rule="evenodd" />
            </svg>
        </defs>
    </svg>

    <script type="module">
        // --- INTERNATIONALIZATION (i18n) ---
        const translations = {
            de: {
                appTitle: "Bunny Budget",
                navDashboard: "√úbersicht",
                navManage: "Verwalten", // NEW
                navSettings: "Einst.", // Kept for reference
                navStats: "Statistik",
                navStore: "Shop", // NEW
                dashboardMoneyToBudget: "Zu Budgetieren",
                dashboardTotalBudgeted: "Gesamt Budgetiert",
                dashboardTotalSpent: "Gesamt Ausgegeben (Variabel)",
                dashboardVariableEnvelopes: "Variable Umschl√§ge",
                dashboardNoVariable: "Noch keine variablen Umschl√§ge budgetiert. Gehe zur 'Verwalten'-Seite, um welche hinzuzuf√ºgen!", // MODIFIED
                dashboardSinkingFunds: "Spart√∂pfe (Ziele)",
                dashboardNoSinking: "Keine Spart√∂pfe. Gehe zur 'Verwalten'-Seite, um einen zu erstellen!", // MODIFIED
                dashboardDebtGoals: "Schulden-Tilgungsziele",
                dashboardNoDebtGoals: "Keine Tilgungsziele. Gehe zu 'Verwalten', um eines hinzuzuf√ºgen.", // MODIFIED
                dashboardRemaining: "Verf√ºgbar",
                dashboardBudgeted: "Budgetiert",
                dashboardSpent: "Ausgegeben",
                dashboardOf: "von",
                dashboardTotalSaved: "Gesamt Zugewiesen",
                budgetIncomeTitle: "Einkommen",
                budgetRollover: "√úbertrag Ersparnisse",
                budgetAddIncome: "+ Hinzuf.",
                budgetOtherIncome: "Sonst. Einkommen",
                budgetTotalIncome: "Gesamteinkommen",
                budgetCostsTitle: "Fixkosten",
                budgetFixedCosts: "Rechnungen & Schulden",
                budgetMoneyToBudget: "Zu Budgetieren",
                budgetTotalAssigned: "Gesamt Zugewiesen",
                budgetRemainingToAssign: "√úbrig",
                budgetNoFixed: "Keine Fixkosten, Schulden oder Spar-Rechnungen.",
                budgetVariableEnvelopes: "Variable Umschl√§ge",
                budgetNoVariable: "Keine variablen Umschl√§ge. F√ºge eine in 'Neue Kategorie Hinzuf√ºgen' hinzu.",
                budgetSinkingFundGoals: "Spartopf-Ziele",
                budgetNoSinking: "Keine Spartopf-Ziele. F√ºge eine in 'Neue Kategorie Hinzuf√ºgen' hinzu.",
                budgetDebtGoals: "Schulden-Tilgungsziele",
                budgetNoDebtGoals: "Keine Tilgungsziele. F√ºge eine in 'Neue Kategorie Hinzuf√ºgen' hinzu.",
                budgetOtherIncomeList: "Sonstige Einnahmen (Posten)",
                budgetNoOtherIncome: "Keine sonstigen Einnahmen f√ºr diesen Monat erfasst.",
                budgetLastMonth: "Zuletzt",
                budgetSave: "Monatsbudget Speichern",
                modalEditIncomeTitle: "Einkommen Bearbeiten",
                settingsMonthlySalary: "Monatsgehalt",
                settingsAddCategory: "Neue Kategorie Hinzuf√ºgen",
                settingsCategoryType: "Typ",
                settingsTypeVariable: "Variabler Umschlag",
                settingsTypeFixed: "Fixkosten",
                settingsTypeDebtPayment: "Schulden (Feste Zahlung)",
                settingsTypeSinkingBill: "Spartopf (Jhrl. Rechnung)",
                settingsTypeSinkingGoal: "Spartopf (Ziel)",
                settingsTypeDebtGoal: "Schulden (Tilgungsziel)",
                settingsCategoryName: "Name",
                settingsGoalAmount: "Gesamtziel (Optional)",
                settingsDefaultAmount: "Monatl. Zahlung (Optional)",
                settingsAddCategoryButton: "Kategorie Hinzuf√ºgen",
                modalEditCategoryTitle: "Kategorie Bearbeiten",
                settingsManageCategories: "Kategorien Verwalten",
                settingsNoFixed: "Keine Fixkosten. F√ºge oben eine hinzu!",
                settingsNoDebtPayment: "Keine festen Schulden. F√ºge oben eine hinzu!",
                settingsNoSinkingBill: "Keine j√§hrlichen Spar-Rechnungen. F√ºge oben eine hinzu!",
                settingsNoVariable: "Keine variablen Umschl√§ge. F√ºge oben eine hinzu!",
                settingsNoSinkingGoal: "Keine Spartopf-Ziele. F√ºge oben eine hinzu!",
                settingsNoDebtGoal: "Keine Tilgungsziele. F√ºge oben eine hinzu!",
                settingsHelpTitle: "Hilfe Erhalten",
                settingsHelpDesc: "Lerne, wie die App funktioniert, was die Begriffe bedeuten und wie man budgetiert.",
                settingsHelpButton: "Hilfe-Anleitung Anzeigen",
                settingsAppSettings: "App-Einstellungen",
                settingsLanguage: "Sprache",
                settingsCurrency: "W√§hrung",
                settingsDangerZone: "Gefahrenzone",
                settingsResetSubtitle: "Dies l√∂scht dauerhaft alle deine Daten (Gehalt, Kategorien, Transaktionen) und startet die App neu.",
                settingsResetButton: "App Zur√ºcksetzen",
                helpHowToUseTitle: "Wie man Bunny Budget nutzt",
                helpHowToUseStep1Title: "1. Richte dein Budget ein",
                helpHowToUseStep1Desc: "Gehe zum Tab 'Verwalten'. Gib zuerst dein monatliches Gehalt ein. F√ºge dann alle deine monatlichen Rechnungen (wie 'Miete' oder 'Internet') als 'Fixkosten' und alle monatlichen Schuldenzahlungen als 'Schulden (Feste Zahlung)' hinzu.", // MODIFIED
                helpHowToUseStep2Title: "2. F√ºge deine Kategorien hinzu",
                helpHowToUseStep2Desc: "F√ºge in 'Verwalten' deine Ausgabenkategorien (wie 'Lebensmittel' oder 'Tanken') als 'Variable Umschl√§ge' hinzu. F√ºge deine Sparziele (wie 'Urlaub') als 'Spartopf (Ziele)' oder 'Schulden (Tilgungsziele)' hinzu.", // MODIFIED
                helpHowToUseStep3Title: "3. Weise dein Geld zu",
                helpHowToUseStep3Desc: "Gehe zum Tab 'Verwalten'. F√ºge 'Sonst. Einkommen' hinzu, das du diesen Monat erhalten hast. Die App zeigt dein 'Geld zu Budgetieren' (dein Gesamteinkommen minus aller Fixkosten, Schulden und J√§hrl. Rechnungen). Weise dieses Geld deinen Variablen Umschl√§gen und Sparzielen zu.", // MODIFIED
                helpHowToUseStep4Title: "4. Verfolge deine Ausgaben",
                helpHowToUseStep4Desc: "Dr√ºcke auf dem '√úbersicht'-Tab den gro√üen 'pinken + Knopf', um eine Ausgabe hinzuzuf√ºgen. W√§hle den Umschlag, aus dem du ausgegeben hast, und sieh zu, wie der 'Verf√ºgbar'-Betrag sinkt.",
                helpHowToUseStep5Title: "5. Korrigiere Fehler",
                helpHowToUseStep5Desc: "Tippfehler gemacht? Klicke auf der '√úbersicht' auf eine 'Variable Umschlag'-Karte (z.B. ‚ÄûLebensmittel‚Äú). Eine Liste aller Transaktionen wird angezeigt. Klicke auf eine Transaktion, um sie zu 'Bearbeiten' oder 'L√∂schen'.",
                helpTermsTitle: "Budget-Begriffe Erkl√§rt",
                helpTermSalaryTitle: "Gehalt",
                helpTermSalaryDesc: "Dein gesamtes *wiederkehrendes* monatliches Einkommen. Dies ist die Basis f√ºr dein Budget.",
                helpTermOtherIncomeTitle: "Sonst. Einkommen",
                helpTermOtherIncomeDesc: "Einmaliges oder variables Einkommen (wie ein Nebenjob oder ein verkaufter Artikel). F√ºge dies auf der 'Verwalten'-Seite hinzu.", // MODIFIED
                helpTermFixedCostTitle: "Fixkosten",
                helpTermFixedCostDesc: "Eine Rechnung, die jeden Monat gleich hoch ist, wie Miete oder Internet. Diese wird bezahlt, *bevor* du budgetierst.",
                helpTermDebtPaymentTitle: "Schulden (Feste Zahlung)",
                helpTermDebtPaymentDesc: "Eine monatliche Zahlung f√ºr eine Schuld (wie ein Autokredit). Dies wird wie Fixkosten behandelt und *bevor* du budgetierst bezahlt.",
                helpTermSinkingBillTitle: "Spartopf (Jhrl. Rechnung)",
                helpTermSinkingBillDesc: "F√ºr nicht-monatliche Rechnungen (wie die j√§hrliche Autoversicherung). Die App spart jeden Monat 1/12 der Kosten und behandelt es wie Fixkosten, damit du nie von der Rechnung √ºberrascht wirst.",
                helpTermMoneyToBudgetTitle: "Geld zu Budgetieren",
                helpTermMoneyToBudgetDesc: "Dies ist dein 'Gesamteinkommen' (Gehalt + Sonstiges) minus all deiner 'Fixkosten', 'Schulden (Feste Zahlungen)' und 'Spart√∂pfe (Rechnungen)'. Dies ist das Geld, das du auf der 'Verwalten'-Seite zuweisen kannst.", // MODIFIED
                helpTermVariableEnvelopeTitle: "Variabler Umschlag",
                helpTermVariableEnvelopeDesc: "Dein 'digitaler Umschlag' f√ºr monatliche Ausgaben, die sich √§ndern, wie Lebensmittel, Tanken oder Ausw√§rts Essen. Du gibst mit dem '+'-Knopf daraus aus.",
                helpTermSinkingGoalTitle: "Spartopf (Ziel)",
                helpTermSinkingGoalDesc: "Dein 'digitaler Spar-Umschlag' f√ºr ein gro√ües, optionales Ziel, wie Urlaub, Weihnachten oder einen Notgroschen. Du weist ihm Geld zu, aber gibst nicht daraus aus.",
                helpTermDebtGoalTitle: "Schulden (Tilgungsziel)",
                helpTermDebtGoalDesc: "Ein 'digitaler Umschlag', um eine Schuld schneller abzubezahlen (wie eine Kreditkarte). Du weist diesem Ziel zus√§tzliches Geld von deinem 'Geld zu Budgetieren' zu.",
                modalAddExpenseTitle: "Ausgabe Hinzuf√ºgen",
                modalAddExpenseCategory: "Kategorie",
                modalAddExpenseAmount: "Betrag",
                modalAddExpenseDate: "Datum",
                modalAddIncomeTitle: "Sonst. Einkommen Hinzuf.",
                modalAddIncomeSource: "Quelle",
                modalAddIncomeSourcePlaceholder: "z.B. Nebenjob, Artikel verkauft",
                modalResetTitle: "Bist du sicher?",
                modalResetText: "Diese Aktion ist dauerhaft und l√∂scht alle deine Daten. Es gibt kein R√ºckg√§ngig.",
                modalResetConfirm: "Ja, App Zur√ºcksetzen",
                modalTxHistoryTitle: "Transaktionsverlauf",
                modalTxHistoryEmpty: "Keine Transaktionen f√ºr diese Kategorie gefunden.",
                modalEditTxTitle: "Transaktion Bearbeiten",
                modalDeleteTx: "Transaktion L√∂schen",
                cancel: "Abbrechen",
                save: "Speichern",
                toastSaved: "Gespeichert!",
                toastCategoryAdded: "Kategorie hinzugef√ºgt!",
                toastCategoryUpdated: "Kategorie aktualisiert!",
                toastCategoryDeleted: "Kategorie gel√∂scht!",
                toastBudgetSaved: "Budget gespeichert!",
                toastExpenseAdded: "Ausgabe hinzugef√ºgt!",
                toastIncomeAdded: "Einkommen hinzugef√ºgt!",
                toastIncomeDeleted: "Einnahmeposten gel√∂scht!",
                toastIncomeUpdated: "Einkommen aktualisiert!",
                toastSettingsSaved: "Einstellungen gespeichert!",
                toastReset: "App wurde zur√ºckgesetzt.",
                toastTxUpdated: "Transaktion aktualisiert!",
                toastTxDeleted: "Transaktion gel√∂scht!",
                toastNewMonth: "Willkommen in einem neuen Monat! Dein Budget wurde zur√ºckgesetzt.",
                onboardingCurrencyTitle: "W√§hrung Ausw√§hlen",
                onboardingCurrencySubtitle: "W√§hle deine Standardw√§hrung.",
                onboardingTemplateTitle: "Starte Dein Budget",
                onboardingTemplateSubtitle: "Du kannst mit unserer Vorlage oder bei Null anfangen.",
                onboardingHelpButton: "Wie funktioniert das? Lies die Anleitung",
                onboardingUseTemplate: "Mit Vorlage Starten",
                onboardingStartFresh: "Neu Starten",
                back: "Zur√ºck",
                next: "Weiter",
                thisMonth: "diesen Monat",
                statsTitle: "Statistik & Verlauf",
                statsTotalCoins: "Bunny Coins Gesamt",
                statsHistory: "√úbertragsverlauf",
                statsNoHistory: "Noch kein Verlauf. Spare etwas Geld, um Coins zu verdienen!",
                statsEntry: "Coins verdient mit",
                onboardingLanguageTitle: "Sprache W√§hlen",
                onboardingLanguageSubtitle: "W√§hle deine bevorzugte Sprache.",
                storeTitle: "Bunny Shop", // NEW
                storeComingSoon: "Der Bunny Shop kommt bald! Gib deine ü™ô f√ºr lustige neue Designs und Icons aus.", // NEW
                
                // --- NEW v3.0 Keys (Refactor) ---
                modalAddTransactionTitle: "Transaktion Hinzuf√ºgen",
                modalAddExpenseButton: "Ausgabe Hinzuf√ºgen",
                modalAddIncomeButton: "Einkommen Hinzuf√ºgen",
                installPwaButton: "App Installieren",
                modalAddExpenseNotes: "Notizen (Optional)",
                modalAddExpenseNotesPlaceholder: "z.B. Geburtstagsgeschenk",
                modalEditTxNotesPlaceholder: "z.B. Geburtstagsgeschenk",
                
                assignTitle: "Geld Zuweisen",
                assignEnvelopes: "Umschl√§ge F√ºllen",
                assignSinking: "Sparziele Besparen",
                assignDebt: "Schulden Bezahlen",
                
                setupManageTitle: "Setup & Verwaltung",
                manageCategoriesButton: "Alle Kategorien Verwalten",
                modalManageCategoriesTitle: "Kategorien Verwalten",
                modalManageTabBills: "Fixkosten & Rechnungen",
                modalManageTabEnvelopes: "Umschl√§ge & Ziele",
                // --- End NEW v3.0 Keys ---
            },
            en: {
                appTitle: "Bunny Budget",
                navDashboard: "Dashboard",
                navManage: "Manage", // NEW
                navSettings: "Settings", // Kept for reference
                navStats: "Stats",
                navStore: "Store", // NEW
                dashboardMoneyToBudget: "Money to Budget",
                dashboardTotalBudgeted: "Total Budgeted",
                dashboardTotalSpent: "Total Spent (Variable)",
                dashboardVariableEnvelopes: "Variable Envelopes",
                dashboardNoVariable: "No variable envelopes budgeted yet. Go to the 'Manage' page to add some!", // MODIFIED
                dashboardSinkingFunds: "Sinking Fund Goals",
                dashboardNoSinking: "No sinking fund goals. Go to the 'Manage' page to create one!", // MODIFIED
                dashboardDebtGoals: "Debt Paydown Goals",
                dashboardNoDebtGoals: "No debt paydown goals. Go to 'Manage' to add one.", // MODIFIED
                dashboardRemaining: "Available",
                dashboardBudgeted: "Budgeted",
                dashboardSpent: "Spent",
                dashboardOf: "of",
                dashboardTotalSaved: "Total Assigned",
                budgetIncomeTitle: "Income",
                budgetRollover: "Rollover Savings",
                budgetAddIncome: "+ Add",
                budgetOtherIncome: "Other Income",
                budgetTotalIncome: "Total Income",
                budgetCostsTitle: "Fixed Costs",
                budgetFixedCosts: "Bills & Debts",
                budgetMoneyToBudget: "Money to Budget",
                budgetTotalAssigned: "Total Assigned",
                budgetRemainingToAssign: "Remaining",
                budgetNoFixed: "No fixed costs, debts, or sinking fund bills.",
                budgetVariableEnvelopes: "Variable Envelopes",
                budgetNoVariable: "No variable envelopes. Add one in 'Add New Category' below.",
                budgetSinkingFundGoals: "Sinking Fund Goals",
                budgetNoSinking: "No sinking fund goals. Add one in 'Add New Category' below.",
                budgetDebtGoals: "Debt Paydown Goals",
                budgetNoDebtGoals: "No debt paydown goals. Add one in 'Add New Category' below.",
                budgetOtherIncomeList: "Other Income Items",
                budgetNoOtherIncome: "No other income added this month.",
                budgetLastMonth: "Last",
                budgetSave: "Save Monthly Budget",
                modalEditIncomeTitle: "Edit Income",
                settingsMonthlySalary: "Monthly Salary",
                settingsAddCategory: "Add New Category",
                settingsCategoryType: "Type",
                settingsTypeVariable: "Variable Envelope",
                settingsTypeFixed: "Fixed Cost",
                settingsTypeDebtPayment: "Debt (Fixed Payment)",
                settingsTypeSinkingBill: "Sinking Fund (Annual Bill)",
                settingsTypeSinkingGoal: "Sinking Fund (Goal)",
                settingsTypeDebtGoal: "Debt (Paydown Goal)",
                settingsCategoryName: "Name",
                settingsGoalAmount: "Total Goal (Optional)",
                settingsDefaultAmount: "Monthly Payment (Optional)",
                settingsAddCategoryButton: "Add Category",
                modalEditCategoryTitle: "Edit Category",
                settingsManageCategories: "Manage Categories",
                settingsNoFixed: "No fixed costs. Add one above!",
                settingsNoDebtPayment: "No fixed debts. Add one above!",
                settingsNoSinkingBill: "No annual bill sinking funds. Add one above!",
                settingsNoVariable: "No variable envelopes. Add one above!",
                settingsNoSinkingGoal: "No sinking fund goals. Add one above!",
                settingsNoDebtGoal: "No debt paydown goals. Add one above!",
                settingsHelpTitle: "Get Help",
                settingsHelpDesc: "Learn how to use the app, what the terms mean, and how to budget.",
                settingsHelpButton: "View Help Guide",
                settingsAppSettings: "App Settings",
                settingsLanguage: "Language",
                settingsCurrency: "Currency",
                settingsDangerZone: "Danger Zone",
                settingsResetSubtitle: "This will permanently delete all your data (salary, categories, transactions) and restart the app.",
                settingsResetButton: "Reset App",
                helpHowToUseTitle: "How to Use Bunny Budget",
                helpHowToUseStep1Title: "1. Setup Your Budget",
                helpHowToUseStep1Desc: "Go to the Manage tab. First, enter your monthly Salary. Then, add all your monthly bills (like 'Rent' or 'Internet') as Fixed Costs and any monthly debt payments as Debts (Fixed Payment).", // MODIFIED
                helpHowToUseStep2Title: "2. Add Your Categories",
                helpHowToUseStep2Desc: "In Manage, add your spending categories (like 'Groceries' or 'Gas') as Variable Envelopes. Add your savings goals (like 'Vacation') as Sinking Fund (Goals) or Debt (Paydown Goals).", // MODIFIED
                helpHowToUseStep3Title: "3. Assign Your Money",
                helpHowToUseStep3Desc: "Go to the Manage tab. Add any Other Income you received this month. The app shows your 'Money to Budget' (your Total Income minus all Fixed Costs, Debts, and Annual Bills). Assign this money into your Variable Envelopes and savings goals.", // MODIFIED
                helpHowToUseStep4Title: "4. Track Your Spending",
                helpHowToUseStep4Desc: "On the Dashboard tab, press the big pink '+' button to add an expense. Select the envelope you spent from, and watch the 'Remaining' amount go down.",
                helpHowToUseStep5Title: "5. Fix Mistakes",
                helpHowToUseStep5Desc: "Made a typo? On the Dashboard, click the Variable Envelope card (e.g., \"Groceries\"). A list of all transactions will appear. Click a transaction to Edit or Delete it.",
                helpTermsTitle: "Budgeting Terms Explained",
                helpTermSalaryTitle: "Salary",
                helpTermSalaryDesc: "Your total *recurring* monthly income. This is the baseline for your budget.",
                helpTermOtherIncomeTitle: "Other Income",
                helpTermOtherIncomeDesc: "One-time or variable income (like a side job or selling an item). Add this on the **Manage** page.", // MODIFIED
                helpTermFixedCostTitle: "Fixed Cost",
                helpTermFixedCostDesc: "A bill that is the same amount every month, like Rent or Internet. This is paid *before* you budget.",
                helpTermDebtPaymentTitle: "Debt (Fixed Payment)",
                helpTermDebtPaymentDesc: "A monthly payment for a debt (like a car loan). This is treated like a Fixed Cost and is paid *before* you budget.",
                helpTermSinkingBillTitle: "Sinking Fund (Annual Bill)",
                helpTermSinkingBillDesc: "For non-monthly bills (like annual car insurance or a quarterly tax). The app saves 1/12th of the cost every month, treating it like a Fixed Cost so you're never surprised by the bill.",
                helpTermMoneyToBudgetTitle: "Money to Budget",
                helpTermMoneyToBudgetDesc: "This is your Total Income (Salary + Other) minus all your Fixed Costs, Debts (Fixed Payments), and Sinking Fund (Bills). This is the money you get to assign on the Manage page.", // MODIFIED
                helpTermVariableEnvelopeTitle: "Variable Envelope",
                helpTermVariableEnvelopeDesc: "Your 'digital envelope' for monthly spending that changes, like Groceries, Gas, or Dining Out. You spend from these using the '+' button.",
                helpTermSinkingGoalTitle: "Sinking Fund (Goal)",
                helpTermSinkingGoalDesc: "Your 'digital savings envelope' for a big, optional goal, like Vacation, Christmas, or an Emergency Fund. You assign money to it, but you don't spend from it.",
                helpTermDebtGoalTitle: "Debt (Paydown Goal)",
                helpTermDebtGoalDesc: "A 'digital envelope' to pay off a debt faster (like a credit card). You assign extra money from your 'Money to Budget' to this goal.",
                modalAddExpenseTitle: "Add Expense",
                modalAddExpenseCategory: "Category",
                modalAddExpenseAmount: "Amount",
                modalAddExpenseDate: "Date",
                modalAddIncomeTitle: "Add Other Income",
                modalAddIncomeSource: "Source",
                modalAddIncomeSourcePlaceholder: "e.g. Side Job, Sold item",
                modalResetTitle: "Are you sure?",
                modalResetText: "This action is permanent and will delete all your data. There is no undo.",
                modalResetConfirm: "Yes, Reset App",
                modalTxHistoryTitle: "Transaction History",
                modalTxHistoryEmpty: "No transactions found for this category.",
                modalEditTxTitle: "Edit Transaction",
                modalDeleteTx: "Delete Transaction",
                cancel: "Cancel",
                save: "Save",
                toastSaved: "Saved!",
                toastCategoryAdded: "Category added!",
                toastCategoryUpdated: "Category updated!",
                toastCategoryDeleted: "Category deleted!",
                toastBudgetSaved: "Budget saved!",
                toastExpenseAdded: "Expense added!",
                toastIncomeAdded: "Income added!",
                toastIncomeDeleted: "Income item deleted!",
                toastIncomeUpdated: "Income updated!",
                toastSettingsSaved: "Settings saved!",
                toastReset: "App has been reset.",
                toastTxUpdated: "Transaction updated!",
                toastTxDeleted: "Transaction deleted!",
                toastNewMonth: "Welcome to a new month! Your budget has been reset.",
                onboardingCurrencyTitle: "Select Currency",
                onboardingCurrencySubtitle: "Choose your default currency.",
                onboardingTemplateTitle: "Start Your Budget",
                onboardingTemplateSubtitle: "You can start with our template or from scratch.",
                onboardingHelpButton: "How does this work? Read the guide",
                onboardingUseTemplate: "Start with Template",
                onboardingStartFresh: "Start Fresh",
                back: "Back",
                next: "Next",
                thisMonth: "this month",
                statsTitle: "Stats & History",
                statsTotalCoins: "Total Bunny Coins",
                statsHistory: "Rollover History",
                statsNoHistory: "No history yet. Save some money to earn coins!",
                statsEntry: "coins earned from",
                onboardingLanguageTitle: "Select Language",
                onboardingLanguageSubtitle: "Choose your preferred language.",
                storeTitle: "Bunny Store", // NEW
                storeComingSoon: "The Bunny Store is coming soon! Spend your ü™ô on fun new themes and icons.", // NEW

                // --- NEW v3.0 Keys (Refactor) ---
                modalAddTransactionTitle: "Add Transaction",
                modalAddExpenseButton: "Add Expense",
                modalAddIncomeButton: "Add Income",
                installPwaButton: "Install App to Home Screen",
                modalAddExpenseNotes: "Notes (Optional)",
                modalAddExpenseNotesPlaceholder: "e.g. Birthday gift for mom",
                modalEditTxNotesPlaceholder: "e.g. Birthday gift for mom",

                assignTitle: "Assign Your Money",
                assignEnvelopes: "Fill Your Envelopes",
                assignSinking: "Contribute to Savings Goals",
                assignDebt: "Make Extra Debt Payments",

                setupManageTitle: "Setup & Manage",
                manageCategoriesButton: "Manage All Categories",
                modalManageCategoriesTitle: "Manage Categories",
                modalManageTabBills: "Income & Bills",
                modalManageTabEnvelopes: "Envelopes & Goals",
                // --- End NEW v3.0 Keys ---
            }
        };

        const i18n = {
            lang: 'en', // Default language
            currency: '‚Ç¨', // Default currency
            currencySymbolDisplay: '‚Ç¨ EUR',
            formattingLocale: 'de-DE', // NEW: For number formatting
            fractionDigits: 2, // NEW: For number formatting
            translationStore: { ...translations }, // Store for all loaded translations

            /**
             * Initializes i18n.
             */
            init() {
                // Try to get language from localStorage, fallback to 'en'
                try {
                    this.lang = localStorage.getItem('bunnyBudgetLanguage') || 'en';
                } catch (e) {
                    this.lang = 'en';
                }
                
                // Try to get currency from localStorage, fallback to defaults
                try {
                    this.currency = localStorage.getItem('bunnyBudgetCurrency') || '‚Ç¨';
                    this.currencySymbolDisplay = localStorage.getItem('bunnyBudgetCurrencySymbol') || '‚Ç¨ EUR';
                    this.formattingLocale = localStorage.getItem('bunnyBudgetLocale') || 'de-DE';
                    this.fractionDigits = parseInt(localStorage.getItem('bunnyBudgetDigits') || '2', 10);
                } catch (e) {
                    this.currency = '‚Ç¨';
                    this.currencySymbolDisplay = '‚Ç¨ EUR';
                    this.formattingLocale = 'de-DE';
                    this.fractionDigits = 2;
                }

                this.translateAll();
                this.updateCurrencyDisplays();
            },

            setLanguage(lang, doTranslate = true) {
                this.lang = lang;
                try {
                    localStorage.setItem('bunnyBudgetLanguage', lang);
                } catch (e) { }
                
                if (doTranslate) {
                    this.translateAll();
                }
                // Update dropdown
                const langSelect = document.getElementById('language-select');
                if (langSelect) langSelect.value = lang;
            },

            setCurrency(currency, currencySymbol, locale, digits) {
                this.currency = currency;
                this.currencySymbolDisplay = currencySymbol;
                this.formattingLocale = locale;
                this.fractionDigits = parseInt(digits, 10);
                
                try {
                    localStorage.setItem('bunnyBudgetCurrency', currency);
                    localStorage.setItem('bunnyBudgetCurrencySymbol', currencySymbol);
                    localStorage.setItem('bunnyBudgetLocale', locale);
                    localStorage.setItem('bunnyBudgetDigits', digits);
                } catch (e) { }
                
                this.updateCurrencyDisplays();
                // Update dropdown
                const currencySelect = document.getElementById('currency-select-settings');
                if (currencySelect) currencySelect.value = currency;
            },

            t(key) {
                // Pull from current language, fallback to English
                return (this.translationStore[this.lang] && this.translationStore[this.lang][key]) || this.translationStore['en'][key] || key;
            },

            translateAll() {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    const translation = this.t(key);
                    if (el.tagName === 'INPUT' && (el.type === 'number' || el.type === 'text' || el.type === 'date') || el.tagName === 'TEXTAREA') {
                        if (el.placeholder) {
                            el.placeholder = translation;
                        }
                    } else {
                        el.textContent = translation;
                    }
                });
            },

            updateCurrencyDisplays() {
                document.querySelectorAll('#salary-currency-symbol, #category-currency-symbol, #expense-currency-symbol, #edit-tx-currency-symbol, #income-currency-symbol, #category-goal-currency-symbol, #edit-income-currency-symbol, #edit-category-currency-symbol, #edit-category-goal-currency-symbol').forEach(el => {
                    if (el) el.textContent = this.currency;
                });
            }
        };

        // --- DATABASE (IndexedDB) ---
        const dbStore = {
            db: null,
            dbName: "BunnyBudgetDB",
            version: 5, // Last update: Add notes to transactions

            /**
             * Initialize the database
             */
            async initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = (event) => {
                        console.error("IndexedDB error:", request.error);
                        reject("IndexedDB error");
                    };

                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        const transaction = event.target.transaction; // Get transaction for migration
                        const oldVersion = event.oldVersion;

                        if (oldVersion < 1) {
                            // Version 1 setup
                            this.db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                            const txStore = this.db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                            txStore.createIndex('categoryId', 'categoryId', { unique: false });
                            this.db.createObjectStore('settings', { keyPath: 'key' });
                            this.db.createObjectStore('budget', { keyPath: 'id' });
                        }

                        if (oldVersion < 2) {
                            // Version 2 upgrade
                            const incomeStore = this.db.createObjectStore('otherIncome', { keyPath: 'id', autoIncrement: true });
                            incomeStore.createIndex('month', 'month', { unique: false });
                        }
                        
                        if (oldVersion < 3) {
                            // Version 3 upgrade (Phase 2: Rollover & Coins)
                            this.db.createObjectStore('envelopes', { keyPath: 'categoryId' });
                            this.db.createObjectStore('bunnyCoins', { keyPath: 'month' });
                        }
                        
                        if (oldVersion < 4) {
                            // Re-create bunnyCoins store to use a proper auto-incrementing key
                            if (this.db.objectStoreNames.contains('bunnyCoins')) {
                                this.db.deleteObjectStore('bunnyCoins');
                            }
                            const coinStore = this.db.createObjectStore('bunnyCoins', { keyPath: 'id', autoIncrement: true });
                            coinStore.createIndex('month', 'month', { unique: false });
                        }

                        if (oldVersion < 5) {
                            // Add 'notes' to transactions
                            // No migration needed, new optional property
                        }
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                });
            },

            /**
             * Load the template data into the database
             * @param {string} lang - 'en' or 'de' (now just 'en')
             */
            async loadTemplateData() {
                const template = {
                    settings: [
                        { key: 'salary', value: 2500 }
                    ],
                    categories: [
                        // Fixed
                        { type: 'fixed', name: 'Rent', amount: 750 },
                        { type: 'fixed', name: 'Electricity', amount: 71 },
                        { type: 'fixed', name: 'Internet', amount: 40 },
                        { type: 'fixed', name: 'Mobile Phone', amount: 49 },
                        { type: 'fixed', name: 'Car Insurance', amount: 83 },
                        { type: 'debt-payment', name: 'Car Loan', amount: 252 },

                        // Sinking Fund (Bill)
                        { type: 'sinking-bill', name: 'TV/Radio Tax', amount: 18.36 },
                        { type: 'sinking-bill', name: 'Dog Tax', amount: 6 },
                        { type: 'sinking-bill', name: 'Car Tax', amount: 8.33 },

                        // Variable
                        { type: 'variable', name: 'Groceries', amount: 250 },
                        { type: 'variable', name: 'Auto', amount: 100 },
                        { type: 'variable', name: 'Household', amount: 50 },
                        { type: 'variable', name: 'Dog', amount: 80 },
                        { type: 'variable', name: 'Dining Out', amount: 75 },

                        // Sinking Fund (Goal)
                        { type: 'sinking-goal', name: 'Vacation', amount: 100 },
                        { type: 'sinking-goal', name: 'Christmas', amount: 50 },
                        { type: 'sinking-goal', name: 'Emergency Fund', amount: 150 },

                        // Debt Goal
                        { type: 'debt-goal', name: 'Credit Card', amount: 50 },
                    ]
                };

                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject("DB not initialized");
                        return;
                    }

                    const transaction = this.db.transaction(['settings', 'categories'], 'readwrite');
                    const settingsStore = transaction.objectStore('settings');
                    const categoriesStore = transaction.objectStore('categories');

                    // Add settings
                    template.settings.forEach(item => {
                        settingsStore.put(item);
                    });

                    // Add categories
                    template.categories.forEach(item => {
                        categoriesStore.add(item);
                    });

                    transaction.oncomplete = () => {
                        console.log("Template data loaded.");
                        resolve();
                    };

                    transaction.onerror = (event) => {
                        console.error("Error loading template data:", event.target.error);
                        reject(event.target.error);
                    };
                });
            },
            
            /**
             * Save a setting (e.g., salary)
             * @param {string} key - The setting key (e.g., 'salary')
             * @param {*} value - The setting value
             */
            async saveSetting(key, value) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('settings', 'readwrite');
                    const store = transaction.objectStore('settings');
                    store.put({ key, value });

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get a setting
             * @param {string} key - The setting key
             */
            async getSetting(key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject("DB not initialized");
                        return;
                    }
                    const transaction = this.db.transaction('settings', 'readonly');
                    const store = transaction.objectStore('settings');
                    const request = store.get(key);

                    request.onsuccess = () => {
                        resolve(request.result ? request.result.value : null);
                    };
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Add a category
             * @param {object} category - The category object {name, type, amount}
             */
            async addCategory(category) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('categories', 'readwrite');
                    const store = transaction.objectStore('categories');
                    const request = store.add(category);

                    request.onsuccess = (event) => {
                        // Return the newly created ID
                        resolve(event.target.result);
                    };
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Update an existing category
             * @param {object} category - The full category object
             */
            async updateCategory(category) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('categories', 'readwrite');
                    const store = transaction.objectStore('categories');
                    const request = store.put(category); // put() will overwrite
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all categories
             */
            async getCategories() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('categories', 'readonly');
                    const store = transaction.objectStore('categories');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Delete a category
             * @param {number} id - The ID of the category to delete
             */
            async deleteCategory(id) {
                return new Promise((resolve, reject) => {
                    // Make transaction aware of all stores
                    const transaction = this.db.transaction(['categories', 'budget', 'transactions', 'envelopes', 'bunnyCoins'], 'readwrite');
                    const categoriesStore = transaction.objectStore('categories');
                    const budgetStore = transaction.objectStore('budget');
                    const transactionsStore = transaction.objectStore('transactions');

                    // 1. Delete the category itself
                    categoriesStore.delete(id);

                    // 2. Delete its budget entry (if any)
                    budgetStore.delete(`variable-${id}`);
                    budgetStore.delete(`sinking-goal-${id}`);
                    budgetStore.delete(`debt-goal-${id}`);

                    // 3. Delete its envelope balance (if any)
                    const envelopesStore = transaction.objectStore('envelopes');
                    envelopesStore.delete(id);

                    // 4. Delete all transactions associated with this category
                    const transactionIndex = transactionsStore.index('categoryId');
                    const transactionRequest = transactionIndex.getAll(id);

                    transactionRequest.onsuccess = () => {
                        transactionRequest.result.forEach(tx => {
                            transactionsStore.delete(tx.id);
                        });
                    };

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => {
                        console.error("Error deleting category:", event.target.error);
                        reject(event.target.error);
                    };
                });
            },

            /**
             * Save monthly budget assignments
             * @param {array} budgetItems - Array of {id, amount}
             */
            async saveBudget(budgetItems) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('budget', 'readwrite');
                    const store = transaction.objectStore('budget');

                    // Phase 1: Clean slate. Clear all old budget items.
                    const clearRequest = store.clear();
                    clearRequest.onerror = (event) => reject(event.target.error);

                    clearRequest.onsuccess = () => {
                        // After clearing, add all new items
                        if (budgetItems.length === 0) {
                            resolve(); // Nothing to add
                            return;
                        }

                        let putCount = 0;
                        budgetItems.forEach(item => {
                            const putRequest = store.put(item);
                            putRequest.onerror = (event) => reject(event.target.error);
                        });
                    };

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all budget items
             */
            async getBudget() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('budget', 'readonly');
                    const store = transaction.objectStore('budget');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Add an expense transaction
             * @param {object} transaction - { categoryId, amount, date }
             */
            async addTransaction(transaction) {
                return new Promise((resolve, reject) => {
                    const dbTransaction = this.db.transaction('transactions', 'readwrite');
                    const store = dbTransaction.objectStore('transactions');
                    const request = store.add(transaction);

                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all transactions
             */
            async getTransactions() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('transactions', 'readonly');
                    const store = transaction.objectStore('transactions');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all transactions for a specific category
             * @param {number} categoryId
             */
            async getTransactionsForCategory(categoryId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('transactions', 'readonly');
                    const store = transaction.objectStore('transactions');
                    const index = store.index('categoryId');
                    const request = index.getAll(categoryId);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Update an existing transaction
             * @param {object} txObject - The full transaction object {id, categoryId, amount, date}
             */
            async updateTransaction(txObject) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('transactions', 'readwrite');
                    const store = transaction.objectStore('transactions');
                    const request = store.put(txObject);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Delete a single transaction by its ID
             * @param {number} id - The transaction's primary key
             */
            async deleteTransaction(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('transactions', 'readwrite');
                    const store = transaction.objectStore('transactions');
                    const request = store.delete(id);

                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Clear all transactions
             */
            async clearTransactions() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('transactions', 'readwrite');
                    const store = transaction.objectStore('transactions');
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Clear all budget items
             */
            async clearBudget() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('budget', 'readwrite');
                    const store = transaction.objectStore('budget');
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Add an other income item
             * @param {object} income - { source, amount, month }
             */
            async addOtherIncome(income) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('otherIncome', 'readwrite');
                    const store = transaction.objectStore('otherIncome');
                    const request = store.add(income);

                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all other income for a specific month
             * @param {string} month - 'YYYY-MM'
             */
            async getOtherIncome(month) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('otherIncome', 'readonly');
                    const store = transaction.objectStore('otherIncome');
                    const index = store.index('month');
                    const request = index.getAll(month);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },
            
            /**
             * Update a single other income item
             * @param {object} income - The full income object
             */
            async updateOtherIncome(income) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('otherIncome', 'readwrite');
                    const store = transaction.objectStore('otherIncome');
                    const request = store.put(income); // 'put' handles updates
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Delete a single other income item
             * @param {number} id - The ID of the income item
             */
            async deleteOtherIncome(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('otherIncome', 'readwrite');
                    const store = transaction.objectStore('otherIncome');
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Clear all other income items (for new month)
             */
            async clearOtherIncome() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('otherIncome', 'readwrite');
                    const store = transaction.objectStore('otherIncome');
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            // --- NEW PHASE 2 FUNCTIONS ---

            /**
             * Get all envelope balances
             */
            async getEnvelopes() {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('envelopes', 'readonly');
                    const store = transaction.objectStore('envelopes');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get a single envelope by its category ID
             * @param {number} categoryId
             */
            async getEnvelope(categoryId) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('envelopes', 'readonly');
                    const store = transaction.objectStore('envelopes');
                    const request = store.get(categoryId);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },
            
            /**
             * Bulk save/update envelope balances
             * @param {Array<object>} envelopes - Array of envelope objects
             */
            async saveEnvelopes(envelopes) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('envelopes', 'readwrite');
                    const store = transaction.objectStore('envelopes');

                    envelopes.forEach(env => {
                        store.put(env);
                    });

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Save a single envelope balance
             * @param {object} envelope - The envelope object
             */
            async saveEnvelope(envelope) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('envelopes', 'readwrite');
                    const store = transaction.objectStore('envelopes');
                    const request = store.put(envelope);

                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all earned bunny coins
             */
            async getBunnyCoins() {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('bunnyCoins', 'readonly');
                    const store = transaction.objectStore('bunnyCoins');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Save/update a coin entry for a specific month
             * @param {object} coinEntry - { month, coins, rollover }
             */
            async saveBunnyCoins(coinEntry) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('bunnyCoins', 'readwrite');
                    const store = transaction.objectStore('bunnyCoins');
                    // Use add() to always create a new entry
                    const request = store.add(coinEntry);

                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * NEW: Clears all data from all object stores
             */
            async clearAllData() {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    
                    const allStores = [
                        'categories', 'transactions', 'settings', 'budget',
                        'otherIncome', 'envelopes', 'bunnyCoins'
                    ];
                    
                    const transaction = this.db.transaction(allStores, 'readwrite');
                    
                    let clearCount = 0;
                    allStores.forEach(storeName => {
                        const request = transaction.objectStore(storeName).clear();
                        request.onerror = (e) => reject(e.target.error);
                    });

                    transaction.oncomplete = () => {
                        console.log("All data cleared from stores.");
                        resolve();
                    };
                    
                    transaction.onerror = (event) => {
                        console.error("Error clearing all data:", event.target.error);
                        reject(event.target.error);
                    };
                });
            }
        };

        // --- MAIN APP ---
        const app = {
            // Debounce utility
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func.apply(this, args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            // App State
            categories: [],
            transactions: [],
            budget: [],
            otherIncome: [],
            envelopes: [], // NEW: For persistent balances
            bunnyCoins: [], // NEW: For gamification
            lastMonthRollover: 0, // NEW: For budget calculation
            lastMonthBudget: [], // NEW: For budget reference
            salary: 0,
            currentPage: 'dashboard-page',
            currentEditingTxId: null,
            deferredPwaPrompt: null, // For PWA install
            
            // Cached DOM Elements
            dom: {},

            // --- Initialization ---

            /**
             * Initialize the application
             */
            async init() {
                // 0. Cache DOM elements
                this.cacheDOMElements();

                // 1. Initialize DB
                try {
                    await dbStore.initDB();
                } catch (e) {
                    console.error("Failed to initialize DB", e);
                    document.body.innerHTML = "Error: Could not open database. Please enable IndexedDB.";
                    return;
                }

                // 2. Initialize i18n
                i18n.init();

                // 3. Check if it's the first run
                const setupDone = await dbStore.getSetting('setupDone');

                if (!setupDone) {
                    // Show onboarding modal
                    this.dom.onboardingModal.classList.remove('hidden');
                    this.dom.onboardingModal.classList.add('flex');
                    this.dom.appContainer.classList.add('opacity-0'); // Keep app hidden
                    this.attachOnboardingListeners();
                } else {
                    // Not first run, load app normally
                    this.dom.onboardingModal.classList.add('hidden');
                    this.dom.onboardingModal.classList.remove('flex');
                    this.dom.appContainer.classList.remove('opacity-0');

                    await this.loadDataAndRender();
                    this.attachListeners();
                    
                    // Run V3 migration if needed
                    await this.runV3DataMigration();

                    this.checkForNewMonth();
                }

                // PWA Service Worker registration
                this.registerServiceWorker();

                // Listen for the PWA install prompt
                window.addEventListener('beforeinstallprompt', (e) => this.onBeforeInstallPrompt(e));
            },

            /**
             * Registers the physical sw.js file to make the app a PWA
             */
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('./sw.js')
                            .then(registration => {
                                console.log('Service Worker registered successfully:', registration);
                            })
                            .catch(error => {
                                console.log('Service Worker registration failed:', error);
                            });
                    });
                }
            },
            
            /**
             * Run after onboarding is complete
             */
            async completeOnboarding() {
                // Save settings from i18n (which are now set from localStorage or onboarding)
                await dbStore.saveSetting('language', i18n.lang);
                await dbStore.saveSetting('currency', i18n.currency);
                await dbStore.saveSetting('currencySymbol', i18n.currencySymbolDisplay);
                await dbStore.saveSetting('formattingLocale', i18n.formattingLocale);
                await dbStore.saveSetting('fractionDigits', i18n.fractionDigits);

                // Finalize setup
                await dbStore.saveSetting('setupDone', true);
                await dbStore.saveSetting('lastMonth', new Date().getMonth()); // Set initial month

                this.dom.onboardingModal.classList.add('hidden');
                this.dom.onboardingModal.classList.remove('flex');
                this.dom.appContainer.classList.remove('opacity-0');

                await this.loadDataAndRender();
                this.attachListeners();
                
                // BUG 1 FIX: Navigate to manage page after onboarding
                this.navigateTo('manage-page');
            },

            /**
             * Cache all necessary DOM elements
             */
            cacheDOMElements() {
                this.dom = {
                    appContainer: document.getElementById('app-container'),
                    // Onboarding
                    bunnyCoinTotal: document.getElementById('bunny-coin-total'),
                    onboardingModal: document.getElementById('onboarding-modal'),
                    onboardingStepLanguage: document.getElementById('onboarding-step-language'),
                    onboardingLangEn: document.getElementById('onboarding-lang-en'),
                    onboardingLangDe: document.getElementById('onboarding-lang-de'),
                    onboardingBackToLang: document.getElementById('onboarding-back-to-lang'),
                    onboardingBackToCurrency: document.getElementById('onboarding-back-to-currency'),
                    onboardingStep1: document.getElementById('onboarding-step-1'),
                    onboardingStep2: document.getElementById('onboarding-step-2'),
                    currencySelect: document.getElementById('currency-select'),
                    onboardingNextStep1: document.getElementById('onboarding-next-step-1'),
                    onboardingUseTemplate: document.getElementById('onboarding-use-template'),
                    onboardingStartFresh: document.getElementById('onboarding-start-fresh'),
                    onboardingGoToHelp: document.getElementById('onboarding-go-to-help'),
                    onboardingStepHelp: document.getElementById('onboarding-step-help'),
                    onboardingHelpBack: document.getElementById('onboarding-help-back'),

                    // Pages
                    pages: document.querySelectorAll('.page'),
                    dashboardPage: document.getElementById('dashboard-page'),
                    managePage: document.getElementById('manage-page'), // NEW (Replaces budget/settings)
                    helpPage: document.getElementById('help-page'),
                    statsPage: document.getElementById('stats-page'),
                    storePage: document.getElementById('store-page'), // NEW

                    // Nav
                    navButtons: document.querySelectorAll('.nav-button'),
                    navDashboard: document.getElementById('nav-dashboard'),
                    navManage: document.getElementById('nav-manage'), // NEW
                    navStats: document.getElementById('nav-stats'),
                    navStore: document.getElementById('nav-store'), // NEW

                    // Dashboard
                    dashboardMoneyToBudget: document.getElementById('dashboard-money-to-budget'),
                    dashboardTotalBudgeted: document.getElementById('dashboard-total-budgeted'),
                    dashboardTotalSpent: document.getElementById('dashboard-total-spent'),
                    variableEnvelopesList: document.getElementById('variable-envelopes-list'),
                    variableEnvelopesEmpty: document.getElementById('variable-envelopes-empty'),
                    sinkingFundGoalsList: document.getElementById('sinking-fund-goals-list'),
                    sinkingFundGoalsEmpty: document.getElementById('sinking-fund-goals-empty'),
                    debtGoalDashboardList: document.getElementById('debt-goal-dashboard-list'),
                    debtGoalDashboardEmpty: document.getElementById('debt-goal-dashboard-empty'),
                    sinkingFundsContainer: document.getElementById('sinking-funds-container'), // NEW
                    debtGoalsContainer: document.getElementById('debt-goals-container'), // NEW

                    // Manage Page (Budget elements)
                    budgetMoneyToBudget: document.getElementById('budget-money-to-budget'),
                    budgetTotalAssigned: document.getElementById('budget-total-assigned'),
                    budgetRemaining: document.getElementById('budget-remaining'),
                    budgetSummarySalary: document.getElementById('budget-summary-salary'),
                    budgetSummaryOtherIncome: document.getElementById('budget-summary-other-income'),
                    budgetSummaryRollover: document.getElementById('budget-summary-rollover'),
                    budgetSummaryTotalIncome: document.getElementById('budget-summary-total-income'),
                    budgetSummaryFixedCosts: document.getElementById('budget-summary-fixed-costs'),
                    // addOtherIncomeBtn: (Removed)
                    budgetForm: document.getElementById('budget-form'),
                    budgetVariableList: document.getElementById('budget-variable-list'),
                    budgetSinkingFundList: document.getElementById('budget-sinking-fund-list'),
                    budgetDebtGoalList: document.getElementById('budget-debt-goal-list'),
                    // budgetFixedCostsList: (Removed)
                    // budgetFixedCostsEmpty: (Removed)
                    otherIncomeList: document.getElementById('other-income-list'), // This ID is in Card 1 now, it's correct
                    otherIncomeEmpty: document.getElementById('other-income-empty'), // This ID is in Card 1 now, it's correct
                    budgetVariableEmpty: document.getElementById('budget-variable-empty'),
                    budgetSinkingFundEmpty: document.getElementById('budget-sinking-fund-empty'),
                    budgetDebtGoalEmpty: document.getElementById('budget-debt-goal-empty'),

                    // Manage Page (Settings elements)
                    salaryForm: document.getElementById('salary-form'),
                    salaryInput: document.getElementById('salary-input'),
                    autoSaveStatus: document.getElementById('auto-save-status'),
                    addCategoryForm: document.getElementById('add-category-form'),
                    categoryType: document.getElementById('category-type'),
                    categoryName: document.getElementById('category-name'),
                    categoryAmount: document.getElementById('category-amount'),
                    categoryGoalAmountGroup: document.getElementById('category-goal-amount-group'),
                    categoryGoalAmount: document.getElementById('category-goal-amount'),
                    
                    // NEW: Manage Categories Modal
                    manageCategoriesButton: document.getElementById('manage-categories-button'),
                    manageCategoriesModal: document.getElementById('manage-categories-modal'),
                    cancelManageCategoriesButton: document.getElementById('cancel-manage-categories-button'),
                    modalManageTabBills: document.getElementById('modal-manage-tab-bills'),
                    modalManageTabEnvelopes: document.getElementById('modal-manage-tab-envelopes'),
                    modalManagePanelBills: document.getElementById('modal-manage-panel-bills'),
                    modalManagePanelEnvelopes: document.getElementById('modal-manage-panel-envelopes'),
                    
                    // Lists inside Manage Categories Modal
                    modalManageContainerFixed: document.getElementById('modal-manage-container-fixed'),
                    modalManageFixedList: document.getElementById('modal-manage-fixed-list'),
                    modalManageContainerDebtPayment: document.getElementById('modal-manage-container-debt-payment'),
                    modalManageDebtPaymentList: document.getElementById('modal-manage-debt-payment-list'),
                    modalManageContainerSinkingBill: document.getElementById('modal-manage-container-sinking-bill'),
                    modalManageSinkingBillList: document.getElementById('modal-manage-sinking-bill-list'),
                    modalManageContainerVariable: document.getElementById('modal-manage-container-variable'),
                    modalManageVariableList: document.getElementById('modal-manage-variable-list'),
                    modalManageContainerSinkingGoal: document.getElementById('modal-manage-container-sinking-goal'),
                    modalManageSinkingGoalList: document.getElementById('modal-manage-sinking-goal-list'),
                    modalManageContainerDebtGoal: document.getElementById('modal-manage-container-debt-goal'),
                    modalManageDebtGoalList: document.getElementById('modal-manage-debt-goal-list'),
                    
                    currencySelectSettings: document.getElementById('currency-select-settings'),
                    languageSelect: document.getElementById('language-select'),
                    goToHelpButton: document.getElementById('go-to-help-button'),
                    resetAppButton: document.getElementById('reset-app-button'),

                    // Modals & Toast
                    addTransactionModal: document.getElementById('add-transaction-modal'), // This is now the main modal
                    cancelAddTransactionButton: document.getElementById('cancel-add-transaction-button'), // This is the 'X' cancel button
                    modalTxTabExpense: document.getElementById('modal-tx-tab-expense'), // NEW Tab
                    modalTxTabIncome: document.getElementById('modal-tx-tab-income'), // NEW Tab

                    addExpenseButton: document.getElementById('add-expense-button'), // The main '+' button
                    
                    // Forms (now inside the main modal)
                    expenseFormContainer: document.getElementById('expense-form-container'), // NEW
                    addExpenseForm: document.getElementById('add-expense-form'),
                    expenseCategory: document.getElementById('expense-category'),
                    expenseAmount: document.getElementById('expense-amount'),
                    expenseDate: document.getElementById('expense-date'),
                    expenseNotes: document.getElementById('expense-notes'),
                    
                    incomeFormContainer: document.getElementById('income-form-container'), // NEW
                    addIncomeForm: document.getElementById('add-income-form'),
                    incomeSource: document.getElementById('income-source'),
                    incomeAmount: document.getElementById('income-amount'),
                    
                    editIncomeModal: document.getElementById('edit-income-modal'),
                    editIncomeForm: document.getElementById('edit-income-form'),
                    cancelEditIncomeButton: document.getElementById('cancel-edit-income-button'),
                    editIncomeId: document.getElementById('edit-income-id'),
                    editIncomeSource: document.getElementById('edit-income-source'),
                    editIncomeAmount: document.getElementById('edit-income-amount'),
                    confirmResetModal: document.getElementById('confirm-reset-modal'),
                    cancelResetButton: document.getElementById('cancel-reset-button'),
                    confirmResetButton: document.getElementById('confirm-reset-button'),
                    
                    editCategoryModal: document.getElementById('edit-category-modal'),
                    editCategoryForm: document.getElementById('edit-category-form'),
                    cancelEditCategoryButton: document.getElementById('cancel-edit-category-button'),
                    editCategoryId: document.getElementById('edit-category-id'),
                    editCategoryType: document.getElementById('edit-category-type'),
                    editCategoryName: document.getElementById('edit-category-name'),
                    editCategoryAmount: document.getElementById('edit-category-amount'),
                    editCategoryGoalAmountGroup: document.getElementById('edit-category-goal-amount-group'),
                    editCategoryGoalAmount: document.getElementById('edit-category-goal-amount'),
                    
                    toast: document.getElementById('toast'),
                    toastMessage: document.getElementById('toast-message'),

                    // Stats Page
                    statsTotalCoins: document.getElementById('stats-total-coins'),
                    statsHistoryList: document.getElementById('stats-history-list'),
                    statsHistoryEmpty: document.getElementById('stats-history-empty'),

                    // Transaction History Modal
                    txHistoryModal: document.getElementById('transaction-history-modal'),
                    txHistoryView: document.getElementById('tx-history-view'),
                    txEditView: document.getElementById('tx-edit-view'),
                    txHistoryTitle: document.getElementById('tx-history-title'),
                    txHistoryCloseBtn: document.getElementById('tx-history-close-btn'),
                    txHistoryList: document.getElementById('tx-history-list'),
                    txHistoryEmpty: document.getElementById('tx-history-empty'),
                    editTxForm: document.getElementById('edit-transaction-form'),
                    editTxId: document.getElementById('edit-tx-id'),
                    editTxDate: document.getElementById('edit-tx-date'),
                    editTxAmount: document.getElementById('edit-tx-amount'),
                    editTxNotes: document.getElementById('edit-tx-notes'),
                    editTxCancel: document.getElementById('edit-tx-cancel'),
                    editTxDelete: document.getElementById('edit-tx-delete'),

                    // NEW: App Settings Modal
                    showSettingsModalBtn: document.getElementById('show-settings-modal-btn'),
                    appSettingsModal: document.getElementById('app-settings-modal'),
                    cancelSettingsButton: document.getElementById('cancel-settings-button'),
                    
                    // NEW: PWA Install
                    installPwaSection: document.getElementById('install-pwa-section'),
                    installPwaButton: document.getElementById('install-pwa-button'),
                };
            },

            /**
             * Runs data migration for v3 (populating envelopes)
             */
            async runV3DataMigration() {
                const migrationDone = await dbStore.getSetting('migrationV3Done');
                if (migrationDone) {
                    return; // Already done
                }
                
                console.log("Running V3 data migration...");
                
                const categories = this.categories;
                const budget = this.budget;
                const envelopes = [];
                
                const budgetMap = new Map(budget.map(b => [b.id, b.amount]));

                categories.forEach(cat => {
                    if (cat.type === 'variable') {
                        envelopes.push({ categoryId: cat.id, type: 'variable', balance: 0 });
                    } else if (cat.type === 'sinking-goal') {
                        const saved = budgetMap.get(`sinking-goal-${cat.id}`) || 0;
                        envelopes.push({ categoryId: cat.id, type: 'sinking-goal', balance: saved });
                    } else if (cat.type === 'debt-goal') {
                        const saved = budgetMap.get(`debt-goal-${cat.id}`) || 0;
                        envelopes.push({ categoryId: cat.id, type: 'debt-goal', balance: saved });
                    }
                });

                if (envelopes.length > 0) {
                    await dbStore.saveEnvelopes(envelopes);
                    this.envelopes = await dbStore.getEnvelopes();
                }

                await dbStore.saveSetting('migrationV3Done', true);
                console.log("V3 data migration complete.");
            },

            /**
             * Attach listeners for onboarding
             */
            attachOnboardingListeners() {
                // Step 1: Language
                this.dom.onboardingLangEn.addEventListener('click', () => this.selectOnboardingLang('en'));
                this.dom.onboardingLangDe.addEventListener('click', () => this.selectOnboardingLang('de'));


                // Step 2: Currency
                this.dom.onboardingNextStep1.addEventListener('click', () => {
                    const selectedOption = this.dom.currencySelect.options[this.dom.currencySelect.selectedIndex];
                    const currency = selectedOption.value;
                    const currencySymbol = selectedOption.dataset.symbol;
                    const locale = selectedOption.dataset.locale;
                    const digits = selectedOption.dataset.digits;
                    i18n.setCurrency(currency, currencySymbol, locale, digits);
                    this.dom.onboardingStep1.classList.remove('active');
                    this.dom.onboardingStep2.classList.add('active');
                });
                this.dom.onboardingBackToLang.addEventListener('click', () => {
                    this.dom.onboardingStep1.classList.remove('active');
                    this.dom.onboardingStepLanguage.classList.add('active');
                });

                // Step 3: Template
                this.dom.onboardingUseTemplate.addEventListener('click', async () => {
                    // 1. Load template categories & settings
                    await dbStore.loadTemplateData();
                    
                    // 2. Fetch the categories we just loaded
                    const templateCategories = await dbStore.getCategories();
                    
                    const newBudgetItems = [];
                    const newEnvelopes = [];

                    templateCategories.forEach(cat => {
                        // 3. Create budget items for categories with a default amount
                        if (cat.amount > 0 && (cat.type === 'variable' || cat.type === 'sinking-goal' || cat.type === 'debt-goal')) {
                            newBudgetItems.push({
                                id: `${cat.type}-${cat.id}`,
                                categoryId: cat.id,
                                type: cat.type,
                                amount: cat.amount
                            });
                        }
                        
                        // 4. Create initial envelope balances
                        if (cat.type === 'variable') {
                            newEnvelopes.push({ categoryId: cat.id, type: 'variable', balance: 0 });
                        } else if (cat.type === 'sinking-goal') {
                            // Goals start with their first month's contribution
                            const initialBalance = (cat.amount > 0) ? cat.amount : 0;
                            newEnvelopes.push({ categoryId: cat.id, type: 'sinking-goal', balance: initialBalance });
                        } else if (cat.type === 'debt-goal') {
                            // Goals start with their first month's contribution
                            const initialBalance = (cat.amount > 0) ? cat.amount : 0;
                            newEnvelopes.push({ categoryId: cat.id, type: 'debt-goal', balance: initialBalance });
                        }
                    });

                    // 5. Save the new budget and envelope data
                    if (newBudgetItems.length > 0) {
                        await dbStore.saveBudget(newBudgetItems);
                    }
                    if (newEnvelopes.length > 0) {
                        await dbStore.saveEnvelopes(newEnvelopes);
                    }

                    // 6. Complete onboarding
                    await this.completeOnboarding();
                });

                this.dom.onboardingStartFresh.addEventListener('click', async () => {
                    await this.completeOnboarding();
                });
                this.dom.onboardingBackToCurrency.addEventListener('click', () => {
                    this.dom.onboardingStep2.classList.remove('active');
                    this.dom.onboardingStep1.classList.add('active');
                });

                this.dom.onboardingGoToHelp.addEventListener('click', () => {
                    this.dom.onboardingStep2.classList.remove('active');
                    this.dom.onboardingStepHelp.classList.add('active');
                });
                
                this.dom.onboardingHelpBack.addEventListener('click', () => {
                    this.dom.onboardingStepHelp.classList.remove('active');
                    this.dom.onboardingStep2.classList.add('active');
                });
            },

            /**
             * Attach all application event listeners
             */
            attachListeners() {
                // Navigation
                this.dom.navDashboard.addEventListener('click', () => this.navigateTo('dashboard-page'));
                this.dom.navManage.addEventListener('click', () => this.navigateTo('manage-page')); // NEW
                this.dom.navStats.addEventListener('click', () => this.navigateTo('stats-page'));
                this.dom.navStore.addEventListener('click', () => this.navigateTo('store-page')); // NEW
                
                // --- Auto-save Listeners ---
                // Debounce saves to 500ms after last input
                this.debouncedAutoSaveSalary = this.debounce(this.onAutoSaveSalary.bind(this), 500);
                this.debouncedAutoSaveBudget = this.debounce(this.onAutoSaveBudget.bind(this), 500);

                // NEW: Add Transaction (Unified Tabbed Modal)
                this.dom.addExpenseButton.addEventListener('click', () => this.showAddTransactionModal());
                this.dom.cancelAddTransactionButton.addEventListener('click', () => this.hideAddTransactionModal());

                // NEW: Tab Listeners
                this.dom.modalTxTabExpense.addEventListener('click', () => this.switchTransactionTab('expense'));
                this.dom.modalTxTabIncome.addEventListener('click', () => this.switchTransactionTab('income'));

                // Form Listeners (no change, but for context)
                this.dom.addExpenseForm.addEventListener('submit', (e) => this.onAddExpense(e));
                this.dom.addIncomeForm.addEventListener('submit', (e) => this.onAddIncome(e));

                // Edit Income (no change, but for context)

                // Edit Income
                this.dom.cancelEditIncomeButton.addEventListener('click', () => this.hideEditIncomeModal());
                this.dom.editIncomeForm.addEventListener('submit', (e) => this.onUpdateIncome(e));

                // Manage Page (Settings)
                this.dom.salaryInput.addEventListener('input', () => {
                    this.dom.autoSaveStatus.textContent = "Saving..."; // Show immediate feedback
                    this.debouncedAutoSaveSalary();
                });
                this.dom.addCategoryForm.addEventListener('submit', (e) => this.onAddCategory(e));
                this.dom.languageSelect.addEventListener('change', (e) => this.onChangeLanguage(e));
                this.dom.currencySelectSettings.addEventListener('change', (e) => this.onChangeCurrency(e));
                this.dom.categoryType.addEventListener('change', () => this.toggleGoalAmountField('add'));
                this.dom.resetAppButton.addEventListener('click', () => this.showResetModal());
                this.dom.goToHelpButton.addEventListener('click', () => {
                    this.hideSettingsModal(); // Close the modal
                    this.navigateTo('help-page'); // Navigate to the help page
                });

                // Edit Category Modal Listeners
                this.dom.cancelEditCategoryButton.addEventListener('click', () => this.hideEditCategoryModal());
                this.dom.editCategoryForm.addEventListener('submit', (e) => this.onUpdateCategory(e));
                this.dom.editCategoryType.addEventListener('change', () => this.toggleGoalAmountField('edit'));

                // NEW: Manage Categories Modal
                this.dom.manageCategoriesButton.addEventListener('click', () => this.showManageCategoriesModal());
                this.dom.cancelManageCategoriesButton.addEventListener('click', () => this.hideManageCategoriesModal());
                this.dom.modalManageTabBills.addEventListener('click', () => this.handleManageCategoriesTabClick('bills'));
                this.dom.modalManageTabEnvelopes.addEventListener('click', () => this.handleManageCategoriesTabClick('envelopes'));

                // NEW: Manage Page (Category Lists - Re-pointed to Modal)
                this.dom.modalManageFixedList.addEventListener('click', (e) => this.handleCategoryListClick(e));
                this.dom.modalManageDebtPaymentList.addEventListener('click', (e) => this.handleCategoryListClick(e));
                this.dom.modalManageSinkingBillList.addEventListener('click', (e) => this.handleCategoryListClick(e));
                this.dom.modalManageVariableList.addEventListener('click', (e) => this.handleCategoryListClick(e));
                this.dom.modalManageSinkingGoalList.addEventListener('click', (e) => this.handleCategoryListClick(e));
                this.dom.modalManageDebtGoalList.addEventListener('click', (e) => this.handleCategoryListClick(e));

                // Manage Page (Budget Form)
                // this.dom.budgetForm.addEventListener('submit', (e) => this.onSaveBudget(e)); // Removed for auto-save
                this.dom.otherIncomeList.addEventListener('click', (e) => this.handleIncomeListClick(e));
                
                const budgetInputHandler = () => {
                    this.updateBudgetSummary(); // Update UI immediately
                    this.debouncedAutoSaveBudget(); // Trigger debounced save
                };

                this.dom.budgetVariableList.addEventListener('input', budgetInputHandler);
                this.dom.budgetSinkingFundList.addEventListener('input', budgetInputHandler);
                this.dom.budgetDebtGoalList.addEventListener('input', budgetInputHandler);

                // Reset Modal
                this.dom.cancelResetButton.addEventListener('click', () => this.hideResetModal());
                this.dom.confirmResetButton.addEventListener('click', () => this.onConfirmReset());

                // NEW: App Settings Modal
                this.dom.showSettingsModalBtn.addEventListener('click', () => this.showSettingsModal());
                this.dom.cancelSettingsButton.addEventListener('click', () => this.hideSettingsModal());

                // NEW: PWA Install Button
                this.dom.installPwaButton.addEventListener('click', () => this.onInstallPwa());

                // Transaction History Modal
                this.dom.variableEnvelopesList.addEventListener('click', (e) => this.handleEnvelopeClick(e));
                this.dom.txHistoryCloseBtn.addEventListener('click', () => this.hideTransactionHistory());
                this.dom.txHistoryList.addEventListener('click', (e) => this.handleTransactionClick(e));
                this.dom.editTxForm.addEventListener('submit', (e) => this.onUpdateTransaction(e));
                this.dom.editTxCancel.addEventListener('click', () => this.showTxHistoryList());
                this.dom.editTxDelete.addEventListener('click', () => this.onDeleteTransaction());
            },

            // --- Data Loading & State Management ---

            /**
             * Load all data from DB and refresh the UI
             */
            async loadDataAndRender() {
                // Get current month
                const currentMonth = this.getCurrentMonthString();

                // Load settings (lang, currency) from DB
                const [salary, lastMonthRollover, lastMonthBudget, categories, budget, transactions, otherIncome, envelopes, bunnyCoins] = await Promise.all([
                    dbStore.getSetting('salary'),
                    dbStore.getSetting('lastMonthRollover'),
                    dbStore.getSetting('lastMonthBudget'),
                    dbStore.getCategories(),
                    dbStore.getBudget(),
                    dbStore.getTransactions(),
                    dbStore.getOtherIncome(currentMonth),
                    dbStore.getEnvelopes(),
                    dbStore.getBunnyCoins()
                ]);

                // Apply settings
                i18n.setCurrency(
                    i18n.currency,
                    i18n.currencySymbolDisplay,
                    await dbStore.getSetting('formattingLocale') || i18n.formattingLocale,
                    await dbStore.getSetting('fractionDigits') || i18n.fractionDigits
                );

                this.dom.currencySelectSettings.value = i18n.currency;

                // Store state
                this.salary = salary || 0;
                this.categories = categories || [];
                this.budget = budget || [];
                this.transactions = transactions || [];
                this.otherIncome = otherIncome || [];
                this.envelopes = envelopes || [];
                this.bunnyCoins = bunnyCoins || [];
                this.lastMonthRollover = lastMonthRollover || 0;
                this.lastMonthBudget = lastMonthBudget || [];

                // Update UI based on loaded data
                this.dom.salaryInput.value = this.salary;

                // Render all parts of the app
                this.renderAllPages();
            },

            /**
             * Check if a new month has started. If so, run rollover logic.
             */
            async checkForNewMonth() {
                const now = new Date();
                const currentMonth = now.getMonth();
                const lastMonth = await dbStore.getSetting('lastMonth');

                if (lastMonth === null || currentMonth === lastMonth) {
                    return; // Not a new month, or first run.
                }

                console.log("New month detected! Running rollover logic...");

                // --- 1. Calculate Balances & Rollover ---
                const spentPerCategory = this.transactions.reduce((acc, tx) => {
                    acc[tx.categoryId] = (acc[tx.categoryId] || 0) + tx.amount;
                    return acc;
                }, {});

                const budgetMap = new Map(this.budget.map(b => [b.id, b.amount]));
                const envelopeMap = new Map(this.envelopes.map(e => [e.categoryId, e]));
                const envelopesToUpdate = [];
                let totalVariableRollover = 0;
                
                const calculations = this.calculateBudget(); // Get totals for the month *ending*
                const totalAssigned = this.budget.reduce((sum, b) => sum + b.amount, 0);
                let unassignedMoney = calculations.moneyToBudget - totalAssigned;
                if (unassignedMoney < 0) unassignedMoney = 0;

                // 1b. Calculate Unspent (Rollover) from Envelopes
                for (const cat of this.categories) {
                    let envelope = envelopeMap.get(cat.id);
                    if (!envelope && (cat.type === 'variable' || cat.type === 'sinking-goal' || cat.type === 'debt-goal')) {
                        envelope = { categoryId: cat.id, type: cat.type, balance: 0 };
                    }
                    if (!envelope) continue; 

                    const budgetedThisMonth = budgetMap.get(`${cat.type}-${cat.id}`) || 0;
                    
                    if (cat.type === 'variable') {
                        const spent = spentPerCategory[cat.id] || 0;
                        const startingBalance = envelope.balance || 0;
                        const rollover = (startingBalance + budgetedThisMonth) - spent;
                        
                        if (rollover > 0) {
                            totalVariableRollover += rollover;
                        }
                        envelope.balance = 0; 
                        envelopesToUpdate.push(envelope);

                    } else if (cat.type === 'sinking-goal' || cat.type === 'debt-goal') {
                        // Sinking/Debt goals balances are already updated by onSaveBudget
                        // No action needed here, their balance persists
                    }
                }

                // --- 2. Calculate and Save Bunny Coins & Rollover Savings ---
                let coinToastMessage = "";

                // 1c. Combine Unspent + Unassigned
                const finalTotalRollover = totalVariableRollover + unassignedMoney;
                
                if (finalTotalRollover > 0) {
                    const oldRollover = await dbStore.getSetting('lastMonthRollover') || 0;
                    const newTotalRollover = oldRollover + finalTotalRollover;
                    await dbStore.saveSetting('lastMonthRollover', newTotalRollover);
                    this.lastMonthRollover = newTotalRollover; // Update state
                }

                const newCoins = Math.floor(finalTotalRollover / 10); // 1 coin per ‚Ç¨10
                if (newCoins > 0) {
                    const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const lastMonthString = `${lastMonthDate.getFullYear()}-${(lastMonthDate.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    await dbStore.saveBunnyCoins({
                        month: lastMonthString,
                        coins: newCoins,
                        rollover: finalTotalRollover
                    });
                    coinToastMessage = ` You earned ${newCoins} ü™ô!`;
                }

                // --- 3. Save New Balances & Clear Monthly Data ---
                if (envelopesToUpdate.length > 0) {
                    await dbStore.saveEnvelopes(envelopesToUpdate);
                }

                await dbStore.saveSetting('lastMonthBudget', this.budget);
                
                await dbStore.clearTransactions();
                await dbStore.clearBudget();
                
                // --- 4. Update Local State & UI ---
                this.transactions = [];
                this.budget = [];
                const newMonthString = this.getCurrentMonthString();
                this.otherIncome = await dbStore.getOtherIncome(newMonthString);
                this.envelopes = await dbStore.getEnvelopes();
                this.bunnyCoins = await dbStore.getBunnyCoins();
                
                await dbStore.saveSetting('lastMonth', currentMonth);

                // --- 5. Re-render and Notify ---
                this.renderAllPages();
                this.showToast(`${i18n.t('toastNewMonth')}${coinToastMessage}`);
            },


            /**
             * Render the total Bunny Coins in the header
             */
            renderBunnyCoins() {
                const totalCoins = this.bunnyCoins.reduce((sum, entry) => sum + entry.coins, 0);
                this.dom.bunnyCoinTotal.textContent = totalCoins;
            },

            /**
             * Re-renders all dynamic page content
             */
            renderAllPages() {
                this.renderDashboard();
                this.renderManagePage(); // MODIFIED
                this.renderBunnyCoins();
                this.renderStatsPage(); // ADDED
            },

            /**
             * NEW: Handle clicks on the Setup Card tabs
             */
            handleManageCategoriesTabClick(tab) {
                // Deactivate all
                this.dom.modalManageTabBills.classList.remove('active', 'border-pink-500', 'text-pink-600');
                this.dom.modalManageTabBills.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                this.dom.modalManageTabEnvelopes.classList.remove('active', 'border-pink-500', 'text-pink-600');
                this.dom.modalManageTabEnvelopes.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                
                this.dom.modalManagePanelBills.classList.add('hidden');
                this.dom.modalManagePanelEnvelopes.classList.add('hidden');

                // Activate target
                if (tab === 'bills') {
                    this.dom.modalManageTabBills.classList.add('active', 'border-pink-500', 'text-pink-600');
                    this.dom.modalManageTabBills.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    this.dom.modalManagePanelBills.classList.remove('hidden');
                } else if (tab === 'envelopes') {
                    this.dom.modalManageTabEnvelopes.classList.add('active', 'border-pink-500', 'text-pink-600');
                    this.dom.modalManageTabEnvelopes.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    this.dom.modalManagePanelEnvelopes.classList.remove('hidden');
                }
            },

            // --- Page Rendering ---

            /**
             * Render the Dashboard
             */
            renderDashboard() {
                const calculations = this.calculateBudget();
                this.dom.dashboardMoneyToBudget.textContent = this.formatCurrency(calculations.moneyToBudget);
                this.dom.dashboardTotalBudgeted.textContent = this.formatCurrency(calculations.totalBudgeted);

                // Render Variable Envelopes
                this.dom.variableEnvelopesList.innerHTML = '';
                const variableCategories = this.categories.filter(c => c.type === 'variable');
                let totalSpent = 0;
                let hasVariable = false;

                variableCategories.forEach(cat => {
                    const budgetItem = this.budget.find(b => b.id === `variable-${cat.id}`);
                    const budgetedThisMonth = budgetItem ? budgetItem.amount : 0;
                    const totalAvailable = budgetedThisMonth;

                    if (!budgetItem) return; 
                    
                    hasVariable = true;
                    const spent = calculations.spentPerCategory[cat.id] || 0;
                    totalSpent += spent;
                    const remaining = totalAvailable - spent;
                    const progressValue = Math.min(spent, totalAvailable); 

                    const card = `
                <div class="bg-white p-4 rounded-2xl shadow hover:shadow-md transition-shadow cursor-pointer" data-category-id="${cat.id}" data-category-name="${cat.name}">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-lg text-gray-800">${cat.name}</span>
                        <div class="text-right">
                            <span class="font-bold text-lg ${remaining < 0 ? 'text-red-500' : 'text-gray-800'}">${this.formatCurrency(remaining)}</span>
                            <span class="text-xs text-gray-400 block">${i18n.t('dashboardRemaining')}</span>
                        </div>
                    </div>
                    <progress class="w-full" value="${progressValue}" max="${totalAvailable}"></progress>
                    <div class="flex justify-between items-center text-sm text-gray-500 mt-2">
                        <span>${i18n.t('dashboardSpent')}: ${this.formatCurrency(spent)}</span>
                        <span>${i18n.t('dashboardBudgeted')}: ${this.formatCurrency(totalAvailable)}</span>
                    </div>
                </div>
            `;
                    this.dom.variableEnvelopesList.insertAdjacentHTML('beforeend', card);
                });

                this.dom.variableEnvelopesEmpty.classList.toggle('hidden', !(variableCategories.length === 0));
                if (hasVariable) this.dom.variableEnvelopesEmpty.classList.add('hidden');

                this.dom.dashboardTotalSpent.textContent = this.formatCurrency(totalSpent);

                // Render Sinking Fund Goals
                this.dom.sinkingFundGoalsList.innerHTML = '';
                const sinkingGoalCategories = this.categories.filter(c => c.type === 'sinking-goal');
                let hasSinkingGoals = false;

                sinkingGoalCategories.forEach(cat => {
                    hasSinkingGoals = true;
                    const envelope = this.envelopes.find(e => e.categoryId === cat.id);
                    const totalSaved = envelope ? envelope.balance : 0;
                    const goalAmount = cat.goalAmount || 0;

                    let progressHTML = '';
                    let savedText = this.formatCurrency(totalSaved);

                    if (goalAmount > 0) {
                        const progressValue = Math.min(totalSaved, goalAmount);
                        savedText = `${this.formatCurrency(totalSaved)} / ${this.formatCurrency(goalAmount)}`;
                        progressHTML = `<progress class="w-full mt-2" value="${progressValue}" max="${goalAmount}"></progress>`;
                    }

                    const card = `
                <div class="bg-white p-4 rounded-2xl shadow">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-lg text-gray-800">${cat.name}</span>
                        <span class="font-bold text-green-600 text-right">${savedText}</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">${i18n.t('dashboardTotalSaved')}</p>
                    ${progressHTML}
                </div>
            `;
                    this.dom.sinkingFundGoalsList.insertAdjacentHTML('beforeend', card);
                });
                this.dom.sinkingFundGoalsEmpty.classList.toggle('hidden', hasSinkingGoals);
                // NEW: Show/hide the entire section container
                this.dom.sinkingFundsContainer.classList.toggle('hidden', !hasSinkingGoals);
                
                // Render Debt Paydown Goals
                this.dom.debtGoalDashboardList.innerHTML = '';
                const debtGoalCategories = this.categories.filter(c => c.type === 'debt-goal');
                let hasDebtGoals = false;

                debtGoalCategories.forEach(cat => {
                    hasDebtGoals = true;
                    const envelope = this.envelopes.find(e => e.categoryId === cat.id);
                    const totalSaved = envelope ? envelope.balance : 0;

                    const card = `
                <div class="bg-white p-4 rounded-2xl shadow">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-lg text-gray-800">${cat.name}</span>
                        <span class="font-bold text-green-600">${this.formatCurrency(totalSaved)}</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">${i18n.t('dashboardTotalSaved')}</p>
                </div>
            `;
                    this.dom.debtGoalDashboardList.insertAdjacentHTML('beforeend', card);
                });
                this.dom.debtGoalDashboardEmpty.classList.toggle('hidden', hasDebtGoals);
                // NEW: Show/hide the entire section container
                this.dom.debtGoalsContainer.classList.toggle('hidden', !hasDebtGoals);
            },

            /**
             * NEW: Render the new unified Manage Page
             */
            renderManagePage() {
                // This function now renders all dynamic parts of the Manage page
                
                // --- Part 1: Render the Summary Card ---
                const calculations = this.calculateBudget();
                const lastMonthBudgetMap = new Map((this.lastMonthBudget || []).map(b => [b.id, b.amount]));

                this.dom.budgetSummarySalary.textContent = this.formatCurrency(this.salary);
                this.dom.budgetSummaryOtherIncome.textContent = this.formatCurrency(calculations.otherIncomeTotal);
                this.dom.budgetSummaryRollover.textContent = this.formatCurrency(this.lastMonthRollover);
                this.dom.budgetSummaryTotalIncome.textContent = this.formatCurrency(calculations.totalIncome);
                this.dom.budgetSummaryFixedCosts.textContent = `-${this.formatCurrency(calculations.totalFixed)}`;
                this.dom.budgetMoneyToBudget.textContent = this.formatCurrency(calculations.moneyToBudget);

                // --- Part 2: Render the Other Income list (MOVED HERE) ---
                // This code was causing the crash because it was in the wrong function!
                this.dom.otherIncomeList.innerHTML = '';
                this.dom.otherIncomeEmpty.classList.toggle('hidden', this.otherIncome.length > 0);
                const iconDelete = document.getElementById('icon-delete').outerHTML;
                const iconEdit = document.getElementById('icon-edit').outerHTML;
                
                this.otherIncome.forEach(income => {
                    const item = `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <span class="font-medium text-gray-800">${income.source}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-medium text-green-600">${this.formatCurrency(income.amount)}</span>
                                <button class="edit-income-btn p-2 text-gray-400 hover:text-blue-500" data-id="${income.id}">
                                    ${iconEdit}
                                </button>
                                <button class="delete-income-btn p-2 text-gray-400 hover:text-red-500" data-id="${income.id}">
                                    ${iconDelete}
                                </button>
                            </div>
                        </div>
                    `;
                    this.dom.otherIncomeList.insertAdjacentHTML('beforeend', item);
                });

                // --- Part 3: Render the Assign Money Card ---
                this.dom.budgetVariableList.innerHTML = '';
                const variableCategories = this.categories.filter(c => c.type === 'variable');
                this.dom.budgetVariableEmpty.classList.toggle('hidden', variableCategories.length > 0);

                variableCategories.forEach(cat => {
                    const budgetItem = this.budget.find(b => b.id === `variable-${cat.id}`);
                    const amount = budgetItem ? budgetItem.amount : (cat.amount || '');
                    const placeholder = cat.amount || '0.00';
                    const lastMonthAmount = lastMonthBudgetMap.get(`variable-${cat.id}`) || 0;
                    const lastMonthHTML = lastMonthAmount > 0 ?
                        `<p class="text-sm text-gray-500">${i18n.t('budgetLastMonth')}: ${this.formatCurrency(lastMonthAmount)}</p>` :
                        '';

                    const card = `
                <div class="bg-white p-4 rounded-2xl shadow flex items-center space-x-3">
                    <div class="flex-1">
                        <label for="budget-variable-${cat.id}" class="font-medium text-gray-700">${cat.name}</label>
                        ${lastMonthHTML}
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-xl font-medium text-gray-500">${i18n.currency}</span>
                        <input type="number" id="budget-variable-${cat.id}"
                               data-id="${cat.id}" data-type="variable"
                               class="budget-input w-32 p-2 border border-gray-300 rounded-lg text-right text-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                               placeholder="${placeholder}" step="0.01" min="0" value="${amount}">
                    </div>
                </div>
            `;
                    this.dom.budgetVariableList.insertAdjacentHTML('beforeend', card);
                });

                // Render Sinking Fund Goal Inputs
                this.dom.budgetSinkingFundList.innerHTML = '';
                const sinkingGoalCategories = this.categories.filter(c => c.type === 'sinking-goal');
                this.dom.budgetSinkingFundEmpty.classList.toggle('hidden', sinkingGoalCategories.length > 0);

                sinkingGoalCategories.forEach(cat => {
                    const budgetItem = this.budget.find(b => b.id === `sinking-goal-${cat.id}`);
                    const amount = budgetItem ? budgetItem.amount : (cat.amount || '');
                    const placeholder = cat.amount || '0.00';
                    const lastMonthAmount = lastMonthBudgetMap.get(`sinking-goal-${cat.id}`) || 0;
                    const lastMonthHTML = lastMonthAmount > 0 ?
                        `<p class="text-sm text-gray-500">${i18n.t('budgetLastMonth')}: ${this.formatCurrency(lastMonthAmount)}</p>` :
                        '';

                    const card = `
                <div class="bg-white p-4 rounded-2xl shadow flex items-center space-x-3">
                    <div class="flex-1">
                        <label for="budget-sinking-goal-${cat.id}" class="font-medium text-gray-700">${cat.name}</label>
                        ${lastMonthHTML}
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-xl font-medium text-gray-500">${i18n.currency}</span>
                        <input type="number" id="budget-sinking-goal-${cat.id}"
                               data-id="${cat.id}" data-type="sinking-goal"
                               class="budget-input w-32 p-2 border border-gray-300 rounded-lg text-right text-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                               placeholder="${placeholder}" step="0.01" min="0" value="${amount}">
                    </div>
                </div>
            `;
                    this.dom.budgetSinkingFundList.insertAdjacentHTML('beforeend', card);
                });

                // Render Debt Paydown Goal Inputs
                this.dom.budgetDebtGoalList.innerHTML = '';
                const debtGoalCategories = this.categories.filter(c => c.type === 'debt-goal');
                this.dom.budgetDebtGoalEmpty.classList.toggle('hidden', debtGoalCategories.length > 0);

                debtGoalCategories.forEach(cat => {
                    const budgetItem = this.budget.find(b => b.id === `debt-goal-${cat.id}`);
                    const amount = budgetItem ? budgetItem.amount : (cat.amount || '');
                    const placeholder = cat.amount || '0.00';
                    const lastMonthAmount = lastMonthBudgetMap.get(`debt-goal-${cat.id}`) || 0;
                    const lastMonthHTML = lastMonthAmount > 0 ?
                        `<p class="text-sm text-gray-500">${i18n.t('budgetLastMonth')}: ${this.formatCurrency(lastMonthAmount)}</p>` :
                        '';

                    const card = `
                <div class="bg-white p-4 rounded-2xl shadow flex items-center space-x-3">
                    <div class="flex-1">
                        <label for="budget-debt-goal-${cat.id}" class="font-medium text-gray-700">${cat.name}</label>
                        ${lastMonthHTML}
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-xl font-medium text-gray-500">${i18n.currency}</span>
                        <input type="number" id="budget-debt-goal-${cat.id}"
                               data-id="${cat.id}" data-type="debt-goal"
                               class="budget-input w-32 p-2 border border-gray-300 rounded-lg text-right text-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                               placeholder="${placeholder}" step="0.01" min="0" value="${amount}">
                    </div>
                </div>
            `;
                    this.dom.budgetDebtGoalList.insertAdjacentHTML('beforeend', card);
                });

                this.updateBudgetSummary();
            },

            

            /**
             * NEW: Show the Manage Categories Modal
             */
            showManageCategoriesModal() {
                this.renderManageCategoriesModal(); // Render lists just before showing
                this.dom.manageCategoriesModal.classList.remove('hidden');
                this.dom.manageCategoriesModal.classList.add('flex');
                // Fix z-index issue with other modals
                this.dom.appSettingsModal.style.zIndex = 30; 
            },

            /**
             * NEW: Hide the Manage Categories Modal
             */
            hideManageCategoriesModal() {
                this.dom.manageCategoriesModal.classList.add('hidden');
                this.dom.manageCategoriesModal.classList.remove('flex');
                // Restore z-index
                this.dom.appSettingsModal.style.zIndex = 40;
            },

            /**
             * NEW: Render the Manage Categories Modal
             */
            renderManageCategoriesModal() {
                // Clear all lists
                this.dom.modalManageFixedList.innerHTML = '';
                this.dom.modalManageDebtPaymentList.innerHTML = '';
                this.dom.modalManageSinkingBillList.innerHTML = '';
                this.dom.modalManageVariableList.innerHTML = '';
                this.dom.modalManageSinkingGoalList.innerHTML = '';
                this.dom.modalManageDebtGoalList.innerHTML = '';

                // Get icon SVGs
                const iconDelete = document.getElementById('icon-delete').outerHTML;
                const iconEdit = document.getElementById('icon-edit').outerHTML;
                const iconFixed = document.getElementById('icon-fixed').outerHTML;
                const iconDebtPayment = document.getElementById('icon-debt-payment').outerHTML;
                const iconSinkingBill = document.getElementById('icon-sinking-bill').outerHTML;
                const iconVariable = document.getElementById('icon-variable').outerHTML;
                const iconSinkingGoal = document.getElementById('icon-sinking-goal').outerHTML;
                const iconDebtGoal = document.getElementById('icon-debt-goal').outerHTML;

                // Loop through categories and render
                let hasFixed = false, hasDebtPayment = false, hasSinkingBill = false, hasVariable = false, hasSinkingGoal = false, hasDebtGoal = false;

                this.categories.forEach(cat => {
                    let listElement, icon;

                    switch (cat.type) {
                        case 'fixed':
                            listElement = this.dom.modalManageFixedList;
                            icon = iconFixed;
                            hasFixed = true;
                            break;
                        case 'debt-payment':
                            listElement = this.dom.modalManageDebtPaymentList;
                            icon = iconDebtPayment;
                            hasDebtPayment = true;
                            break;
                        case 'sinking-bill':
                            listElement = this.dom.modalManageSinkingBillList;
                            icon = iconSinkingBill;
                            hasSinkingBill = true;
                            break;
                        case 'variable':
                            listElement = this.dom.modalManageVariableList;
                            icon = iconVariable;
                            hasVariable = true;
                            break;
                        case 'sinking-goal':
                            listElement = this.dom.modalManageSinkingGoalList;
                            icon = iconSinkingGoal;
                            hasSinkingGoal = true;
                            break;
                        case 'debt-goal':
                            listElement = this.dom.modalManageDebtGoalList;
                            icon = iconDebtGoal;
                            hasDebtGoal = true;
                            break;
                        default:
                            return;
                    }

                    const formattedAmount = cat.amount ? this.formatCurrency(cat.amount) : i18n.t('noDefaultSet') || 'No default';
                    const item = `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <span class="text-gray-400">${icon}</span>
                        <div>
                            <span class="font-medium text-gray-800">${cat.name}</span>
                            <span class="block text-sm text-gray-500">${formattedAmount}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button class="edit-category-btn p-2 text-gray-400 hover:text-blue-500" data-id="${cat.id}">
                            ${iconEdit}
                        </button>
                        <button class="delete-category-btn p-2 text-gray-400 hover:text-red-500" data-id="${cat.id}">
                            ${iconDelete}
                        </button>
                    </div>
                </div>
            `;
                    listElement.insertAdjacentHTML('beforeend', item);
                });

                // --- NEW: Conditional UI ---
                // Show/hide sections based on if they have items
                this.dom.modalManageContainerFixed.classList.toggle('hidden', !hasFixed);
                this.dom.modalManageContainerDebtPayment.classList.toggle('hidden', !hasDebtPayment);
                this.dom.modalManageContainerSinkingBill.classList.toggle('hidden', !hasSinkingBill);
                this.dom.modalManageContainerVariable.classList.toggle('hidden', !hasVariable);
                this.dom.modalManageContainerSinkingGoal.classList.toggle('hidden', !hasSinkingGoal);
                this.dom.modalManageContainerDebtGoal.classList.toggle('hidden', !hasDebtGoal);
            },

            /**
             * Render the Stats Page
             */
            renderStatsPage() {
                const totalCoins = this.bunnyCoins.reduce((sum, entry) => sum + entry.coins, 0);
                this.dom.statsTotalCoins.textContent = `ü™ô ${totalCoins}`;
                
                this.dom.statsHistoryList.innerHTML = '';
                
                if (this.bunnyCoins.length === 0) {
                    this.dom.statsHistoryEmpty.classList.remove('hidden');
                    return;
                }
                
                this.dom.statsHistoryEmpty.classList.add('hidden');
                
                // Sort by month, most recent first
                const sortedHistory = [...this.bunnyCoins].sort((a, b) => b.month.localeCompare(a.month));
                
                sortedHistory.forEach(entry => {
                    // Format month 'YYYY-MM' to 'Month YYYY'
                    const [year, month] = entry.month.split('-');
                    const date = new Date(year, month - 1, 1);
                    const monthName = date.toLocaleString(i18n.lang, { month: 'long', year: 'numeric' });
                    
                    const li = document.createElement('li');
                    li.className = "p-3 bg-gray-50 rounded-lg flex justify-between items-center";
                    li.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800">${monthName}</span>
                            <span class="block text-sm text-gray-500">${entry.coins} ${i18n.t('statsEntry')} ${this.formatCurrency(entry.rollover)}</span>
                        </div>
                        <span class="font-bold text-lg text-pink-600">ü™ô ${entry.coins}</span>
                    `;
                    this.dom.statsHistoryList.appendChild(li);
                });
            },


            // --- Event Handlers ---

            /**
             * Handle navigation
             * @param {string} pageId - The ID of the page to navigate to
             */
            navigateTo(pageId) {
                window.scrollTo(0, 0);
                this.currentPage = pageId;
                // Hide all pages
                this.dom.pages.forEach(page => page.classList.remove('active'));
                // Show target page
                document.getElementById(pageId).classList.add('active');

                // Update nav button active states
                this.dom.navButtons.forEach(btn => btn.classList.remove('active'));
                const navButton = document.getElementById(`nav-${pageId.split('-')[0]}`);
                if (navButton) {
                    navButton.classList.add('active');
                }

                // Refresh page content
                if (pageId === 'dashboard-page') this.renderDashboard();
                if (pageId === 'manage-page') this.renderManagePage(); // Re-point to the new main manage function
                if (pageId === 'stats-page') this.renderStatsPage();
                // No render needed for store or help
            },

            /**
             * NEW: Switches the active tab in the transaction modal
             * @param {string} tabName - 'expense' or 'income'
             */
            switchTransactionTab(tabName) {
                const expenseTab = this.dom.modalTxTabExpense;
                const incomeTab = this.dom.modalTxTabIncome;
                const expenseForm = this.dom.expenseFormContainer;
                const incomeForm = this.dom.incomeFormContainer;

                if (tabName === 'expense') {
                    // Activate Expense Tab
                    expenseTab.classList.add('active', 'border-pink-500', 'text-pink-600');
                    expenseTab.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300');
                    // Deactivate Income Tab
                    incomeTab.classList.remove('active', 'border-pink-500', 'text-pink-600');
                    incomeTab.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300');
                    // Show Expense Form
                    expenseForm.classList.remove('hidden');
                    expenseForm.classList.add('active');
                    incomeForm.classList.add('hidden');
                    incomeForm.classList.remove('active');
                } else if (tabName === 'income') {
                    // Deactivate Expense Tab
                    expenseTab.classList.remove('active', 'border-pink-500', 'text-pink-600');
                    expenseTab.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300');
                    // Activate Income Tab
                    incomeTab.classList.add('active', 'border-pink-500', 'text-pink-600');
                    incomeTab.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300');
                    // Show Income Form
                    expenseForm.classList.add('hidden');
                    expenseForm.classList.remove('active');
                    incomeForm.classList.remove('hidden');
                    incomeForm.classList.add('active');
                }
            },

            /**
             * NEW: Show the Unified Add Transaction modal
             */
            showAddTransactionModal() {
                // Default to expense tab every time
                this.switchTransactionTab('expense');

                // Populate categories (logic from old showAddExpenseModal)
                this.dom.expenseCategory.innerHTML = '';
                const variableCategories = this.categories.filter(c => c.type === 'variable');

                if (variableCategories.length === 0) {
                    this.showToast(i18n.t('dashboardNoVariable'));
                    return;
                }

                variableCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    this.dom.expenseCategory.appendChild(option);
                });

                // Set date to today (logic from old showAddExpenseModal)
                this.dom.expenseDate.valueAsDate = new Date();

                // Show the modal
                this.dom.addTransactionModal.classList.remove('hidden');
                this.dom.addTransactionModal.classList.add('flex');
            },

            /**
             * NEW: Hide the Unified Add Transaction modal
             */
            hideAddTransactionModal() {
                // Reset both forms
                this.dom.addExpenseForm.reset();
                this.dom.addIncomeForm.reset();
                // Hide the modal
                this.dom.addTransactionModal.classList.add('hidden');
                this.dom.addTransactionModal.classList.remove('flex');
            },

            /**
             * NEW: Show the App Settings modal
             */
            showSettingsModal() {
                this.dom.appSettingsModal.classList.remove('hidden');
                this.dom.appSettingsModal.classList.add('flex');
            },

            /**
             * NEW: Hide the App Settings modal
             */
            hideSettingsModal() {
                this.dom.appSettingsModal.classList.add('hidden');
                this.dom.appSettingsModal.classList.remove('flex');
            },

            /**
             * NEW: Catches the PWA install prompt
             */
            onBeforeInstallPrompt(e) {
                // Prevent the mini-infobar from appearing
                e.preventDefault();
                // Stash the event so it can be triggered later.
                this.deferredPwaPrompt = e;
                // Show our custom install button
                this.dom.installPwaSection.classList.remove('hidden');
                console.log("PWA install prompt saved.");
            },
            
            /**
             * NEW: Shows the PWA install prompt when our button is clicked
             */
            async onInstallPwa() {
                if (!this.deferredPwaPrompt) {
                    return;
                }
                // Hide our button
                this.dom.installPwaSection.classList.add('hidden');
                // Show the prompt
                this.deferredPwaPrompt.prompt();
                // Wait for the user to respond to the prompt
                const { outcome } = await this.deferredPwaPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                // We've used the prompt, so clear it
                this.deferredPwaPrompt = null;
            },

            /**
             * Handle Add Expense form submission
             * @param {Event} e - The form event
             */
            async onAddExpense(e) {
                e.preventDefault();
                const categoryId = parseInt(this.dom.expenseCategory.value);
                const amount = parseFloat(this.dom.expenseAmount.value);
                const date = this.dom.expenseDate.value;
                const notes = this.dom.expenseNotes.value;

                if (!categoryId || isNaN(amount) || amount <= 0 || !date) {
                    this.showToast("Invalid amount or date.");
                    return;
                }

                const newTx = { categoryId, amount, date, notes };
                const newId = await dbStore.addTransaction(newTx);
                this.transactions.push({ id: newId, ...newTx }); // Update local state

                this.hideAddTransactionModal(); // UPDATED
                this.showToast(i18n.t('toastExpenseAdded'));

                if (this.currentPage === 'dashboard-page') {
                    this.renderDashboard();
                }
            },
            
            /* (show/hideAddIncomeModal are now deleted) */
            
            /**
             * Handle Add Income form submission
             * @param {Event} e - The form event
             */
            async onAddIncome(e) {
                e.preventDefault();
                const source = this.dom.incomeSource.value;
                const amount = parseFloat(this.dom.incomeAmount.value);
                const month = this.getCurrentMonthString();

                if (!source || isNaN(amount) || amount <= 0) {
                    this.showToast("Invalid source or amount.");
                    return;
                }
                
                const newIncome = { source, amount, month };
                const newId = await dbStore.addOtherIncome(newIncome);
                this.otherIncome.push({ id: newId, ...newIncome }); // Update local state

                this.hideAddTransactionModal(); // UPDATED
                this.showToast(i18n.t('toastIncomeAdded'));

                this.renderManagePage(); // MODIFIED
                if (this.currentPage === 'dashboard-page') {
                    this.renderDashboard();
                }
            },

            /**
             * Show the Edit Income modal
             */
            showEditIncomeModal(id) {
                const income = this.otherIncome.find(item => item.id === id);
                if (!income) return;

                this.dom.editIncomeId.value = income.id;
                this.dom.editIncomeSource.value = income.source;
                this.dom.editIncomeAmount.value = income.amount;
                
                this.dom.editIncomeModal.classList.remove('hidden');
                this.dom.editIncomeModal.classList.add('flex');
            },

            /**
             * Hide the Edit Income modal
             */
            hideEditIncomeModal() {
                this.dom.editIncomeForm.reset();
                this.dom.editIncomeModal.classList.add('hidden');
                this.dom.editIncomeModal.classList.remove('flex');
            },

            /**
             * Handle Edit Income form submission
             * @param {Event} e - The form event
             */
            async onUpdateIncome(e) {
                e.preventDefault();
                const id = parseInt(this.dom.editIncomeId.value);
                const source = this.dom.editIncomeSource.value;
                const amount = parseFloat(this.dom.editIncomeAmount.value);
                const month = this.getCurrentMonthString();

                if (!id || !source || isNaN(amount) || amount <= 0) {
                    this.showToast("Invalid source or amount.");
                    return;
                }
                
                const updatedIncome = { id, source, amount, month };
                
                await dbStore.updateOtherIncome(updatedIncome);
                
                // Update local state
                this.otherIncome = this.otherIncome.map(item => item.id === id ? updatedIncome : item);

                this.hideEditIncomeModal();
                this.showToast(i18n.t('toastIncomeUpdated'));

                this.renderManagePage(); // MODIFIED
                if (this.currentPage === 'dashboard-page') {
                    this.renderDashboard();
                }
            },

            /**
             * Handle clicks on the income list (edit or delete)
             * @param {Event} e - The click event
             */
            async handleIncomeListClick(e) {
                const editButton = e.target.closest('.edit-income-btn');
                if (editButton) {
                    const id = parseInt(editButton.dataset.id);
                    if (id) this.showEditIncomeModal(id);
                    return;
                }
                
                const deleteButton = e.target.closest('.delete-income-btn');
                if (deleteButton) {
                    const id = parseInt(deleteButton.dataset.id);
                    if (isNaN(id)) return;

                    try {
                        await dbStore.deleteOtherIncome(id);
                        this.otherIncome = this.otherIncome.filter(item => item.id !== id);
                        this.showToast(i18n.t('toastIncomeDeleted'));
                        this.renderManagePage(); // MODIFIED
                        if (this.currentPage === 'dashboard-page') {
                            this.renderDashboard();
                        }
                    } catch (err) {
                        console.error("Error deleting income:", err);
                        this.showToast("Error deleting income item.");
                    }
                }
            },


            /**
             * Handle Auto-Save Salary on input
             */
            async onAutoSaveSalary() {
                const newSalary = parseFloat(this.dom.salaryInput.value) || 0;
                this.salary = newSalary;
                await dbStore.saveSetting('salary', newSalary);
                try {
                    localStorage.setItem('bunnyBudgetSalary', newSalary);
                } catch (e) { }

                this.dom.autoSaveStatus.textContent = "Saved!"; // Update feedback
                
                // Re-render the budget section to update summaries
                this.renderBudgetSection();
                // If on dashboard, re-render that too
                if (this.currentPage === 'dashboard-page') {
                    this.renderDashboard();
                }
            },

            /**
             * Show/hide the 'Total Goal' field based on category type
             * @param {string} modalType - 'add' or 'edit'
             */
            toggleGoalAmountField(modalType = 'add') {
                let type, group;
                if (modalType === 'add') {
                    type = this.dom.categoryType.value;
                    group = this.dom.categoryGoalAmountGroup;
                } else {
                    type = this.dom.editCategoryType.value;
                    group = this.dom.editCategoryGoalAmountGroup;
                }
                
                if (type === 'sinking-goal') {
                    group.classList.remove('hidden');
                } else {
                    group.classList.add('hidden');
                }
            },

            /**
             * Handle Add Category form submission
             * @param {Event} e - The form event
             */
            async onAddCategory(e) {
                e.preventDefault();
                const name = this.dom.categoryName.value;
                const type = this.dom.categoryType.value;
                const amount = parseFloat(this.dom.categoryAmount.value) || 0;
                const goalAmount = parseFloat(this.dom.categoryGoalAmount.value) || 0;

                if (!name) {
                    this.showToast("Please enter a category name.");
                    return;
                }

                const newCategory = { name, type, amount, goalAmount };
                const newId = await dbStore.addCategory(newCategory);
                this.categories.push({ id: newId, ...newCategory });

                if (type === 'variable' || type === 'sinking-goal' || type === 'debt-goal') {
                    const newEnvelope = { categoryId: newId, type: type, balance: 0 };
                    await dbStore.saveEnvelope(newEnvelope);
                    this.envelopes.push(newEnvelope);
                }

                this.showToast(i18n.t('toastCategoryAdded'));
                this.dom.addCategoryForm.reset();
                this.dom.categoryType.value = type;

                // --- BUG FIX: Add new category to budget if it has a default amount ---
                if (newCategory.amount > 0 && (type === 'variable' || type === 'sinking-goal' || type === 'debt-goal')) {
                    const newBudgetItem = {
                        id: `${type}-${newId}`,
                        categoryId: newId,
                        type: type,
                        amount: newCategory.amount
                    };
                    // Add to local state
                    this.budget.push(newBudgetItem);
                    
                    // Save the entire updated budget to DB
                    // We can just call onAutoSaveBudget, but it's safer to save the full state
                    await dbStore.saveBudget(this.budget);
                    console.log("Added new category to budget.");
                }
                // --- End Bug Fix ---

                this.renderAllPages(); // Use renderAllPages to update both dashboard and manage page
            },

            /**
             * Show the Edit Category modal
             */
            showEditCategoryModal(id) {
                const cat = this.categories.find(c => c.id === id);
                if (!cat) return;
                
                this.dom.editCategoryId.value = cat.id;
                this.dom.editCategoryType.value = cat.type;
                this.dom.editCategoryName.value = cat.name;
                this.dom.editCategoryAmount.value = cat.amount || '';
                this.dom.editCategoryGoalAmount.value = cat.goalAmount || '';
                
                this.toggleGoalAmountField('edit');
                
                this.dom.editCategoryModal.classList.remove('hidden');
                this.dom.editCategoryModal.classList.add('flex');
            },

            /**
             * Hide the Edit Category modal
             */
            hideEditCategoryModal() {
                this.dom.editCategoryForm.reset();
                this.dom.editCategoryModal.classList.add('hidden');
                this.dom.editCategoryModal.classList.remove('flex');
                // Restore z-index of the modal it was launched from
                this.dom.manageCategoriesModal.style.zIndex = 50;
            },

            /**
             * Handle Edit Category form submission
             * @param {Event} e - The form event
             */
            async onUpdateCategory(e) {
                e.preventDefault();
                const id = parseInt(this.dom.editCategoryId.value);
                const name = this.dom.editCategoryName.value;
                const amount = parseFloat(this.dom.editCategoryAmount.value) || 0;
                const goalAmount = parseFloat(this.dom.editCategoryGoalAmount.value) || 0;
                
                const cat = this.categories.find(c => c.id === id);
                if (!cat) return;

                if (!name) {
                    this.showToast("Please enter a category name.");
                    return;
                }
                
                cat.name = name;
                cat.amount = amount;
                cat.goalAmount = goalAmount;
                
                await dbStore.updateCategory(cat);
                
                this.categories = this.categories.map(c => c.id === id ? cat : c);
                
                this.hideEditCategoryModal();
                this.showToast(i18n.t('toastCategoryUpdated'));

                this.renderAllPages();
            },

            /**
             * Handle clicking edit or delete on a category
             * @param {Event} e - The click event
             */
            async handleCategoryListClick(e) {
                // Handle Edit
                const editButton = e.target.closest('.edit-category-btn');
                if (editButton) {
                    const id = parseInt(editButton.dataset.id);
                    if (id) {
                        // Make the edit modal appear on top
                        this.dom.manageCategoriesModal.style.zIndex = 30;
                        this.showEditCategoryModal(id);
                    }
                    return;
                }

                // Handle Delete
                const deleteButton = e.target.closest('.delete-category-btn');
                if (!deleteButton) return;

                const id = parseInt(deleteButton.dataset.id);

                try {
                    await dbStore.deleteCategory(id);

                    this.categories = this.categories.filter(c => c.id !== id);
                    this.transactions = this.transactions.filter(t => t.categoryId !== id);
                    this.budget = this.budget.filter(b => b.categoryId !== id);
                    this.envelopes = this.envelopes.filter(e => e.categoryId !== id); // Don't forget envelopes

                    this.showToast(i18n.t('toastCategoryDeleted'));

                    this.renderAllPages();
                } catch (err) {
                    console.error("Error deleting category:", err);
                    this.showToast("Error deleting category.");
                }
            },

            /**
             * Handle Auto-Save Budget on input
             */
            async onAutoSaveBudget() {
                // e.preventDefault(); // No longer needed
                const inputs = this.dom.budgetForm.querySelectorAll('.budget-input');
                const newBudgetItems = [];
                const envelopesToUpdate = [];
                
                const oldBudgetMap = new Map(this.budget.map(b => [b.id, b.amount]));
                const envelopeMap = new Map(this.envelopes.map(e => [e.categoryId, e]));

                inputs.forEach(input => {
                    const id = parseInt(input.dataset.id);
                    const type = input.dataset.type;
                    const newAmount = parseFloat(input.value) || 0;
                    const budgetId = `${type}-${id}`;

                    const oldAmount = oldBudgetMap.get(budgetId) || 0;
                    
                    if (newAmount > 0) {
                        newBudgetItems.push({
                            id: budgetId,
                            categoryId: id,
                            type: type,
                            amount: newAmount
                        });
                    }

                    if (type === 'sinking-goal' || type === 'debt-goal') {
                        const envelope = envelopeMap.get(id);
                        if (envelope) {
                            const diff = newAmount - oldAmount;
                            envelope.balance = (envelope.balance || 0) + diff;
                            envelopesToUpdate.push(envelope);
                        }
                    }
                });

                if (envelopesToUpdate.length > 0) {
                    await dbStore.saveEnvelopes(envelopesToUpdate);
                    this.envelopes = await dbStore.getEnvelopes();
                }
                
                await dbStore.saveBudget(newBudgetItems);
                this.budget = newBudgetItems;

                console.log("Budget auto-saved."); // No toast, no navigation

                // Re-render dashboard if we are on it, as totals have changed
                if (this.currentPage === 'dashboard-page') {
                    this.renderDashboard();
                }
            },

            /**
             * Handle currency change in settings
             */
            async onChangeCurrency(e) {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const currency = selectedOption.value;
                const currencySymbol = selectedOption.dataset.symbol;
                const locale = selectedOption.dataset.locale;
                const digits = selectedOption.dataset.digits;
                
                i18n.setCurrency(currency, currencySymbol, locale, digits);
                
                await dbStore.saveSetting('currency', currency);
                await dbStore.saveSetting('currencySymbol', currencySymbol);
                await dbStore.saveSetting('formattingLocale', locale);
                await dbStore.saveSetting('fractionDigits', digits);

                this.showToast(i18n.t('toastSettingsSaved'));
                this.renderAllPages();
            },
            
            /**
             * Handle language change in settings
             */
            async onChangeLanguage(e) {
                const lang = e.target.value;
                i18n.setLanguage(lang);
                await dbStore.saveSetting('language', lang);
                this.showToast(i18n.t('toastSettingsSaved'));
                this.renderAllPages(); 
            },
            
            /**
             * Handle language selection during onboarding
             */
            selectOnboardingLang(lang) {
                i18n.setLanguage(lang);
                
                if (lang === 'en') {
                    this.dom.onboardingLangEn.classList.add('bg-pink-100', 'border-pink-500');
                    this.dom.onboardingLangEn.classList.remove('bg-gray-200');
                    this.dom.onboardingLangDe.classList.add('bg-gray-200');
                    this.dom.onboardingLangDe.classList.remove('bg-pink-100', 'border-pink-500');
                } else {
                    this.dom.onboardingLangDe.classList.add('bg-pink-100', 'border-pink-500');
                    this.dom.onboardingLangDe.classList.remove('bg-gray-200');
                    this.dom.onboardingLangEn.classList.add('bg-gray-200');
                    this.dom.onboardingLangEn.classList.remove('bg-pink-100', 'border-pink-500');
                }
                
                setTimeout(() => {
                    this.dom.onboardingStepLanguage.classList.remove('active');
                    this.dom.onboardingStep1.classList.add('active');
                }, 200);
            },

            /**
             * Show the reset confirmation modal
             */
            showResetModal() {
                this.dom.confirmResetModal.classList.remove('hidden');
                this.dom.confirmResetModal.classList.add('flex');
            },

            /**
             * Hide the reset confirmation modal
             */
            hideResetModal() {
                this.dom.confirmResetModal.classList.add('hidden');
                this.dom.confirmResetModal.classList.remove('flex');
            },

            /**
             * Handle the final reset confirmation
             */
            async onConfirmReset() {
                this.hideResetModal();
                this.showToast(i18n.t('toastReset'));

                try {
                    // --- Step 1: Clear all data from inside the database ---
                    // This avoids the 'deleteDatabase' block bug entirely.
                    console.log("Clearing all data from DB stores...");
                    await dbStore.clearAllData();

                    // --- Step 2: Clear localStorage ---
                    // This will make the app show onboarding on next load.
                    console.log("Clearing localStorage...");
                    try {
                        localStorage.clear();
                    } catch (e) { }

                    // --- Step 3: Unregister service workers ---
                    // This ensures the PWA re-fetches cleanly.
                    console.log("Unregistering service workers...");
                    if ('serviceWorker' in navigator) {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (const registration of registrations) {
                            await registration.unregister();
                        }
                    }

                    // --- Step 4: Reload the page ---
                    console.log("Reloading for a fresh start...");
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);

                } catch (error) {
                    console.error("Reset failed:", error.message);
                    this.showToast("Reset failed. Please try reloading the app.");
                }
            },

            // --- Transaction History ---

            /**
             * Handle clicking on a variable envelope card
             */
            handleEnvelopeClick(e) {
                const card = e.target.closest('[data-category-id]');
                if (!card) return;

                const categoryId = parseInt(card.dataset.categoryId);
                const categoryName = card.dataset.categoryName;
                this.showTransactionHistory(categoryId, categoryName);
            },

            /**
             * Show the transaction history modal for a category
             * @param {number} categoryId
             * @param {string} categoryName
             */
            async showTransactionHistory(categoryId, categoryName) {
                this.dom.txHistoryTitle.textContent = `${i18n.t('modalTxHistoryTitle')}: ${categoryName}`;
                this.dom.txHistoryList.innerHTML = '';
                this.showTxHistoryList();

                const transactions = await dbStore.getTransactionsForCategory(categoryId);
                transactions.sort((a, b) => b.date.localeCompare(a.date));

                if (transactions.length === 0) {
                    this.dom.txHistoryEmpty.classList.remove('hidden');
                    this.dom.txHistoryModal.classList.remove('hidden');
                    this.dom.txHistoryModal.classList.add('flex');
                    return;
                }
                
                this.dom.txHistoryEmpty.classList.add('hidden');
                
                transactions.forEach(tx => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center p-3 cursor-pointer hover:bg-pink-100";
                    li.dataset.txId = tx.id;
                    
                    const notesHTML = tx.notes ? `<span class="block text-sm text-gray-500 truncate italic">${tx.notes}</span>` : '';

                    li.innerHTML = `
                        <div class="flex-1 min-w-0"> <span class="block font-medium text-gray-800">${this.formatCurrency(tx.amount)}</span>
                            <span class="block text-sm text-gray-600">${this.formatDate(tx.date)}</span>
                            ${notesHTML}
                        </div>
                        <span class="text-gray-400 ml-2">&gt;</span>
                    `;
                    this.dom.txHistoryList.appendChild(li);
                });

                this.dom.txHistoryModal.classList.remove('hidden');
                this.dom.txHistoryModal.classList.add('flex');
            },

            /**
             * Hide the transaction history modal
             */
            hideTransactionHistory() {
                this.dom.txHistoryModal.classList.add('hidden');
                this.dom.txHistoryModal.classList.remove('flex');
                this.currentEditingTxId = null;
            },

            /**
             * Show the list view in the history modal
             */
            showTxHistoryList() {
                this.dom.txHistoryView.classList.remove('hidden');
                this.dom.txEditView.classList.add('hidden');
                this.currentEditingTxId = null;
            },

            /**
             * Handle clicking a transaction in the history list
             */
            handleTransactionClick(e) {
                const li = e.target.closest('[data-tx-id]');
                if (!li) return;

                const txId = parseInt(li.dataset.txId);
                const tx = this.transactions.find(t => t.id === txId);
                if (!tx) return;

                this.currentEditingTxId = tx.id;
                this.dom.editTxId.value = tx.id;
                this.dom.editTxDate.value = tx.date;
                this.dom.editTxAmount.value = tx.amount;
                this.dom.editTxNotes.value = tx.notes || '';

                this.dom.txHistoryView.classList.add('hidden');
                this.dom.txEditView.classList.remove('hidden');
            },

            /**
             * Handle saving an edited transaction
             */
            async onUpdateTransaction(e) {
                e.preventDefault();
                const id = this.currentEditingTxId;
                const amount = parseFloat(this.dom.editTxAmount.value);
                const date = this.dom.editTxDate.value;
                const notes = this.dom.editTxNotes.value;

                if (!id || isNaN(amount) || amount <= 0 || !date) {
                    this.showToast("Invalid amount or date.");
                    return;
                }
                
                const originalTx = this.transactions.find(t => t.id === id);
                if (!originalTx) return;

                const updatedTx = { id, amount, date, notes, categoryId: originalTx.categoryId };

                await dbStore.updateTransaction(updatedTx);

                this.transactions = this.transactions.map(t => t.id === id ? updatedTx : t);

                this.showToast(i18n.t('toastTxUpdated'));
                this.hideTransactionHistory();
                this.renderDashboard();
            },

            /**
             * Handle deleting an edited transaction
             */
            async onDeleteTransaction() {
                const id = this.currentEditingTxId;
                if (!id) return;

                await dbStore.deleteTransaction(id);
                
                this.transactions = this.transactions.filter(t => t.id !== id);
                
                this.showToast(i18n.t('toastTxDeleted'));
                this.hideTransactionHistory();
                this.renderDashboard();
            },


            // --- Calculations & Formatting ---

            /**
             * Update the budget summary (Assigned vs Remaining) on the Budget page
             */
            updateBudgetSummary() {
                const inputs = this.dom.budgetForm.querySelectorAll('.budget-input');
                let totalAssigned = 0;
                inputs.forEach(input => {
                    totalAssigned += parseFloat(input.value) || 0;
                });

                const calculations = this.calculateBudget();
                const remaining = calculations.moneyToBudget - totalAssigned;

                this.dom.budgetTotalAssigned.textContent = this.formatCurrency(totalAssigned);
                this.dom.budgetRemaining.textContent = this.formatCurrency(remaining);
                this.dom.budgetRemaining.classList.toggle('text-red-500', remaining < 0);
                this.dom.budgetRemaining.classList.toggle('text-green-600', remaining >= 0);
            },

            /**
             * Perform all major budget calculations
             * @returns {object} - A calculations object
             */
            calculateBudget() {
                // 1. Calculate total fixed costs
                const fixedCosts = this.categories
                    .filter(c => c.type === 'fixed')
                    .reduce((sum, c) => sum + (c.amount || 0), 0);

                const sinkingFundBills = this.categories
                    .filter(c => c.type === 'sinking-bill')
                    .reduce((sum, c) => sum + (c.amount || 0), 0);

                const debtPayments = this.categories
                    .filter(c => c.type === 'debt-payment')
                    .reduce((sum, c) => sum + (c.amount || 0), 0);

                const totalFixed = fixedCosts + sinkingFundBills + debtPayments;

                // 2. Calculate total income
                const otherIncomeTotal = this.otherIncome.reduce((sum, income) => sum + income.amount, 0);
                const totalIncome = this.salary + otherIncomeTotal + this.lastMonthRollover;

                // 3. Calculate money to budget
                const moneyToBudget = totalIncome - totalFixed;

                // 4. Calculate total budgeted (assigned to variable/goals)
                const totalBudgeted = this.budget
                    .filter(b => b.type === 'variable' || b.type === 'sinking-goal' || b.type === 'debt-goal')
                    .reduce((sum, b) => sum + (b.amount || 0), 0);

                // 5. Calculate spending per category
                const spentPerCategory = this.transactions
                    .reduce((acc, tx) => {
                        const id = tx.categoryId;
                        acc[id] = (acc[id] || 0) + tx.amount;
                        return acc;
                    }, {});

                return {
                    totalIncome,
                    otherIncomeTotal,
                    moneyToBudget,
                    totalFixed,
                    totalBudgeted,
                    spentPerCategory
                };
            },

            /**
             * Get the current month as 'YYYY-MM'
             */
            getCurrentMonthString() {
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                return `${year}-${month}`;
            },

            /**
             * Format a number as currency, using locale-aware separators.
             * @param {number} amount - The number to format
             */
            formatCurrency(amount) {
                if (typeof amount !== 'number') {
                    amount = 0;
                }
                
                const formattedNumber = new Intl.NumberFormat(i18n.formattingLocale, {
                    style: 'decimal',
                    minimumFractionDigits: i18n.fractionDigits,
                    maximumFractionDigits: i18n.fractionDigits
                }).format(amount);
                
                return `${i18n.currency}${formattedNumber}`;
            },

            /**
             * Format a date string (YYYY-MM-DD) to a readable format
             * @param {string} dateString
             */
            formatDate(dateString) {
                const date = new Date(dateString);
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                const adjustedDate = new Date(date.getTime() + userTimezoneOffset);
                
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return adjustedDate.toLocaleDateString(i18n.lang, options);
            },

            /**
             * Show a toast notification
             * @param {string} message - The message to display
             */
            showToast(message) {
                this.dom.toastMessage.textContent = message;
                this.dom.toast.classList.remove('opacity-0', 'translate-y-4');
                setTimeout(() => {
                    this.dom.toast.classList.add('opacity-0', 'translate-y-4');
                }, 2000);
            },
        };

        // --- App Entry Point ---
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>

</html>
