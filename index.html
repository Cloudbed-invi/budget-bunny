<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bunny Budget">
    <meta name="theme-color" content="#f472b6">

    <link rel="manifest" href="./manifest.json?v=3">
    
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
    
    <title>Bunny Budget</title>
    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="./src/output.css">
    <!-- Inter Font -->
    <style>
        /* --- NEW: OFFLINE FONT DEFINITIONS (Roboto) --- */
        /* roboto-regular - 400 */
        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 400;
            src: url('./fonts/Roboto-Regular.ttf') format('truetype');
        }
        
        /* roboto-medium - 500 (replaces semibold 600) */
        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 500;
            src: url('./fonts/Roboto-Medium.ttf') format('truetype');
        }

        /* roboto-bold - 700 */
        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 700;
            src: url('./fonts/Roboto-Bold.ttf') format('truetype');
        }
        
        /* roboto-black - 900 (replaces extrabold 800) */
        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 900;
            src: url('./fonts/Roboto-Black.ttf') format('truetype');
        }
        /* --- END OFFLINE FONT DEFINITIONS --- */

        /* Base styles */
        body,
        html {
            font-family: 'Roboto', sans-serif;
            background-color: #f7f3f8;
            /* Lighter bunny pink-white */
            color: #3f3c47;
            /* Bunny dark gray */
            overscroll-behavior: none;
            /* NEW: Global fix for text-selection bleed */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Our Bunny Theme */
        :root {
            --bunny-pink-light: #fdf2f8;
            /* Light pink for backgrounds */
            --bunny-pink: #f472b6;
            /* Main pink for buttons */
            --bunny-pink-dark: #db2777;
            /* Pink for hover */
            --bunny-gray-light: #f7f3f8;
            /* Page background */
            --bunny-gray-medium: #e5e0e7;
            /* Borders */
            --bunny-gray-dark: #3f3c47;
            /* Text */
            --bunny-green: #34d399;
            /* Green for progress */
            --bunny-white: #ffffff;
            --bunny-red: #ef4444;
            /* Red for danger */
            --bunny-red-dark: #dc2626;
        }

        /* Helper class to hide elements */
        .hidden {
            display: none !important;
        }

        /* Page transitions (simple fade) */
        .page {
            display: none;
            /* All pages hidden by default */
            animation: fadeIn 0.3s ease-in-out;
        }

        .page.active {
            display: block;
            /* Active page is shown */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Active nav button style */
        .nav-button.active {
            color: var(--bunny-pink);
        }

        .nav-button {
            -webkit-user-select: none;
            /* Safari */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* IE10+/Edge */
            user-select: none;
            /* Standard */
        }

        /* Bunny SVG Icon Styles */
        .bunny-icon {
            width: 1.5rem;
            height: 1.5rem;
            transition: all 0.2s ease;
        }

        .bunny-icon-sm {
            width: 1.25rem;
            height: 1.25rem;
        }

        /* Progress Bar */
        progress[value] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 99px;
            overflow: hidden;
            border: 0;
        }

        progress[value]::-webkit-progress-bar {
            background-color: var(--bunny-gray-medium);
        }

        progress[value]::-webkit-progress-value {
            background-color: var(--bunny-green);
            transition: all 0.3s ease;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            /* NEW: Force default cursor to stop text-bleed bug */
            cursor: default;
        }

        /* Onboarding Modal */
        #onboarding-modal {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .onboarding-step {
            display: none;
        }

        .onboarding-step.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* NEW: Force-fix for stubborn cursor bug */
        #reset-app-button, #confirm-reset-button, #cancel-reset-button {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            cursor: pointer !important;
        }

        /* NEW: Fixes text cursor on ALL buttons */
        button {
            -webkit-user-select: none;
            /* Safari */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* IE10+/Edge */
            user-select: none;
            /* Standard */
            cursor: pointer; /* Ensures all buttons get the pointer */
        }
        /* NEW: Re-enable text selection for inputs and textareas */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea {
            -webkit-user-select: text; /* Safari */
            -moz-user-select: text;    /* Firefox */
            -ms-user-select: text;     /* IE10+/Edge */
            user-select: text;         /* Standard */
        }
        /* NEW: Allow text selection in help/guide sections */
        #help-page,
        #onboarding-step-help {
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }
        /* Transaction History List */
        #tx-history-list li:nth-child(even) {
            background-color: #fdf2f8;
            /* --bunny-pink-light */
        }
        /* NEW: Active state for stats filter button */
        .stats-filter-btn.active {
            background-color: var(--bunny-white);
            color: var(--bunny-pink);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        /* NEW: Zoom Button Styles */
        .chart-zoom-btn {
            padding: 0.25rem 0.75rem;
            min-width: 38px;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4b5563; /* text-gray-600 */
            transition: all 0.15s ease-in-out;
        }
        .chart-zoom-btn:hover {
            background-color: var(--bunny-white);
            color: var(--bunny-pink);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .chart-zoom-btn:active {
            transform: scale(0.95);
        }
        /* NEW: Fix for coin wrapping */
        #stats-total-coins {
            white-space: nowrap;
        }
        /* NEW: Segmented Control Button Styles */
        .category-type-btn {
            padding: 0.5rem 0.25rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4b5563; /* text-gray-600 */
            transition: all 0.15s ease-in-out;
        }
        .category-type-btn.active {
            background-color: var(--bunny-white);
            color: var(--bunny-pink);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
    </style>
    <!-- Chart.js - for new stats page -->
    <script src="./chart.min.js"></script>
    <script src="./chartjs-plugin-zoom.min.js"></script>
    <script>
    // Restore the intended deep link after 404->index.html redirect on GitHub Pages
    (function () {
        var redirect = sessionStorage.getItem('redirect');
        if (redirect) {
        sessionStorage.removeItem('redirect');
        if (location.href !== redirect) history.replaceState(null, '', redirect);
        }
    })();
    </script>
    <script>
    // Restore deep link after 404->index.html redirect on GitHub Pages
    (function () {
        var redirect = sessionStorage.getItem('redirect');
        if (redirect) {
        sessionStorage.removeItem('redirect');
        if (location.href !== redirect) history.replaceState(null, '', redirect);
        }
    })();
    </script>
    </head>



<body class="antialiased">

    <!-- ====== FULL SCREEN ONBOARDING MODAL ====== -->
    <div id="onboarding-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto overflow-hidden">

            <div id="onboarding-step-language" class="onboarding-step active p-6 md:p-8 space-y-6">
                <h2 class="text-2xl font-bold text-center te    xt-gray-800" data-i18n="onboardingLanguageTitle">Select Language</h2>
                <p class="text-center text-gray-600" data-i18n="onboardingLanguageSubtitle">Choose your preferred language.</p>
                <div class="flex space-x-4 justify-center pt-4">
                    <button id="onboarding-lang-en"
                        class="lang-select-btn w-32 h-32 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-2xl text-base sm:text-lg transition-all flex flex-col items-center justify-center space-y-2 shadow hover:shadow-md border-2 border-transparent">
                        <span class="text-6xl">ðŸ‡ºðŸ‡¸</span>
                        <span class="font-bold">English</span>
                    </button>
                    <button id="onboarding-lang-de"
                        class="lang-select-btn w-32 h-32 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-2xl text-base sm:text-lg transition-all flex flex-col items-center justify-center space-y-2 shadow hover:shadow-md border-2 border-transparent">
                        <span class="text-6xl">ðŸ‡©ðŸ‡ª</span>
                        <span class="font-bold">Deutsch</span>
                    </button>
                </div>
            </div>

            <div id="onboarding-step-1" class="onboarding-step p-6 md:p-8">
                <div class="space-y-6"> <h2 class="text-2xl font-bold text-center text-gray-800" data-i18n="onboardingCurrencyTitle">Select
                    Currency</h2>
                <p class="text-center text-gray-600" data-i18n="onboardingCurrencySubtitle">Choose your default currency.
                </p>
                <div class="flex flex-col space-y-3">
                    <select id="currency-select"
                        class="w-full p-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                        <option value="â‚¬" data-symbol="â‚¬ EUR" data-locale="de-DE" data-digits="2">â‚¬ EUR (Euro)</option>
                        <option value="$" data-symbol="$ USD" data-locale="en-US" data-digits="2">$ USD (US Dollar)</option>
                        <option value="â‚¹" data-symbol="â‚¹ INR" data-locale="en-IN" data-digits="2">â‚¹ INR (Indian Rupee)</option>
                        <option value="â‚±" data-symbol="â‚± PHP" data-locale="en-PH" data-digits="2">â‚± PHP (Philippine Peso)</option>
                        <option value="Â£" data-symbol="Â£ GBP" data-locale="en-GB" data-digits="2">Â£ GBP (British Pound)</option>
                        <option value="Â¥" data-symbol="Â¥ JPY" data-locale="ja-JP" data-digits="0">Â¥ JPY (Japanese Yen)</option>
                        <option value="CHF" data-symbol="CHF" data-locale="de-CH" data-digits="2">CHF (Swiss Franc)</option>
                        <option value="C$" data-symbol="C$ CAD" data-locale="en-CA" data-digits="2">C$ CAD (Canadian Dollar)</option>
                        <option value="A$" data-symbol="A$ AUD" data-locale="en-AU" data-digits="2">A$ AUD (Australian Dollar)</option>
                    </select>
                    <button id="onboarding-next-step-1"
                        class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                        data-i18n="next">Next</button>
                </div>
                </div> <div class="w-full pt-6 mt-6 border-t border-gray-200"> <button id="onboarding-back-to-lang"
                        class="text-gray-500 hover:text-gray-800 font-medium transition-all"
                        data-i18n="back">Back</button>
                </div>
            </div>

            <!-- Step 2 (was 3): Template -->
            <div id="onboarding-step-2" class="onboarding-step p-6 md:p-8">
                <div class="space-y-6"> <h2 class="text-2xl font-bold text-center text-gray-800" data-i18n="onboardingTemplateTitle">Start Your
                    Budget</h2>
                <p class="text-center text-gray-600" data-i18n="onboardingTemplateSubtitle">You can start with our
                    template or from scratch.</p>
                <div class="flex flex-col space-y-3">
                    <button id="onboarding-use-template"
                        class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                        data-i18n="onboardingUseTemplate">Start with Template</button>
                    <button id="onboarding-start-fresh"
                        class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                        data-i18n="onboardingStartFresh">Start Fresh</button>
                    
                    <button id="onboarding-try-demo"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                        data-i18n="onboardingTryDemo"> Try a Demo
                    </button>
                    
                    <button id="onboarding-restore"
                        class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                        data-i18n="onboardingRestore">Restore from Backup
                    </button>
                    
                    <button id="onboarding-go-to-help"
                        class="w-full text-pink-600 hover:text-pink-800 font-medium py-2 rounded-lg transition-all"
                        data-i18n="onboardingHelpButton">How does this work? Read the guide</button>
                </div>
                </div> <div class="w-full pt-6 mt-6 border-t border-gray-200"> <button id="onboarding-back-to-currency"
                        class="text-gray-500 hover:text-gray-800 font-medium transition-all"
                        data-i18n="back">Back</button>
                </div>
            </div>

            <div id="onboarding-step-help" class="onboarding-step p-6 md:p-8">
                <div class="space-y-6 max-h-[70vh] overflow-y-auto pr-2"> <div class="space-y-4">
                        <h2 class="text-2xl font-bold text-center text-gray-800" data-i18n="helpHowToUseTitle">How to Use Bunny Budget</h2>
                    <div class="space-y-4 text-gray-700">
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep1Title">1. Setup Your
                                Budget</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpHowToUseStep1Desc">Go to the <strong
                                    class="text-pink-600">Manage</strong> tab.
                                First, enter your monthly **Salary**. Then, add all your monthly bills (like 'Rent' or
                                'Internet') as **Fixed Costs** and any monthly debt payments as **Debts (Fixed
                                Payment)**.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep2Title">2. Add Your
                                Categories</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpHowToUseStep2Desc">In <strong
                                    class="text-pink-600">Manage</strong>, add your spending
                                categories (like 'Groceries' or 'Gas') as **Variable Envelopes**. Add your savings goals
                                (like 'Vacation') as **Sinking Fund (Goals)** or **Debt (Paydown Goals)**.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep3Title">3. Assign Your
                                Money</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpHowToUseStep3Desc">Go to the <strong
                                    class="text-pink-600">Manage</strong> tab.
                                Add any **Other Income** you received this month. The app shows your "Money to Budget"
                                (your Total Income minus all Fixed Costs, Debts, and Annual Bills). Assign this money
                                into your Variable Envelopes and savings goals.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep4Title">4. Track Your
                                Spending</h3>
                            <p data-i18n="helpHowToUseStep4Desc">On the <strong
                                    class="text-pink-600">Dashboard</strong> tab, press
                                the big **pink '+' button** to add an expense. Select the envelope you spent from, and
                                watch the 'Remaining' amount go down.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep5Title">5. Fix Mistakes
                            </h3>
                            <p data-i18n="helpHowToUseStep5Desc">Made a typo? On the <strong
                                    class="text-pink-600">Dashboard</strong>, click the
                                **Variable Envelope** card (e.g., "Groceries"). A list of all transactions will appear.
                                Click a transaction to **Edit** or **Delete** it.</p>
                        </div>
                    </div>
                </div>
                </div> <div class="w-full pt-6 mt-6 border-t border-gray-200"> <button id="onboarding-help-back"
                        class="text-gray-500 hover:text-gray-800 font-medium transition-all"
                        data-i18n="back">Back</button>
                </div>
            </div>

        </div>
    </div>
    
    <div id="demo-mode-banner" class="hidden fixed top-0 left-0 right-0 z-[999] bg-yellow-400 text-yellow-900 font-bold text-center p-2 shadow">
        <span data-i18n="demoMode">Demo Mode</span> - <span data-i18n="demoModeResets">Resets in</span>: <span id="demo-mode-timer">10:00</span>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-6 opacity-0">

        <!-- Header -->
        <header class="mb-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <!-- Bunny Head Icon -->
                    <svg class="bunny-icon text-pink-500" viewBox="0 0 24 24" fill="currentColor"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12.6,6.3c0-0.8-0.7-1.5-1.5-1.5H12c-0.8,0-1.5,0.7-1.5,1.5v0c0,0.8,0.7,1.5,1.5,1.5h-0.1C11.9,7.8,12.6,7.1,12.6,6.3zM15.6,6.3c0-0.8-0.7-1.5-1.5-1.5h-0.1c-0.8,0-1.5,0.7-1.5,1.5v0c0,0.8,0.7,1.5,1.5,1.5h0C14.9,7.8,15.6,7.1,15.6,6.3z M9,12c-0.8,0-1.5,0.7-1.5,1.5S7.7,15,8.5,15S10,14.3,10,13.5S9.8,12,9,12z M15.5,15c0.8,0,1.5-0.7,1.5-1.5s-0.7-1.5-1.5-1.5s-1.5,0.7-1.5,1.5S14.7,15,15.5,15z M21.4,11.5c-0.2-1.2-0.6-2.4-1.2-3.5c-1.2-2-3-3.2-5.1-3.7C14.3,2.9,13.2,2,12,2s-2.3,0.9-3.1,2.2c-2.1,0.5-3.9,1.7-5.1,3.7C3.1,8,2.7,9.1,2.6,10.4C2.5,10.9,2.5,11.4,2.5,12c0,4.1,2.7,7.7,6.4,8.7c1.1,0.3,2.2,0.4,3.1,0.4c1,0,2.1-0.1,3.1-0.4c3.8-1,6.4-4.5,6.4-8.7C21.5,11.9,21.5,11.7,21.4,11.5z M19.5,12c0,3.6-2.2,6.7-5.4,7.5c-0.9,0.2-1.8,0.3-2.1,0.3c-0.4,0-1.2-0.1-2.1-0.3C6.7,18.7,4.5,15.6,4.5,12c0-0.5,0-0.7,0.1-1.2c0.2-1,0.5-1.9,1-2.8c0.9-1.5,2.3-2.5,4-3c0.3,1,1.2,1.8,2.4,1.8s2.1-0.8,2.4-1.8c1.7,0.5,3.1,1.5,4,3c0.5,0.9,0.8,1.8,1,2.8C19.5,11.3,19.5,11.5,19.5,12z" />
                    </svg>
                    <h1 class="text-2xl font-bold" data-i18n="appTitle">Bunny Budget</h1>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="flex items-center space-x-1 bg-pink-100 text-pink-700 font-bold text-lg px-4 py-2 rounded-full">
                        <span>ðŸª™</span>
                        <span id="bunny-coin-total">0</span>
                    </div>

                    <button id="show-settings-modal-btn" class="text-gray-500 hover:text-pink-500 p-2">
                        <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-.99h2.593c.55 0 1.02.448 1.11.99l.213 1.281c.063.374.313.686.64.87.317.174.69.24 1.065.21l1.28-.215c.53-.09 1.03.26 1.25.75l1.27 2.197c.22.38.22.86-.01 1.24l-1.08 1.08c-.29.29-.43.68-.43 1.08s.14 1.79.43 1.08l1.08 1.08c.23.38.23.86.01 1.24l-1.27 2.197c-.22.49-.72.84-1.25.75l-1.28-.215c-.375-.03-.748.036-1.065.21-.327.184-.577.496-.64.87l-.213 1.281c-.09.542-.56 1.007-1.11.99h-2.593c-.55 0-1.02-.448-1.11-.99l-.213-1.281c-.063-.374-.313-.686-.64-.87-.317-.174-.69-.24-1.065.21l-1.28.215c.53.09-1.03-.26-1.25-.75l-1.27-2.197c-.22-.38-.22-.86.01-1.24l1.08-1.08c.29-.29.43-.68.43-1.08s-.14-.79-.43-1.08L3.01 8.63c-.23-.38-.23-.86-.01-1.24l1.27-2.197c.22-.49.72.84 1.25.75l1.28.215c.375.03.748-.036 1.065.21.327-.184.577.496.64.87l.213-1.281z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- ====== Main Content Area ====== -->
        <main id="main-content">

            <!-- ====== Dashboard Page ====== -->
            <section id="dashboard-page" class="page active space-y-6">
                <!-- Money to Budget -->
                <div class="bg-white p-5 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm font-medium text-gray-500" data-i18n="dashboardMoneyToBudget">Money to
                                Budget</p>
                            <p id="dashboard-money-to-budget" class="text-3xl font-bold text-gray-800">â‚¬0.00</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-500" data-i18n="dashboardTotalBudgeted">Total
                                Budgeted</p>
                            <p id="dashboard-total-budgeted" class="text-lg font-semibold text-pink-600">â‚¬0.00</p>
                        </div>
                    </div>
                    <div id="dashboard-toggle-area" class="mt-4 cursor-pointer" data-view="spent">
                        <p id="dashboard-toggle-label" class="text-sm font-medium text-gray-500" data-i18n="dashboardTotalSpent">Total Spent (Variable)</p>
                        <p id="dashboard-toggle-value" class="text-3xl font-bold text-gray-800">â‚¬0.00</p>
                        <input type="hidden" id="dashboard-available-value" value="">
                        <input type="hidden" id="dashboard-spent-value" value="">
                    </div>
                </div>
                
                <div id="bills-card-container" class="bg-white p-5 rounded-2xl shadow-lg space-y-3 hidden">
                    <button id="bills-card-toggle-btn" class="w-full flex justify-between items-center text-left">
                        <div>
                            <h2 class="text-xl font-semibold" data-i18n="dashboardBillsTitle">Bills & Fixed Debts</h2>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span id="bills-card-total" class="font-semibold text-lg text-red-600">â‚¬0.00</span>
                            <svg id="bills-card-chevron" class="w-5 h-5 text-gray-500 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </div>
                    </button>
                    <div id="bills-card-details" class="mt-2 hidden space-y-2 border-t border-gray-100 pt-3">
                        <div id="bills-card-list" class="space-y-2">
                            </div>
                        <p id="bills-card-empty" class="text-gray-500" data-i18n="dashboardBillsEmpty">No monthly bills. Go to 'Manage' to add one.</p>
                    </div>
                </div>

                <div id="variable-envelopes-container" class="hidden">
                    <h2 class="text-xl font-semibold mb-3" data-i18n="dashboardVariableEnvelopes">Variable Envelopes
                    </h2>
                    <div id="variable-envelopes-list" class="space-y-3">
                        <!-- JS will render envelopes here -->
                    </div>
                    <p id="variable-envelopes-empty" class="text-gray-500" data-i18n="dashboardNoVariable">No variable
                        envelopes budgeted yet. Go to the 'Manage' page to add some!</p>
                </div>

                <!-- Sinking Funds (Goals) -->
                <div id="saving-goals-container" class="hidden"> <h2 class="text-xl font-semibold mb-3" data-i18n="dashboardSinkingFunds">Savings Goals</h2>
                    <div id="saving-goals-list" class="space-y-3">
                        </div>
                    <p id="saving-goals-empty" class="text-gray-500" data-i18n="dashboardNoSinking">No savings
                        goals. Go to the 'Manage' page to create one!</p>
                </div>

                <!-- Debt Paydown Goals -->
                <div id="debt-goals-container" class="hidden"> <h2 class="text-xl font-semibold mb-3" data-i18n="dashboardDebtGoals">Debt Paydown Goals</h2>
                    <div id="debt-goals-list" class="space-y-3">
                        </div>
                    <p id="debt-goals-empty" class="text-gray-500" data-i18n="dashboardNoDebtGoals">No debt
                        paydown goals. Go to 'Manage' to add one.</p>
                </div>
            </section>

            <!-- ====== NEW: Manage Page (Budget + Settings) ====== -->
            <section id="manage-page" class="page space-y-6">

                <div class="bg-white p-5 rounded-2xl shadow-lg space-y-4">
                    
                    <div>
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold" data-i18n="helpTermSalaryTitle">Salary</span>
                            <span id="budget-summary-salary" class="text-lg font-medium text-gray-800">â‚¬0.00</span>
                        </div>
                        <div id="other-income-container" class="border-t border-gray-200 pt-4 hidden">
                            <button id="other-income-toggle-btn" class="w-full flex justify-between items-center text-left">
                                <span class="text-lg font-semibold" data-i18n="budgetOtherIncome">Other Income</span>
                                <div class="flex items-center space-x-2">
                                    <span id="other-income-total-span" class="font-medium text-green-600">â‚¬0.00</span>
                                    <svg id="other-income-chevron" class="w-5 h-5 text-gray-500 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                    </svg>
                                </div>
                            </button>
                            <div id="other-income-details" class="mt-2 hidden">
                                <div id="other-income-list" class="space-y-2">
                                </div>
                                <p id="other-income-empty" class="text-gray-500 hidden" data-i18n="budgetNoOtherIncome">No other income added this month.</p>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center text-lg font-semibold border-t border-gray-200 pt-2 mt-2">
                            <span data-i18n="budgetTotalIncome">Total Income</span>
                            <span id="budget-summary-total-income" class="text-gray-900">â‚¬0.00</span>
                        </div>

                        <div id="fixed-costs-container" class="border-t border-gray-200 pt-4 hidden">
                            <button id="fixed-costs-toggle-btn" class="w-full flex justify-between items-center text-left">
                                <span class="text-lg font-semibold" data-i18n="budgetFixedCosts">Bills & Debts</span>
                                <div class="flex items-center space-x-2">
                                    <span id="budget-summary-fixed-costs" class="font-medium text-red-600">â‚¬0.00</span>
                                    <svg id="fixed-costs-chevron" class="w-5 h-5 text-gray-500 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                    </svg>
                                </div>
                            </button>
                            <div id="fixed-costs-details" class="mt-2 hidden space-y-2">
                                <div id="fixed-costs-list" class="space-y-2">
                                </div>
                            </div>
                        </div>
                        
                    </div>

                </div> <div
                    class="bg-pink-50 border-2 border-pink-200 p-4 rounded-lg space-y-3">
                    <div>
                            <p class="text-sm font-medium text-pink-700" data-i18n="budgetMoneyToBudget">Money to Budget
                            </p>
                            <p id="budget-money-to-budget" class="text-3xl font-bold text-pink-900">â‚¬0.00</p>
                        </div>
                        <div class="flex justify-between">
                            <p class="text-sm font-medium text-pink-700" data-i18n="budgetTotalAssigned">Total Assigned
                            </p>
                            <p id="budget-total-assigned" class="text-lg font-semibold text-pink-900">â‚¬0.00</p>
                        </div>
                        <div class="flex justify-between">
                            <p class="text-sm font-medium text-pink-700" data-i18n="budgetRemainingToAssign">Remaining
                            </p>
                            <p id="budget-remaining" class="text-lg font-semibold text-green-600">â‚¬0.00</p>
                        </div>
                    </div>

                <div class="bg-white rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold p-5" data-i18n="assignTitle">Assign Your Money</h2>
                    <form id="budget-form" class="space-y-1 p-5 pt-0">
                        
                        <div class="border-t border-gray-100 py-3">
                            <button type="button" id="assign-bills-toggle-btn" class="assign-toggle-btn w-full flex justify-between items-center text-left" data-target-details="assignBillsDetails" data-target-chevron="assignBillsChevron">
                                <span class="text-lg font-semibold" data-i18n="assignBills">Assign to Bills</span>
                                <svg id="assign-bills-chevron" class="w-5 h-5 text-gray-500 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                </svg>
                            </button>
                            <div id="assign-bills-details" class="mt-3 hidden">
                                <div id="budget-bill-list" class="space-y-3"></div>
                                <p id="budget-bill-empty" class="text-gray-500" data-i18n="budgetNoVariable">No bills. Add one below.</p>
                            </div>
                        </div>

                        <div class="border-t border-gray-100 py-3">
                            <button type="button" id="assign-envelopes-toggle-btn" class="assign-toggle-btn w-full flex justify-between items-center text-left" data-target-details="assignEnvelopesDetails" data-target-chevron="assignEnvelopesChevron">
                                <span class="text-lg font-semibold" data-i18n="assignEnvelopes">Fill Envelopes</span>
                                <svg id="assign-envelopes-chevron" class="w-5 h-5 text-gray-500 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                </svg>
                            </button>
                            <div id="assign-envelopes-details" class="mt-3 hidden"> <div id="budget-envelope-list" class="space-y-3"></div>
                                <p id="budget-envelope-empty" class="text-gray-500" data-i18n="budgetNoVariable">No envelopes. Add one below.</p>
                            </div>
                        </div>

                        <div class="border-t border-gray-100 py-3">
                            <button type="button" id="assign-savings-toggle-btn" class="assign-toggle-btn w-full flex justify-between items-center text-left" data-target-details="assignSavingsDetails" data-target-chevron="assignSavingsChevron">
                                <span class="text-lg font-semibold" data-i18n="assignSavings">Contribute to Savings</span>
                                <svg id="assign-savings-chevron" class="w-5 h-5 text-gray-500 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                </svg>
                            </button>
                            <div id="assign-savings-details" class="mt-3 hidden">
                                <div id="budget-saving-list" class="space-y-3"></div>
                                <p id="budget-saving-empty" class="text-gray-500" data-i18n="budgetNoSinking">No saving goals. Add one below.</p>
                            </div>
                        </div>

                        <div class="border-t border-gray-100 py-3">
                            <button type="button" id="assign-debts-toggle-btn" class="assign-toggle-btn w-full flex justify-between items-center text-left" data-target-details="assignDebtsDetails" data-target-chevron="assignDebtsChevron">
                                <span class="text-lg font-semibold" data-i18n="assignDebts">Pay Down Debts</span>
                                <svg id="assign-debts-chevron" class="w-5 h-5 text-gray-500 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                </svg>
                            </button>
                            <div id="assign-debts-details" class="mt-3 hidden">
                                <div id="budget-debt-list" class="space-y-3"></div>
                                <p id="budget-debt-empty" class="text-gray-500" data-i18n="budgetNoDebtGoals">No debt goals. Add one below.</p>
                            </div>
                        </div>

                    </form>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-lg space-y-6">
                    <h2 class="text-xl font-semibold" data-i18n="setupManageTitle">Setup & Manage</h2>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-3" data-i18n="settingsMonthlySalary">Monthly Salary</h3>
                        <form id="salary-form"
                            class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                            <div class="flex-1 flex items-center space-x-2">
                                <span id="salary-currency-symbol" class="text-2xl font-medium text-gray-500">â‚¬</span>
                                <input type="number" id="salary-input"
                                    class="flex-1 w-full p-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                    placeholder="2500" step="0.01" min="0">
                            </div>
                            <div id="auto-save-status" class="text-center text-gray-500 h-6" style="pointer-events: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;"></div>
                        </form>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <h3 class="text-lg font-semibold mb-3" data-i18n="addCategoryTitle">Add New Category</h3>
                        <form id="add-category-form" class="space-y-4">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700" data-i18n="categoryTypeLabel">Choose a Type</label>
                                <input type="hidden" id="category-type" value="envelope"> <div id="category-type-selector" class="flex items-center space-x-1 bg-gray-100 p-1 rounded-lg mt-1">
                                    <button type="button" data-type="bill" class="category-type-btn w-1/4" data-i18n="categoryTypeBill">Bill</button>
                                    <button type="button" data-type="envelope" class="category-type-btn w-1/4 active" data-i18n="categoryTypeEnvelope">Envelope</button>
                                    <button type="button" data-type="saving" class="category-type-btn w-1/4" data-i18n="categoryTypeSaving">Saving</button>
                                    <button type="button" data-type="debt" class="category-type-btn w-1/4" data-i18n="categoryTypeDebt">Debt</button>
                                </div>
                                <p id="category-type-description" class="text-xs text-gray-500 mt-2" data-i18n="categoryTypeEnvelopeDesc">Flexible spending (e.g., Groceries, Gas)</p>
                            </div>

                            <div>
                                <label for="category-name" class="block text-sm font-medium text-gray-700"
                                    data-i18n="categoryNameLabel">Category Name</label>
                                <input type="text" id="category-name"
                                    class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                    required>
                            </div>
                            
                            <div>
                                <label for="category-amount" class="block text-sm font-medium text-gray-700"
                                    data-i18n="categoryMonthlyAmountLabel">Monthly Planned Amount</label>
                                <p class="text-xs text-gray-500 mb-1" data-i18n="categoryMonthlyAmountDesc">How much you plan to assign this month.</p>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span id="category-currency-symbol" class="text-xl font-medium text-gray-500">â‚¬</span>
                                    <input type="number" id="category-amount"
                                        class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                        placeholder="50.00" step="0.01" min="0">
                                </div>
                            </div>

                            <button type="button" id="category-optional-toggle-btn" class="hidden w-full flex justify-between items-center text-left p-2 bg-gray-50 hover:bg-gray-100 rounded-lg">
                                <span class="font-medium text-gray-700" data-i18n="categoryOptionalFields">Optional Details</span>
                                <svg id="category-optional-chevron" class="w-5 h-5 text-gray-500 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                </svg>
                            </button>

                            <div id="category-optional-details" class="hidden space-y-3 pt-3 border-t">
                                <div>
                                    <label for="category-goal-amount" class="block text-sm font-medium text-gray-700"
                                        data-i18n="categoryTotalGoalLabel">Total Goal / Debt Amount</label>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <span id="category-goal-currency-symbol" class="text-xl font-medium text-gray-500">â‚¬</span>
                                        <input type="number" id="category-goal-amount"
                                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                            placeholder="1000.00" step="0.01" min="0">
                                    </div>
                                </div>

                                <div>
                                    <label for="category-current-balance" class="block text-sm font-medium text-gray-700"
                                        data-i18n="categoryCurrentBalanceLabel">Current Balance / Already Saved</label>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <span id="category-current-balance-currency-symbol" class="text-xl font-medium text-gray-500">â‚¬</span>
                                        <input type="number" id="category-current-balance"
                                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                            placeholder="0.00" step="0.01" min="0">
                                    </div>
                                </div>
                                
                                <div id="category-goal-date-group">
                                    <label for="category-goal-date" class="block text-sm font-medium text-gray-700"
                                    data-i18n="settingsGoalDate">Goal Date (Optional)</label>
                                <input type="date" id="category-goal-date"
                                    class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                            </div>

                            <button type="submit"
                                class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                                data-i18n="settingsAddCategoryButton">Add Category</button>
                        </form>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <button id="manage-categories-button"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                            data-i18n="manageCategoriesButton">Manage All Categories</button>
                    </div>

                </div>

            </section>
            
            <!-- ====== Help Page (Unchanged) ====== -->
            <section id="help-page" class="page space-y-6">
                <!-- How to Use -->
                <div class="bg-white p-5 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-3" data-i18n="helpHowToUseTitle">How to Use Bunny Budget</h2>
                    <div class="space-y-4 text-gray-700">
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep1Title">1. Setup Your
                                Budget</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpHowToUseStep1Desc">Go to the <strong
                                    class="text-pink-600">Manage</strong> tab.
                                First, enter your monthly **Salary**. Then, add all your monthly bills (like 'Rent' or
                                'Internet') as **Fixed Costs** and any monthly debt payments as **Debts (Fixed
                                Payment)**.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep2Title">2. Add Your
                                Categories</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpHowToUseStep2Desc">In <strong
                                    class="text-pink-600">Manage</strong>, add your spending
                                categories (like 'Groceries' or 'Gas') as **Variable Envelopes**. Add your savings goals
                                (like 'Vacation') as **Sinking Fund (Goals)** or **Debt (Paydown Goals)**.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep3Title">3. Assign Your
                                Money</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpHowToUseStep3Desc">Go to the <strong
                                    class="text-pink-600">Manage</strong> tab.
                                Add any **Other Income** you received this month. The app shows your "Money to Budget"
                                (your Total Income minus all Fixed Costs, Debts, and Annual Bills). Assign this money
                                into your Variable Envelopes and savings goals.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep4Title">4. Track Your
                                Spending</h3>
                            <p data-i18n="helpHowToUseStep4Desc">On the <strong
                                    class="text-pink-600">Dashboard</strong> tab, press
                                the big **pink '+' button** to add an expense. Select the envelope you spent from, and
                                watch the 'Remaining' amount go down.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpHowToUseStep5Title">5. Fix Mistakes
                            </h3>
                            <p data-i18n="helpHowToUseStep5Desc">Made a typo? On the <strong
                                    class="text-pink-600">Dashboard</strong>, click the
                                **Variable Envelope** card (e.g., "Groceries"). A list of all transactions will appear.
                                Click a transaction to **Edit** or **Delete** it.</p>
                        </div>
                    </div>
                </div>

                <!-- Budgeting Terms Explained -->
                <div class="bg-white p-5 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-3" data-i18n="helpTermsTitle">Budgeting Terms Explained</h2>
                    <div class="space-y-4 text-gray-700">
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermSalaryTitle">Salary</h3>
                            <p data-i18n="helpTermSalaryDesc">Your total *recurring* monthly income. This is the baseline
                                for your budget.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermOtherIncomeTitle">Other Income
                            </h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpTermOtherIncomeDesc">One-time or variable income (like a side job or
                                selling an item). Add this on the <strong class="text-pink-600">Manage</strong> page.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermFixedCostTitle">Fixed Cost</h3>
                            <p data-i18n="helpTermFixedCostDesc">A bill that is the same amount every month, like Rent or
                                Internet. This is paid *before* you budget.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermDebtPaymentTitle">Debt (Fixed
                                Payment)</h3>
                            <p data-i18n="helpTermDebtPaymentDesc">A monthly payment for a debt (like a car loan). This
                                is treated like a Fixed Cost and is paid *before* you budget.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermSinkingBillTitle">Sinking Fund
                                (Annual Bill)</h3>
                            <p data-i18n="helpTermSinkingBillDesc">For non-monthly bills (like annual car insurance or a
                                quarterly tax). The app saves 1/12th of the cost every month, treating it like a Fixed
                                Cost so you're never surprised by the bill.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermMoneyToBudgetTitle">Money to
                                Budget</h3>
                            <!-- MODIFIED: Updated help text to reflect new "Manage" page -->
                            <p data-i18n="helpTermMoneyToBudgetDesc">This is your Total Income (Salary + Other) minus
                                all your Fixed Costs, Debts (Fixed Payments), and Sinking Fund (Bills). This is the
                                money you get to assign on the <strong class="text-pink-600">Manage</strong> page.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermVariableEnvelopeTitle">Variable
                                Envelope</h3>
                            <p data-i18n="helpTermVariableEnvelopeDesc">Your "digital envelope" for monthly spending that
                                changes, like Groceries, Gas, or Dining Out. You spend from these using the '+' button.
                            </p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermSinkingGoalTitle">Sinking Fund
                                (Goal)</h3>
                            <p data-i18n="helpTermSinkingGoalDesc">Your "digital savings envelope" for a big, optional
                                goal, like Vacation, Christmas, or an Emergency Fund. You assign money to it, but you
                                don't spend from it.</p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="font-semibold text-gray-900" data-i18n="helpTermDebtGoalTitle">Debt (Paydown
                                Goal)</h3>
                            <p data-i18n="helpTermDebtGoalDesc">A "digital envelope" to pay off a debt faster (like a
                                credit card). You assign extra money from your 'Money to Budget' to this goal.</p>
                        </div>
                    </div>
                </div>

            </section>

            <!-- ====== Stats Page (NEW: With Charts) ====== -->
            <section id="stats-page" class="page space-y-6">
                
                <!-- Card 1: Bunny Coins & History (The original content) -->
                <div class="bg-white p-5 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4" data-i18n="statsTitle">Stats & History</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm font-medium text-gray-500" data-i18n="statsTotalCoins">Total Bunny Coins</p>
                            <p id="stats-total-coins" class="text-3xl font-bold text-pink-600">ðŸª™ 0</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2" data-i18n="statsHistory">Rollover History</h3>
                            <ul id="stats-history-list" class="space-y-3">
                                </ul>
                            <p id="stats-history-empty" class="text-gray-500" data-i18n="statsNoHistory">No history yet. Save some money to earn coins!</p>
                        </div>
                    </div>
                </div>

                <!-- Card 2: NEW Snapshot Analysis -->
                <div class="bg-white p-5 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 space-y-3 sm:space-y-0">
                        <h2 class="text-xl font-semibold" data-i18n="statsMonthlyAnalysis">Monthly Analysis</h2>
                        
                        <div class="flex items-center space-x-1 bg-gray-100 p-1 rounded-lg">
                            <button id="stats-overview-zoom-out" class="chart-zoom-btn">-</button>
                            <button id="stats-overview-zoom-in" class="chart-zoom-btn">+</button>
                            <button id="stats-overview-zoom-reset" class="chart-zoom-btn">Reset</button>
                        </div>
                        
                        <div id="stats-filter-buttons" class="flex items-center space-x-1 bg-gray-100 p-1 rounded-lg">
                            <button class="stats-filter-btn px-3 py-1 rounded-md text-sm font-medium text-gray-600" data-months="3">3M</button>
                            <button class="stats-filter-btn px-3 py-1 rounded-md text-sm font-medium text-gray-600" data-months="6">6M</button>
                            <button class="stats-filter-btn px-3 py-1 rounded-md text-sm font-medium text-gray-600 active" data-months="12">12M</button>
                        </div>
                    </div>

                    <!-- This will show if no snapshots are found -->
                    <p id="stats-snapshot-empty" class="text-gray-500 hidden">No monthly snapshots found. Check back after your first month!</p>

                    <!-- Container for the main overview chart -->
                    <div id="stats-overview-container" class="hidden">
                        <h3 class="text-lg font-semibold mb-2" data-i18n="statsIncomeVsSpend">Income vs. Spend vs. Savings</h3>
                        <div class="w-full h-64 md:h-80">
                            <canvas id="stats-overview-chart"></canvas>
                        </div>
                    </div>

                    <!-- Container for the category drill-down -->
                    <div id="stats-category-drilldown" class="hidden mt-8 border-t border-gray-200 pt-6">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-3 space-y-3 sm:space-y-0">
                            <div>
                                <h3 class="text-lg font-semibold" data-i18n="statsCompareCategory">Compare a Category</h3>
                                <p class="text-sm text-gray-500" data-i18n="statsCompareCategoryDesc">Select a category to see its history.</p>
                            </div>
                            <div class="flex items-center space-x-1 bg-gray-100 p-1 rounded-lg">
                                <button id="stats-category-zoom-out" class="chart-zoom-btn">-</button>
                                <button id="stats-category-zoom-in" class="chart-zoom-btn">+</button>
                                <button id="stats-category-zoom-reset" class="chart-zoom-btn">Reset</button>
                            </div>
                        </div>
                        <select id="stats-category-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                            <!-- Options will be populated by JS -->
                        </select>
                        <div class="w-full h-64 md:h-80 mt-4">
                            <canvas id="stats-category-chart"></canvas>
                        </div>
                    </div>

                </div>
            </section>

            <!-- ====== NEW: Store Page ====== -->
            <section id="store-page" class="page space-y-6">
                <div class="bg-white p-5 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-3" data-i18n="storeTitle">Bunny Store</h2>
                    <div class="text-center py-10">
                        <span class="text-6xl">ðŸ›ï¸</span>
                        <p class="text-gray-600 mt-4" data-i18n="storeComingSoon">The Bunny Store is coming soon! Spend your ðŸª™ on fun new themes and icons.</p>
                    </div>
                </div>
            </section>


            <div class="h-32"></div>

        </main>
    </div>

    <!-- ====== Bottom Navigation Bar (MODIFIED) ====== -->
    <nav
        class="fixed bottom-0 left-0 right-0 h-20 bg-white shadow-[0_-4px_12px_rgba(0,0,0,0.05)] flex justify-around items-center max-w-4xl mx-auto md:rounded-t-2xl">
        <!-- Dashboard -->
        <button id="nav-dashboard" class="nav-button active flex flex-col items-center justify-center text-gray-500 w-20">
            <!-- Dashboard Icon -->
            <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
            </svg>
            <span class="text-xs font-medium mt-1" data-i18n="navDashboard">Dashboard</span>
        </button>

        <!-- NEW: Manage (Budget + Settings) -->
        <button id="nav-manage" class="nav-button flex flex-col items-center justify-center text-gray-500 w-20">
            <!-- Settings Icon -->
            <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
            </svg>
            <span class="text-xs font-medium mt-1" data-i18n="navManage">Manage</span>
        </button>

        <!-- Add Expense Button (Stays in Center) -->
        <button id="add-expense-button"
            class="bg-pink-500 hover:bg-pink-600 text-white rounded-full h-16 w-16 flex items-center justify-center shadow-lg -mt-8">
            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd"
                    d="M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z"
                    clip-rule="evenodd" />
            </svg>
        </button>

        <!-- Stats (Was Help/Stats) -->
        <button id="nav-stats" class="nav-button flex flex-col items-center justify-center text-gray-500 w-20">
            <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3.75 3v11.25A2.25 2.25 0 006 16.5h12M3.75 3h16.5M3.75 3A2.25 2.25 0 016 5.25h12A2.25 2.25 0 0120.25 3M3.75 16.5h16.5m-16.5 0A2.25 2.25 0 006 14.25h12A2.25 2.25 0 0020.25 16.5m0 0v1.125c0 .621-.504 1.125-1.125 1.125H9.75l-4.06-4.06a.75.75 0 010-1.06l4.06-4.06a1.125 1.125 0 011.59 0l4.06 4.06c.3.3.434.7.434 1.06v6.375c0 .621-.504 1.125-1.125 1.125H3.75z" />
            </svg>
            <span class="text-xs font-medium mt-1" data-i18n="navStats">Stats</span>
        </button>

        <!-- NEW: Store -->
        <button id="nav-store" class="nav-button flex flex-col items-center justify-center text-gray-500 w-20">
            <!-- Storefront Icon -->
            <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" 
                stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 21v-7.5A.75.75 0 0 1 14.25 12h.01a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75Zm-3.75 0v-7.5A.75.75 0 0 1 10.5 12h.01a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75Zm-3.75 0v-7.5A.75.75 0 0 1 6.75 12h.01a.75.75 0 0 1 .75.75V21a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75ZM3 12h18M3 12c0-1.12 0-1.68.218-2.108a2.25 2.25 0 0 1 .874-.874C4.5 8.782 5.06 8.782 6.18 8.782h11.64c1.12 0 1.68 0 2.108.218a2.25 2.25 0 0 1 .874.874c.218.428.218.988.218 2.108M3 12v6.75A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V12M3 8.782c0-.622 0-.933.109-1.187a1.5 1.5 0 0 1 .6-.6C4.137 6.886 4.448 6.886 5.07 6.886h13.86c.622 0 .933 0 1.187.109a1.5 1.5 0 0 1 .6.6c.109.254.109.565.109 1.187M9.75 6.886V6a2.25 2.25 0 1 0-4.5 0v.886M18.75 6.886V6a2.25 2.25 0 1 0-4.5 0v.886" />
            </svg>
            <span class="text-xs font-medium mt-1" data-i18n="navStore">Store</span>
        </button>
    </nav>


    <!-- ====== Modals (Unchanged) ====== -->
    <!-- Add Expense Modal -->
    <div id="add-transaction-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-2xl font-bold text-gray-800" data-i18n="modalAddTransactionTitle">Add Transaction</h2>
                <button type="button" id="cancel-add-transaction-button"
                    class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>

            <div class="flex border-b border-gray-200">
                <button id="modal-tx-tab-expense"
                    class="tab-button active border-pink-500 text-pink-600 w-1/2 py-3 px-1 text-center border-b-2 font-medium"
                    data-i18n="modalAddExpenseButton">
                    Add Expense
                </button>
                <button id="modal-tx-tab-income"
                    class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 w-1/2 py-3 px-1 text-center border-b-2 font-medium"
                    data-i18n="modalAddIncomeButton">
                    Add Income
                </button>
            </div>

            <div id="expense-form-container" class="tab-panel active">
                <form id="add-expense-form" class="space-y-4">
                    <div>
                        <label for="expense-category" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseCategory">Category</label>
                        <select id="expense-category"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            required>
                            </select>
                    </div>
                    <div>
                        <label for="expense-notes" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseNotes">Notes (Optional)</label>
                        <textarea id="expense-notes"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            rows="2" placeholder="e.g. Birthday gift for mom"
                            data-i18n="modalAddExpenseNotesPlaceholder"></textarea>
                    </div>
                    <div>
                        <label for="expense-date" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseDate">Date</label>
                        <input type="date" id="expense-date"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            required>
                    </div>
                    <div>
                        <label for="expense-amount" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseAmount">Amount</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <span id="expense-currency-symbol" class="text-xl font-medium text-gray-500">â‚¬</span>
                            <input type="number" id="expense-amount"
                                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                placeholder="12.50" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="pt-2">
                        <button type="submit"
                            class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                            data-i18n="save" style="-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; cursor: pointer;">Save Expense</button>
                    </div>
                </form>
            </div>

            <div id="income-form-container" class="tab-panel hidden">
                <form id="add-income-form" class="space-y-4">
                    <div>
                        <label for="income-source" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddIncomeSource">Source</label>
                        <input type="text" id="income-source"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            placeholder="e.g. Side Job, Sold item" data-i18n="modalAddIncomeSourcePlaceholder" required>
                    </div>
                    <div>
                        <label for="income-amount" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseAmount">Amount</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <span id="income-currency-symbol" class="text-xl font-medium text-gray-500">â‚¬</span>
                            <input type="number" id="income-amount"
                                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                placeholder="50.00" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="pt-10"> </div>
                    <div class="pt-10"> </div>
                     <div class="pt-2">
                        <button type="submit"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                            data-i18n="save" style="-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; cursor: pointer;">Save Income</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="edit-income-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            <h2 class="text-2xl font-bold text-gray-800" data-i18n="modalEditIncomeTitle">Edit Income</h2>
            <form id="edit-income-form" class="space-y-4">
                <input type="hidden" id="edit-income-id">
                <div>
                    <label for="edit-income-source" class="block text-sm font-medium text-gray-700"
                        data-i18n="modalAddIncomeSource">Source</label>
                    <input type="text" id="edit-income-source"
                        class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                        placeholder="e.g. Side Job, Sold item" data-i18n="modalAddIncomeSourcePlaceholder" required>
                </div>
                <div>
                    <label for="edit-income-amount" class="block text-sm font-medium text-gray-700"
                        data-i18n="modalAddExpenseAmount">Amount</label>
                    <div class="flex items-center space-x-2 mt-1">
                        <span id="edit-income-currency-symbol" class="text-xl font-medium text-gray-500">â‚¬</span>
                        <input type="number" id="edit-income-amount"
                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            placeholder="50.00" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0">
                    <button type="button" id="cancel-edit-income-button"
                        class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition-all"
                        data-i18n="cancel">Cancel</button>
                    <button type="submit"
                        class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                        data-i18n="save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="transaction-history-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            <!-- View List -->
            <div id="tx-history-view">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800" id="tx-history-title" data-i18n="modalHistoryTitle">History</h2>
                    <button type="button" id="tx-history-close-btn"
                        class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <ul id="tx-history-list" class="max-h-60 overflow-y-auto divide-y divide-gray-200">
                    <!-- JS will render transactions here -->
                </ul>
                <p id="tx-history-empty" class="text-gray-500 hidden" data-i18n="modalTxHistoryEmpty">No transactions
                    found for this category.</p>
            </div>
            <!-- Edit Form (hidden by default) -->
            <div id="tx-edit-view" class="hidden space-y-4">
                <h2 class="text-2xl font-bold text-gray-800" data-i18n="modalEditTxTitle">Edit Transaction</h2>
                <form id="edit-transaction-form" class="space-y-4">
                    <input type="hidden" id="edit-tx-id">
                    <div>
                        <label for="edit-tx-notes" class="block text-sm font-medium text-gray-700" data-i18n="modalAddExpenseNotes">Notes (Optional)</label>
                        <textarea id="edit-tx-notes"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            rows="2" placeholder="e.g. Birthday gift for mom" data-i18n="modalEditTxNotesPlaceholder"></textarea>
                    </div>
                    <div>
                        <label for="edit-tx-date" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseDate">Date</label>
                        <input type="date" id="edit-tx-date"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            required>
                    </div>
                    <div>
                        <label for="edit-tx-amount" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseAmount">Amount</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <span id="edit-tx-currency-symbol" class="text-xl font-medium text-gray-500">â‚¬</span>
                            <input type="number" id="edit-tx-amount"
                                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                placeholder="1S2.50" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0">
                        <button type="button" id="edit-tx-cancel"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition-all"
                            data-i18n="cancel">Cancel</button>
                        <button type="submit"
                            class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                            data-i18n="save">Save</button>
                    </div>
                    <button type="button" id="edit-tx-delete"
                        class="w-full text-red-500 hover:text-red-700 font-medium py-2 rounded-lg transition-all"
                        data-i18n="modalDeleteTx">Delete Transaction</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirm Reset Modal -->
    <div id="confirm-reset-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            <h2 class="text-2xl font-bold text-red-600" data-i18n="modalResetTitle">Are you sure?</h2>
            <p class="text-gray-600" data-i18n="modalResetText">This action is permanent and will delete all your data.
                There is no undo.</p>
            <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0">
                <button type="button" id="cancel-reset-button"
                    class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition-all"
                    data-i18n="cancel" style="-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; cursor: pointer;">Cancel</button>
                <button type="button" id="confirm-reset-button"
                    class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                    data-i18n="modalResetConfirm" style="-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; cursor: pointer;">Yes, Reset App</button>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="edit-category-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            <h2 class="text-2xl font-bold text-gray-800" data-i18n="modalEditCategoryTitle">Edit Category</h2>
            <form id="edit-category-form" class="space-y-3">
                <input type="hidden" id="edit-category-id">
                <div>
                    <label for="edit-category-type" class="block text-sm font-medium text-gray-700"
                        data-i18n="categoryTypeLabel">Type</label>
                    <select id="edit-category-type"
                        class="w-full p-3 border border-gray-300 rounded-lg mt-1 bg-gray-100 text-gray-500 cursor-not-allowed"
                        disabled>
                        <option value="bill" data-i18n="categoryTypeBill">Bill</option>
                        <option value="envelope" data-i18n="categoryTypeEnvelope">Envelope</option>
                        <option value="saving" data-i18n="categoryTypeSaving">Saving</option>
                        <option value="debt" data-i18n="categoryTypeDebt">Debt</option>
                    </select>
                </div>
                <div>
                    <label for="edit-category-name" class="block text-sm font-medium text-gray-700"
                        data-i18n="settingsCategoryName">Name</label>
                    <input type="text" id="edit-category-name"
                        class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                        required>
                </div>
                <div id="edit-category-goal-amount-group" class="hidden">
                    <label for="edit-category-goal-amount" class="block text-sm font-medium text-gray-700"
                        data-i18n="settingsGoalAmount">Total Goal (Optional)</label>
                    <div class="flex items-center space-x-2 mt-1">
                        <span id="edit-category-goal-currency-symbol" class="text-xl font-medium text-gray-500">â‚¬</span>
                        <input type="number" id="edit-category-goal-amount"
                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            placeholder="1000.00" step="0.01" min="0">
                    </div>
                </div>
                <div id="edit-category-goal-date-group" class="hidden">
                    <label for="edit-category-goal-date" class="block text-sm font-medium text-gray-700"
                        data-i18n="settingsGoalDate">Goal Date (Optional)</label>
                    <input type="date" id="edit-category-goal-date"
                        class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                </div>
                <div>
                    <label for="edit-category-amount" class="block text-sm font-medium text-gray-700"
                        data-i18n="settingsDefaultAmount">Monthly Payment (Optional)</label>
                    <div class="flex items-center space-x-2 mt-1">
                        <span id="edit-category-currency-symbol" class="text-xl font-medium text-gray-500">â‚¬</span>
                        <input type="number" id="edit-category-amount"
                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            placeholder="50.00" step="0.01" min="0">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0">
                    <button type="button" id="cancel-edit-category-button"
                        class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition-all"
                        data-i18n="cancel">Cancel</button>
                    <button type="submit"
                        class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                        data-i18n="save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app-settings-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800" data-i18n="settingsAppSettings">App Settings</h2>
                <button type="button" id="cancel-settings-button"
                    class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>

            <div class="border-b border-gray-200">
                <nav id="settings-tab-nav" class="flex -mb-px" aria-label="Tabs">
                    <button class="settings-tab-btn active border-pink-500 text-pink-600 w-1/5 py-4 px-1 text-center border-b-2 font-medium text-sm" data-tab="general" data-i18n="settingsTabGeneral">
                        General
                    </button>
                    <button class="settings-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 w-1/5 py-4 px-1 text-center border-b-2 font-medium text-sm" data-tab="backup" data-i18n="settingsTabData">
                        Backup
                    </button>
                    <button class="settings-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 w-1/5 py-4 px-1 text-center border-b-2 font-medium text-sm" data-tab="export" data-i18n="settingsTabExport">
                        Export
                    </button>
                    <button class="settings-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 w-1/5 py-4 px-1 text-center border-b-2 font-medium text-sm" data-tab="help" data-i18n="settingsTabHelp">
                        Help
                    </button>
                    <button class="settings-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 w-1/5 py-4 px-1 text-center border-b-2 font-medium text-sm" data-tab="danger" data-i18n="settingsTabDanger">
                        Danger
                    </button>
                </nav>
            </div>

            <div class="py-6" style="min-height: 350px;">
                <div id="settings-tab-general" class="settings-tab-panel active space-y-6">
                    <div class="space-y-4">
                        <div>
                            <label for="language-select" class="block text-sm font-medium text-gray-700"
                                data-i18n="settingsLanguage">Language</label>
                            <select id="language-select"
                                class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                                <option value="en">English</option>
                                <option value="de">Deutsch (German)</option>
                            </select>
                        </div>
                        <div>
                            <label for="currency-select-settings" class="block text-sm font-medium text-gray-700"
                                data-i18n="settingsCurrency">Currency</label>
                            <select id="currency-select-settings"
                                class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                                <option value="â‚¬" data-symbol="â‚¬ EUR" data-locale="de-DE" data-digits="2">â‚¬ EUR (Euro)</option>
                                <option value="$" data-symbol="$ USD" data-locale="en-US" data-digits="2">$ USD (US Dollar)</option>
                                <option value="â‚¹" data-symbol="â‚¹ INR" data-locale="en-IN" data-digits="2">â‚¹ INR (Indian Rupee)</option>
                                <option value="â‚±" data-symbol="â‚± PHP" data-locale="en-PH" data-digits="2">â‚± PHP (Philippine Peso)</option>
                                <option value="Â£" data-symbol="Â£ GBP" data-locale="en-GB" data-digits="2">Â£ GBP (British Pound)</option>
                                <option value="Â¥" data-symbol="Â¥ JPY" data-locale="ja-JP" data-digits="0">Â¥ JPY (Japanese Yen)</option>
                                <option value="CHF" data-symbol="CHF" data-locale="de-CH" data-digits="2">CHF (Swiss Franc)</option>
                                <option value="C$" data-symbol="C$ CAD" data-locale="en-CA" data-digits="2">C$ CAD (Canadian Dollar)</option>
                                <option value="A$" data-symbol="A$ AUD" data-locale="en-AU" data-digits="2">A$ AUD (Australian Dollar)</option>
                            </select>
                        </div>
                    </div>
                    <div id="install-pwa-section" class="hidden pt-4 border-t border-gray-100">
                        <button id="install-pwa-button"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all flex items-center justify-center space-x-2">
                            <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                            </svg>
                            <span data-i18n="installPwaButton">Install App to Home Screen</span>
                        </button>
                    </div>
                </div>

                <div id="settings-tab-backup" class="settings-tab-panel hidden space-y-4">
                    <h3 class="text-xl font-semibold" data-i18n="settingsDataManagement">Data Management</h3>
                    <p class="text-gray-600 text-sm" data-i18n="settingsBackupDesc">Save all your data to a .json file. Keep this file safe to restore your budget later.</p>
                    
                    <button id="backup-data-button"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all flex items-center justify-center space-x-2">
                        <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        <span data-i18n="settingsBackupButton">Create Backup</span>
                    </button>
                    
                    <button id="restore-data-button"
                        class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all flex items-center justify-center space-x-2">
                        <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                        </svg>
                        <span data-i18n="settingsRestoreButton">Restore from Backup</span>
                    </button>
                    
                    </div>

                <div id="settings-tab-export" class="settings-tab-panel hidden space-y-4">
                    <h3 class="text-xl font-semibold">Export Data</h3>
                    <p class="text-gray-600 text-sm">Download your data in CSV format to analyze in Excel or other spreadsheet software.</p>
                
                    <button id="export-csv-button"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all flex items-center justify-center space-x-2">
                        <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        <span data-i18n="settingsExportCSVButton">Export Transactions (.csv)</span>
                </button>
                
                <button id="export-categories-button"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all flex items-center justify-center space-x-2">
                    <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    <span data-i18n="settingsExportCategoriesButton">Export Categories & Goals (.csv)</span>
                </button>
                
                <button id="export-summaries-button"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all flex items-center justify-center space-x-2">
                    <svg class="bunny-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    <span data-i18n="settingsExportSummariesButton">Export Monthly Summaries (.csv)</span>
                </button>
            </div>

                <div id="settings-tab-help" class="settings-tab-panel hidden space-y-4">
                    <h3 class="text-xl font-semibold" data-i18n="settingsHelpTitle">Get Help</h3>
                    <p class="text-gray-600" data-i18n="settingsHelpDesc">Learn how to use the app, what the terms mean, and how to budget.</p>
                    <button id="go-to-help-button"
                        class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                        data-i18n="settingsHelpButton">View Help Guide</button>
                </div>

                <div id="settings-tab-danger" class="settings-tab-panel hidden space-y-4">
                    <h3 class="text-xl font-semibold text-red-600" data-i18n="settingsDangerZone">Danger Zone
                    </h3>
                    <p class="text-gray-600" data-i18n="settingsResetSubtitle">This will permanently delete all your
                        data (salary, categories, transactions) and restart the app.</p>
                    <button id="reset-app-button" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all" data-i18n="settingsResetButton" style="-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; cursor: pointer;">Reset App</button>
                </div>
            </div>

        </div>
    </div>

    <div id="goal-history-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            <div id="goal-history-view">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800" id="goal-history-title" data-i18n="modalGoalHistoryTitle">Goal History</h2>
                    <button type="button" id="goal-history-close-btn"
                        class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <div class="bg-green-50 p-4 rounded-lg mb-4 text-center">
                    <p class="text-sm font-medium text-green-700" data-i18n="modalGoalCurrentBalance">Current Balance</p>
                    <p id="goal-history-balance" class="text-3xl font-bold text-green-800">â‚¬0.00</p>
                </div>
                
                <h3 class="text-lg font-semibold mb-2" data-i18n="statsHistory">Activity</h3>
                <ul id="goal-history-list" class="max-h-60 overflow-y-auto divide-y divide-gray-200">
                    </ul>
                <p id="goal-history-empty" class="text-gray-500 hidden" data-i18n="modalTxHistoryEmpty">No activity
                    found for this goal.</p>
                
                <button id="goal-history-withdraw-btn"
                    class="w-full mt-4 bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-lg transition-all"
                    data-i18n="modalGoalWithdrawButton">
                    Withdraw Funds
                </button>
            </div>

            <div id="goal-edit-view" class="hidden space-y-4">
                <h2 class="text-2xl font-bold text-gray-800" data-i18n="modalEditTxTitle">Edit Transaction</h2>
                <form id="edit-goal-tx-form" class="space-y-4">
                    <input type="hidden" id="edit-goal-tx-id">
                    <div>
                        <label for="edit-goal-tx-notes" class="block text-sm font-medium text-gray-700" data-i18n="modalAddExpenseNotes">Notes (Optional)</label>
                        <textarea id="edit-goal-tx-notes"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            rows="2" placeholder="e.g. Flights to Rome" data-i18n="modalEditTxNotesPlaceholder"></textarea>
                    </div>
                    <div>
                        <label for="edit-goal-tx-date" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseDate">Date</label>
                        <input type="date" id="edit-goal-tx-date"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            required>
                    </div>
                    <div>
                        <label for="edit-goal-tx-amount" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseAmount">Amount (Read-only)</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <span id="edit-goal-tx-currency-symbol" class="text-xl font-medium text-gray-500">â‚¬</span>
                            <input type="number" id="edit-goal-tx-amount"
                                class="flex-1 p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"
                                placeholder="150.00" step="0.01" min="0" required disabled>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0">
                        <button type="button" id="edit-goal-tx-cancel"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition-all"
                            data-i18n="cancel">Cancel</button>
                        <button type="submit"
                            class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                            data-i18n="save">Save</button>
                    </div>
                    <button type="button" id="edit-goal-tx-delete"
                        class="w-full text-red-500 hover:text-red-700 font-medium py-2 rounded-lg transition-all"
                        data-i18n="modalDeleteTx">Delete Transaction</button>
                </form>
            </div>

        </div>
    </div>

    <div id="withdraw-goal-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-2xl font-bold text-gray-800" data-i18n="modalWithdrawTitle">Use Savings</h2>
                <button type="button" id="withdraw-goal-close-btn"
                    class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>

            <input type="hidden" id="withdraw-goal-category-id">

            <p id="withdraw-goal-penalty-warning" class="text-sm font-medium text-red-600 bg-red-50 p-3 rounded-lg hidden"></p>

            <div class="flex border-b border-gray-200">
                <button id="modal-goal-tab-spend"
                    class="tab-button active border-pink-500 text-pink-600 w-1/2 py-3 px-1 text-center border-b-2 font-medium"
                    data-i18n="modalGoalTabSpend">
                    Record an Expense
                </button>
                <button id="modal-goal-tab-transfer"
                    class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 w-1/2 py-3 px-1 text-center border-b-2 font-medium"
                    data-i18n="modalGoalTabTransfer">
                    Move to Spending
                </button>
            </div>

            <div id="goal-spend-form-container" class="tab-panel active">
                <form id="goal-spend-form" class="space-y-4">
                    <p class="text-sm text-gray-600" data-i18n="modalGoalSpendDesc">Record an expense paid for <strong>directly</strong> from this savings goal (e.g., buying plane tickets from your "Vacation" fund).</p>
                    <div>
                        <label for="goal-spend-notes" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseNotes">Notes (Optional)</label>
                        <textarea id="goal-spend-notes"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            rows="2" placeholder="e.g. Flights to Rome"
                            data-i18n="modalAddExpenseNotesPlaceholder"></textarea>
                    </div>
                    <div>
                        <label for="goal-spend-date" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseDate">Date</label>
                        <input type="date" id="goal-spend-date"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            required>
                    </div>
                    <div>
                        <label for="goal-spend-amount" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseAmount">Amount</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <span id="goal-spend-currency-symbol" class="text-xl font-medium text-gray-500">â‚¬</span>
                            <input type="number" id="goal-spend-amount"
                                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                placeholder="150.00" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="pt-2">
                        <button type="submit"
                            class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                            data-i18n="modalGoalLogExpense" style="-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; cursor: pointer;">Log Expense</button>
                    </div>
                </form>
            </div>

            <div id="goal-transfer-form-container" class="tab-panel hidden">
                <form id="goal-transfer-form" class="space-y-4">
                    <p class="text-sm text-gray-600" data-i18n="modalGoalTransferDesc">Move money <strong>out</strong> of this goal and <strong>into</strong> one of your monthly spending envelopes (like "Groceries" or "Dining Out").</p>
                    <div>
                        <label for="goal-transfer-category" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseCategory">Transfer to Envelope</label>
                        <select id="goal-transfer-category"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            required>
                            </select>
                    </div>
                    <div>
                        <label for="goal-transfer-notes" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseNotes">Notes (Optional)</label>
                        <textarea id="goal-transfer-notes"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            rows="2" placeholder="e.g. Souvenir money"></textarea>
                    </div>
                    <div>
                        <label for="goal-transfer-date" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseDate">Date</label>
                        <input type="date" id="goal-transfer-date"
                            class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                            required>
                    </div>
                    <div>
                        <label for="goal-transfer-amount" class="block text-sm font-medium text-gray-700"
                            data-i18n="modalAddExpenseAmount">Amount</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <span id="goal-transfer-currency-symbol" class="text-xl font-medium text-gray-500">â‚¬</span>
                            <input type="number" id="goal-transfer-amount"
                                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                placeholder="50.00" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="pt-2">
                        <button type="submit"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-all"
                            data-i18n="modalGoalTransferFunds" style="-webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; cursor: pointer;">Transfer Funds</button>
                    </div>
                </form>
            </div>
            
        </div>
    </div>

    <div id="manage-categories-modal"
        class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto p-6 space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800" data-i18n="modalManageCategoriesTitle">Manage Categories</h2>
                <button type="button" id="cancel-manage-categories-button"
                    class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>

            <div class="border-b border-gray-200">
                <nav class="flex -mb-px" aria-label="Tabs">
                    <button id="modal-manage-tab-bills" class="tab-button active border-pink-500 text-pink-600 w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm" data-i18n="modalManageTabBills">
                        Income & Bills
                    </button>
                    <button id="modal-manage-tab-envelopes" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm" data-i18n="modalManageTabEnvelopes">
                        Envelopes & Goals
                    </button>
                </nav>
            </div>

            <div class="space-y-4 max-h-80 overflow-y-auto pr-2">
                <div id="modal-manage-panel-bills" class="tab-panel active space-y-4">
                    <div id="modal-manage-container-bill" class="hidden">
                        <h3 class="text-lg font-medium text-gray-800" data-i18n="modalManageTypeBill">Bills</h3>
                        <div id="modal-manage-bill-list" class="space-y-2 mt-2"></div>
                    </div>
                    <p id="modal-manage-bills-empty" class="text-gray-500">No "Bill" categories found.</p>
                </div>

                <div id="modal-manage-panel-envelopes" class="tab-panel hidden space-y-4">
                    <div id="modal-manage-container-envelope" class="hidden">
                        <h3 class="text-lg font-medium text-gray-800" data-i18n="modalManageTypeEnvelope">Envelopes</h3>
                        <div id="modal-manage-envelope-list" class="space-y-2 mt-2"></div>
                    </div>
                    <div id="modal-manage-container-saving" class="hidden">
                        <h3 class="text-lg font-medium text-gray-800" data-i18n="modalManageTypeSaving">Savings</h3>
                        <div id="modal-manage-saving-list" class="space-y-2 mt-2"></div>
                    </div>
                    <div id="modal-manage-container-debt" class="hidden">
                        <h3 class="text-lg font-medium text-gray-800" data-i18n="modalManageTypeDebt">Debts</h3>
                        <div id="modal-manage-debt-list" class="space-y-2 mt-2"></div>
                    </div>
                    <p id="modal-manage-envelopes-empty" class="text-gray-500">No "Envelope" or "Goal" categories found.</p>
                </div>
            </div>
            
        </div>
    </div>

    <div id="toast"
        class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 translate-y-4 transition-all duration-300 z-[9999]">
        <span id="toast-message">Saved!</span>
    </div>

    <!-- Custom Bunny SVG Icons (used in JS) -->
    <svg width="0" height="0" class="hidden">
        <defs>
            <!-- Delete Icon -->
            <svg id="icon-delete" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="1.5" stroke="currentColor" class="bunny-icon-sm">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.518 0A48.108 48.108 0 017.5 5.392m0 0A48.068 48.068 0 0112 5.25c2.148 0 4.217.3 6.21.879m-6.21-.879C11.332 5.11 10.152 5 9 5c-1.152 0-2.332.11-3.478.397m12.518 0C16.92 5.71 15.688 6 14.25 6c-1.438 0-2.67-.11-3.75-.397" />
            </svg>
            <!-- Edit Icon -->
            <svg id="icon-edit" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="1.5" stroke="currentColor" class="bunny-icon-sm">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6.17 18a.75.75 0 01-.9- .9l.79-2.513a4.5 4.5 0 011.13-1.897l8.93-8.93z" />
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M19.5 12.572l-4.5-4.5" />
            </svg>
            <!-- Rabbit Icon for Sinking Fund -->
            <svg id="icon-sinking-goal" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                class="bunny-icon-sm">
                <path
                    d="M12.6,6.3c0-0.8-0.7-1.5-1.5-1.5H12c-0.8,0-1.5,0.7-1.5,1.5v0c0,0.8,0.7,1.5,1.5,1.5h-0.1C11.9,7.8,12.6,7.1,12.6,6.3z M15.6,6.3c0-0.8-0.7-1.5-1.5-1.5h-0.1c-0.8,0-1.5,0.7-1.5,1.5v0c0,0.8,0.7,1.5,1.5,1.5h0C14.9,7.8,15.6,7.1,15.6,6.3z M9,12c-0.8,0-1.5,0.7-1.5,1.5S7.7,15,8.5,15S10,14.3,10,13.5S9.8,12,9,12z M15.5,15c0.8,0,1.5-0.7,1.5-1.5s-0.7-1.5-1.5-1.5s-1.5,0.7-1.5,1.5S14.7,15,15.5,15z M21.4,11.5c-0.2-1.2-0.6-2.4-1.2-3.5c-1.2-2-3-3.2-5.1-3.7C14.3,2.9,13.2,2,12,2s-2.3,0.9-3.1,2.2c-2.1,0.5-3.9,1.7-5.1,3.7C3.1,8,2.7,9.1,2.6,10.4C2.5,10.9,2.5,11.4,2.5,12c0,4.1,2.7,7.7,6.4,8.7c1.1,0.3,2.2,0.4,3.1,0.4c1,0,2.1-0.1,3.1-0.4c3.8-1,6.4-4.5,6.4-8.7C21.5,11.9,21.5,11.7,21.4,11.5z M19.5,12c0,3.6-2.2,6.7-5.4,7.5c-0.9,0.2-1.8,0.3-2.1,0.3c-0.4,0-1.2-0.1-2.1-0.3C6.7,18.7,4.5,15.6,4.5,12c0-0.5,0-0.7,0.1-1.2c0.2-1,0.5-1.9,1-2.8c0.9-1.5,2.3-2.5,4-3c0.3,1,1.2,1.8,2.4,1.8s2.1-0.8,2.4-1.8c1.7,0.5,3.1,1.5,4,3c0.5,0.9,0.8,1.8,1,2.8C19.5,11.3,19.5,11.5,19.5,12z" />
            </svg>
            <!-- Bill Icon for Fixed Cost -->
            <svg id="icon-fixed" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                class="bunny-icon-sm">
                <path fill-rule="evenodd"
                    d="M3.75 4.5a.75.75 0 01.75-.75h.75c.414 0 .75.336.75.75v1.5c0 .414-.336.75-.75.75H4.5a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75c.414 0 .75.336.75.75v1.5c0 .414-.336.75-.75.75H4.5a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75c.414 0 .75.336.75.75v1.5c0 .414-.336.75-.75.75H4.5a.75.75 0 01-.75-.75v-1.5zM8.25 4.5a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v-1.5zM12.75 4.5a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-1.5zM17.25 4.5a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-1.5zm0 6a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-1.5z"
                    clip-rule="evenodd" />
            </svg>
            <!-- Calendar Icon for Annual Bill -->
            <svg id="icon-sinking-bill" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                class="bunny-icon-sm">
                <path fill-rule="evenodd"
                    d="M6.75 2.25A.75.75 0 017.5 3v1.5h9V3A.75.75 0 0118 3v1.5h2.25a3 3 0 013 3v11.25a3 3 0 01-3 3H3.75a3 3 0 01-3-3V7.5a3 3 0 013-3H6V3a.75.75 0 01.75-.75zM3.75 7.5v11.25c0 .414.336.75.75.75h15a.75.75 0 00.75-.75V7.5h-16.5z"
                    clip-rule="evenodd" />
                <path
                    d="M10.5 10.5a.75.75 0 00-1.5 0v.75H7.5a.75.75 0 000 1.5h1.5V15a.75.75 0 001.5 0v-2.25H12a.75.75 0 000-1.5h-1.5v-.75zM16.5 10.5a.75.75 0 00-1.5 0v.75h-1.5a.75.75 0 000 1.5h1.5V15a.75.75 0 001.5 0v-2.25h1.5a.75.75 0 000-1.5h-1.5v-.75z" />
            </svg>
            <!-- Shopping Bag Icon for Variable -->
            <svg id="icon-variable" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                class="bunny-icon-sm">
                <path fill-rule="evenodd"
                    d="M7.5 6v.75H5.513c-.96 0-1.763.746-1.858 1.705L3.22 19.516A3 3 0 006.18 22.5h11.64a3 3 0 002.96-2.984l-.433-11.057a1.875 1.875 0 00-1.858-1.705H16.5V6a4.5 4.5 0 10-9 0zM12 3a3 3 0 00-3 3v.75h6V6a3 3 0 00-3-3zM9 15v-3.75a.75.75 0 011.5 0V15a.75.75 0 01-1.5 0zm4.5-3.75a.75.75 0 00-1.5 0V15a.75.75 0 001.5 0v-3.75z"
                    clip-rule="evenodd" />
            </svg>
            <!-- Debt Icon (Credit Card) -->
            <svg id="icon-debt-payment" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                class="bunny-icon-sm">
                <path
                    d="M18 10a.75.75 0 01-.75.75H6.75a.75.75 0 010-1.5h10.5a.75.75 0 01.75.75z" />
                <path fill-rule="evenodd"
                    d="M2.25 5.25A3 3 0 015.25 2.25h13.5A3 3 0 0121.75 5.25v13.5a3 3 0 01-3 3H5.25a3 3 0 01-3-3V5.25zM5.25 3.75a1.5 1.5 0 00-1.5 1.5v13.5a1.5 1.5 0 001.5 1.5h13.5a1.5 1.5 0 001.5-1.5V5.25a1.5 1.5 0 00-1.5-1.5H5.25z"
                    clip-rule="evenodd" />
                <path
                    d="M12.75 15a.75.75 0 01-.75.75H8.25a.75.75 0 010-1.5h3.75a.75.75 0 01.75.75z" />
            </svg>
            <!-- Debt Goal Icon (similar to sinking) -->
            <svg id="icon-debt-goal" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"
                class="bunny-icon-sm">
                <path
                    d="M18.364 18.364a9 9 0 00-12.728 0" />
                <path fill-rule="evenodd"
                    d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6.19l-2.47-2.47a.75.75 0 00-1.06 1.06l3.75 3.75a.75.75 0 001.06 0l3.75-3.75a.75.75 0 10-1.06-1.06l-2.47 2.47V6z"
                    clip-rule="evenodd" />
            </svg>
        </defs>
    </svg>

    <script type="module">
        // --- INTERNATIONALIZATION (i18n) ---
        const translations = {
            de: {
                penaltyWarning: "Warnung: FrÃ¼hes Abheben kostet 5 ðŸª™!",
                penaltyToast: "Du hast 5 ðŸª™ fÃ¼r frÃ¼hes Abheben verloren!",
                dashboardInflows: "EingÃ¤nge",
                modalWithdrawTitle: "Erspartes Nutzen",
                modalGoalTabSpend: "Ausgabe Erfassen",
                modalGoalTabTransfer: "Umbuchen",
                appTitle: "Bunny Budget",
                navDashboard: "Ãœbersicht",
                navManage: "Verwalten", // NEW
                navSettings: "Einst.", // Kept for reference
                navStats: "Statistik",
                navStore: "Shop", // NEW
                dashboardMoneyToBudget: "Zu Budgetieren",
                dashboardTotalBudgeted: "Gesamt Budgetiert",
                dashboardTotalSpent: "Gesamt Ausgegeben (Variabel)",
                dashboardVariableEnvelopes: "Ausgaben-UmschlÃ¤ge",
                dashboardNoVariable: "Noch keine Ausgaben-UmschlÃ¤ge budgetiert. Gehe zur 'Verwalten'-Seite, um welche hinzuzufÃ¼gen!", // MODIFIED
                dashboardSinkingFunds: "Sparziele",
                dashboardNoSinking: "Keine Sparziele. Gehe zur 'Verwalten'-Seite, um einen zu erstellen!", // MODIFIED
                dashboardDebtGoals: "Schuldenziele",
                dashboardNoDebtGoals: "Keine Tilgungsziele. Gehe zu 'Verwalten', um eines hinzuzufÃ¼gen.", // MODIFIED
                dashboardBillsTitle: "Rechnungen & Fixkosten",
                dashboardBillsEmpty: "Keine monatlichen Rechnungen oder Fixkosten. Gehe zu 'Verwalten', um eine hinzuzufÃ¼gen.",
                dashboardRemaining: "VerfÃ¼gbar",
                dashboardBudgeted: "Budgetiert",
                dashboardSpent: "Ausgegeben",
                dashboardOf: "von",
                dashboardTotalSaved: "Gesamt Gespart", // <-- FIX: Changed from "Assigned" to "Saved"
                dashboardTotalPaid: "Gesamt Bezahlt", // <-- NEW
                budgetIncomeTitle: "Einkommen",
                budgetRollover: "Ãœbertrag Ersparnisse",
                budgetAddIncome: "+ Hinzuf.",
                budgetOtherIncome: "Sonst. Einkommen",
                budgetTotalIncome: "Gesamteinkommen",
                budgetCostsTitle: "Fixkosten",
                budgetFixedCosts: "Rechnungen & Schulden",
                budgetMoneyToBudget: "Zu Budgetieren",
                budgetTotalAssigned: "Gesamt Zugewiesen",
                budgetRemainingToAssign: "Ãœbrig",
                budgetNoFixed: "Keine Fixkosten, Schulden oder Spar-Rechnungen.",
                budgetVariableEnvelopes: "Variable UmschlÃ¤ge",
                budgetNoVariable: "Keine variablen UmschlÃ¤ge. FÃ¼ge eine in 'Neue Kategorie HinzufÃ¼gen' hinzu.",
                budgetSinkingFundGoals: "Spartopf-Ziele",
                budgetNoSinking: "Keine Spartopf-Ziele. FÃ¼ge eine in 'Neue Kategorie HinzufÃ¼gen' hinzu.",
                budgetDebtGoals: "Schulden-Tilgungsziele",
                budgetNoDebtGoals: "Keine Tilgungsziele. FÃ¼ge eine in 'Neue Kategorie HinzufÃ¼gen' hinzu.",
                budgetOtherIncomeList: "Sonstige Einnahmen (Posten)",
                budgetNoOtherIncome: "Keine sonstigen Einnahmen fÃ¼r diesen Monat erfasst.",
                budgetLastMonth: "Zuletzt",
                budgetSave: "Monatsbudget Speichern",
                modalEditIncomeTitle: "Einkommen Bearbeiten",
                settingsMonthlySalary: "Monatsgehalt",
                settingsAddCategory: "Neue Kategorie HinzufÃ¼gen",
                settingsCategoryType: "Typ",
                settingsTypeVariable: "Variabler Umschlag",
                settingsTypeFixed: "Fixkosten",
                settingsTypeDebtPayment: "Schulden (Feste Zahlung)",
                settingsTypeSinkingBill: "Spartopf (Jhrl. Rechnung)",
                settingsTypeSinkingGoal: "Spartopf (Ziel)",
                settingsTypeDebtGoal: "Schulden (Tilgungsziel)",
                settingsCategoryName: "Name",
                settingsGoalAmount: "Gesamtziel (Optional)",
                settingsGoalDate: "Zieldatum (Optional)", // NEW
                settingsDefaultAmount: "Monatl. Zahlung (Optional)",
                goalDateLabel: "Zieldatum", // NEW
                suggestedContribution: "Empfohlen", // NEW
                settingsAddCategoryButton: "Kategorie HinzufÃ¼gen",
                modalEditCategoryTitle: "Kategorie Bearbeiten",
                settingsManageCategories: "Kategorien Verwalten",
                settingsNoFixed: "Keine Fixkosten. FÃ¼ge oben eine hinzu!",
                settingsNoDebtPayment: "Keine festen Schulden. FÃ¼ge oben eine hinzu!",
                settingsNoSinkingBill: "Keine jÃ¤hrlichen Spar-Rechnungen. FÃ¼ge oben eine hinzu!",
                settingsNoVariable: "Keine variablen UmschlÃ¤ge. FÃ¼ge oben eine hinzu!",
                settingsNoSinkingGoal: "Keine Spartopf-Ziele. FÃ¼ge oben eine hinzu!",
                settingsNoDebtGoal: "Keine Tilgungsziele. FÃ¼ge oben eine hinzu!",
                settingsHelpTitle: "Hilfe Erhalten",
                settingsHelpDesc: "Lerne, wie die App funktioniert, was die Begriffe bedeuten und wie man budgetiert.",
                settingsHelpButton: "Hilfe-Anleitung Anzeigen",
                settingsAppSettings: "App-Einstellungen",
                settingsLanguage: "Sprache",
                settingsCurrency: "WÃ¤hrung",
                settingsDangerZone: "Gefahrenzone",
                settingsResetSubtitle: "Dies lÃ¶scht dauerhaft alle deine Daten (Gehalt, Kategorien, Transaktionen) und startet die App neu.",
                settingsResetButton: "App ZurÃ¼cksetzen",
                helpHowToUseTitle: "Wie man Bunny Budget nutzt",
                helpHowToUseStep1Title: "1. Richte dein Budget ein",
                helpHowToUseStep1Desc: "Gehe zum Tab 'Verwalten'. Gib zuerst dein monatliches Gehalt ein. FÃ¼ge dann alle deine monatlichen Rechnungen (wie 'Miete' oder 'Internet') als 'Fixkosten' und alle monatlichen Schuldenzahlungen als 'Schulden (Feste Zahlung)' hinzu.", // MODIFIED
                helpHowToUseStep2Title: "2. FÃ¼ge deine Kategorien hinzu",
                helpHowToUseStep2Desc: "FÃ¼ge in 'Verwalten' deine Ausgabenkategorien (wie 'Lebensmittel' oder 'Tanken') als 'Variable UmschlÃ¤ge' hinzu. FÃ¼ge deine Sparziele (wie 'Urlaub') als 'Spartopf (Ziele)' oder 'Schulden (Tilgungsziele)' hinzu.", // MODIFIED
                helpHowToUseStep3Title: "3. Weise dein Geld zu",
                helpHowToUseStep3Desc: "Gehe zum Tab 'Verwalten'. FÃ¼ge 'Sonst. Einkommen' hinzu, das du diesen Monat erhalten hast. Die App zeigt dein 'Geld zu Budgetieren' (dein Gesamteinkommen minus aller Fixkosten, Schulden und JÃ¤hrl. Rechnungen). Weise dieses Geld deinen Variablen UmschlÃ¤gen und Sparzielen zu.", // MODIFIED
                helpHowToUseStep4Title: "4. Verfolge deine Ausgaben",
                helpHowToUseStep4Desc: "DrÃ¼cke auf dem 'Ãœbersicht'-Tab den groÃŸen 'pinken + Knopf', um eine Ausgabe hinzuzufÃ¼gen. WÃ¤hle den Umschlag, aus dem du ausgegeben hast, und sieh zu, wie der 'VerfÃ¼gbar'-Betrag sinkt.",
                helpHowToUseStep5Title: "5. Korrigiere Fehler",
                helpHowToUseStep5Desc: "Tippfehler gemacht? Klicke auf der 'Ãœbersicht' auf eine 'Variable Umschlag'-Karte (z.B. â€žLebensmittelâ€œ). Eine Liste aller Transaktionen wird angezeigt. Klicke auf eine Transaktion, um sie zu 'Bearbeiten' oder 'LÃ¶schen'.",
                helpTermsTitle: "Budget-Begriffe ErklÃ¤rt",
                helpTermSalaryTitle: "Gehalt",
                helpTermSalaryDesc: "Dein gesamtes *wiederkehrendes* monatliches Einkommen. Dies ist die Basis fÃ¼r dein Budget.",
                helpTermOtherIncomeTitle: "Sonst. Einkommen",
                helpTermOtherIncomeDesc: "Einmaliges oder variables Einkommen (wie ein Nebenjob oder ein verkaufter Artikel). FÃ¼ge dies auf der 'Verwalten'-Seite hinzu.", // MODIFIED
                helpTermFixedCostTitle: "Fixkosten",
                helpTermFixedCostDesc: "Eine Rechnung, die jeden Monat gleich hoch ist, wie Miete oder Internet. Diese wird bezahlt, *bevor* du budgetierst.",
                helpTermDebtPaymentTitle: "Schulden (Feste Zahlung)",
                helpTermDebtPaymentDesc: "Eine monatliche Zahlung fÃ¼r eine Schuld (wie ein Autokredit). Dies wird wie Fixkosten behandelt und *bevor* du budgetierst bezahlt.",
                helpTermSinkingBillTitle: "Spartopf (Jhrl. Rechnung)",
                helpTermSinkingBillDesc: "FÃ¼r nicht-monatliche Rechnungen (wie die jÃ¤hrliche Autoversicherung). Die App spart jeden Monat 1/12 der Kosten und behandelt es wie Fixkosten, damit du nie von der Rechnung Ã¼berrascht wirst.",
                helpTermMoneyToBudgetTitle: "Geld zu Budgetieren",
                helpTermMoneyToBudgetDesc: "Dies ist dein 'Gesamteinkommen' (Gehalt + Sonstiges) minus all deiner 'Fixkosten', 'Schulden (Feste Zahlungen)' und 'SpartÃ¶pfe (Rechnungen)'. Dies ist das Geld, das du auf der 'Verwalten'-Seite zuweisen kannst.", // MODIFIED
                helpTermVariableEnvelopeTitle: "Variabler Umschlag",
                helpTermVariableEnvelopeDesc: "Dein 'digitaler Umschlag' fÃ¼r monatliche Ausgaben, die sich Ã¤ndern, wie Lebensmittel, Tanken oder AuswÃ¤rts Essen. Du gibst mit dem '+'-Knopf daraus aus.",
                helpTermSinkingGoalTitle: "Spartopf (Ziel)",
                helpTermSinkingGoalDesc: "Dein 'digitaler Spar-Umschlag' fÃ¼r ein groÃŸes, optionales Ziel, wie Urlaub, Weihnachten oder einen Notgroschen. Du weist ihm Geld zu, aber gibst nicht daraus aus.",
                helpTermDebtGoalTitle: "Schulden (Tilgungsziel)",
                helpTermDebtGoalDesc: "Ein 'digitaler Umschlag', um eine Schuld schneller abzubezahlen (wie eine Kreditkarte). Du weist diesem Ziel zusÃ¤tzliches Geld von deinem 'Geld zu Budgetieren' zu.",
                modalAddExpenseTitle: "Ausgabe HinzufÃ¼gen",
                modalAddExpenseCategory: "Kategorie",
                modalAddExpenseAmount: "Betrag",
                modalAddExpenseDate: "Datum",
                modalAddIncomeTitle: "Sonst. Einkommen Hinzuf.",
                modalAddIncomeSource: "Quelle",
                modalAddIncomeSourcePlaceholder: "z.B. Nebenjob, Artikel verkauft",
                modalResetTitle: "Bist du sicher?",
                modalResetText: "Diese Aktion ist dauerhaft und lÃ¶scht alle deine Daten. Es gibt kein RÃ¼ckgÃ¤ngig.",
                modalResetConfirm: "Ja, App ZurÃ¼cksetzen",
                modalTxHistoryTitle: "Transaktionsverlauf",
                modalTxHistoryEmpty: "Keine Transaktionen fÃ¼r diese Kategorie gefunden.",
                modalEditTxTitle: "Transaktion Bearbeiten",
                modalDeleteTx: "Transaktion LÃ¶schen",
                cancel: "Abbrechen",
                save: "Speichern",
                toastSaved: "Gespeichert!",
                toastCategoryAdded: "Kategorie hinzugefÃ¼gt!",
                toastCategoryUpdated: "Kategorie aktualisiert!",
                toastCategoryDeleted: "Kategorie gelÃ¶scht!",
                toastBudgetSaved: "Budget gespeichert!",
                toastExpenseAdded: "Ausgabe hinzugefÃ¼gt!",
                toastIncomeAdded: "Einkommen hinzugefÃ¼gt!",
                toastIncomeDeleted: "Einnahmeposten gelÃ¶scht!",
                toastIncomeUpdated: "Einkommen aktualisiert!",
                toastSettingsSaved: "Einstellungen gespeichert!",
                toastReset: "App wurde zurÃ¼ckgesetzt.",
                toastTxUpdated: "Transaktion aktualisiert!",
                toastTxDeleted: "Transaktion gelÃ¶scht!",
                toastNewMonth: "Willkommen in einem neuen Monat! Dein Budget wurde zurÃ¼ckgesetzt.",
                onboardingCurrencyTitle: "WÃ¤hrung AuswÃ¤hlen",
                onboardingCurrencySubtitle: "WÃ¤hle deine StandardwÃ¤hrung.",
                onboardingTemplateTitle: "Starte Dein Budget",
                onboardingTemplateSubtitle: "Du kannst mit unserer Vorlage oder bei Null anfangen.",
                onboardingHelpButton: "Wie funktioniert das? Lies die Anleitung",
                onboardingUseTemplate: "Mit Vorlage Starten",
                onboardingStartFresh: "Neu Starten",
                onboardingTryDemo: "Demo Testen", // <-- ADD THIS
                onboardingRestore: "Aus Backup Wiederherstellen",
                back: "ZurÃ¼ck",
                next: "Weiter",
                thisMonth: "diesen Monat",
                statsTitle: "Statistik & Verlauf",
                statsTotalCoins: "Bunny Coins Gesamt",
                statsHistory: "Ãœbertragsverlauf",
                statsNoHistory: "Noch kein Verlauf. Spare etwas Geld, um Coins zu verdienen!",
                statsEntry: "Coins verdient mit",
                onboardingLanguageTitle: "Sprache WÃ¤hlen",
                onboardingLanguageSubtitle: "WÃ¤hle deine bevorzugte Sprache.",
                storeTitle: "Bunny Shop", // NEW
                storeComingSoon: "Der Bunny Shop kommt bald! Gib deine ðŸª™ fÃ¼r lustige neue Designs und Icons aus.", // NEW
                
                // --- NEW v3.0 Keys (Refactor) ---
                modalAddTransactionTitle: "Transaktion HinzufÃ¼gen",
                modalAddExpenseButton: "Ausgabe HinzufÃ¼gen",
                modalAddIncomeButton: "Einkommen HinzufÃ¼gen",
                installPwaButton: "App Installieren",
                modalAddExpenseNotes: "Notizen (Optional)",
                modalAddExpenseNotesPlaceholder: "z.B. Geburtstagsgeschenk",
                modalEditTxNotesPlaceholder: "z.B. Geburtstagsgeschenk",
                
                assignTitle: "Geld Zuweisen",
                assignEnvelopes: "UmschlÃ¤ge FÃ¼llen",
                assignSinking: "Sparziele Besparen",
                assignDebt: "Schulden Bezahlen",
                
                setupManageTitle: "Setup & Verwaltung",
                manageCategoriesButton: "Alle Kategorien Verwalten",
                modalManageCategoriesTitle: "Kategorien Verwalten",
                modalManageTabBills: "Fixkosten & Rechnungen",
                modalManageTabEnvelopes: "UmschlÃ¤ge & Ziele",
                // --- End NEW v3.0 Keys ---
                
                // --- NEW v3.1 Keys (Hardcode Fix) ---
                remaining: "Restbetrag",
                saving: "Speichern...",
                saved: "Gespeichert!",
                statsMonthlyAnalysis: "Monatliche Analyse",
                statsIncomeVsSpend: "Einnahmen vs. Ausgaben vs. Ersparnisse",
                statsCompareCategory: "Kategorie Vergleichen",
                statsCompareCategoryDesc: "WÃ¤hle eine Kategorie, um ihren Verlauf zu sehen.",
                statsSelectCategory: "WÃ¤hle eine Kategorie...",
                modalHistoryTitle: "Verlauf",
                modalGoalHistoryTitle: "Ziel-Verlauf",
                modalGoalCurrentBalance: "Aktueller Saldo",
                modalGoalWithdrawButton: "Geld Abheben",
                modalGoalSpendDesc: "Erfasse eine Ausgabe, die <strong>direkt</strong> von diesem Sparziel bezahlt wurde (z.B. Flugtickets vom 'Urlaub'-Topf).",
                modalGoalTransferDesc: "Verschiebe Geld <strong>aus</strong> diesem Ziel <strong>in</strong> einen deiner monatlichen Ausgaben-UmschlÃ¤ge (z.B. 'Lebensmittel').",
                modalGoalLogExpense: "Ausgabe Buchen",
                modalGoalTransferFunds: "Geld Verschieben",
                toastInvalidDate: "UngÃ¼ltiges Datum.",
                toastInvalidAmountDate: "UngÃ¼ltiger Betrag oder Datum.",
                toastInvalidSourceAmount: "UngÃ¼ltige Quelle oder Betrag.",
                toastErrorDeleteIncome: "Fehler beim LÃ¶schen der Einnahme.",
                toastErrorDeleteCategory: "Fehler beim LÃ¶schen der Kategorie.",
                toastEnterCategoryName: "Bitte gib einen Kategorienamen ein.",
                toastResetFailed: "ZurÃ¼cksetzen fehlgeschlagen. Bitte lade die App neu.",
                toastWithdrawLimit: "Du kannst nicht mehr abheben als im Topf ist.",
                toastExpenseLogged: "Ausgabe vom Ziel gebucht!",
                toastInvalidTransfer: "UngÃ¼ltiger Betrag, Datum oder Kategorie.",
                toastFundsTransferred: "Geld zum Umschlag verschoben!",
                statsChartSpentIn: "Ausgegeben in",
                statsChartSavedIn: "Gespart in",
                statsChartPaidFor: "Bezahlt fÃ¼r",
                // --- NEW v3.2 Keys (Category Simplification) ---
                addCategoryTitle: "Neue Kategorie HinzufÃ¼gen",
                categoryTypeLabel: "WÃ¤hle einen Typ",
                categoryTypeBill: "Rechnung",
                categoryTypeBillDesc: "Wiederkehrende Kosten (z.B. Miete, Strom, Auto-Rate)",
                categoryTypeEnvelope: "Umschlag",
                categoryTypeEnvelopeDesc: "Flexible Ausgaben (z.B. Lebensmittel, Tanken)",
                categoryTypeSaving: "Sparen",
                categoryTypeSavingDesc: "Geld fÃ¼r positive Ziele beiseitelegen (z.B. Urlaub)",
                categoryTypeDebt: "Schulden",
                categoryTypeDebtDesc: "Geld zur Abzahlung von Schulden (z.B. Kreditkarte)",
                categoryNameLabel: "Name der Kategorie",
                categoryMonthlyAmountLabel: "Geplanter Betrag",
                categoryMonthlyAmountDesc: "Wieviel planst du, diesen Monat zuzuweisen?",
                categoryOptionalFields: "Optionale Details",
                categoryTotalGoalLabel: "Gesamtziel / SchuldenhÃ¶he",
                categoryCurrentBalanceLabel: "Aktueller Saldo / Bereits Gespart",
                // --- NEW v4.0 Keys (Backup/Restore) ---
                settingsDataManagement: "Datenverwaltung",
                settingsBackupDesc: "Speichere all deine Daten in einer .json-Datei. Bewahre diese Datei sicher auf, um dein Budget spÃ¤ter wiederherzustellen.",
                settingsBackupButton: "Backup Erstellen (.json)",
                settingsRestoreButton: "Backup Wiederherstellen",
                toastBackupSuccess: "Backup-Datei wird heruntergeladen!",
                toastRestoreSuccess: "Daten erfolgreich wiederhergestellt! App wird neu geladen.",
                toastRestoreError: "Fehler: UngÃ¼ltige oder beschÃ¤digte Backup-Datei.",
                settingsTabGeneral: "Allgemein",
                settingsTabData: "Backup",
                settingsTabExport: "Export",
                settingsTabHelp: "Hilfe",
                settingsTabDanger: "Gefahr",
                settingsExportCSVButton: "Transaktionen Exportieren (.csv)",
                settingsExportCategoriesButton: "Kategorien & Ziele Exportieren (.csv)",
                settingsExportSummariesButton: "MonatsÃ¼bersichten Exportieren (.csv)",
                toastExportSuccess: "Transaktionen werden als CSV-Datei heruntergeladen!",
                toastExportCategoriesSuccess: "Kategorien & Ziele werden als CSV-Datei heruntergeladen!",
                toastExportSummariesSuccess: "MonatsÃ¼bersichten werden als CSV-Datei heruntergeladen!",
                toastExportError: "Export fehlgeschlagen.",
                modalManageTypeBill: "Rechnungen",
                modalManageTypeEnvelope: "UmschlÃ¤ge",
                modalManageTypeSaving: "Sparen",
                modalManageTypeDebt: "Schulden",
                dashboardThisMonth: "Dieser Monat",
                // --- END NEW v4.0 Keys ---
                // --- NEW v3.3 Keys (Collapsible UI) ---
                assignBills: "Rechnungen Zuweisen",
                assignEnvelopes: "UmschlÃ¤ge FÃ¼llen",
                assignSavings: "Sparziele Besparen",
                assignDebts: "Schulden Bezahlen",
                // --- End NEW v3.3 Keys ---
            },
            en: {
                penaltyWarning: "Warning: Withdrawing early will cost 5 ðŸª™!",
                penaltyToast: "You lost 5 ðŸª™ for withdrawing early!",
                dashboardInflows: "Inflows",
                modalWithdrawTitle: "Use Savings",
                modalGoalTabSpend: "Record an Expense",
                modalGoalTabTransfer: "Move to Spending",
                appTitle: "Bunny Budget",
                navDashboard: "Dashboard",
                navManage: "Manage", // NEW
                navSettings: "Settings", // Kept for reference
                navStats: "Stats",
                navStore: "Store", // NEW
                dashboardMoneyToBudget: "Money to Budget",
                dashboardTotalBudgeted: "Total Budgeted",
                dashboardTotalSpent: "Total Spent On Envelopes",
                dashboardTotalSpentAll: "Total Monthly Spending", // <-- ADD THIS
                demoMode: "Demo Mode", // <-- ADD THIS
                demoModeResets: "Resets in", // <-- ADD THIS
                dashboardVariableEnvelopes: "Spending Envelopes",
                dashboardNoVariable: "No spending envelopes budgeted yet. Go to the 'Manage' page to add some!", // MODIFIED
                dashboardSinkingFunds: "Savings Goals",
                dashboardNoSinking: "No savings goals. Go to the 'Manage' page to create one!", // MODIFIED
                dashboardDebtGoals: "Debt Goals",
                dashboardNoDebtGoals: "No debt goals. Go to 'Manage' to add one.", // MODIFIED
                dashboardBillsTitle: "Bills & Fixed Debts",
                dashboardBillsEmpty: "No monthly bills or fixed debts. Go to 'Manage' to add one.",
                dashboardRemaining: "Available",
                dashboardBudgeted: "Budgeted",
                dashboardSpent: "Spent",
                dashboardOf: "of",
                dashboardTotalSaved: "Total Saved", // <-- FIX: Changed from "Assigned" to "Saved"
                dashboardTotalPaid: "Total Paid", // <-- NEW
                budgetIncomeTitle: "Income",
                budgetRollover: "Rollover Savings",
                budgetAddIncome: "+ Add",
                budgetOtherIncome: "Other Income",
                budgetTotalIncome: "Total Income",
                budgetCostsTitle: "Fixed Costs",
                budgetFixedCosts: "Bills & Debts",
                budgetMoneyToBudget: "Money to Budget",
                budgetTotalAssigned: "Total Assigned",
                budgetRemainingToAssign: "Remaining",
                budgetNoFixed: "No fixed costs, debts, or sinking fund bills.",
                budgetVariableEnvelopes: "Variable Envelopes",
                budgetNoVariable: "No variable envelopes. Add one in 'Add New Category' below.",
                budgetSinkingFundGoals: "Sinking Fund Goals",
                budgetNoSinking: "No sinking fund goals. Add one in 'Add New Category' below.",
                budgetDebtGoals: "Debt Paydown Goals",
                budgetNoDebtGoals: "No debt paydown goals. Add one in 'Add New Category' below.",
                budgetOtherIncomeList: "Other Income Items",
                budgetNoOtherIncome: "No other income added this month.",
                budgetLastMonth: "Last",
                budgetSave: "Save Monthly Budget",
                modalEditIncomeTitle: "Edit Income",
                settingsMonthlySalary: "Monthly Salary",
                settingsAddCategory: "Add New Category",
                settingsCategoryType: "Type",
                settingsTypeVariable: "Variable Envelope",
                settingsTypeFixed: "Fixed Cost",
                settingsTypeDebtPayment: "Debt (Fixed Payment)",
                settingsTypeSinkingBill: "Sinking Fund (Annual Bill)",
                settingsTypeSinkingGoal: "Sinking Fund (Goal)",
                settingsTypeDebtGoal: "Debt (Paydown Goal)",
                settingsCategoryName: "Name",
                settingsGoalAmount: "Total Goal (Optional)",
                settingsGoalDate: "Goal Date (Optional)", // NEW
                settingsDefaultAmount: "Monthly Payment (Optional)",
                goalDateLabel: "Goal Date", // NEW
                suggestedContribution: "Suggested", // NEW
                settingsAddCategoryButton: "Add Category",
                modalEditCategoryTitle: "Edit Category",
                settingsManageCategories: "Manage Categories",
                settingsNoFixed: "No fixed costs. Add one above!",
                settingsNoDebtPayment: "No fixed debts. Add one above!",
                settingsNoSinkingBill: "No annual bill sinking funds. Add one above!",
                settingsNoVariable: "No variable envelopes. Add one above!",
                settingsNoSinkingGoal: "No sinking fund goals. Add one above!",
                settingsNoDebtGoal: "No debt paydown goals. Add one above!",
                settingsHelpTitle: "Get Help",
                settingsHelpDesc: "Learn how to use the app, what the terms mean, and how to budget.",
                settingsHelpButton: "View Help Guide",
                settingsAppSettings: "App Settings",
                settingsLanguage: "Language",
                settingsCurrency: "Currency",
                settingsDangerZone: "Danger Zone",
                settingsResetSubtitle: "This will permanently delete all your data (salary, categories, transactions) and restart the app.",
                settingsResetButton: "Reset App",
                helpHowToUseTitle: "How to Use Bunny Budget",
                helpHowToUseStep1Title: "1. Setup Your Budget",
                helpHowToUseStep1Desc: "Go to the Manage tab. First, enter your monthly Salary. Then, add all your monthly bills (like 'Rent' or 'Internet') as Fixed Costs and any monthly debt payments as Debts (Fixed Payment).", // MODIFIED
                helpHowToUseStep2Title: "2. Add Your Categories",
                helpHowToUseStep2Desc: "In Manage, add your spending categories (like 'Groceries' or 'Gas') as Variable Envelopes. Add your savings goals (like 'Vacation') as Sinking Fund (Goals) or Debt (Paydown Goals).", // MODIFIED
                helpHowToUseStep3Title: "3. Assign Your Money",
                helpHowToUseStep3Desc: "Go to the Manage tab. Add any Other Income you received this month. The app shows your 'Money to Budget' (your Total Income minus all Fixed Costs, Debts, and Annual Bills). Assign this money into your Variable Envelopes and savings goals.", // MODIFIED
                helpHowToUseStep4Title: "4. Track Your Spending",
                helpHowToUseStep4Desc: "On the Dashboard tab, press the big pink '+' button to add an expense. Select the envelope you spent from, and watch the 'Remaining' amount go down.",
                helpHowToUseStep5Title: "5. Fix Mistakes",
                helpHowToUseStep5Desc: "Made a typo? On the Dashboard, click the Variable Envelope card (e.g., \"Groceries\"). A list of all transactions will appear. Click a transaction to Edit or Delete it.",
                helpTermsTitle: "Budgeting Terms Explained",
                helpTermSalaryTitle: "Salary",
                helpTermSalaryDesc: "Your total *recurring* monthly income. This is the baseline for your budget.",
                helpTermOtherIncomeTitle: "Other Income",
                helpTermOtherIncomeDesc: "One-time or variable income (like a side job or selling an item). Add this on the **Manage** page.", // MODIFIED
                helpTermFixedCostTitle: "Fixed Cost",
                helpTermFixedCostDesc: "A bill that is the same amount every month, like Rent or Internet. This is paid *before* you budget.",
                helpTermDebtPaymentTitle: "Debt (Fixed Payment)",
                helpTermDebtPaymentDesc: "A monthly payment for a debt (like a car loan). This is treated like a Fixed Cost and is paid *before* you budget.",
                helpTermSinkingBillTitle: "Sinking Fund (Annual Bill)",
                helpTermSinkingBillDesc: "For non-monthly bills (like annual car insurance or a quarterly tax). The app saves 1/12th of the cost every month, treating it like a Fixed Cost so you're never surprised by the bill.",
                helpTermMoneyToBudgetTitle: "Money to Budget",
                helpTermMoneyToBudgetDesc: "This is your Total Income (Salary + Other) minus all your Fixed Costs, Debts (Fixed Payments), and Sinking Fund (Bills). This is the money you get to assign on the Manage page.", // MODIFIED
                helpTermVariableEnvelopeTitle: "Variable Envelope",
                helpTermVariableEnvelopeDesc: "Your 'digital envelope' for monthly spending that changes, like Groceries, Gas, or Dining Out. You spend from these using the '+' button.",
                helpTermSinkingGoalTitle: "Sinking Fund (Goal)",
                helpTermSinkingGoalDesc: "Your 'digital savings envelope' for a big, optional goal, like Vacation, Christmas, or an Emergency Fund. You assign money to it, but you don't spend from it.",
                helpTermDebtGoalTitle: "Debt (Paydown Goal)",
                helpTermDebtGoalDesc: "A 'digital envelope' to pay off a debt faster (like a credit card). You assign extra money from your 'Money to Budget' to this goal.",
                modalAddExpenseTitle: "Add Expense",
                modalAddExpenseCategory: "Category",
                modalAddExpenseAmount: "Amount",
                modalAddExpenseDate: "Date",
                modalAddIncomeTitle: "Add Other Income",
                modalAddIncomeSource: "Source",
                modalAddIncomeSourcePlaceholder: "e.g. Side Job, Sold item",
                modalResetTitle: "Are you sure?",
                modalResetText: "This action is permanent and will delete all your data. There is no undo.",
                modalResetConfirm: "Yes, Reset App",
                modalTxHistoryTitle: "Transaction History",
                modalTxHistoryEmpty: "No transactions found for this category.",
                modalEditTxTitle: "Edit Transaction",
                modalDeleteTx: "Delete Transaction",
                cancel: "Cancel",
                save: "Save",
                toastSaved: "Saved!",
                toastCategoryAdded: "Category added!",
                toastCategoryUpdated: "Category updated!",
                toastCategoryDeleted: "Category deleted!",
                toastBudgetSaved: "Budget saved!",
                toastExpenseAdded: "Expense added!",
                toastIncomeAdded: "Income added!",
                toastIncomeDeleted: "Income item deleted!",
                toastIncomeUpdated: "Income updated!",
                toastSettingsSaved: "Settings saved!",
                toastReset: "App has been reset.",
                toastTxUpdated: "Transaction updated!",
                toastTxDeleted: "Transaction deleted!",
                toastNewMonth: "Welcome to a new month! Your budget has been reset.",
                onboardingCurrencyTitle: "Select Currency",
                onboardingCurrencySubtitle: "Choose your default currency.",
                onboardingTemplateTitle: "Start Your Budget",
                onboardingTemplateSubtitle: "You can start with our template or from scratch.",
                onboardingHelpButton: "How does this work? Read the guide",
                onboardingUseTemplate: "Start with Template",
                onboardingStartFresh: "Start Fresh",
                onboardingTryDemo: "Try a Demo", // <-- ADD THIS
                onboardingRestore: "Restore from Backup",
                back: "Back",
                next: "Next",
                thisMonth: "this month",
                statsTitle: "Stats & History",
                statsTotalCoins: "Total Bunny Coins",
                statsHistory: "Rollover History",
                statsNoHistory: "No history yet. Save some money to earn coins!",
                statsEntry: "coins earned from",
                onboardingLanguageTitle: "Select Language",
                onboardingLanguageSubtitle: "Choose your preferred language.",
                storeTitle: "Bunny Store", // NEW
                storeComingSoon: "The Bunny Store is coming soon! Spend your ðŸª™ on fun new themes and icons.", // NEW

                // --- NEW v3.0 Keys (Refactor) ---
                modalAddTransactionTitle: "Add Transaction",
                modalAddExpenseButton: "Add Expense",
                modalAddIncomeButton: "Add Income",
                installPwaButton: "Install App to Home Screen",
                modalAddExpenseNotes: "Notes (Optional)",
                modalAddExpenseNotesPlaceholder: "e.g. Birthday gift for mom",
                modalEditTxNotesPlaceholder: "e.g. Birthday gift for mom",

                assignTitle: "Assign Your Money",
                assignEnvelopes: "Fill Your Envelopes",
                assignSinking: "Contribute to Savings Goals",
                assignDebt: "Make Extra Debt Payments",

                setupManageTitle: "Setup & Manage",
                manageCategoriesButton: "Manage All Categories",
                modalManageCategoriesTitle: "Manage Categories",
                modalManageTabBills: "Income & Bills",
                modalManageTabEnvelopes: "Envelopes & Goals",
                // --- End NEW v3.0 Keys ---
                
                // --- NEW v3.1 Keys (Hardcode Fix) ---
                remaining: "Remaining",
                saving: "Saving...",
                saved: "Saved!",
                statsMonthlyAnalysis: "Monthly Analysis",
                statsIncomeVsSpend: "Income vs. Spend vs. Savings",
                statsCompareCategory: "Compare a Category",
                statsCompareCategoryDesc: "Select a category to see its history.",
                statsSelectCategory: "Select a category...",
                modalHistoryTitle: "History",
                modalGoalHistoryTitle: "Goal History",
                modalGoalCurrentBalance: "Current Balance",
                modalGoalWithdrawButton: "Withdraw Funds",
                modalGoalSpendDesc: "Record an expense paid for directly from this savings goal (e.g., buying plane tickets from your 'Vacation' fund).",
                modalGoalTransferDesc: "Move money out of this goal and into one of your monthly spending envelopes (like 'Groceries' or 'Dining Out').",
                modalGoalLogExpense: "Log Expense",
                modalGoalTransferFunds: "Transfer Funds",
                toastInvalidDate: "Invalid date.",
                toastInvalidAmountDate: "Invalid amount or date.",
                toastInvalidSourceAmount: "Invalid source or amount.",
                toastErrorDeleteIncome: "Error deleting income item.",
                toastErrorDeleteCategory: "Error deleting category.",
                toastEnterCategoryName: "Please enter a category name.",
                toastResetFailed: "Reset failed. Please try reloading the app.",
                toastWithdrawLimit: "Cannot withdraw more than the goal balance.",
                toastExpenseLogged: "Expense logged from goal!",
                toastInvalidTransfer: "Invalid amount, date, or category.",
                toastFundsTransferred: "Funds transferred to envelope!",
                statsChartSpentIn: "Spent in",
                statsChartSavedIn: "Saved in",
                statsChartPaidFor: "Paid for",
                // --- NEW v3.2 Keys (Category Simplification) ---
                addCategoryTitle: "Add New Category",
                categoryTypeLabel: "Choose a Type",
                categoryTypeBill: "Bill",
                categoryTypeBillDesc: "Recurring costs (e.g., Rent, Utilities, Car Payment)",
                categoryTypeEnvelope: "Envelope",
                categoryTypeEnvelopeDesc: "Flexible spending (e.g., Groceries, Gas)",
                categoryTypeSaving: "Saving",
                categoryTypeSavingDesc: "Set money aside for positive goals (e.g., Vacation)",
                categoryTypeDebt: "Debt",
                categoryTypeDebtDesc: "Pay down what you owe (e.g., Credit Card)",
                categoryNameLabel: "Category Name",
                categoryMonthlyAmountLabel: "Monthly Planned Amount",
                categoryMonthlyAmountDesc: "How much you plan to assign this month.",
                categoryOptionalFields: "Optional Details",
                categoryTotalGoalLabel: "Total Goal / Debt Amount",
                categoryCurrentBalanceLabel: "Current Balance / Already Saved",
                // --- NEW v4.0 Keys (Backup/Restore) ---
                settingsDataManagement: "Data Management",
                settingsBackupDesc: "Save all your data to a .json file. Keep this file safe to restore your budget later.",
                settingsBackupButton: "Create Backup (.json)",
                settingsRestoreButton: "Restore from Backup",
                toastBackupSuccess: "Backup file downloading!",
                toastRestoreSuccess: "Data restored successfully! Reloading app.",
                toastRestoreError: "Error: Invalid or corrupt backup file.",
                settingsTabGeneral: "General",
                settingsTabData: "Backup",
                settingsTabExport: "Export",
                settingsTabHelp: "Help",
                settingsTabDanger: "Danger",
                settingsExportCSVButton: "Export Transactions (.csv)",
                settingsExportCategoriesButton: "Export Categories & Goals (.csv)",
                settingsExportSummariesButton: "Export Monthly Summaries (.csv)",
                toastExportSuccess: "Transactions downloading as .csv!",
                toastExportCategoriesSuccess: "Categories & Goals downloading as .csv!",
                toastExportSummariesSuccess: "Monthly Summaries downloading as .csv!",
                modalManageTypeBill: "Bills",
                modalManageTypeEnvelope: "Envelopes",
                modalManageTypeSaving: "Savings",
                modalManageTypeDebt: "Debts",
                toastExportError: "Export failed.",
                dashboardThisMonth: "This Month",
                // --- END NEW v4.0 Keys ---
                // --- NEW v3.3 Keys (Collapsible UI) ---
                assignBills: "Assign to Bills",
                assignEnvelopes: "Fill Envelopes",
                assignSavings: "Contribute to Savings",
                assignDebts: "Pay Down Debts",
                // --- End NEW v3.3 Keys ---
            }
        };

        const i18n = {
            lang: 'en', // Default language
            currency: 'â‚¬', // Default currency
            currencySymbolDisplay: 'â‚¬ EUR',
            formattingLocale: 'de-DE', // NEW: For number formatting
            fractionDigits: 2, // NEW: For number formatting
            translationStore: { ...translations }, // Store for all loaded translations

            /**
             * Initializes i18n.
             */
            init() {
                // Try to get language from localStorage, fallback to 'en'
                try {
                    this.lang = localStorage.getItem('bunnyBudgetLanguage') || 'en';
                } catch (e) {
                    this.lang = 'en';
                }
                
                // Try to get currency from localStorage, fallback to defaults
                try {
                    this.currency = localStorage.getItem('bunnyBudgetCurrency') || 'â‚¬';
                    this.currencySymbolDisplay = localStorage.getItem('bunnyBudgetCurrencySymbol') || 'â‚¬ EUR';
                    this.formattingLocale = localStorage.getItem('bunnyBudgetLocale') || 'de-DE';
                    this.fractionDigits = parseInt(localStorage.getItem('bunnyBudgetDigits') || '2', 10);
                } catch (e) {
                    this.currency = 'â‚¬';
                    this.currencySymbolDisplay = 'â‚¬ EUR';
                    this.formattingLocale = 'de-DE';
                    this.fractionDigits = 2;
                }

                this.translateAll();
                this.updateCurrencyDisplays();
            },

            setLanguage(lang, doTranslate = true) {
                this.lang = lang;
                try {
                    localStorage.setItem('bunnyBudgetLanguage', lang);
                } catch (e) { }
                
                if (doTranslate) {
                    this.translateAll();
                }
                // Update dropdown
                const langSelect = document.getElementById('language-select');
                if (langSelect) langSelect.value = lang;
            },

            setCurrency(currency, currencySymbol, locale, digits) {
                this.currency = currency;
                this.currencySymbolDisplay = currencySymbol;
                this.formattingLocale = locale;
                this.fractionDigits = parseInt(digits, 10);
                
                try {
                    localStorage.setItem('bunnyBudgetCurrency', currency);
                    localStorage.setItem('bunnyBudgetCurrencySymbol', currencySymbol);
                    localStorage.setItem('bunnyBudgetLocale', locale);
                    localStorage.setItem('bunnyBudgetDigits', digits);
                } catch (e) { }
                
                this.updateCurrencyDisplays();
                // Update dropdown
                const currencySelect = document.getElementById('currency-select-settings');
                if (currencySelect) currencySelect.value = currency;
            },

            t(key) {
                // Pull from current language, fallback to English
                return (this.translationStore[this.lang] && this.translationStore[this.lang][key]) || this.translationStore['en'][key] || key;
            },

            translateAll() {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    const translation = this.t(key);
                    if (el.tagName === 'INPUT' && (el.type === 'number' || el.type === 'text' || el.type === 'date') || el.tagName === 'TEXTAREA') {
                        if (el.placeholder) {
                            el.placeholder = translation;
                        }
                    } else {
                        el.textContent = translation;
                    }
                });
            },

            updateCurrencyDisplays() {
                document.querySelectorAll('#salary-currency-symbol, #category-currency-symbol, #expense-currency-symbol, #edit-tx-currency-symbol, #income-currency-symbol, #category-goal-currency-symbol, #edit-income-currency-symbol, #edit-category-currency-symbol, #edit-category-goal-currency-symbol').forEach(el => {
                    if (el) el.textContent = this.currency;
                });
            }
        };

        // --- DATABASE (IndexedDB) ---
        const dbStore = {
            db: null,
            dbName: "BunnyBudgetDB",
            version: 7, // NEW: Add goalTransactions store

            /**
             * Initialize the database
             */
            async initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = (event) => {
                        console.error("IndexedDB error:", request.error);
                        reject("IndexedDB error");
                    };

                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        const transaction = event.target.transaction; // Get transaction for migration
                        const oldVersion = event.oldVersion;

                        if (oldVersion < 1) {
                            // Version 1 setup
                            this.db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                            const txStore = this.db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                            txStore.createIndex('categoryId', 'categoryId', { unique: false });
                            this.db.createObjectStore('settings', { keyPath: 'key' });
                            this.db.createObjectStore('budget', { keyPath: 'id' });
                        }

                        if (oldVersion < 2) {
                            // Version 2 upgrade
                            const incomeStore = this.db.createObjectStore('otherIncome', { keyPath: 'id', autoIncrement: true });
                            incomeStore.createIndex('month', 'month', { unique: false });
                        }
                        
                        if (oldVersion < 3) {
                            // Version 3 upgrade (Phase 2: Rollover & Coins)
                            this.db.createObjectStore('envelopes', { keyPath: 'categoryId' });
                            this.db.createObjectStore('bunnyCoins', { keyPath: 'month' });
                        }
                        
                        if (oldVersion < 4) {
                            // Re-create bunnyCoins store to use a proper auto-incrementing key
                            if (this.db.objectStoreNames.contains('bunnyCoins')) {
                                this.db.deleteObjectStore('bunnyCoins');
                            }
                            const coinStore = this.db.createObjectStore('bunnyCoins', { keyPath: 'id', autoIncrement: true });
                            coinStore.createIndex('month', 'month', { unique: false });
                        }

                        if (oldVersion < 5) {
                            // Add 'notes' to transactions
                            // No migration needed, new optional property
                        }

                        if (oldVersion < 6) {
                            // Version 6: Add goalTransactions store
                            const goalTxStore = this.db.createObjectStore('goalTransactions', { keyPath: 'id', autoIncrement: true });
                            goalTxStore.createIndex('categoryId', 'categoryId', { unique: false });
                        }

                        if (oldVersion < 7) {
                            // Version 7: Add monthlySnapshots store
                            this.db.createObjectStore('monthlySnapshots', { keyPath: 'month' });
                        }
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                });
            },

            /**
             * Load the template data into the database
             * @param {string} lang - 'en' or 'de' (now just 'en')
             */
            async loadTemplateData() {
                // Today is Nov 6, 2025
                const template = {
                    settings: [
                        { key: 'salary', value: 2500 }
                    ],
                    categories: [
                        // --- NEW Type: "bill" ---
                        { type: 'bill', name: 'Rent', amount: 750 },
                        { type: 'bill', name: 'Car Insurance (Annual)', amount: 10 },
                        
                        // --- NEW Type: "envelope" ---
                        { type: 'envelope', name: 'Groceries', amount: 300 },
                        { type: 'envelope', name: 'Dining Out', amount: 50 },
                        { type: 'envelope', name: 'Gas/Transport', amount: 50 },

                        // --- NEW Type: "saving" ---
                        { type: 'saving', name: 'Vacation', amount: 75, goalAmount: 1500, goalDate: '2026-07-01' },
                        { type: 'saving', name: 'Emergency Fund', amount: 50 },
                        { type: 'saving', name: 'New PC', amount: 50, goalAmount: 1000, goalDate: '2025-10-01' },
                        
                        // --- NEW Type: "debt" ---
                        { type: 'debt', name: 'Car Loan', amount: 250, goalAmount: 17000 }, // Example Total Debt
                        { type: 'debt', name: 'Credit Card', amount: 50, goalAmount: 800 }, // Example Total Debt
                    ]
                };

                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject("DB not initialized");
                        return;
                    }

                    const transaction = this.db.transaction(['settings', 'categories'], 'readwrite');
                    const settingsStore = transaction.objectStore('settings');
                    const categoriesStore = transaction.objectStore('categories');

                    // Add settings
                    template.settings.forEach(item => {
                        settingsStore.put(item);
                    });

                    // Add categories
                    template.categories.forEach(item => {
                        categoriesStore.add(item);
                    });

                    transaction.oncomplete = () => {
                        console.log("Template data loaded.");
                        resolve();
                    };

                    transaction.onerror = (event) => {
                        console.error("Error loading template data:", event.target.error);
                        reject(event.target.error);
                    };
                });
            },

            /**
             * NEW: Load demo data (snapshots, coins, envelopes)
             * This runs *after* loadTemplateData, so categories already exist.
             * @param {Array<object>} categories - The categories created by loadTemplateData
             */
            async loadDemoSnapshots(categories) {
                // 1. Create a map of category names to their new IDs
                const idMap = new Map(categories.map(c => [c.name, c.id]));
                
                // 2. Define our demo budget
                // We'll use this as a base for all 3 snapshots
                const demoBudget = [
                    { name: "Groceries", amount: 300 },
                    { name: "Dining Out", amount: 50 },
                    { name: "Gas/Transport", amount: 50 },
                    { name: "Vacation", amount: 75 },
                    { name: "Emergency Fund", amount: 50 },
                    { name: "New PC", amount: 50 },
                    { name: "Credit Card", amount: 50 },
                ];
                
                // Helper to get type from name
                const catType = (name) => categories.find(c => c.name === name).type;
                
                // 3. Define the snapshots
                const snapshots = [
                    // --- August 2025 ---
                    {
                        month: "2025-08",
                        salary: 2500,
                        categories: categories, // Full category list
                        // Build budget from our template + dynamic IDs
                        budget: demoBudget.map(b => ({
                            id: `${catType(b.name)}-${idMap.get(b.name)}`,
                            categoryId: idMap.get(b.name),
                            type: catType(b.name),
                            amount: b.amount
                        })),
                        transactions: [
                            { categoryId: idMap.get("Groceries"), amount: 280, date: "2025-08-10", notes: "Weekly shop" },
                            { categoryId: idMap.get("Dining Out"), amount: 60, date: "2025-08-15", notes: "Pizza night (overspent)" },
                            { categoryId: idMap.get("Gas/Transport"), amount: 40, date: "2025-08-20" },
                        ],
                        otherIncome: [],
                        goalTransactions: [],
                        // Balances at *end* of Aug
                        envelopes: [
                            { categoryId: idMap.get("Groceries"), type: "variable", balance: 0 },
                            { categoryId: idMap.get("Dining Out"), type: "variable", balance: 0 },
                            { categoryId: idMap.get("Gas/Transport"), type: "variable", balance: 0 },
                            { categoryId: idMap.get("Vacation"), type: "sinking-goal", balance: 75 },
                            { categoryId: idMap.get("Emergency Fund"), type: "sinking-goal", balance: 50 },
                            { categoryId: idMap.get("New PC"), type: "sinking-goal", balance: 50 },
                            { categoryId: idMap.get("Credit Card"), type: "debt-goal", balance: 50 },
                        ],
                        calculations: { totalIncome: 2500, totalFixed: 1010, totalVariableSpent: 380, moneyToBudget: 1490 },
                        coinsEarned: 88,
                        totalRollover: 885 // (1490 - 625 unassigned) + (300-280) + (50-60) + (50-40)
                    },
                    // --- September 2025 ---
                    {
                        month: "2025-09",
                        salary: 2500,
                        categories: categories,
                        budget: demoBudget.map(b => ({
                            id: `${catType(b.name)}-${idMap.get(b.name)}`,
                            categoryId: idMap.get(b.name),
                            type: catType(b.name),
                            amount: b.amount
                        })),
                        transactions: [
                            { categoryId: idMap.get("Groceries"), amount: 310, date: "2025-09-12", notes: "Stocked up" },
                            { categoryId: idMap.get("Dining Out"), amount: 40, date: "2025-09-18" },
                            { categoryId: idMap.get("Gas/Transport"), amount: 50, date: "2025-09-22" },
                        ],
                        otherIncome: [], // Rollover is handled by calculations
                        goalTransactions: [],
                        // Balances at *end* of Sep
                        envelopes: [
                            { categoryId: idMap.get("Groceries"), type: "variable", balance: 0 },
                            { categoryId: idMap.get("Dining Out"), type: "variable", balance: 0 },
                            { categoryId: idMap.get("Gas/Transport"), type: "variable", balance: 0 },
                            { categoryId: idMap.get("Vacation"), type: "sinking-goal", balance: 150 }, // 75 + 75
                            { categoryId: idMap.get("Emergency Fund"), type: "sinking-goal", balance: 100 }, // 50 + 50
                            { categoryId: idMap.get("New PC"), type: "sinking-goal", balance: 100 }, // 50 + 50
                            { categoryId: idMap.get("Credit Card"), type: "debt-goal", balance: 100 }, // 50 + 50
                        ],
                        calculations: { totalIncome: 3385, totalFixed: 1010, totalVariableSpent: 400, moneyToBudget: 2375 },
                        coinsEarned: 175,
                        totalRollover: 1750 // (2375 - 625 unassigned) + (300-310) + (50-40) + (50-50)
                    },
                    // --- October 2025 ---
                    {
                        month: "2025-10",
                        salary: 2500,
                        categories: categories,
                        budget: demoBudget.map(b => ({
                            id: `${catType(b.name)}-${idMap.get(b.name)}`,
                            categoryId: idMap.get(b.name),
                            type: catType(b.name),
                            amount: b.amount
                        })),
                        transactions: [
                            { categoryId: idMap.get("Groceries"), amount: 290, date: "2025-10-11" },
                            { categoryId: idMap.get("Dining Out"), amount: 50, date: "2025-10-17" },
                            { categoryId: idMap.get("Gas/Transport"), amount: 45, date: "2025-10-21" },
                        ],
                        otherIncome: [],
                        goalTransactions: [
                            { categoryId: idMap.get("Vacation"), type: "spend", amount: 100, date: "2025-10-25", notes: "Flights booked!" }
                        ],
                        // Balances at *end* of Oct (FOR CURRENT MONTH)
                        envelopes: [
                            { categoryId: idMap.get("Groceries"), type: "variable", balance: 0 },
                            { categoryId: idMap.get("Dining Out"), type: "variable", balance: 0 },
                            { categoryId: idMap.get("Gas/Transport"), type: "variable", balance: 0 },
                            { categoryId: idMap.get("Vacation"), type: "sinking-goal", balance: 125 }, // 150 + 75 - 100
                            { categoryId: idMap.get("Emergency Fund"), type: "sinking-goal", balance: 150 }, // 100 + 50
                            { categoryId: idMap.get("New PC"), type: "sinking-goal", balance: 150 }, // 100 + 50
                            { categoryId: idMap.get("Credit Card"), type: "debt-goal", balance: 150 }, // 100 + 50
                        ],
                        calculations: { totalIncome: 4250, totalFixed: 1010, totalVariableSpent: 385, moneyToBudget: 3240 },
                        coinsEarned: 263,
                        totalRollover: 2630 // (3240 - 625 unassigned) + (300-290) + (50-50) + (50-45)
                    }
                ];

                // 4. Data for other tables
                const coinEntries = [
                    { month: "2025-08", coins: 88, rollover: 885 },
                    { month: "2025-09", coins: 175, rollover: 1750 },
                    { month: "2025-10", coins: 263, rollover: 2630 },
                ];
                
                // The final state of envelopes to load for the *current* month (Nov)
                const finalEnvelopes = snapshots[2].envelopes;
                
                // The final settings to load for the *current* month (Nov)
                const finalSettings = [
                    { key: 'lastMonth', value: 9 }, // Oct is month 9 (0-indexed)
                    { key: 'lastMonthRollover', value: 2630 },
                ];

                // 5. Save everything to the database
                return new Promise((resolve, reject) => {
                    const storesToUpdate = ['monthlySnapshots', 'bunnyCoins', 'envelopes', 'settings', 'budget', 'goalTransactions'];
                    const transaction = this.db.transaction(storesToUpdate, 'readwrite');
                    
                    const snapshotStore = transaction.objectStore('monthlySnapshots');
                    const coinStore = transaction.objectStore('bunnyCoins');
                    const envelopeStore = transaction.objectStore('envelopes');
                    const settingsStore = transaction.objectStore('settings');
                    const budgetStore = transaction.objectStore('budget');
                    const goalTxStore = transaction.objectStore('goalTransactions');

                    // Clear budget/envelopes created by loadTemplateData
                    envelopeStore.clear();
                    budgetStore.clear();

                    // Save Snapshots
                    snapshots.forEach(s => snapshotStore.put(s));
                    
                    // Save Coins
                    coinEntries.forEach(c => coinStore.add(c));
                    
                    // Save Final Envelopes
                    finalEnvelopes.forEach(e => envelopeStore.put(e));
                    
                    // Save Final Settings
                    finalSettings.forEach(s => settingsStore.put(s));
                    
                    // Save the budget & goal tx for the *last* month (Oct)
                    // so the app state is correct for Nov.
                    snapshots[2].budget.forEach(b => budgetStore.put(b));
                    snapshots[2].goalTransactions.forEach(gtx => goalTxStore.add(gtx));

                    transaction.oncomplete = () => {
                        console.log("Demo data snapshots loaded.");
                        resolve();
                    };

                    transaction.onerror = (event) => {
                        console.error("Error loading demo data:", event.target.error);
                        reject(event.target.error);
                    };
                });
            },
            
            /**
             * Save a setting (e.g., salary)
             * @param {string} key - The setting key (e.g., 'salary')
             * @param {*} value - The setting value
             */
            async saveSetting(key, value) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('settings', 'readwrite');
                    const store = transaction.objectStore('settings');
                    store.put({ key, value });

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get a setting
             * @param {string} key - The setting key
             */
            async getSetting(key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject("DB not initialized");
                        return;
                    }
                    const transaction = this.db.transaction('settings', 'readonly');
                    const store = transaction.objectStore('settings');
                    const request = store.get(key);

                    request.onsuccess = () => {
                        resolve(request.result ? request.result.value : null);
                    };
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Add a category
             * @param {object} category - The category object {name, type, amount}
             */
            async addCategory(category) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('categories', 'readwrite');
                    const store = transaction.objectStore('categories');
                    const request = store.add(category);

                    request.onsuccess = (event) => {
                        // Return the newly created ID
                        resolve(event.target.result);
                    };
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Update an existing category
             * @param {object} category - The full category object
             */
            async updateCategory(category) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('categories', 'readwrite');
                    const store = transaction.objectStore('categories');
                    const request = store.put(category); // put() will overwrite
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all categories
             */
            async getCategories() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('categories', 'readonly');
                    const store = transaction.objectStore('categories');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Delete a category
             * @param {number} id - The ID of the category to delete
             */
            async deleteCategory(id) {
                return new Promise((resolve, reject) => {
                    // Make transaction aware of all stores
                    const allStores = ['categories', 'budget', 'transactions', 'envelopes', 'goalTransactions'];
                    const transaction = this.db.transaction(allStores, 'readwrite');

                    const categoriesStore = transaction.objectStore('categories');
                    const budgetStore = transaction.objectStore('budget');
                    const transactionsStore = transaction.objectStore('transactions');
                    const envelopesStore = transaction.objectStore('envelopes');
                    const goalTransactionsStore = transaction.objectStore('goalTransactions'); // NEW

                    // 1. Delete the category itself
                    categoriesStore.delete(id);

                    // 2. Delete its budget entry (if any)
                    budgetStore.delete(`variable-${id}`);
                    budgetStore.delete(`sinking-goal-${id}`);
                    budgetStore.delete(`debt-goal-${id}`);

                    // 3. Delete its envelope balance (if any)
                    envelopesStore.delete(id);

                    // 4. Delete all transactions associated with this category
                    const transactionIndex = transactionsStore.index('categoryId');
                    const transactionRequest = transactionIndex.getAll(id);
                    transactionRequest.onsuccess = () => {
                        transactionRequest.result.forEach(tx => {
                            transactionsStore.delete(tx.id);
                        });
                    };

                    // 5. NEW: Delete all goal transactions associated with this category
                    const goalTransactionIndex = goalTransactionsStore.index('categoryId');
                    const goalTransactionRequest = goalTransactionIndex.getAll(id);
                    goalTransactionRequest.onsuccess = () => {
                        goalTransactionRequest.result.forEach(tx => {
                            goalTransactionsStore.delete(tx.id);
                        });
                    };

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => {
                        console.error("Error deleting category:", event.target.error);
                        reject(event.target.error);
                    };
                });
            },

            /**
             * Save monthly budget assignments
             * @param {array} budgetItems - Array of {id, amount}
             */
            async saveBudget(budgetItems) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('budget', 'readwrite');
                    const store = transaction.objectStore('budget');

                    // Phase 1: Clean slate. Clear all old budget items.
                    const clearRequest = store.clear();
                    clearRequest.onerror = (event) => reject(event.target.error);

                    clearRequest.onsuccess = () => {
                        // After clearing, add all new items
                        if (budgetItems.length === 0) {
                            resolve(); // Nothing to add
                            return;
                        }

                        let putCount = 0;
                        budgetItems.forEach(item => {
                            const putRequest = store.put(item);
                            putRequest.onerror = (event) => reject(event.target.error);
                        });
                    };

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all budget items
             */
            async getBudget() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('budget', 'readonly');
                    const store = transaction.objectStore('budget');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Add an expense transaction
             * @param {object} transaction - { categoryId, amount, date }
             */
            async addTransaction(transaction) {
                return new Promise((resolve, reject) => {
                    const dbTransaction = this.db.transaction('transactions', 'readwrite');
                    const store = dbTransaction.objectStore('transactions');
                    const request = store.add(transaction);

                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all transactions
             */
            async getTransactions() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('transactions', 'readonly');
                    const store = transaction.objectStore('transactions');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all transactions for a specific category
             * @param {number} categoryId
             */
            async getTransactionsForCategory(categoryId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('transactions', 'readonly');
                    const store = transaction.objectStore('transactions');
                    const index = store.index('categoryId');
                    const request = index.getAll(categoryId);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Update an existing transaction
             * @param {object} txObject - The full transaction object {id, categoryId, amount, date}
             */
            async updateTransaction(txObject) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('transactions', 'readwrite');
                    const store = transaction.objectStore('transactions');
                    const request = store.put(txObject);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Delete a single transaction by its ID
             * @param {number} id - The transaction's primary key
             */
            async deleteTransaction(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('transactions', 'readwrite');
                    const store = transaction.objectStore('transactions');
                    const request = store.delete(id);

                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Clear all transactions
             */
            async clearTransactions() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('transactions', 'readwrite');
                    const store = transaction.objectStore('transactions');
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Clear all budget items
             */
            async clearBudget() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('budget', 'readwrite');
                    const store = transaction.objectStore('budget');
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Add an other income item
             * @param {object} income - { source, amount, month }
             */
            async addOtherIncome(income) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('otherIncome', 'readwrite');
                    const store = transaction.objectStore('otherIncome');
                    const request = store.add(income);

                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all other income for a specific month
             * @param {string} month - 'YYYY-MM'
             */
            async getOtherIncome(month) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('otherIncome', 'readonly');
                    const store = transaction.objectStore('otherIncome');
                    const index = store.index('month');
                    const request = index.getAll(month);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },
            
            /**
             * Update a single other income item
             * @param {object} income - The full income object
             */
            async updateOtherIncome(income) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('otherIncome', 'readwrite');
                    const store = transaction.objectStore('otherIncome');
                    const request = store.put(income); // 'put' handles updates
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Delete a single other income item
             * @param {number} id - The ID of the income item
             */
            async deleteOtherIncome(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('otherIncome', 'readwrite');
                    const store = transaction.objectStore('otherIncome');
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Clear all other income items (for new month)
             */
            async clearOtherIncome() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('otherIncome', 'readwrite');
                    const store = transaction.objectStore('otherIncome');
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            // --- NEW PHASE 2 FUNCTIONS ---

            /**
             * Get all envelope balances
             */
            async getEnvelopes() {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('envelopes', 'readonly');
                    const store = transaction.objectStore('envelopes');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get a single envelope by its category ID
             * @param {number} categoryId
             */
            async getEnvelope(categoryId) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('envelopes', 'readonly');
                    const store = transaction.objectStore('envelopes');
                    const request = store.get(categoryId);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },
            
            /**
             * Bulk save/update envelope balances
             * @param {Array<object>} envelopes - Array of envelope objects
             */
            async saveEnvelopes(envelopes) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('envelopes', 'readwrite');
                    const store = transaction.objectStore('envelopes');

                    envelopes.forEach(env => {
                        store.put(env);
                    });

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Save a single envelope balance
             * @param {object} envelope - The envelope object
             */
            async saveEnvelope(envelope) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('envelopes', 'readwrite');
                    const store = transaction.objectStore('envelopes');
                    const request = store.put(envelope);

                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all earned bunny coins
             */
            async getBunnyCoins() {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('bunnyCoins', 'readonly');
                    const store = transaction.objectStore('bunnyCoins');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Save/update a coin entry for a specific month
             * @param {object} coinEntry - { month, coins, rollover }
             */
            async saveBunnyCoins(coinEntry) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('bunnyCoins', 'readwrite');
                    const store = transaction.objectStore('bunnyCoins');
                    // Use add() to always create a new entry
                    const request = store.add(coinEntry);

                    request.onsuccess = (event) => resolve(event.target.result); // Return the new ID
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Add a goal transaction
             * @param {object} transaction - { categoryId, type, amount, date, notes, targetCategoryId }
             */
            async addGoalTransaction(transaction) {
                return new Promise((resolve, reject) => {
                    const dbTransaction = this.db.transaction('goalTransactions', 'readwrite');
                    const store = dbTransaction.objectStore('goalTransactions');
                    // --- FIX: Use put() instead of add() ---
                    // put() will add a new item OR update an existing one,
                    // which is exactly what we need for the "Save" button.
                    const request = store.put(transaction); 

                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all goal transactions for a specific category
             * @param {number} categoryId
             */
            async getGoalTransactions(categoryId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('goalTransactions', 'readonly');
                    const store = transaction.objectStore('goalTransactions');
                    const index = store.index('categoryId');
                    const request = index.getAll(categoryId);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * NEW: Clears all data from all object stores
             */
            async clearAllData() {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    
                    const allStores = [
                        'categories', 'transactions', 'settings', 'budget',
                        'otherIncome', 'envelopes', 'bunnyCoins', 'goalTransactions',
                        'monthlySnapshots' // This line is critical for a clean reset
                    ];
                    
                    const transaction = this.db.transaction(allStores, 'readwrite');
                    
                    let clearCount = 0;
                    allStores.forEach(storeName => {
                        const request = transaction.objectStore(storeName).clear();
                        request.onerror = (e) => reject(e.target.error);
                    });

                    transaction.oncomplete = () => {
                        console.log("All data cleared from stores.");
                        resolve();
                    };
                    
                    transaction.onerror = (event) => {
                        console.error("Error clearing all data:", event.target.error);
                        reject(event.target.error);
                    };
                });
            },
            /**
             * Get all goal transactions (for snapshot)
             */
            /**
             * Delete a single goal transaction by its ID
             * @param {number} id - The transaction's primary key
             */
            async deleteGoalTransaction(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('goalTransactions', 'readwrite');
                    const store = transaction.objectStore('goalTransactions');
                    const request = store.delete(id);

                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Get all goal transactions (for snapshot)
             */
            async getAllGoalTransactions() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('goalTransactions', 'readonly');
                    const store = transaction.objectStore('goalTransactions');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Clear all goal transactions (for new month)
             */
            async clearGoalTransactions() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction('goalTransactions', 'readwrite');
                    const store = transaction.objectStore('goalTransactions');
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            },

            /**
             * Save a complete monthly snapshot
             * @param {object} snapshot - The snapshot object
             */
            async saveMonthlySnapshot(snapshot) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('monthlySnapshots', 'readwrite');
                    const store = transaction.objectStore('monthlySnapshots');
                    const request = store.put(snapshot);

                    request.onsuccess = () => {
                        console.log(`Snapshot saved for ${snapshot.month}`);
                        resolve();
                    };
                    request.onerror = (event) => {
                        console.error("Error saving snapshot:", event.target.error);
                        reject(event.target.error);
                    };
                });
            },

            /**
             * Get all monthly snapshots
             */
            async getMonthlySnapshots() {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction('monthlySnapshots', 'readonly');
                    const store = transaction.objectStore('monthlySnapshots');
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }
        };

        // --- MAIN APP ---
        const app = {
            // Debounce utility
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func.apply(this, args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            // App State
            categories: [],
            transactions: [],
            budget: [],
            otherIncome: [],
            envelopes: [], // NEW: For persistent balances
            bunnyCoins: [], // NEW: For gamification
            snapshots: [],
            overviewChart: null,
            categoryChart: null,
            statsDateRange: 12, // NEW: Default to 12 months
            lastMonthRollover: 0, // NEW: For budget calculation
            lastMonthBudget: [], // NEW: For budget reference
            salary: 0,
            currentPage: 'dashboard-page',
            currentEditingTxId: null,
            deferredPwaPrompt: null, // For PWA install
            toastTimeout: null, // NEW: To manage toast hiding
            
            // Cached DOM Elements
            dom: {},
            /**
             * NEW: Handles Demo Mode
             */
            startDemoMode() {
                const banner = document.getElementById('demo-mode-banner');
                const timerSpan = document.getElementById('demo-mode-timer');
                if (!banner || !timerSpan) return;

                banner.classList.remove('hidden');
                // Move the app container down to make space for the banner
                this.dom.appContainer.style.paddingTop = '60px';
                
                let startTime;
                try {
                    startTime = parseInt(sessionStorage.getItem('bunnyBudgetDemoStart'), 10);
                } catch (e) {
                    startTime = Date.now();
                    sessionStorage.setItem('bunnyBudgetDemoStart', startTime);
                }
                
                const tenMinutes = 10 * 60 * 1000;
                
                const updateTimer = () => {
                    const elapsed = Date.now() - startTime;
                    const remaining = tenMinutes - elapsed;

                    if (remaining <= 0) {
                        // Time's up!
                        clearInterval(this.demoTimerInterval);
                        timerSpan.textContent = "0:00";
                        this.showToast("Demo time is over. Resetting app...");
                        // Call reset *after* toast shows
                        setTimeout(() => {
                            this.onConfirmReset();
                        }, 1000);
                    } else {
                        // Update timer
                        const minutes = Math.floor(remaining / 60000);
                        const seconds = Math.floor((remaining % 60000) / 1000);
                        timerSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                };

                // Clear any old timer
                if (this.demoTimerInterval) {
                    clearInterval(this.demoTimerInterval);
                }
                
                // Run immediately and then every second
                updateTimer();
                this.demoTimerInterval = setInterval(updateTimer, 1000);
            },
            // --- Initialization ---

            /**
             * Initialize the application
             */
            async init() {
                // 0. Cache DOM elements
                this.cacheDOMElements();

                // 1. Initialize DB
                try {
                    await dbStore.initDB();
                } catch (e) {
                    console.error("Failed to initialize DB", e);
                    document.body.innerHTML = "Error: Could not open database. Please enable IndexedDB.";
                    return;
                }

                // 2. Initialize i18n
                i18n.init();

                // 3. Check if it's the first run
                const setupDone = await dbStore.getSetting('setupDone');
                // --- NEW: Check for Demo Mode ---
                try {
                    if (sessionStorage.getItem('bunnyBudgetDemo') === 'true') {
                        this.startDemoMode();
                    }
                } catch (e) { }
                // --- End New ---

                if (!setupDone) {
                    // Show onboarding modal
                    this.dom.onboardingModal.classList.remove('hidden');
                    this.dom.onboardingModal.classList.add('flex');
                    this.dom.appContainer.classList.add('opacity-0'); // Keep app hidden
                    this.attachOnboardingListeners();
                } else {
                    // Not first run, load app normally
                    this.dom.onboardingModal.classList.add('hidden');
                    this.dom.onboardingModal.classList.remove('flex');
                    this.dom.appContainer.classList.remove('opacity-0');

                    await this.loadDataAndRender();
                    this.attachListeners();
                    
                    // Run V3 migration if needed
                    await this.runV3DataMigration();

                    this.checkForNewMonth();
                }

                // NEW: Register plugins & Fix chart blurriness
                Chart.register(ChartZoom);
                Chart.defaults.devicePixelRatio = window.devicePixelRatio;

                // PWA Service Worker registration
                this.registerServiceWorker();

                // Listen for the PWA install prompt
                window.addEventListener('beforeinstallprompt', (e) => this.onBeforeInstallPrompt(e));
            },

            /**
             * Registers the physical sw.js file to make the app a PWA
             */
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('./sw.js')
                            .then(registration => {
                                if (location.hostname === 'localhost') console.log('SW registered:', registration);
                            })
                            .catch(error => {
                                if (location.hostname === 'localhost') console.warn('SW registration failed:', error);
                            });
                    });
                }
            },
            
            /**
             * Run after onboarding is complete
             */
            async completeOnboarding(navigateToPage = 'manage-page') {
                // Save settings from i18n (which are now set from localStorage or onboarding)
                await dbStore.saveSetting('language', i18n.lang);
                await dbStore.saveSetting('currency', i18n.currency);
                await dbStore.saveSetting('currencySymbol', i18n.currencySymbolDisplay);
                await dbStore.saveSetting('formattingLocale', i18n.formattingLocale);
                await dbStore.saveSetting('fractionDigits', i18n.fractionDigits);

                // Finalize setup
                await dbStore.saveSetting('setupDone', true);
                await dbStore.saveSetting('lastMonth', new Date().getMonth()); // Set initial month

                this.dom.onboardingModal.classList.add('hidden');
                this.dom.onboardingModal.classList.remove('flex');
                this.dom.appContainer.classList.remove('opacity-0');

                await this.loadDataAndRender();
                this.attachListeners();
                
                // Navigate to the correct page
                this.navigateTo(navigateToPage);

                if (navigateToPage === 'manage-page') {
                    // Scroll to and focus the salary input for fresh starts
                    this.dom.salaryInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    this.dom.salaryInput.focus();
                }
            },

            /**
             * Cache all necessary DOM elements
             */
            cacheDOMElements() {
                this.dom = {
                    appContainer: document.getElementById('app-container'),
                    // Onboarding
                    bunnyCoinTotal: document.getElementById('bunny-coin-total'),
                    onboardingModal: document.getElementById('onboarding-modal'),
                    onboardingStepLanguage: document.getElementById('onboarding-step-language'),
                    onboardingLangEn: document.getElementById('onboarding-lang-en'),
                    onboardingLangDe: document.getElementById('onboarding-lang-de'),
                    onboardingBackToLang: document.getElementById('onboarding-back-to-lang'),
                    onboardingBackToCurrency: document.getElementById('onboarding-back-to-currency'),
                    onboardingStep1: document.getElementById('onboarding-step-1'),
                    onboardingStep2: document.getElementById('onboarding-step-2'),
                    currencySelect: document.getElementById('currency-select'),
                    onboardingNextStep1: document.getElementById('onboarding-next-step-1'),
                    onboardingUseTemplate: document.getElementById('onboarding-use-template'),
                    onboardingStartFresh: document.getElementById('onboarding-start-fresh'),
                    onboardingTryDemo: document.getElementById('onboarding-try-demo'), // <-- ADD THIS
                    onboardingGoToHelp: document.getElementById('onboarding-go-to-help'),
                    onboardingStepHelp: document.getElementById('onboarding-step-help'),
                    onboardingHelpBack: document.getElementById('onboarding-help-back'),
                    onboardingRestore: document.getElementById('onboarding-restore'),

                    // Pages
                    pages: document.querySelectorAll('.page'),
                    dashboardPage: document.getElementById('dashboard-page'),
                    managePage: document.getElementById('manage-page'), // NEW (Replaces budget/settings)
                    helpPage: document.getElementById('help-page'),
                    statsPage: document.getElementById('stats-page'),
                    storePage: document.getElementById('store-page'), // NEW

                    // Nav
                    navButtons: document.querySelectorAll('.nav-button'),
                    navDashboard: document.getElementById('nav-dashboard'),
                    navManage: document.getElementById('nav-manage'), // NEW
                    navStats: document.getElementById('nav-stats'),
                    navStore: document.getElementById('nav-store'), // NEW

                    // Dashboard
                    dashboardMoneyToBudget: document.getElementById('dashboard-money-to-budget'),
                    dashboardTotalBudgeted: document.getElementById('dashboard-total-budgeted'),
                    //dashboardTotalSpent: document.getElementById('dashboard-total-spent'), // <-- This ID is gone, but we'll leave the line
                    // NEW: Dashboard Toggle
                    dashboardToggleArea: document.getElementById('dashboard-toggle-area'),
                    dashboardToggleLabel: document.getElementById('dashboard-toggle-label'),
                    
                    // NEW: Bills Card
                    billsCardContainer: document.getElementById('bills-card-container'),
                    billsCardToggleBtn: document.getElementById('bills-card-toggle-btn'),
                    billsCardChevron: document.getElementById('bills-card-chevron'),
                    billsCardDetails: document.getElementById('bills-card-details'),
                    billsCardList: document.getElementById('bills-card-list'),
                    billsCardEmpty: document.getElementById('bills-card-empty'),
                    billsCardTotal: document.getElementById('bills-card-total'),
                    dashboardToggleValue: document.getElementById('dashboard-toggle-value'),
                    dashboardAvailableValue: document.getElementById('dashboard-available-value'),
                    dashboardSpentValue: document.getElementById('dashboard-spent-value'),
                    
                    variableEnvelopesList: document.getElementById('variable-envelopes-list'),
                    variableEnvelopesEmpty: document.getElementById('variable-envelopes-empty'),
                    variableEnvelopesContainer: document.getElementById('variable-envelopes-container'),
                    
                    // NEW: Renamed elements
                    savingGoalsList: document.getElementById('saving-goals-list'),
                    savingGoalsEmpty: document.getElementById('saving-goals-empty'),
                    savingGoalsContainer: document.getElementById('saving-goals-container'),
                    debtGoalsList: document.getElementById('debt-goals-list'),
                    debtGoalsEmpty: document.getElementById('debt-goals-empty'),
                    debtGoalsContainer: document.getElementById('debt-goals-container'),

                    // Manage Page (Budget elements)
                    budgetMoneyToBudget: document.getElementById('budget-money-to-budget'),
                    budgetTotalAssigned: document.getElementById('budget-total-assigned'),
                    budgetRemaining: document.getElementById('budget-remaining'),
                    budgetSummarySalary: document.getElementById('budget-summary-salary'),
                    budgetSummaryOtherIncome: document.getElementById('budget-summary-other-income'),
                    budgetSummaryTotalIncome: document.getElementById('budget-summary-total-income'),
                    budgetSummaryFixedCosts: document.getElementById('budget-summary-fixed-costs'),
                    // addOtherIncomeBtn: (Removed)
                    budgetForm: document.getElementById('budget-form'),
                    
                    // NEW: Collapsible "Assign" sections
                    assignBillsToggleBtn: document.getElementById('assign-bills-toggle-btn'),
                    assignBillsChevron: document.getElementById('assign-bills-chevron'),
                    assignBillsDetails: document.getElementById('assign-bills-details'),
                    budgetBillList: document.getElementById('budget-bill-list'),
                    budgetBillEmpty: document.getElementById('budget-bill-empty'),

                    assignEnvelopesToggleBtn: document.getElementById('assign-envelopes-toggle-btn'),
                    assignEnvelopesChevron: document.getElementById('assign-envelopes-chevron'),
                    assignEnvelopesDetails: document.getElementById('assign-envelopes-details'),
                    budgetEnvelopeList: document.getElementById('budget-envelope-list'),
                    budgetEnvelopeEmpty: document.getElementById('budget-envelope-empty'),

                    assignSavingsToggleBtn: document.getElementById('assign-savings-toggle-btn'),
                    assignSavingsChevron: document.getElementById('assign-savings-chevron'),
                    assignSavingsDetails: document.getElementById('assign-savings-details'),
                    budgetSavingList: document.getElementById('budget-saving-list'),
                    budgetSavingEmpty: document.getElementById('budget-saving-empty'),

                    assignDebtsToggleBtn: document.getElementById('assign-debts-toggle-btn'),
                    assignDebtsChevron: document.getElementById('assign-debts-chevron'),
                    assignDebtsDetails: document.getElementById('assign-debts-details'),
                    budgetDebtList: document.getElementById('budget-debt-list'),
                    budgetDebtEmpty: document.getElementById('budget-debt-empty'),

                    // OLD: Rename these for clarity in the next step
                    budgetVariableList: document.getElementById('budget-variable-list'), // Will be deleted soon
                    budgetSinkingFundList: document.getElementById('budget-sinking-fund-list'), // Will be deleted soon
                    budgetDebtGoalList: document.getElementById('budget-debt-goal-list'), // Will be deleted soon
                    // budgetFixedCostsList: (Removed)
                    // budgetFixedCostsEmpty: (Removed)
                    otherIncomeList: document.getElementById('other-income-list'),
                    otherIncomeEmpty: document.getElementById('other-income-empty'),
                    otherIncomeContainer: document.getElementById('other-income-container'),
                    otherIncomeToggleBtn: document.getElementById('other-income-toggle-btn'),
                    otherIncomeDetails: document.getElementById('other-income-details'),
                    otherIncomeTotalSpan: document.getElementById('other-income-total-span'),
                    otherIncomeChevron: document.getElementById('other-income-chevron'),
                    
                    fixedCostsContainer: document.getElementById('fixed-costs-container'),
                    fixedCostsToggleBtn: document.getElementById('fixed-costs-toggle-btn'),
                    fixedCostsDetails: document.getElementById('fixed-costs-details'),
                    fixedCostsList: document.getElementById('fixed-costs-list'),
                    fixedCostsChevron: document.getElementById('fixed-costs-chevron'),
                    budgetVariableEmpty: document.getElementById('budget-variable-empty'),
                    budgetSinkingFundEmpty: document.getElementById('budget-sinking-fund-empty'),
                    budgetDebtGoalEmpty: document.getElementById('budget-debt-goal-empty'),

                    // Manage Page (Settings elements)
                    salaryForm: document.getElementById('salary-form'),
                    salaryInput: document.getElementById('salary-input'),
                    autoSaveStatus: document.getElementById('auto-save-status'),
                    addCategoryForm: document.getElementById('add-category-form'),
                    categoryType: document.getElementById('category-type'),
                    categoryName: document.getElementById('category-name'),
                    categoryAmount: document.getElementById('category-amount'),
                    
                    // NEW: Category Type Buttons
                    categoryTypeSelector: document.getElementById('category-type-selector'),
                    categoryTypeDescription: document.getElementById('category-type-description'),
                    
                    // NEW: Optional Fields
                    categoryOptionalToggleBtn: document.getElementById('category-optional-toggle-btn'),
                    categoryOptionalChevron: document.getElementById('category-optional-chevron'),
                    categoryOptionalDetails: document.getElementById('category-optional-details'),
                    categoryGoalAmount: document.getElementById('category-goal-amount'),
                    categoryCurrentBalance: document.getElementById('category-current-balance'),

                    // OLD (but still used)
                    categoryGoalAmountGroup: document.getElementById('category-goal-amount-group'),
                    categoryGoalDateGroup: document.getElementById('category-goal-date-group'), // NEW
                    categoryGoalDate: document.getElementById('category-goal-date'), // NEW
                    
                    // NEW: Manage Categories Modal
                    manageCategoriesButton: document.getElementById('manage-categories-button'),
                    manageCategoriesModal: document.getElementById('manage-categories-modal'),
                    cancelManageCategoriesButton: document.getElementById('cancel-manage-categories-button'),
                    modalManageTabBills: document.getElementById('modal-manage-tab-bills'),
                    modalManageTabEnvelopes: document.getElementById('modal-manage-tab-envelopes'),
                    modalManagePanelBills: document.getElementById('modal-manage-panel-bills'),
                    modalManagePanelEnvelopes: document.getElementById('modal-manage-panel-envelopes'),
                    
                    // Lists inside Manage Categories Modal
                    modalManageContainerBill: document.getElementById('modal-manage-container-bill'),
                    modalManageBillList: document.getElementById('modal-manage-bill-list'),
                    modalManageContainerEnvelope: document.getElementById('modal-manage-container-envelope'),
                    modalManageEnvelopeList: document.getElementById('modal-manage-envelope-list'),
                    modalManageContainerSaving: document.getElementById('modal-manage-container-saving'),
                    modalManageSavingList: document.getElementById('modal-manage-saving-list'),
                    modalManageContainerDebt: document.getElementById('modal-manage-container-debt'),
                    modalManageDebtList: document.getElementById('modal-manage-debt-list'),
                    modalManageBillsEmpty: document.getElementById('modal-manage-bills-empty'),
                    modalManageEnvelopesEmpty: document.getElementById('modal-manage-envelopes-empty'),
                    
                    currencySelectSettings: document.getElementById('currency-select-settings'),
                    languageSelect: document.getElementById('language-select'),
                    goToHelpButton: document.getElementById('go-to-help-button'),
                    resetAppButton: document.getElementById('reset-app-button'),

                    // Modals & Toast
                    addTransactionModal: document.getElementById('add-transaction-modal'), // This is now the main modal
                    cancelAddTransactionButton: document.getElementById('cancel-add-transaction-button'), // This is the 'X' cancel button
                    modalTxTabExpense: document.getElementById('modal-tx-tab-expense'), // NEW Tab
                    modalTxTabIncome: document.getElementById('modal-tx-tab-income'), // NEW Tab

                    addExpenseButton: document.getElementById('add-expense-button'), // The main '+' button
                    
                    // Forms (now inside the main modal)
                    expenseFormContainer: document.getElementById('expense-form-container'), // NEW
                    addExpenseForm: document.getElementById('add-expense-form'),
                    expenseCategory: document.getElementById('expense-category'),
                    expenseAmount: document.getElementById('expense-amount'),
                    expenseDate: document.getElementById('expense-date'),
                    expenseNotes: document.getElementById('expense-notes'),
                    
                    incomeFormContainer: document.getElementById('income-form-container'), // NEW
                    addIncomeForm: document.getElementById('add-income-form'),
                    incomeSource: document.getElementById('income-source'),
                    incomeAmount: document.getElementById('income-amount'),
                    
                    editIncomeModal: document.getElementById('edit-income-modal'),
                    editIncomeForm: document.getElementById('edit-income-form'),
                    cancelEditIncomeButton: document.getElementById('cancel-edit-income-button'),
                    editIncomeId: document.getElementById('edit-income-id'),
                    editIncomeSource: document.getElementById('edit-income-source'),
                    editIncomeAmount: document.getElementById('edit-income-amount'),
                    confirmResetModal: document.getElementById('confirm-reset-modal'),
                    cancelResetButton: document.getElementById('cancel-reset-button'),
                    confirmResetButton: document.getElementById('confirm-reset-button'),
                    
                    editCategoryModal: document.getElementById('edit-category-modal'),
                    editCategoryForm: document.getElementById('edit-category-form'),
                    cancelEditCategoryButton: document.getElementById('cancel-edit-category-button'),
                    editCategoryId: document.getElementById('edit-category-id'),
                    editCategoryType: document.getElementById('edit-category-type'),
                    editCategoryName: document.getElementById('edit-category-name'),
                    editCategoryAmount: document.getElementById('edit-category-amount'),
                    editCategoryGoalAmountGroup: document.getElementById('edit-category-goal-amount-group'),
                    editCategoryGoalAmount: document.getElementById('edit-category-goal-amount'),
                    editCategoryGoalDateGroup: document.getElementById('edit-category-goal-date-group'), // NEW
                    editCategoryGoalDate: document.getElementById('edit-category-goal-date'), // NEW
                    
                    toast: document.getElementById('toast'),
                    toastMessage: document.getElementById('toast-message'),

                    // Stats Page
                    statsTotalCoins: document.getElementById('stats-total-coins'),
                    statsHistoryList: document.getElementById('stats-history-list'),
                    statsHistoryEmpty: document.getElementById('stats-history-empty'),
                    
                    // NEW: Stats Page Charts
                    statsSnapshotEmpty: document.getElementById('stats-snapshot-empty'),
                    statsOverviewContainer: document.getElementById('stats-overview-container'),
                    statsOverviewChart: document.getElementById('stats-overview-chart'),
                    statsCategoryDrilldown: document.getElementById('stats-category-drilldown'),
                    statsCategorySelect: document.getElementById('stats-category-select'),
                    statsCategoryChart: document.getElementById('stats-category-chart'),
                    statsFilterButtons: document.getElementById('stats-filter-buttons'),
                    
                    // NEW: Chart Zoom Buttons
                    statsOverviewZoomIn: document.getElementById('stats-overview-zoom-in'),
                    statsOverviewZoomOut: document.getElementById('stats-overview-zoom-out'),
                    statsOverviewZoomReset: document.getElementById('stats-overview-zoom-reset'),
                    statsCategoryZoomIn: document.getElementById('stats-category-zoom-in'),
                    statsCategoryZoomOut: document.getElementById('stats-category-zoom-out'),
                    statsCategoryZoomReset: document.getElementById('stats-category-zoom-reset'),

                    // Transaction History Modal
                    txHistoryModal: document.getElementById('transaction-history-modal'),
                    txHistoryView: document.getElementById('tx-history-view'),
                    txEditView: document.getElementById('tx-edit-view'),
                    txHistoryTitle: document.getElementById('tx-history-title'),
                    txHistoryCloseBtn: document.getElementById('tx-history-close-btn'),
                    txHistoryList: document.getElementById('tx-history-list'),
                    txHistoryEmpty: document.getElementById('tx-history-empty'),
                    editTxForm: document.getElementById('edit-transaction-form'),
                    editTxId: document.getElementById('edit-tx-id'),
                    editTxDate: document.getElementById('edit-tx-date'),
                    editTxAmount: document.getElementById('edit-tx-amount'),
                    editTxNotes: document.getElementById('edit-tx-notes'),
                    editTxCancel: document.getElementById('edit-tx-cancel'),
                    editTxDelete: document.getElementById('edit-tx-delete'),

                    // NEW: Goal Hub Modals (Task 3)
                    goalHistoryModal: document.getElementById('goal-history-modal'),
                    goalHistoryView: document.getElementById('goal-history-view'),
                    goalHistoryTitle: document.getElementById('goal-history-title'),
                    goalHistoryCloseBtn: document.getElementById('goal-history-close-btn'),
                    goalHistoryBalance: document.getElementById('goal-history-balance'),
                    goalHistoryList: document.getElementById('goal-history-list'),
                    goalHistoryEmpty: document.getElementById('goal-history-empty'),
                    goalHistoryWithdrawBtn: document.getElementById('goal-history-withdraw-btn'),
                    
                    // NEW: Goal Edit View
                    goalEditView: document.getElementById('goal-edit-view'),
                    editGoalTxForm: document.getElementById('edit-goal-tx-form'),
                    editGoalTxId: document.getElementById('edit-goal-tx-id'),
                    editGoalTxNotes: document.getElementById('edit-goal-tx-notes'),
                    editGoalTxDate: document.getElementById('edit-goal-tx-date'),
                    editGoalTxAmount: document.getElementById('edit-goal-tx-amount'),
                    editGoalTxCancel: document.getElementById('edit-goal-tx-cancel'),
                    editGoalTxDelete: document.getElementById('edit-goal-tx-delete'),

                    withdrawGoalModal: document.getElementById('withdraw-goal-modal'),
                    withdrawGoalCloseBtn: document.getElementById('withdraw-goal-close-btn'),
                    withdrawGoalCategoryId: document.getElementById('withdraw-goal-category-id'),
                    withdrawGoalPenaltyWarning: document.getElementById('withdraw-goal-penalty-warning'),
                    modalGoalTabSpend: document.getElementById('modal-goal-tab-spend'),
                    modalGoalTabTransfer: document.getElementById('modal-goal-tab-transfer'),
                    
                    goalSpendFormContainer: document.getElementById('goal-spend-form-container'),
                    goalSpendForm: document.getElementById('goal-spend-form'),
                    goalSpendDate: document.getElementById('goal-spend-date'),
                    goalSpendAmount: document.getElementById('goal-spend-amount'),
                    goalSpendNotes: document.getElementById('goal-spend-notes'),
                    
                    goalTransferFormContainer: document.getElementById('goal-transfer-form-container'),
                    goalTransferForm: document.getElementById('goal-transfer-form'),
                    goalTransferCategory: document.getElementById('goal-transfer-category'),
                    goalTransferDate: document.getElementById('goal-transfer-date'),
                    goalTransferAmount: document.getElementById('goal-transfer-amount'),
                    goalTransferNotes: document.getElementById('goal-transfer-notes'),

                    // NEW: App Settings Modal
                    showSettingsModalBtn: document.getElementById('show-settings-modal-btn'),
                    appSettingsModal: document.getElementById('app-settings-modal'),
                    cancelSettingsButton: document.getElementById('cancel-settings-button'),
                    
                    // NEW: Settings Modal Tabs
                    settingsTabNav: document.getElementById('settings-tab-nav'),
                    settingsTabPanels: document.querySelectorAll('.settings-tab-panel'),
                    settingsTabButtons: document.querySelectorAll('.settings-tab-btn'),
                    
                    // NEW: PWA Install
                    installPwaSection: document.getElementById('install-pwa-section'),
                    installPwaButton: document.getElementById('install-pwa-button'),
                    
                    // NEW: Backup/Restore
                    backupDataButton: document.getElementById('backup-data-button'),
                    restoreDataButton: document.getElementById('restore-data-button'),
                    exportCsvButton: document.getElementById('export-csv-button'),
                    exportCategoriesButton: document.getElementById('export-categories-button'),
                    exportSummariesButton: document.getElementById('export-summaries-button'),
                };
            },

            /**
             * Runs data migration for v3 (populating envelopes)
             */
            async runV3DataMigration() {
                const migrationDone = await dbStore.getSetting('migrationV3Done');
                if (migrationDone) {
                    return; // Already done
                }
                
                console.log("Running V3 data migration...");
                
                const categories = this.categories;
                const budget = this.budget;
                const envelopes = [];
                
                const budgetMap = new Map(budget.map(b => [b.id, b.amount]));

                categories.forEach(cat => {
                    if (cat.type === 'envelope') {
                        envelopes.push({ categoryId: cat.id, type: 'variable', balance: 0 });
                    } else if (cat.type === 'saving') {
                        const saved = budgetMap.get(`sinking-goal-${cat.id}`) || 0;
                        envelopes.push({ categoryId: cat.id, type: 'sinking-goal', balance: saved });
                    } else if (cat.type === 'debt') {
                        const saved = budgetMap.get(`debt-goal-${cat.id}`) || 0;
                        envelopes.push({ categoryId: cat.id, type: 'debt-goal', balance: saved });
                    }
                });

                if (envelopes.length > 0) {
                    await dbStore.saveEnvelopes(envelopes);
                    this.envelopes = await dbStore.getEnvelopes();
                }

                await dbStore.saveSetting('migrationV3Done', true);
                console.log("V3 data migration complete.");
            },

            /**
             * Attach listeners for onboarding
             */
            attachOnboardingListeners() {
                // Step 1: Language
                this.dom.onboardingLangEn.addEventListener('click', () => this.selectOnboardingLang('en'));
                this.dom.onboardingLangDe.addEventListener('click', () => this.selectOnboardingLang('de'));


                // Step 2: Currency
                this.dom.onboardingNextStep1.addEventListener('click', () => {
                    const selectedOption = this.dom.currencySelect.options[this.dom.currencySelect.selectedIndex];
                    const currency = selectedOption.value;
                    const currencySymbol = selectedOption.dataset.symbol;
                    const locale = selectedOption.dataset.locale;
                    const digits = selectedOption.dataset.digits;
                    i18n.setCurrency(currency, currencySymbol, locale, digits);
                    this.dom.onboardingStep1.classList.remove('active');
                    this.dom.onboardingStep2.classList.add('active');
                });
                this.dom.onboardingBackToLang.addEventListener('click', () => {
                    this.dom.onboardingStep1.classList.remove('active');
                    this.dom.onboardingStepLanguage.classList.add('active');
                });

                // Step 3: Template
                this.dom.onboardingUseTemplate.addEventListener('click', async () => {
                    // 1. Load template categories & settings
                    await dbStore.loadTemplateData();
                    
                    // 2. Fetch the categories we just loaded
                    const templateCategories = await dbStore.getCategories();
                    
                    const newBudgetItems = [];
                    const newEnvelopes = [];

                    templateCategories.forEach(cat => {
                        // 3. Create budget items for categories with a default amount
                        if (cat.amount > 0 && (cat.type === 'variable' || cat.type === 'sinking-goal' || cat.type === 'debt-goal')) {
                            newBudgetItems.push({
                                id: `${cat.type}-${cat.id}`,
                                categoryId: cat.id,
                                type: cat.type,
                                amount: cat.amount
                            });
                        }
                        
                        // 4. Create initial envelope balances
                        if (cat.type === 'variable') {
                            newEnvelopes.push({ categoryId: cat.id, type: 'variable', balance: 0 });
                        } else if (cat.type === 'sinking-goal') {
                            // Goals start with their first month's contribution
                            const initialBalance = (cat.amount > 0) ? cat.amount : 0;
                            newEnvelopes.push({ categoryId: cat.id, type: 'sinking-goal', balance: initialBalance });
                        } else if (cat.type === 'debt-goal') {
                            // Goals start with their first month's contribution
                            const initialBalance = (cat.amount > 0) ? cat.amount : 0;
                            newEnvelopes.push({ categoryId: cat.id, type: 'debt-goal', balance: initialBalance });
                        }
                    });

                    // 5. Save the new budget and envelope data
                    if (newBudgetItems.length > 0) {
                        await dbStore.saveBudget(newBudgetItems);
                    }
                    if (newEnvelopes.length > 0) {
                        await dbStore.saveEnvelopes(newEnvelopes);
                    }

                    // 6. Complete onboarding
                    await this.completeOnboarding('manage-page');
                });

                this.dom.onboardingStartFresh.addEventListener('click', async () => {
                    await this.completeOnboarding('manage-page');
                });
                
                // --- NEW: Demo Button Listener ---
                this.dom.onboardingTryDemo.addEventListener('click', async () => {
                    // --- NEW: Set Demo Mode Flags ---
                    try {
                        sessionStorage.setItem('bunnyBudgetDemo', 'true');
                        sessionStorage.setItem('bunnyBudgetDemoStart', Date.now());
                        this.showToast("Demo Mode Started! App will reset in 10 minutes.");
                    } catch (e) {
                        console.warn("Could not set demo flags in sessionStorage.");
                    }
                    // --- End New ---

                    // 1. Load the *same template* as "Start with Template" to get categories
                    await dbStore.loadTemplateData();
                    
                    // 2. Get the categories we just created (with their new IDs)
                    const templateCategories = await dbStore.getCategories();
                    
                    // 3. Pass these categories to our new function to build and save demo data
                    await dbStore.loadDemoSnapshots(templateCategories);

                    // 4. Complete onboarding and go to Dashboard to see the result
                    await this.completeOnboarding('dashboard-page');
                    
                    // 5. --- THIS IS THE FIX ---
                    // Manually start the timer now that the app is loaded
                    this.startDemoMode();
                });
                // --- End NEW ---

                this.dom.onboardingBackToCurrency.addEventListener('click', () => {
                    this.dom.onboardingStep2.classList.remove('active');
                    this.dom.onboardingStep1.classList.add('active');
                });

                this.dom.onboardingRestore.addEventListener('click', () => this.onOnboardingRestore());

                this.dom.onboardingGoToHelp.addEventListener('click', () => {
                    this.dom.onboardingStep2.classList.remove('active');
                    this.dom.onboardingStepHelp.classList.add('active');
                });
                
                this.dom.onboardingHelpBack.addEventListener('click', () => {
                    this.dom.onboardingStepHelp.classList.remove('active');
                    this.dom.onboardingStep2.classList.add('active');
                });
            },

            /**
             * Attach all application event listeners
             */
            attachListeners() {
                // Navigation
                this.dom.navDashboard.addEventListener('click', () => this.navigateTo('dashboard-page'));
                this.dom.navManage.addEventListener('click', () => this.navigateTo('manage-page')); // NEW
                this.dom.navStats.addEventListener('click', () => this.navigateTo('stats-page'));
                this.dom.navStore.addEventListener('click', () => this.navigateTo('store-page')); // NEW
                
                // --- Auto-save Listeners ---
                // Debounce saves to 500ms after last input
                this.debouncedAutoSaveSalary = this.debounce(this.onAutoSaveSalary.bind(this), 500);
                this.debouncedAutoSaveBudget = this.debounce(this.onAutoSaveBudget.bind(this), 500);

                // NEW: Add Transaction (Unified Tabbed Modal)
                this.dom.addExpenseButton.addEventListener('click', () => this.showAddTransactionModal());
                this.dom.cancelAddTransactionButton.addEventListener('click', () => this.hideAddTransactionModal());
                this.dom.addTransactionModal.addEventListener('click', (e) => { if (e.target === this.dom.addTransactionModal) this.hideAddTransactionModal(); });

                // NEW: Tab Listeners
                this.dom.modalTxTabExpense.addEventListener('click', () => this.switchTransactionTab('expense'));
                this.dom.modalTxTabIncome.addEventListener('click', () => this.switchTransactionTab('income'));

                // Form Listeners (no change, but for context)
                this.dom.addExpenseForm.addEventListener('submit', (e) => this.onAddExpense(e));
                this.dom.addIncomeForm.addEventListener('submit', (e) => this.onAddIncome(e));

                // Edit Income (no change, but for context)

                // Edit Income
                this.dom.cancelEditIncomeButton.addEventListener('click', () => this.hideEditIncomeModal());
                this.dom.editIncomeModal.addEventListener('click', (e) => { if (e.target === this.dom.editIncomeModal) this.hideEditIncomeModal(); });
                this.dom.editIncomeForm.addEventListener('submit', (e) => this.onUpdateIncome(e));

                // Manage Page (Settings)
                this.dom.salaryInput.addEventListener('input', () => {
                    this.dom.autoSaveStatus.textContent = i18n.t('saving'); // Show immediate feedback
                    this.debouncedAutoSaveSalary();
                });
                this.dom.addCategoryForm.addEventListener('submit', (e) => this.onAddCategory(e));
                
                // NEW: Listener for our new category type buttons
                this.dom.categoryTypeSelector.addEventListener('click', (e) => this.handleCategoryTypeClick(e));
                
                // NEW: Listener for optional details toggle
                this.dom.categoryOptionalToggleBtn.addEventListener('click', () => {
                    this.dom.categoryOptionalDetails.classList.toggle('hidden');
                    this.dom.categoryOptionalChevron.classList.toggle('rotate-180');
                });
                
                this.dom.languageSelect.addEventListener('change', (e) => this.onChangeLanguage(e));
                this.dom.currencySelectSettings.addEventListener('change', (e) => this.onChangeCurrency(e));
                this.dom.resetAppButton.addEventListener('click', () => this.showResetModal());

                // Reset Modal Listeners
                this.dom.cancelResetButton.addEventListener('click', () => this.hideResetModal());
                this.dom.confirmResetButton.addEventListener('click', () => this.onConfirmReset());
                
                this.dom.goToHelpButton.addEventListener('click', () => {
                    this.hideSettingsModal(); // Close the modal
                    this.navigateTo('help-page'); // Navigate to the help page
                });

                // Edit Category Modal Listeners
                this.dom.cancelEditCategoryButton.addEventListener('click', () => this.hideEditCategoryModal());
                this.dom.editCategoryModal.addEventListener('click', (e) => { if (e.target === this.dom.editCategoryModal) this.hideEditCategoryModal(); });
                this.dom.editCategoryForm.addEventListener('submit', (e) => this.onUpdateCategory(e));

                // NEW: Manage Categories Modal
                this.dom.manageCategoriesButton.addEventListener('click', () => this.showManageCategoriesModal());
                this.dom.cancelManageCategoriesButton.addEventListener('click', () => this.hideManageCategoriesModal());
                this.dom.manageCategoriesModal.addEventListener('click', (e) => { if (e.target === this.dom.manageCategoriesModal) this.hideManageCategoriesModal(); });
                this.dom.modalManageTabBills.addEventListener('click', () => this.handleManageCategoriesTabClick('bills'));
                this.dom.modalManageTabEnvelopes.addEventListener('click', () => this.handleManageCategoriesTabClick('envelopes'));

                // NEW: Manage Page (Category Lists - Re-pointed to Modal)
                this.dom.modalManageBillList.addEventListener('click', (e) => this.handleCategoryListClick(e));
                this.dom.modalManageEnvelopeList.addEventListener('click', (e) => this.handleCategoryListClick(e));
                this.dom.modalManageSavingList.addEventListener('click', (e) => this.handleCategoryListClick(e));
                this.dom.modalManageDebtList.addEventListener('click', (e) => this.handleCategoryListClick(e));

                // Manage Page (Budget Form)
                // this.dom.budgetForm.addEventListener('submit', (e) => this.onSaveBudget(e)); // Removed for auto-save
                this.dom.otherIncomeList.addEventListener('click', (e) => this.handleIncomeListClick(e));
                // NEW: Expandable Section Toggles
                this.dom.otherIncomeToggleBtn.addEventListener('click', () => {
                    this.dom.otherIncomeDetails.classList.toggle('hidden');
                    this.dom.otherIncomeChevron.classList.toggle('rotate-180');
                });

                this.dom.fixedCostsToggleBtn.addEventListener('click', () => {
                    this.dom.fixedCostsDetails.classList.toggle('hidden');
                    this.dom.fixedCostsChevron.classList.toggle('rotate-180');
                });
                
                // NEW: Accordion listener for "Assign" sections
                this.dom.budgetForm.addEventListener('click', (e) => this.handleAssignAccordionClick(e));
                
                const budgetInputHandler = () => {
                    this.updateBudgetSummary(); // Update UI immediately
                    this.debouncedAutoSaveBudget(); // Trigger debounced save
                };

                this.dom.budgetBillList.addEventListener('input', budgetInputHandler);
                this.dom.budgetEnvelopeList.addEventListener('input', budgetInputHandler);
                this.dom.budgetSavingList.addEventListener('input', budgetInputHandler);
                this.dom.budgetDebtList.addEventListener('input', budgetInputHandler);

                // NEW: Envelope Summary Card Toggle
                // We use the list itself since the card is dynamic
                this.dom.variableEnvelopesList.addEventListener('click', (e) => {
                    if (e.target.closest('#envelope-summary-card')) {
                        this.onToggleEnvelopeSummary();
                    }
                });

                // NEW: Bills Card Toggle
                this.dom.billsCardToggleBtn.addEventListener('click', () => {
                    this.dom.billsCardDetails.classList.toggle('hidden');
                    this.dom.billsCardChevron.classList.toggle('rotate-180');
                });

                // NEW: App Settings Modal
                this.dom.showSettingsModalBtn.addEventListener('click', () => this.showSettingsModal());
                this.dom.cancelSettingsButton.addEventListener('click', () => this.hideSettingsModal());
                this.dom.appSettingsModal.addEventListener('click', (e) => { if (e.target === this.dom.appSettingsModal) this.hideSettingsModal(); });
                
                // NEW: Settings Tab Click
                this.dom.settingsTabNav.addEventListener('click', (e) => this.handleSettingsTabClick(e));

                // NEW: PWA Install Button
                this.dom.installPwaButton.addEventListener('click', () => this.onInstallPwa());
                
                // NEW: Backup/Restore Listeners
                this.dom.backupDataButton.addEventListener('click', () => this.onBackupData());
                this.dom.restoreDataButton.addEventListener('click', () => this.onRestoreData());
                this.dom.exportCsvButton.addEventListener('click', () => this.onExportTransactionsCSV());
                this.dom.exportCategoriesButton.addEventListener('click', () => this.onExportCategoriesCSV());
                this.dom.exportSummariesButton.addEventListener('click', () => this.onExportSummariesCSV());

                // Transaction History Modal
                this.dom.variableEnvelopesList.addEventListener('click', (e) => this.handleEnvelopeClick(e));
                
                // NEW: Goal Hub Click Listeners (Task 3)
                this.dom.savingGoalsList.addEventListener('click', (e) => this.handleGoalCardClick(e));
                this.dom.debtGoalsList.addEventListener('click', (e) => this.handleGoalCardClick(e));
                this.dom.goalHistoryCloseBtn.addEventListener('click', () => this.hideGoalHistoryModal());
                this.dom.goalHistoryList.addEventListener('click', (e) => this.handleGoalTransactionClick(e)); // <-- ADD THIS
                this.dom.editGoalTxForm.addEventListener('submit', (e) => this.onUpdateGoalTransaction(e)); // <-- ADD THIS
                this.dom.editGoalTxCancel.addEventListener('click', () => this.showGoalHistoryList()); // <-- ADD THIS
                this.dom.editGoalTxDelete.addEventListener('click', () => this.onDeleteGoalTransaction()); // <-- ADD THIS
                this.dom.goalHistoryModal.addEventListener('click', (e) => { if (e.target === this.dom.goalHistoryModal) this.hideGoalHistoryModal(); });
                this.dom.goalHistoryWithdrawBtn.addEventListener('click', () => this.onOpenWithdrawModal());
                
                this.dom.withdrawGoalCloseBtn.addEventListener('click', () => this.hideWithdrawGoalModal());
                this.dom.withdrawGoalModal.addEventListener('click', (e) => { if (e.target === this.dom.withdrawGoalModal) this.hideWithdrawGoalModal(); });
                this.dom.modalGoalTabSpend.addEventListener('click', () => this.switchWithdrawGoalTab('spend'));
                this.dom.modalGoalTabTransfer.addEventListener('click', () => this.switchWithdrawGoalTab('transfer'));
                
                this.dom.goalSpendForm.addEventListener('submit', (e) => this.onSpendFromGoal(e));
                this.dom.goalTransferForm.addEventListener('submit', (e) => this.onTransferFromGoal(e));


                this.dom.txHistoryCloseBtn.addEventListener('click', () => this.hideTransactionHistory());
                this.dom.txHistoryModal.addEventListener('click', (e) => { if (e.target === this.dom.txHistoryModal) this.hideTransactionHistory(); });
                this.dom.txHistoryList.addEventListener('click', (e) => this.handleTransactionClick(e));
                this.dom.editTxForm.addEventListener('submit', (e) => this.onUpdateTransaction(e));
                this.dom.editTxCancel.addEventListener('click', () => this.showTxHistoryList());
                this.dom.editTxDelete.addEventListener('click', () => this.onDeleteTransaction());

                // NEW: Stats Page Listeners
                this.dom.statsCategorySelect.addEventListener('change', () => this.renderCategoryChart());
                this.dom.statsFilterButtons.addEventListener('click', (e) => this.onStatsDateRangeChange(e));
                
                // NEW: Chart Zoom Listeners
                this.dom.statsOverviewZoomIn.addEventListener('click', () => this.handleChartZoom(this.overviewChart, 1.1));
                this.dom.statsOverviewZoomOut.addEventListener('click', () => this.handleChartZoom(this.overviewChart, 0.9));
                this.dom.statsOverviewZoomReset.addEventListener('click', () => this.handleChartReset(this.overviewChart));
                this.dom.statsCategoryZoomIn.addEventListener('click', () => this.handleChartZoom(this.categoryChart, 1.1));
                this.dom.statsCategoryZoomOut.addEventListener('click', () => this.handleChartZoom(this.categoryChart, 0.9));
                this.dom.statsCategoryZoomReset.addEventListener('click', () => this.handleChartReset(this.categoryChart));
            },

            // --- Data Loading & State Management ---

            /**
             * Load all data from DB and refresh the UI
             */
            async loadDataAndRender() {
                // Get current month
                const currentMonth = this.getCurrentMonthString();

                // Load settings (lang, currency) from DB
                const [salary, lastMonthRollover, lastMonthBudget, categories, budget, transactions, otherIncome, envelopes, bunnyCoins, snapshots, allGoalTransactions] = await Promise.all([
                    dbStore.getSetting('salary'),
                    dbStore.getSetting('lastMonthRollover'),
                    dbStore.getSetting('lastMonthBudget'),
                    dbStore.getCategories(),
                    dbStore.getBudget(),
                    dbStore.getTransactions(),
                    dbStore.getOtherIncome(currentMonth),
                    dbStore.getEnvelopes(),
                    dbStore.getBunnyCoins(),
                    dbStore.getMonthlySnapshots() // NEW
                ]);

                // Apply settings
                i18n.setCurrency(
                    i18n.currency,
                    i18n.currencySymbolDisplay,
                    await dbStore.getSetting('formattingLocale') || i18n.formattingLocale,
                    await dbStore.getSetting('fractionDigits') || i18n.fractionDigits
                );

                this.dom.currencySelectSettings.value = i18n.currency;

                // Store state
                this.salary = salary || 0;
                this.categories = categories || [];
                this.budget = budget || [];
                this.transactions = transactions || [];
                this.otherIncome = otherIncome || [];
                this.envelopes = envelopes || [];
                this.bunnyCoins = bunnyCoins || [];
                this.snapshots = snapshots || []; // NEW
                this.goalTransactions = allGoalTransactions || []; // <-- ADD THIS LINE
                this.lastMonthRollover = lastMonthRollover || 0;
                this.lastMonthBudget = lastMonthBudget || [];

                // Update UI based on loaded data
                this.dom.salaryInput.value = this.salary;

                // Render all parts of the app
                this.renderAllPages();
            },

            /**
             * Check if a new month has started. If so, run rollover logic.
             */
            async checkForNewMonth() {
                const now = new Date();
                const currentMonth = now.getMonth();
                const lastMonth = await dbStore.getSetting('lastMonth');

                if (lastMonth === null || currentMonth === lastMonth) {
                    return; // Not a new month, or first run.
                }

                console.log("New month detected! Running rollover and snapshot logic...");

                // --- 1. Calculate Balances & Rollover (Same as before) ---
                const budgetMap = new Map(this.budget.map(b => [b.id, b.amount]));
                const envelopeMap = new Map(this.envelopes.map(e => [e.categoryId, e]));
                const envelopesToUpdate = [];
                let totalVariableRollover = 0;
                
                const calculations = this.calculateBudget(); // Get totals for the month *ending*
                const totalAssigned = this.budget.reduce((sum, b) => sum + b.amount, 0);
                let unassignedMoney = calculations.moneyToBudget - totalAssigned;
                if (unassignedMoney < 0) unassignedMoney = 0;

                // 1b. Calculate Unspent (Rollover) from Envelopes
                for (const cat of this.categories) {
                    let envelope = envelopeMap.get(cat.id);
                    if (!envelope && (cat.type === 'variable' || cat.type === 'sinking-goal' || cat.type === 'debt-goal')) {
                        envelope = { categoryId: cat.id, type: cat.type, balance: 0 };
                    }
                    if (!envelope) continue; 

                    const budgetedThisMonth = budgetMap.get(`${cat.type}-${cat.id}`) || 0;
                    
                    if (cat.type === 'variable') {
                        const spent = calculations.outflowsPerCategory[cat.id] || 0;
                        const inflows = calculations.inflowsPerCategory[cat.id] || 0;
                        const startingBalance = envelope.balance || 0;
                        const rollover = (startingBalance + budgetedThisMonth + inflows) - spent;
                        
                        if (rollover > 0) {
                            totalVariableRollover += rollover;
                        }
                        envelope.balance = 0; 
                        envelopesToUpdate.push(envelope);
                    }
                }

                // --- 2. Calculate and Save Bunny Coins & Rollover Savings (Same as before) ---
                let coinToastMessage = "";
                const finalTotalRollover = totalVariableRollover + unassignedMoney;
                
                if (finalTotalRollover > 0) {
                    const oldRollover = await dbStore.getSetting('lastMonthRollover') || 0;
                    const newTotalRollover = oldRollover + finalTotalRollover;
                    await dbStore.saveSetting('lastMonthRollover', newTotalRollover);
                    this.lastMonthRollover = newTotalRollover; // Update state
                }
                
                const conversionRate = 1.0; // Failsafe, replace with your CURRENCY_TO_STANDARD if you have it
                const standardRolloverValue = finalTotalRollover * conversionRate;
                const newCoins = Math.floor(standardRolloverValue / 10); 
                
                const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastMonthString = `${lastMonthDate.getFullYear()}-${(lastMonthDate.getMonth() + 1).toString().padStart(2, '0')}`;
                
                if (newCoins > 0) {
                    await dbStore.saveBunnyCoins({
                        month: lastMonthString,
                        coins: newCoins,
                        rollover: finalTotalRollover
                    });
                    coinToastMessage = ` You earned ${newCoins} ðŸª™!`;
                }

                // --- 3. NEW: Create and Save Snapshot ---
                console.log(`Creating snapshot for ${lastMonthString}...`);
                try {
                    const allGoalTransactions = await dbStore.getAllGoalTransactions();

                    const snapshot = {
                        month: lastMonthString,
                        salary: this.salary,
                        categories: JSON.parse(JSON.stringify(this.categories)), // Deep copy
                        budget: JSON.parse(JSON.stringify(this.budget)), // Deep copy
                        transactions: JSON.parse(JSON.stringify(this.transactions)), // Deep copy
                        otherIncome: JSON.parse(JSON.stringify(this.otherIncome)), // Deep copy
                        goalTransactions: JSON.parse(JSON.stringify(allGoalTransactions)), // Deep copy
                        envelopes: JSON.parse(JSON.stringify(this.envelopes)), // State of envelopes at month end
                        calculations: calculations, // Save all calculated totals
                        coinsEarned: newCoins,
                        totalRollover: finalTotalRollover
                    };
                    
                    await dbStore.saveMonthlySnapshot(snapshot);
                } catch (e) {
                    console.error("Failed to create or save snapshot:", e);
                    // We shouldn't stop the new month process, but log the error
                    this.showToast("Error saving monthly snapshot!");
                }
                // --- End NEW Snapshot Logic ---


                // --- 4. Save New Balances & Clear Monthly Data ---
                if (envelopesToUpdate.length > 0) {
                    await dbStore.saveEnvelopes(envelopesToUpdate);
                }

                await dbStore.saveSetting('lastMonthBudget', this.budget);
                
                // NOW we clear the data
                await dbStore.clearTransactions();
                await dbStore.clearBudget();
                await dbStore.clearGoalTransactions(); // NEW: Clear goal txs
                await dbStore.clearOtherIncome(); // <-- FIX: Add this line

                // --- 5. Update Local State & UI ---
                this.transactions = [];
                this.budget = [];
                this.goalTransactions = []; // NEW: Clear local state
                const newMonthString = this.getCurrentMonthString();
                // otherIncome is fetched by new month string, so it's fine
                this.otherIncome = await dbStore.getOtherIncome(newMonthString); 
                this.envelopes = await dbStore.getEnvelopes(); // Get updated envelopes
                this.bunnyCoins = await dbStore.getBunnyCoins(); // Get new coin list
                this.snapshots = await dbStore.getMonthlySnapshots(); // <-- ADD THIS LINE
                
                await dbStore.saveSetting('lastMonth', currentMonth);

                // --- 6. Re-render and Notify ---
                this.renderAllPages();
                this.showToast(`${i18n.t('toastNewMonth')}${coinToastMessage}`);
            },


            /**
             * Render the total Bunny Coins in the header
             */
            renderBunnyCoins() {
                const totalCoins = this.bunnyCoins.reduce((sum, entry) => sum + entry.coins, 0);
                this.dom.bunnyCoinTotal.textContent = totalCoins;
            },

            /**
             * Re-renders all dynamic page content
             */
            renderAllPages() {
                this.renderDashboard();
                this.renderManagePage(); // MODIFIED
                this.renderBunnyCoins();
                this.renderStatsPage(); // ADDED
            },

            /**
             * NEW: Handle clicks on the Setup Card tabs
             */
            handleManageCategoriesTabClick(tab) {
                // Deactivate all
                this.dom.modalManageTabBills.classList.remove('active', 'border-pink-500', 'text-pink-600');
                this.dom.modalManageTabBills.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                this.dom.modalManageTabEnvelopes.classList.remove('active', 'border-pink-500', 'text-pink-600');
                this.dom.modalManageTabEnvelopes.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                
                this.dom.modalManagePanelBills.classList.add('hidden');
                this.dom.modalManagePanelEnvelopes.classList.add('hidden');

                // Activate target
                if (tab === 'bills') {
                    this.dom.modalManageTabBills.classList.add('active', 'border-pink-500', 'text-pink-600');
                    this.dom.modalManageTabBills.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    this.dom.modalManagePanelBills.classList.remove('hidden');
                } else if (tab === 'envelopes') {
                    this.dom.modalManageTabEnvelopes.classList.add('active', 'border-pink-500', 'text-pink-600');
                    this.dom.modalManageTabEnvelopes.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    this.dom.modalManagePanelEnvelopes.classList.remove('hidden');
                }
            },

            // --- Page Rendering ---

            /**
             * Render the Dashboard
             */
            renderDashboard() {
                const calculations = this.calculateBudget();
                this.dom.dashboardMoneyToBudget.textContent = this.formatCurrency(calculations.moneyToBudget);
                this.dom.dashboardTotalBudgeted.textContent = this.formatCurrency(calculations.totalBudgeted);

                // Render NEW: Bills Card
                this.dom.billsCardList.innerHTML = '';
                // Get all categories of type 'bill'
                const billCategories = this.categories.filter(c => c.type === 'bill');
                
                let totalBills = 0;
                let hasBills = false;
                
                billCategories.forEach(cat => {
                    hasBills = true;
                    const amount = cat.amount || 0;
                    totalBills += amount;
                    
                    const item = `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-700">${cat.name}</span>
                            <span class="font-medium text-gray-800">${this.formatCurrency(amount)}</span>
                        </div>
                    `;
                    this.dom.billsCardList.insertAdjacentHTML('beforeend', item);
                });

                // Show/hide the card and empty message
                this.dom.billsCardContainer.classList.toggle('hidden', !hasBills);
                this.dom.billsCardEmpty.classList.toggle('hidden', hasBills);
                this.dom.billsCardTotal.textContent = this.formatCurrency(totalBills);


                // Render Spending Envelopes
                this.dom.variableEnvelopesList.innerHTML = '';
                const variableCategories = this.categories.filter(c => c.type === 'envelope');
                let hasVariable = false;
                
                // --- NEW: Calculate Envelope Totals ---
                const envelopeBudgeted = this.budget
                    .filter(b => b.type === 'envelope')
                    .reduce((sum, b) => sum + b.amount, 0);
                
                const envelopeSpent = calculations.outflowsPerCategory; // This is our map
                let envelopeSpentTotal = 0;
                let envelopeInflowsTotal = 0;
                
                variableCategories.forEach(cat => {
                    envelopeSpentTotal += (envelopeSpent[cat.id] || 0);
                    envelopeInflowsTotal += (calculations.inflowsPerCategory[cat.id] || 0);
                });

                const envelopeAvailable = (envelopeBudgeted + envelopeInflowsTotal) - envelopeSpentTotal;
                
                // --- NEW: Add Summary Card ---
                // Only show the summary card if there is anything budgeted
                if (envelopeBudgeted > 0) {
                    hasVariable = true; // Show the section
                    const summaryCard = `
                        <div id="envelope-summary-card" class="bg-pink-50 border-2 border-pink-200 p-4 rounded-2xl shadow-inner cursor-pointer" data-view="spent">
                            <input type="hidden" id="env-summary-spent" value="${envelopeSpentTotal}">
                            <input type="hidden" id="env-summary-available" value="${envelopeAvailable}">
                            
                            <div class="flex justify-between items-center mb-2">
                                <span id="env-summary-label" class="font-semibold text-lg text-pink-800">${i18n.t('dashboardTotalSpent') || 'Total Spent'}</span>
                                <span id="env-summary-value" class="font-bold text-lg text-pink-900">${this.formatCurrency(envelopeSpentTotal)}</span>
                            </div>
                            <progress class="w-full" value="${envelopeSpentTotal}" max="${envelopeBudgeted + envelopeInflowsTotal}"></progress>
                            <div class="flex justify-between items-center text-sm text-pink-700 mt-2">
                                <span>${i18n.t('dashboardBudgeted')}: ${this.formatCurrency(envelopeBudgeted)}</span>
                                ${envelopeInflowsTotal > 0 ? `<span>${i18n.t('dashboardInflows')}: ${this.formatCurrency(envelopeInflowsTotal)}</span>` : ''}
                            </div>
                        </div>
                    `;
                    this.dom.variableEnvelopesList.insertAdjacentHTML('beforeend', summaryCard);
                }
                // --- End New Summary Card ---

                variableCategories.forEach(cat => {
                    const budgetItem = this.budget.find(b => b.id === `envelope-${cat.id}`);
                    const budgetedThisMonth = budgetItem ? budgetItem.amount : 0;
                    
                    const inflows = calculations.inflowsPerCategory[cat.id] || 0;
                    // Total available money is what you budgeted PLUS what you transferred in
                    const totalAvailable = budgetedThisMonth + inflows;
                    
                    // Only show envelopes that have been budgeted for OR have received a transfer
                    if (!budgetItem && inflows === 0) return; 
                    
                    hasVariable = true;
                    // "Spent" is now only your positive expenses
                    const spent = calculations.outflowsPerCategory[cat.id] || 0;
                    
                    // "Remaining" is your total pool of money minus what you spent
                    const remaining = totalAvailable - spent;
                    const progressValue = Math.min(spent, totalAvailable); 

                    // NEW: Show inflows if they exist
                    const inflowsHTML = inflows > 0 ? 
                        `<span class="text-xs block text-green-600">${i18n.t('dashboardInflows') || 'Inflows'}: +${this.formatCurrency(inflows)}</span>` : 
                        '';

                    const card = `
                <div class="bg-white p-4 rounded-2xl shadow hover:shadow-md transition-shadow cursor-pointer" data-category-id="${cat.id}" data-category-name="${cat.name}">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-lg text-gray-800">${cat.name}</span>
                        <div class="text-right">
                            <span class="font-bold text-lg ${remaining < 0 ? 'text-red-500' : 'text-gray-800'}">${this.formatCurrency(remaining)}</span>
                            <span class="text-xs text-gray-400 block">${i18n.t('dashboardRemaining')}</span>
                        </div>
                    </div>
                    <progress class="w-full" value="${progressValue}" max="${totalAvailable}"></progress>
                    <div class="flex justify-between items-center text-sm text-gray-500 mt-2">
                        <div class="flex-1 min-w-0">
                            <span>${i18n.t('dashboardSpent')}: ${this.formatCurrency(spent)}</span>
                            ${inflowsHTML}
                        </div>
                        <span class="text-right ml-2">${i18n.t('dashboardBudgeted')}: ${this.formatCurrency(budgetedThisMonth)}</span>
                    </div>
                </div>
            `;
                    this.dom.variableEnvelopesList.insertAdjacentHTML('beforeend', card);
                });

                this.dom.variableEnvelopesEmpty.classList.toggle('hidden', hasVariable);
                // NEW: Show/hide the entire section container
                this.dom.variableEnvelopesContainer.classList.toggle('hidden', !hasVariable);

                // Use the new, accurate totals from the calculator
                const totalSpentAll = calculations.totalSpent; // Our new TRUE total
                const totalSpentOnEnvelopes = calculations.totalVariableSpent; // Just envelopes
                
                // Available = Total Budgeted for Envelopes - Spent on Envelopes
                const totalAvailable = calculations.totalBudgeted - totalSpentOnEnvelopes;

                // Store both values in the hidden inputs
                this.dom.dashboardAvailableValue.value = totalAvailable;
                this.dom.dashboardSpentValue.value = totalSpentAll; // Store the NEW true total

                // Set the *current* view based on the data-view attribute
                const currentView = this.dom.dashboardToggleArea.dataset.view;
                if (currentView === 'spent') {
                    // --- MODIFIED: Use the new total and a new i18n key ---
                    this.dom.dashboardToggleLabel.textContent = i18n.t('dashboardTotalSpentAll') || 'Total Monthly Spending';
                    this.dom.dashboardToggleValue.textContent = this.formatCurrency(totalSpentAll);
                    this.dom.dashboardToggleValue.classList.remove('text-green-600');
                    this.dom.dashboardToggleValue.classList.add('text-gray-800');
                } else {
                    this.dom.dashboardToggleLabel.textContent = i18n.t('dashboardRemaining') || 'Total Available';
                    this.dom.dashboardToggleValue.textContent = this.formatCurrency(totalAvailable);
                    this.dom.dashboardToggleValue.classList.remove('text-gray-800');
                    this.dom.dashboardToggleValue.classList.add('text-green-600');
                }

                // Render Savings Goals
                this.dom.savingGoalsList.innerHTML = '';
                const savingCategories = this.categories.filter(c => c.type === 'saving');
                let hasSavingGoals = false;

                savingCategories.forEach(cat => {
                    hasSavingGoals = true;
                    // This logic is now PERFECT because `envelope.balance`
                    // contains our "Initial Stock" + any new contributions.
                    const envelope = this.envelopes.find(e => e.categoryId === cat.id);
                    const totalSaved = envelope ? envelope.balance : 0;
                    const goalAmount = cat.goalAmount || 0;
                    
                    // NEW: Find this month's contribution
                    const budgetItem = this.budget.find(b => b.id === `saving-${cat.id}`);
                    const thisMonthContribution = budgetItem ? budgetItem.amount : 0;
                    
                    const thisMonthHTML = thisMonthContribution > 0 ?
                        `<p class="text-sm text-gray-500">${i18n.t('dashboardThisMonth')}: <span class="font-medium text-green-600">+${this.formatCurrency(thisMonthContribution)}</span></p>` :
                        '';

                    let progressHTML = '';
                    let savedText = this.formatCurrency(totalSaved);

                    if (goalAmount > 0) {
                        const progressValue = Math.min(totalSaved, goalAmount);
                        savedText = `${this.formatCurrency(totalSaved)} / ${this.formatCurrency(goalAmount)}`;
                        progressHTML = `<progress class="w-full mt-2" value="${progressValue}" max="${goalAmount}"></progress>`;
                    }

                    const card = `
                <div class="bg-white p-4 rounded-2xl shadow hover:shadow-md transition-shadow cursor-pointer goal-card-clickable" data-category-id="${cat.id}" data-category-name="${cat.name}">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-lg text-gray-800">${cat.name}</span>
                        <span class="font-bold text-green-600 text-right">${savedText}</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <p class="text-sm text-gray-500">${i18n.t('dashboardTotalSaved')}</p>
                        ${thisMonthHTML}
                    </div>
                    ${cat.goalDate ? `<p class="text-sm text-pink-600 mt-1">${i18n.t('goalDateLabel')}: ${this.formatDate(cat.goalDate)}</p>` : ''}
                    ${progressHTML}
                </div>
            `;
                    this.dom.savingGoalsList.insertAdjacentHTML('beforeend', card);
                });
                this.dom.savingGoalsEmpty.classList.toggle('hidden', hasSavingGoals);
                // NEW: Show/hide the entire section container
                this.dom.savingGoalsContainer.classList.toggle('hidden', !hasSavingGoals);
                
                // Render Debt Paydown Goals
                this.dom.debtGoalsList.innerHTML = '';
                const debtGoalCategories = this.categories.filter(c => c.type === 'debt');
                let hasDebtGoals = false;

                debtGoalCategories.forEach(cat => {
                    hasDebtGoals = true;
                    const envelope = this.envelopes.find(e => e.categoryId === cat.id);
                    const totalPaid = envelope ? envelope.balance : 0; // This is the total paid *off*
                    const totalDebt = cat.goalAmount || 0; // This is the "initial stock"
                    
                    // NEW: Find this month's contribution
                    const budgetItem = this.budget.find(b => b.id === `debt-${cat.id}`);
                    const thisMonthContribution = budgetItem ? budgetItem.amount : 0;
                    
                    const thisMonthHTML = thisMonthContribution > 0 ?
                        `<p class="text-sm text-gray-500">${i18n.t('dashboardThisMonth')}: <span class="font-medium text-green-600">+${this.formatCurrency(thisMonthContribution)}</span></p>` :
                        '';

                    let progressHTML = '';
                    let balanceText = this.formatCurrency(totalPaid);
                    let remainingHTML = '';

                    if (totalDebt > 0) {
                        const remaining = totalDebt - totalPaid;
                        const progressValue = Math.min(totalPaid, totalDebt);
                        
                        // "Paid / Total"
                        balanceText = `${this.formatCurrency(totalPaid)} / ${this.formatCurrency(totalDebt)}`;
                        
                        // "Remaining" (the user's key request)
                        remainingHTML = `<p class="text-sm text-gray-500 mt-1">${i18n.t('remaining')}: ${this.formatCurrency(remaining)}</p>`;
                        
                        progressHTML = `<progress class="w-full mt-2" value="${progressValue}" max="${totalDebt}"></progress>`;
                    }

                    const card = `
                <div class="bg-white p-4 rounded-2xl shadow hover:shadow-md transition-shadow cursor-pointer goal-card-clickable" data-category-id="${cat.id}" data-category-name="${cat.name}">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-lg text-gray-800">${cat.name}</span>
                        <span class="font-bold text-green-600 text-right">${balanceText}</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <p class="text-sm text-gray-500">${i18n.t('dashboardTotalPaid')}</p>
                        ${thisMonthHTML}
                    </div>
                    ${remainingHTML}
                    ${progressHTML}
                </div>
            `;
                    this.dom.debtGoalsList.insertAdjacentHTML('beforeend', card);
                });
                this.dom.debtGoalsEmpty.classList.toggle('hidden', hasDebtGoals);
                // NEW: Show/hide the entire section container
                this.dom.debtGoalsContainer.classList.toggle('hidden', !hasDebtGoals);
            },

            /**
             * NEW: Render the new unified Manage Page
             */
            renderManagePage() {
                // This function now renders all dynamic parts of the Manage page
                
                // --- Part 1: Render the Summary Card ---
                const calculations = this.calculateBudget();
                const lastMonthBudgetMap = new Map((this.lastMonthBudget || []).map(b => [b.id, b.amount]));

                this.dom.budgetSummarySalary.textContent = this.formatCurrency(this.salary);
                // this.dom.budgetSummaryOtherIncome.textContent = this.formatCurrency(calculations.otherIncomeTotal); // DELETED
                this.dom.budgetSummaryTotalIncome.textContent = this.formatCurrency(calculations.totalIncome);
                this.dom.budgetSummaryFixedCosts.textContent = `-${this.formatCurrency(calculations.totalFixed)}`;
                this.dom.budgetMoneyToBudget.textContent = this.formatCurrency(calculations.moneyToBudget);

                // --- Part 2: Render the Other Income list (Expandable) ---
                this.dom.otherIncomeList.innerHTML = '';
                // NEW: Add Rollover to this section
                const totalOtherIncome = calculations.otherIncomeTotal + this.lastMonthRollover;
                this.dom.otherIncomeTotalSpan.textContent = this.formatCurrency(totalOtherIncome);
                this.dom.otherIncomeEmpty.classList.toggle('hidden', this.otherIncome.length > 0);
                // --- FIX: Logic for Other Income section visibility ---
                const noOtherIncomeItems = this.otherIncome.length === 0;
                const noRollover = this.lastMonthRollover === 0;

                // Conditionally show the whole container (Fix for Bug 4)
                this.dom.otherIncomeContainer.classList.toggle('hidden', noOtherIncomeItems && noRollover);

                // Only show "empty" message if BOTH rollover and other income are 0 (Fix for Bug 5)
                this.dom.otherIncomeEmpty.classList.toggle('hidden', !noOtherIncomeItems || !noRollover);
                // --- End Fix ---

                const iconDelete = document.getElementById('icon-delete').outerHTML;
                const iconEdit = document.getElementById('icon-edit').outerHTML;

                // NEW: Add Rollover Savings as the first item in this list
                if (this.lastMonthRollover > 0) {
                    const rolloverHtml = `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <span class="font-medium text-gray-800" data-i18n="budgetRollover">Rollover Savings</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-medium text-green-600">${this.formatCurrency(this.lastMonthRollover)}</span>
                            </div>
                        </div>
                    `;
                    this.dom.otherIncomeList.insertAdjacentHTML('beforeend', rolloverHtml);
                }
                
                this.otherIncome.forEach(income => {
                    const item = `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <span class="font-medium text-gray-800">${income.source}</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="font-medium text-green-600">${this.formatCurrency(income.amount)}</span>
                                <button class="edit-income-btn p-2 text-gray-400 hover:text-blue-500" data-id="${income.id}">
                                    ${iconEdit}
                                </button>
                                <button class="delete-income-btn p-2 text-gray-400 hover:text-red-500" data-id="${income.id}">
                                    ${iconDelete}
                                </button>
                            </div>
                        </div>
                    `;
                    this.dom.otherIncomeList.insertAdjacentHTML('beforeend', item);
                });

                // --- Part 3: Render the Fixed Costs list (Expandable) ---
                this.dom.fixedCostsList.innerHTML = '';
                // NEW: Use the correct 'bill' type
                const fixedCategories = this.categories.filter(c => c.type === 'bill');

                // Conditionally show the whole container
                this.dom.fixedCostsContainer.classList.toggle('hidden', fixedCategories.length === 0);

                fixedCategories.forEach(cat => {
                    const item = `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-800">${cat.name}</span>
                            <span class="font-medium text-gray-600">${this.formatCurrency(cat.amount)}</span>
                        </div>
                    `;
                    this.dom.fixedCostsList.insertAdjacentHTML('beforeend', item);
                });


                // --- Part 4: Render the Assign Money Card (NEW v4 Logic) ---
                
                // Clear all lists
                this.dom.budgetBillList.innerHTML = '';
                this.dom.budgetEnvelopeList.innerHTML = '';
                this.dom.budgetSavingList.innerHTML = '';
                this.dom.budgetDebtList.innerHTML = '';

                // Get categories by new types
                const billCategories = this.categories.filter(c => c.type === 'bill');
                const envelopeCategories = this.categories.filter(c => c.type === 'envelope');
                const savingCategories = this.categories.filter(c => c.type === 'saving');
                const debtCategories = this.categories.filter(c => c.type === 'debt');

                // Toggle "empty" messages
                this.dom.budgetBillEmpty.classList.toggle('hidden', billCategories.length > 0);
                this.dom.budgetEnvelopeEmpty.classList.toggle('hidden', envelopeCategories.length > 0);
                this.dom.budgetSavingEmpty.classList.toggle('hidden', savingCategories.length > 0);
                this.dom.budgetDebtEmpty.classList.toggle('hidden', debtCategories.length > 0);

                // Re-usable function to build the input card
                const createBudgetInputCard = (cat) => {
                    const budgetItem = this.budget.find(b => b.id === `${cat.type}-${cat.id}`);
                    const amount = budgetItem ? budgetItem.amount : (cat.amount || '');
                    const placeholder = cat.amount || '0.00';
                    const lastMonthAmount = lastMonthBudgetMap.get(`${cat.type}-${cat.id}`) || 0;
                    const lastMonthHTML = lastMonthAmount > 0 ?
                        `<p class="text-sm text-gray-500">${i18n.t('budgetLastMonth')}: ${this.formatCurrency(lastMonthAmount)}</p>` :
                        '';
                    
                    // Only show "suggested" for Savings goals, not debts
                    const suggestedHTML = (cat.type === 'saving') ? this.calculateSuggestedContribution(cat) : '';

                    return `
                        <div class="bg-white p-4 rounded-2xl shadow flex items-center space-x-3">
                            <div class="flex-1">
                                <label for="budget-${cat.type}-${cat.id}" class="font-medium text-gray-700">${cat.name}</label>
                                ${lastMonthHTML}
                                ${suggestedHTML}
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xl font-medium text-gray-500">${i18n.currency}</span>
                                <input type="number" id="budget-${cat.type}-${cat.id}"
                                       data-id="${cat.id}" data-type="${cat.type}"
                                       class="budget-input w-32 p-2 border border-gray-300 rounded-lg text-right text-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                       placeholder="${placeholder}" step="0.01" min="0" value="${amount}">
                            </div>
                        </div>
                    `;
                };

                // Render all 4 lists
                billCategories.forEach(cat => {
                    this.dom.budgetBillList.insertAdjacentHTML('beforeend', createBudgetInputCard(cat));
                });
                envelopeCategories.forEach(cat => {
                    this.dom.budgetEnvelopeList.insertAdjacentHTML('beforeend', createBudgetInputCard(cat));
                });
                savingCategories.forEach(cat => {
                    this.dom.budgetSavingList.insertAdjacentHTML('beforeend', createBudgetInputCard(cat));
                });
                debtCategories.forEach(cat => {
                    this.dom.budgetDebtList.insertAdjacentHTML('beforeend', createBudgetInputCard(cat));
                });

                this.updateBudgetSummary();
            },

            

            /**
             * NEW: Show the Manage Categories Modal
             */
            showManageCategoriesModal() {
                this.renderManageCategoriesModal(); // Render lists just before showing
                this.dom.manageCategoriesModal.classList.remove('hidden');
                this.dom.manageCategoriesModal.classList.add('flex');
                // Fix z-index issue with other modals
                this.dom.appSettingsModal.style.zIndex = 30; 
            },

            /**
             * NEW: Hide the Manage Categories Modal
             */
            hideManageCategoriesModal() {
                this.dom.manageCategoriesModal.classList.add('hidden');
                this.dom.manageCategoriesModal.classList.remove('flex');
                // Restore z-index
                this.dom.appSettingsModal.style.zIndex = 40;
            },

            /**
             * NEW: Render the Manage Categories Modal
             */
            renderManageCategoriesModal() {
                // Clear all lists
                this.dom.modalManageBillList.innerHTML = '';
                this.dom.modalManageEnvelopeList.innerHTML = '';
                this.dom.modalManageSavingList.innerHTML = '';
                this.dom.modalManageDebtList.innerHTML = '';

                // Get icon SVGs
                const iconDelete = document.getElementById('icon-delete').outerHTML;
                const iconEdit = document.getElementById('icon-edit').outerHTML;
                
                // --- Re-map icons to our 4 types ---
                const icons = {
                    bill: document.getElementById('icon-fixed').outerHTML,
                    envelope: document.getElementById('icon-variable').outerHTML,
                    saving: document.getElementById('icon-sinking-goal').outerHTML,
                    debt: document.getElementById('icon-debt-goal').outerHTML
                };

                // Loop through categories and render
                let hasBill = false, hasEnvelope = false, hasSaving = false, hasDebt = false;

                this.categories.forEach(cat => {
                    let listElement, icon;

                    switch (cat.type) {
                        case 'bill':
                            listElement = this.dom.modalManageBillList;
                            icon = icons.bill;
                            hasBill = true;
                            break;
                        case 'envelope':
                            listElement = this.dom.modalManageEnvelopeList;
                            icon = icons.envelope;
                            hasEnvelope = true;
                            break;
                        case 'saving':
                            listElement = this.dom.modalManageSavingList;
                            icon = icons.saving;
                            hasSaving = true;
                            break;
                        case 'debt':
                            listElement = this.dom.modalManageDebtList;
                            icon = icons.debt;
                            hasDebt = true;
                            break;
                        default:
                            return;
                    }

                    const formattedAmount = cat.amount ? this.formatCurrency(cat.amount) : i18n.t('noDefaultSet') || 'No default';
                    const item = `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <span class="text-gray-400">${icon}</span>
                        <div>
                            <span class="font-medium text-gray-800">${cat.name}</span>
                            <span class="block text-sm text-gray-500">${formattedAmount}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button class="edit-category-btn p-2 text-gray-400 hover:text-blue-500" data-id="${cat.id}">
                            ${iconEdit}
                        </button>
                        <button class="delete-category-btn p-2 text-gray-400 hover:text-red-500" data-id="${cat.id}">
                            ${iconDelete}
                        </button>
                    </div>
                </div>
            `;
                    listElement.insertAdjacentHTML('beforeend', item);
                });

                // Show/hide sections based on if they have items
                this.dom.modalManageContainerBill.classList.toggle('hidden', !hasBill);
                this.dom.modalManageContainerEnvelope.classList.toggle('hidden', !hasEnvelope);
                this.dom.modalManageContainerSaving.classList.toggle('hidden', !hasSaving);
                this.dom.modalManageContainerDebt.classList.toggle('hidden', !hasDebt);
                
                // Show/hide the "empty" messages for each tab
                this.dom.modalManageBillsEmpty.classList.toggle('hidden', hasBill);
                this.dom.modalManageEnvelopesEmpty.classList.toggle('hidden', hasEnvelope || hasSaving || hasDebt);
            },

            /**
             * Render the Stats Page
             */
            renderStatsPage() {
                // 1. Render the Bunny Coins section (the old logic)
                this.renderStatsBunnyCoins();
                
                // 2. Render the new Snapshot charts
                this.renderStatsSnapshots();
            },


            // --- Event Handlers ---

            /**
             * Handle navigation
             * @param {string} pageId - The ID of the page to navigate to
             */
            navigateTo(pageId) {
                window.scrollTo(0, 0);
                this.currentPage = pageId;
                // Hide all pages
                this.dom.pages.forEach(page => page.classList.remove('active'));
                // Show target page
                document.getElementById(pageId).classList.add('active');

                // Update nav button active states
                this.dom.navButtons.forEach(btn => btn.classList.remove('active'));
                const navButton = document.getElementById(`nav-${pageId.split('-')[0]}`);
                if (navButton) {
                    navButton.classList.add('active');
                }

                // Refresh page content
                if (pageId === 'dashboard-page') this.renderDashboard();
                if (pageId === 'manage-page') this.renderManagePage(); // Re-point to the new main manage function
                if (pageId === 'stats-page') this.renderStatsPage();
                // No render needed for store or help
            },

            /**
             * NEW: Switches the active tab in the transaction modal
             * @param {string} tabName - 'expense' or 'income'
             */
            switchTransactionTab(tabName) {
                const expenseTab = this.dom.modalTxTabExpense;
                const incomeTab = this.dom.modalTxTabIncome;
                const expenseForm = this.dom.expenseFormContainer;
                const incomeForm = this.dom.incomeFormContainer;

                if (tabName === 'expense') {
                    // Activate Expense Tab
                    expenseTab.classList.add('active', 'border-pink-500', 'text-pink-600');
                    expenseTab.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300');
                    // Deactivate Income Tab
                    incomeTab.classList.remove('active', 'border-pink-500', 'text-pink-600');
                    incomeTab.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300');
                    // Show Expense Form
                    expenseForm.classList.remove('hidden');
                    expenseForm.classList.add('active');
                    incomeForm.classList.add('hidden');
                    incomeForm.classList.remove('active');
                } else if (tabName === 'income') {
                    // Deactivate Expense Tab
                    expenseTab.classList.remove('active', 'border-pink-500', 'text-pink-600');
                    expenseTab.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300');
                    // Activate Income Tab
                    incomeTab.classList.add('active', 'border-pink-500', 'text-pink-600');
                    incomeTab.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300');
                    // Show Income Form
                    expenseForm.classList.add('hidden');
                    expenseForm.classList.remove('active');
                    incomeForm.classList.remove('hidden');
                    incomeForm.classList.add('active');
                }
            },

            /**
             * NEW: Show the Unified Add Transaction modal
             */
            showAddTransactionModal() {
                // Default to expense tab every time
                this.switchTransactionTab('expense');

                // Populate categories (logic from old showAddExpenseModal)
                this.dom.expenseCategory.innerHTML = '';
                const spendableTypes = ['envelope', 'variable'];
                const variableCategories = this.categories.filter(c => spendableTypes.includes(c.type));

                if (variableCategories.length === 0) {
                    // NEW: If no categories, open modal but switch to 'income' tab
                    this.dom.addTransactionModal.classList.remove('hidden');
                    this.dom.addTransactionModal.classList.add('flex');
                    this.switchTransactionTab('income');
                    return; // Stop here
                }

                variableCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    this.dom.expenseCategory.appendChild(option);
                });

                // Set date to today (logic from old showAddExpenseModal)
                this.dom.expenseDate.valueAsDate = new Date();

                // Show the modal
                this.dom.addTransactionModal.classList.remove('hidden');
                this.dom.addTransactionModal.classList.add('flex');
            },

            /**
             * NEW: Hide the Unified Add Transaction modal
             */
            hideAddTransactionModal() {
                // Reset both forms
                this.dom.addExpenseForm.reset();
                this.dom.addIncomeForm.reset();
                // Hide the modal
                this.dom.addTransactionModal.classList.add('hidden');
                this.dom.addTransactionModal.classList.remove('flex');
            },

            /**
             * NEW: Show the App Settings modal
             */
            showSettingsModal() {
                // Reset to the first tab every time it's opened
                this.switchSettingsTab('general');
                this.dom.appSettingsModal.classList.remove('hidden');
                this.dom.appSettingsModal.classList.add('flex');
            },

            /**
             * NEW: Handle clicks on the settings modal tabs
             */
            handleSettingsTabClick(e) {
                const button = e.target.closest('.settings-tab-btn');
                if (!button) return;
                
                const tabName = button.dataset.tab;
                this.switchSettingsTab(tabName);
            },

            /**
             * NEW: Switch the active tab in the settings modal
             */
            switchSettingsTab(tabName) {
                // 1. Hide all panels
                this.dom.settingsTabPanels.forEach(panel => {
                    panel.classList.add('hidden');
                    panel.classList.remove('active');
                });
                
                // 2. Deactivate all tab buttons
                this.dom.settingsTabButtons.forEach(btn => {
                    btn.classList.remove('active', 'border-pink-500', 'text-pink-600');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300');
                });
                
                // 3. Show the target panel
                // REMAP "data" to "backup" for our logic
                const panelId = (tabName === 'data') ? 'backup' : tabName;
                const targetPanel = document.getElementById(`settings-tab-${panelId}`);
                if (targetPanel) {
                    targetPanel.classList.remove('hidden');
                    targetPanel.classList.add('active');
                }
                
                // 4. Activate the target tab button
                // REMAP "data" to "backup" for our logic
                const buttonSelector = (tabName === 'data') ? 'backup' : tabName;
                const targetButton = this.dom.settingsTabNav.querySelector(`[data-tab="${buttonSelector}"]`);
                if (targetButton) {
                    targetButton.classList.add('active', 'border-pink-500', 'text-pink-600');
                    targetButton.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300');
                }
            },

            /**
             * NEW: Hide the App Settings modal
             */
            hideSettingsModal() {
                this.dom.appSettingsModal.classList.add('hidden');
                this.dom.appSettingsModal.classList.remove('flex');
            },

            /**
             * NEW: Catches the PWA install prompt
             */
            onBeforeInstallPrompt(e) {
                // Prevent the mini-infobar from appearing
                e.preventDefault();
                // Stash the event so it can be triggered later.
                this.deferredPwaPrompt = e;
                // Show our custom install button
                this.dom.installPwaSection.classList.remove('hidden');
                //console.log("PWA install prompt saved.");
            },
            
            /**
             * NEW: Shows the PWA install prompt when our button is clicked
             */
            /**
             * NEW: Initiates restore from the onboarding screen.
             */
            onOnboardingRestore() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json,application/json';
                fileInput.style.display = 'none';
                
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (fileEvent) => {
                        try {
                            const json = fileEvent.target.result;
                            // This is the same function used by the main settings
                            await this.processRestoreData(json);
                            
                            // Now, instead of reloading, we complete the onboarding
                            // This will load the restored data and show the app
                            await this.completeOnboarding('dashboard-page');
                            
                            // We can't use showToast here, but we can after
                            // completeOnboarding finishes and the app is rendered
                            setTimeout(() => {
                                this.showToast(i18n.t('toastRestoreSuccess'));
                            }, 500); // Give app time to fade in
                            
                        } catch (err) {
                            console.error("Restore failed:", err);
                            // We don't have the toast manager, so alert is a safe fallback
                            // We use the English key as a fallback for the i18n key
                            const errorKey = i18n.t('toastRestoreError') || 'Error: Invalid or corrupt backup file.';
                            alert(errorKey + ' ' + err.message);
                        } finally {
                            // Clean up the file input
                            if (fileInput.parentNode) {
                                fileInput.parentNode.removeChild(fileInput);
                            }
                        }
                    };
                    reader.onerror = () => {
                        const errorKey = i18n.t('toastRestoreError') || 'Error: Invalid or corrupt backup file.';
                        alert(errorKey);
                        if (fileInput.parentNode) {
                            fileInput.parentNode.removeChild(fileInput);
                        }
                    };
                    reader.readAsText(file);
                });
                
                document.body.appendChild(fileInput);
                fileInput.click();
            },

            async onInstallPwa() {
                if (!this.deferredPwaPrompt) {
                    return;
                }
                // Hide our button
                this.dom.installPwaSection.classList.add('hidden');
                // Show the prompt
                this.deferredPwaPrompt.prompt();
                // Wait for the user to respond to the prompt
                const { outcome } = await this.deferredPwaPrompt.userChoice;
                if (location.hostname === 'localhost') console.log('Install prompt outcome:', outcome);
                // We've used the prompt, so clear it
                this.deferredPwaPrompt = null;
            },

            /**
             * Handle Add Expense form submission
             * @param {Event} e - The form event
             */
            async onAddExpense(e) {
                e.preventDefault();
                const categoryId = parseInt(this.dom.expenseCategory.value);
                const amount = parseFloat(this.dom.expenseAmount.value);
                const date = this.dom.expenseDate.value;
                const notes = this.dom.expenseNotes.value;

                if (!categoryId || isNaN(amount) || amount <= 0 || !date) {
                    this.showToast(i18n.t('toastInvalidAmountDate'));
                    return;
                }

                const newTx = { categoryId, amount, date, notes };
                const newId = await dbStore.addTransaction(newTx);
                this.transactions.push({ id: newId, ...newTx }); // Update local state

                this.hideAddTransactionModal(); // UPDATED
                this.showToast(i18n.t('toastExpenseAdded'));

                if (this.currentPage === 'dashboard-page') {
                    this.renderDashboard();
                }
            },
            
            /* (show/hideAddIncomeModal are now deleted) */
            
            /**
             * Handle Add Income form submission
             * @param {Event} e - The form event
             */
            async onAddIncome(e) {
                e.preventDefault();
                const source = this.dom.incomeSource.value;
                const amount = parseFloat(this.dom.incomeAmount.value);
                const month = this.getCurrentMonthString();

                if (!source || isNaN(amount) || amount <= 0) {
                    this.showToast(i18n.t('toastInvalidSourceAmount'));
                    return;
                }
                
                const newIncome = { source, amount, month };
                const newId = await dbStore.addOtherIncome(newIncome);
                this.otherIncome.push({ id: newId, ...newIncome }); // Update local state

                this.hideAddTransactionModal(); // UPDATED
                this.showToast(i18n.t('toastIncomeAdded'));

                this.renderManagePage(); // MODIFIED
                if (this.currentPage === 'dashboard-page') {
                    this.renderDashboard();
                }
            },

            /**
             * Show the Edit Income modal
             */
            showEditIncomeModal(id) {
                const income = this.otherIncome.find(item => item.id === id);
                if (!income) return;

                this.dom.editIncomeId.value = income.id;
                this.dom.editIncomeSource.value = income.source;
                this.dom.editIncomeAmount.value = income.amount;
                
                this.dom.editIncomeModal.classList.remove('hidden');
                this.dom.editIncomeModal.classList.add('flex');
            },

            /**
             * Hide the Edit Income modal
             */
            hideEditIncomeModal() {
                this.dom.editIncomeForm.reset();
                this.dom.editIncomeModal.classList.add('hidden');
                this.dom.editIncomeModal.classList.remove('flex');
            },

            /**
             * Handle Edit Income form submission
             * @param {Event} e - The form event
             */
            async onUpdateIncome(e) {
                e.preventDefault();
                const id = parseInt(this.dom.editIncomeId.value);
                const source = this.dom.editIncomeSource.value;
                const amount = parseFloat(this.dom.editIncomeAmount.value);
                const month = this.getCurrentMonthString();

                if (!id || !source || isNaN(amount) || amount <= 0) {
                    this.showToast(i18n.t('toastInvalidSourceAmount'));
                    return;
                }
                
                const updatedIncome = { id, source, amount, month };
                
                await dbStore.updateOtherIncome(updatedIncome);
                
                // Update local state
                this.otherIncome = this.otherIncome.map(item => item.id === id ? updatedIncome : item);

                this.hideEditIncomeModal();
                this.showToast(i18n.t('toastIncomeUpdated'));

                this.renderManagePage(); // MODIFIED
                if (this.currentPage === 'dashboard-page') {
                    this.renderDashboard();
                }
            },

            /**
             * Handle clicks on the income list (edit or delete)
             * @param {Event} e - The click event
             */
            async handleIncomeListClick(e) {
                const editButton = e.target.closest('.edit-income-btn');
                if (editButton) {
                    const id = parseInt(editButton.dataset.id);
                    if (id) this.showEditIncomeModal(id);
                    return;
                }
                
                const deleteButton = e.target.closest('.delete-income-btn');
                if (deleteButton) {
                    const id = parseInt(deleteButton.dataset.id);
                    if (isNaN(id)) return;

                    try {
                        await dbStore.deleteOtherIncome(id);
                        this.otherIncome = this.otherIncome.filter(item => item.id !== id);
                        this.showToast(i18n.t('toastIncomeDeleted'));
                        this.renderManagePage(); // MODIFIED
                        if (this.currentPage === 'dashboard-page') {
                            this.renderDashboard();
                        }
                    } catch (err) {
                        console.error("Error deleting income:", err);
                        this.showToast(i18n.t('toastErrorDeleteIncome'));
                    }
                }
            },


            /**
             * Handle Auto-Save Salary on input
             */
            async onAutoSaveSalary() {
                const newSalary = parseFloat(this.dom.salaryInput.value) || 0;
                this.salary = newSalary;
                await dbStore.saveSetting('salary', newSalary);
                try {
                    localStorage.setItem('bunnyBudgetSalary', newSalary);
                } catch (e) { }

                this.dom.autoSaveStatus.textContent = i18n.t('saved'); // Update feedback

                // Re-render the manage page to update summaries
                this.renderManagePage();
                // If on dashboard, re-render that too
                if (this.currentPage === 'dashboard-page') {
                    this.renderDashboard();
                }
            },

            /**
             * NEW: Handles clicking on the new category type buttons
             */
            handleCategoryTypeClick(e) {
                const button = e.target.closest('.category-type-btn');
                if (!button) return;

                const newType = button.dataset.type;
                
                // 1. Update the hidden input
                document.getElementById('category-type').value = newType;

                // 2. Update button UI
                this.dom.categoryTypeSelector.querySelectorAll('.category-type-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
                
                // 3. Update description box
                const descKey = 'categoryType' + newType.charAt(0).toUpperCase() + newType.slice(1) + 'Desc';
                this.dom.categoryTypeDescription.textContent = i18n.t(descKey);
                this.dom.categoryTypeDescription.setAttribute('data-i18n', descKey);

                // 4. Show/Hide Optional Fields
                if (newType === 'saving' || newType === 'debt') {
                    this.dom.categoryOptionalToggleBtn.classList.remove('hidden'); // Show the button
                } else {
                    this.dom.categoryOptionalToggleBtn.classList.add('hidden'); // Hide the button
                    // Also hide the details if they were open
                    this.dom.categoryOptionalDetails.classList.add('hidden');
                    this.dom.categoryOptionalChevron.classList.remove('rotate-180');
                }
            },

            /**
             * Handle Add Category form submission (NEW v4 LOGIC)
             * @param {Event} e - The form event
             */
                
            async onAddCategory(e) {
                e.preventDefault();
                
                // 1. Get all values from the form
                const name = this.dom.categoryName.value;
                const type = document.getElementById('category-type').value;
                
                // This one form field has two meanings:
                // For "Bill" -> It's the fixed monthly cost (e.g., 250)
                // For "Envelope", "Saving", "Debt" -> It's the *planned* budget amount (e.g., 75)
                const amount = parseFloat(this.dom.categoryAmount.value) || 0;
                
                let goalAmount = 0;
                let currentBalance = 0; // This is the "Initial Stock"
                let goalDate = null;

                if (type === 'saving' || type === 'debt') {
                    goalAmount = parseFloat(this.dom.categoryGoalAmount.value) || 0;
                    currentBalance = parseFloat(this.dom.categoryCurrentBalance.value) || 0;
                    goalDate = this.dom.categoryGoalDate.value || null;
                }

                if (!name) {
                    this.showToast(i18n.t('toastEnterCategoryName'));
                    return;
                }

                // 2. Create the category object
                const newCategory = { 
                    name, 
                    type,
                    // --- THIS IS THE FIX ---
                    // If it's a BILL, the 'amount' (250) is its fixed cost.
                    // If it's a GOAL, the 'amount' (75) is its *default planned* amount.
                    amount: amount, 
                    goalAmount, 
                    goalDate
                };
                
                const newId = await dbStore.addCategory(newCategory);
                this.categories.push({ id: newId, ...newCategory });

                // 3. --- THIS IS THE NEW, CORRECT LOGIC ---
                
                let finalInitialBalance = currentBalance; // Start with the "Initial Stock"
                
                // A "Bill" (like Rent or Car Loan *as a fixed cost*)
                // does NOT get added to the budget. It's a fixed cost.
                // Its envelope balance is 0. This is correct.
                
                // An "Envelope", "Saving", or "Debt" (Goal) IS budgettable.
                const budgettableTypes = ['envelope', 'saving', 'debt'];
                
                if (budgettableTypes.includes(type)) {
                    // This is a budgettable item.
                    // Its starting balance is its "Initial Stock" + its first "Monthly Planned Amount".
                    finalInitialBalance += amount;
                    
                    // If a "Monthly Planned" amount was entered, add it to this month's budget
                    if (amount > 0) {
                        const newBudgetItem = {
                            id: `${type}-${newId}`,
                            categoryId: newId,
                            type: type,
                            amount: amount
                        };
                        this.budget.push(newBudgetItem);
                        await dbStore.saveBudget(this.budget);
                    }
                }
                
                // 4. Create and save the envelope ONCE with the correct final balance
                // For a "Bill", finalInitialBalance will be 0 (correct).
                // For a "Goal", finalInitialBalance will be "Initial Stock + Planned" (correct).
                const newEnvelope = { 
                    categoryId: newId, 
                    type: type, 
                    balance: finalInitialBalance 
                };
                await dbStore.saveEnvelope(newEnvelope);
                this.envelopes.push(newEnvelope);
                // --- END FIX ---

                this.showToast(i18n.t('toastCategoryAdded'));
                
                // 5. Reset form
                this.dom.categoryName.value = '';
                this.dom.categoryAmount.value = '';
                this.dom.categoryGoalAmount.value = '';
                this.dom.categoryCurrentBalance.value = '';
                
                // 6. Re-render
                this.renderAllPages();
            },

            /**
             * Show the Edit Category modal
             */
            showEditCategoryModal(id) {
                const cat = this.categories.find(c => c.id === id);
                if (!cat) return;
                
                this.dom.editCategoryId.value = cat.id;
                this.dom.editCategoryType.value = cat.type;
                this.dom.editCategoryName.value = cat.name;
                this.dom.editCategoryAmount.value = cat.amount || '';
                this.dom.editCategoryGoalAmount.value = cat.goalAmount || '';
                this.dom.editCategoryGoalDate.value = cat.goalDate || ''; // NEW
                
                this.toggleGoalAmountField('edit');
                
                this.dom.editCategoryModal.classList.remove('hidden');
                this.dom.editCategoryModal.classList.add('flex');
            },

            /**
             * Hide the Edit Category modal
             */
            hideEditCategoryModal() {
                this.dom.editCategoryForm.reset();
                this.dom.editCategoryModal.classList.add('hidden');
                this.dom.editCategoryModal.classList.remove('flex');
                // Restore z-index of the modal it was launched from
                this.dom.manageCategoriesModal.style.zIndex = 50;
            },

            /**
             * Handle Edit Category form submission
             * @param {Event} e - The form event
             */
            async onUpdateCategory(e) {
                e.preventDefault();
                const id = parseInt(this.dom.editCategoryId.value);
                const name = this.dom.editCategoryName.value;
                const amount = parseFloat(this.dom.editCategoryAmount.value) || 0; // This is the new "Monthly Payment"
                const goalAmount = parseFloat(this.dom.editCategoryGoalAmount.value) || 0;
                const goalDate = this.dom.editCategoryGoalDate.value || null; // NEW

                const cat = this.categories.find(c => c.id === id);
                if (!cat) return;

                if (!name) {
                    this.showToast("Please enter a category name.");
                    return;
                }

                // 1. Update the category's properties
                cat.name = name;
                cat.amount = amount;
                cat.goalAmount = goalAmount;
                cat.goalDate = goalDate; // NEW

                // 2. Save the category to the DB
                await dbStore.updateCategory(cat);

                // 3. Update the local state for categories
                this.categories = this.categories.map(c => c.id === id ? cat : c);

                // 4. --- NEW: Update the *actual budget value* for this month ---
                const budgettableTypes = ['envelope', 'saving', 'debt'];
                if (budgettableTypes.includes(cat.type)) {
                    const budgetId = `${cat.type}-${id}`;
                    const budgetItemIndex = this.budget.findIndex(b => b.id === budgetId);

                    if (amount > 0) {
                        // User set a new default amount, so update or create the budget item
                        if (budgetItemIndex > -1) {
                            // Budget item exists, just update its amount
                            this.budget[budgetItemIndex].amount = amount;
                        } else {
                            // Budget item doesn't exist, create it
                            this.budget.push({
                                id: budgetId,
                                categoryId: id,
                                type: cat.type,
                                amount: amount
                            });
                        }
                    } else {
                        // User cleared the default amount, so remove it from the budget
                        if (budgetItemIndex > -1) {
                            this.budget.splice(budgetItemIndex, 1);
                        }
                    }

                    // 5. Save the updated budget array to the DB
                    await dbStore.saveBudget(this.budget);
                }
                // --- End of new logic ---

                this.hideEditCategoryModal();
                this.showToast(i18n.t('toastCategoryUpdated'));

                // Re-render the modal list *before* re-rendering all pages
                this.renderManageCategoriesModal();
                this.renderAllPages();
            },

            /**
             * Handle clicking edit or delete on a category
             * @param {Event} e - The click event
             */
            async handleCategoryListClick(e) {
                // Handle Edit
                const editButton = e.target.closest('.edit-category-btn');
                if (editButton) {
                    const id = parseInt(editButton.dataset.id);
                    if (id) {
                        // Make the edit modal appear on top
                        this.dom.manageCategoriesModal.style.zIndex = 30;
                        this.showEditCategoryModal(id);
                    }
                    return;
                }

                // Handle Delete
                const deleteButton = e.target.closest('.delete-category-btn');
                if (!deleteButton) return;

                const id = parseInt(deleteButton.dataset.id);

                try {
                    await dbStore.deleteCategory(id);

                    this.categories = this.categories.filter(c => c.id !== id);
                    this.transactions = this.transactions.filter(t => t.categoryId !== id);
                    this.budget = this.budget.filter(b => b.categoryId !== id);
                    this.envelopes = this.envelopes.filter(e => e.categoryId !== id); // Don't forget envelopes

                    this.showToast(i18n.t('toastCategoryDeleted'));
                    
                    this.renderManageCategoriesModal(); // ****** THIS IS THE FIX ******

                    this.renderAllPages();
                } catch (err) {
                    console.error("Error deleting category:", err);
                    this.showToast(i18n.t('toastErrorDeleteCategory'));
                }
            },

            /**
             * Handle Auto-Save Budget on input
             */
            async onAutoSaveBudget() {
                // e.preventDefault(); // No longer needed
                const inputs = this.dom.budgetForm.querySelectorAll('.budget-input');
                const newBudgetItems = [];
                const envelopesToUpdate = [];

                const oldBudgetMap = new Map(this.budget.map(b => [b.id, b.amount]));
                const envelopeMap = new Map(this.envelopes.map(e => [e.categoryId, e]));

                inputs.forEach(input => {
                    const id = parseInt(input.dataset.id);
                    const type = input.dataset.type;
                    const newAmount = parseFloat(input.value) || 0;
                    const budgetId = `${type}-${id}`;

                    const oldAmount = oldBudgetMap.get(budgetId) || 0;

                    if (newAmount > 0) {
                        newBudgetItems.push({
                            id: budgetId,
                            categoryId: id,
                            type: type,
                            amount: newAmount
                        });
                    }

                    if (type === 'saving' || type === 'debt') {
                        let envelope = envelopeMap.get(id); // Use 'let'
                        const diff = newAmount - oldAmount;
                        
                        if (envelope) {
                            // Envelope exists, update its balance
                            envelope.balance = (envelope.balance || 0) + diff;
                        } else {
                            // --- THIS IS THE FIX ---
                            // Envelope does NOT exist, create it
                            envelope = {
                                categoryId: id,
                                type: type, 
                                balance: diff // Balance is just the new amount
                            };
                            // Also update our local map for this loop
                            envelopeMap.set(id, envelope);
                        }
                        
                        // Push the (either updated or new) envelope to be saved
                        envelopesToUpdate.push(envelope);
                    }
                });

                if (envelopesToUpdate.length > 0) {
                    await dbStore.saveEnvelopes(envelopesToUpdate);
                    this.envelopes = await dbStore.getEnvelopes();
                }

                await dbStore.saveBudget(newBudgetItems);
                this.budget = newBudgetItems;

                console.log("Budget auto-saved."); // No toast, no navigation

                // Re-render all pages, as this data affects both dashboard and manage page
                this.renderAllPages();
            },

            /**
             * Handle currency change in settings
             */
            async onChangeCurrency(e) {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const currency = selectedOption.value;
                const currencySymbol = selectedOption.dataset.symbol;
                const locale = selectedOption.dataset.locale;
                const digits = selectedOption.dataset.digits;
                
                i18n.setCurrency(currency, currencySymbol, locale, digits);
                
                await dbStore.saveSetting('currency', currency);
                await dbStore.saveSetting('currencySymbol', currencySymbol);
                await dbStore.saveSetting('formattingLocale', locale);
                await dbStore.saveSetting('fractionDigits', digits);

                this.showToast(i18n.t('toastSettingsSaved'));
                this.renderAllPages();
            },
            
            /**
             * Handle language change in settings
             */
            async onChangeLanguage(e) {
                const lang = e.target.value;
                i18n.setLanguage(lang);
                await dbStore.saveSetting('language', lang);
                this.showToast(i18n.t('toastSettingsSaved'));
                this.renderAllPages(); 
            },
            
            /**
             * Handle language selection during onboarding
             */
            selectOnboardingLang(lang) {
                i18n.setLanguage(lang);
                
                if (lang === 'en') {
                    this.dom.onboardingLangEn.classList.add('bg-pink-100', 'border-pink-500');
                    this.dom.onboardingLangEn.classList.remove('bg-gray-200');
                    this.dom.onboardingLangDe.classList.add('bg-gray-200');
                    this.dom.onboardingLangDe.classList.remove('bg-pink-100', 'border-pink-500');
                } else {
                    this.dom.onboardingLangDe.classList.add('bg-pink-100', 'border-pink-500');
                    this.dom.onboardingLangDe.classList.remove('bg-gray-200');
                    this.dom.onboardingLangEn.classList.add('bg-gray-200');
                    this.dom.onboardingLangEn.classList.remove('bg-pink-100', 'border-pink-500');
                }
                
                setTimeout(() => {
                    this.dom.onboardingStepLanguage.classList.remove('active');
                    this.dom.onboardingStep1.classList.add('active');
                }, 200);
            },

            /**
             * Show the reset confirmation modal
             */
            showResetModal() {
                this.dom.confirmResetModal.classList.remove('hidden');
                this.dom.confirmResetModal.classList.add('flex');
            },

            /**
             * Hide the reset confirmation modal
             */
            hideResetModal() {
                this.dom.confirmResetModal.classList.add('hidden');
                this.dom.confirmResetModal.classList.remove('flex');
            },

            /**
             * Handle the final reset confirmation
             */
            async onConfirmReset() {
                this.hideResetModal();
                this.showToast(i18n.t('toastReset'));

                try {
                    // --- Step 1: Clear all data from inside the database ---
                    // This avoids the 'deleteDatabase' block bug entirely.
                    console.log("Clearing all data from DB stores...");
                    await dbStore.clearAllData();

                    // --- Step 2: Clear localStorage & sessionStorage ---
                    // This will make the app show onboarding on next load.
                    console.log("Clearing localStorage...");
                    try {
                        localStorage.clear();
                        sessionStorage.clear(); // <-- ADD THIS
                    } catch (e) { }

                    // --- Step 3: Unregister service workers ---
                    // This ensures the PWA re-fetches cleanly.
                    console.log("Unregistering service workers...");
                    if ('serviceWorker' in navigator) {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (const registration of registrations) {
                            await registration.unregister();
                        }
                    }

                    // --- Step 4: Reload the page ---
                    console.log("Reloading for a fresh start...");
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);

                } catch (error) {
                    console.error("Reset failed:", error.message);
                    this.showToast(i18n.t('toastResetFailed'));
                }
            },

            // --- Transaction History ---

            /**
             * Handle clicking on a variable envelope card
             */
            handleEnvelopeClick(e) {
                const card = e.target.closest('[data-category-id]');
                if (!card) return;

                const categoryId = parseInt(card.dataset.categoryId);
                const categoryName = card.dataset.categoryName;
                this.showTransactionHistory(categoryId, categoryName);
            },
            /**
             * NEW: Toggles the envelope summary card between Spent and Available
             */
            onToggleEnvelopeSummary() {
                const card = document.getElementById('envelope-summary-card');
                if (!card) return; // Should not happen

                const currentView = card.dataset.view;
                const spent = parseFloat(document.getElementById('env-summary-spent').value);
                const available = parseFloat(document.getElementById('env-summary-available').value);
                
                const label = document.getElementById('env-summary-label');
                const value = document.getElementById('env-summary-value');

                if (currentView === 'spent') {
                    // Switch to "Available" view
                    label.textContent = i18n.t('dashboardRemaining') || 'Total Available';
                    value.textContent = this.formatCurrency(available);
                    value.classList.remove('text-pink-900');
                    value.classList.add('text-green-600'); // Use green for available
                    card.dataset.view = 'available';
                } else {
                    // Switch back to "Spent" view
                    label.textContent = i18n.t('dashboardTotalSpent');
                    value.textContent = this.formatCurrency(spent);
                    value.classList.remove('text-green-600');
                    value.classList.add('text-pink-900'); // Back to pink
                    card.dataset.view = 'spent';
                }
            },
            /**
             * NEW: Toggles the main dashboard summary between Spent and Available
             */
            onToggleDashboardSummary() {
                const currentView = this.dom.dashboardToggleArea.dataset.view;
                
                const spent = parseFloat(this.dom.dashboardSpentValue.value);
                const available = parseFloat(this.dom.dashboardAvailableValue.value);

                if (currentView === 'spent') {
                    // Switch to "Available" view
                    this.dom.dashboardToggleLabel.textContent = i18n.t('dashboardRemaining') || 'Total Available';
                    this.dom.dashboardToggleValue.textContent = this.formatCurrency(available);
                    this.dom.dashboardToggleValue.classList.remove('text-gray-800');
                    this.dom.dashboardToggleValue.classList.add('text-green-600');
                    this.dom.dashboardToggleArea.dataset.view = 'available';
                } else {
                    // Switch back to "Spent" view
                    this.dom.dashboardToggleLabel.textContent = i18n.t('dashboardTotalSpent');
                    this.dom.dashboardToggleValue.textContent = this.formatCurrency(spent);
                    this.dom.dashboardToggleValue.classList.remove('text-green-600');
                    this.dom.dashboardToggleValue.classList.add('text-gray-800');
                    this.dom.dashboardToggleArea.dataset.view = 'spent';
                }
            },

            /**
             * NEW: Handles the "Accordion" logic for the assign money lists
             */
            handleAssignAccordionClick(e) {
                const button = e.target.closest('.assign-toggle-btn');
                if (!button) return;

                // We are already inside a form, so no page refresh.
                // e.preventDefault() is not needed since we set type="button".

                const targetDetailsId = button.dataset.targetDetails;
                const targetChevronId = button.dataset.targetChevron;
                
                const targetDetailsEl = this.dom[targetDetailsId];
                const targetChevronEl = this.dom[targetChevronId];
                
                // Check if the one we clicked is *already* open
                const isAlreadyOpen = !targetDetailsEl.classList.contains('hidden');

                // 1. Close all sections
                this.dom.assignBillsDetails.classList.add('hidden');
                this.dom.assignEnvelopesDetails.classList.add('hidden');
                this.dom.assignSavingsDetails.classList.add('hidden');
                this.dom.assignDebtsDetails.classList.add('hidden');
                
                // 2. Reset all chevrons
                this.dom.assignBillsChevron.classList.remove('rotate-180');
                this.dom.assignEnvelopesChevron.classList.remove('rotate-180');
                this.dom.assignSavingsChevron.classList.remove('rotate-180');
                this.dom.assignDebtsChevron.classList.remove('rotate-180');

                // 3. If it was NOT already open, open it.
                // (If it was open, it will just close, which is what we want)
                if (!isAlreadyOpen) {
                    targetDetailsEl.classList.remove('hidden');
                    targetChevronEl.classList.add('rotate-180');
                }
            },

            /**
             * Show the transaction history modal for a category
             * @param {number} categoryId
             * @param {string} categoryName
             */
            async showTransactionHistory(categoryId, categoryName) {
                this.dom.txHistoryTitle.textContent = `${i18n.t('modalTxHistoryTitle')}: ${categoryName}`;
                this.dom.txHistoryList.innerHTML = '';
                this.showTxHistoryList();

                const transactions = await dbStore.getTransactionsForCategory(categoryId);
                transactions.sort((a, b) => b.date.localeCompare(a.date));

                if (transactions.length === 0) {
                    this.dom.txHistoryEmpty.classList.remove('hidden');
                    this.dom.txHistoryModal.classList.remove('hidden');
                    this.dom.txHistoryModal.classList.add('flex');
                    return;
                }
                
                this.dom.txHistoryEmpty.classList.add('hidden');
                
                transactions.forEach(tx => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center p-3 cursor-pointer hover:bg-pink-100";
                    li.dataset.txId = tx.id;
                    
                    const notesHTML = tx.notes ? `<span class="block text-sm text-gray-500 truncate italic">${tx.notes}</span>` : '';

                    // --- NEW: Handle positive (expense) vs negative (transfer-in) ---
                    const isTransferIn = tx.amount < 0;
                    const displayAmount = Math.abs(tx.amount);
                    // Inflows are green with a '+', outflows are regular
                    const amountColor = isTransferIn ? 'text-green-600' : 'text-gray-800';
                    const sign = isTransferIn ? '+' : '';

                    li.innerHTML = `
                        <div class="flex-1 min-w-0"> <span class="block font-medium ${amountColor}">${sign} ${this.formatCurrency(displayAmount)}</span>
                            <span class="block text-sm text-gray-600">${this.formatDate(tx.date)}</span>
                            ${notesHTML}
                        </div>
                        <span class="text-gray-400 ml-2">&gt;</span>
                    `;
                    this.dom.txHistoryList.appendChild(li);
                });

                this.dom.txHistoryModal.classList.remove('hidden');
                this.dom.txHistoryModal.classList.add('flex');
            },

            /**
             * Hide the transaction history modal
             */
            hideTransactionHistory() {
                this.dom.txHistoryModal.classList.add('hidden');
                this.dom.txHistoryModal.classList.remove('flex');
                this.currentEditingTxId = null;
            },

            /**
             * Show the list view in the history modal
             */
            showTxHistoryList() {
                this.dom.txHistoryView.classList.remove('hidden');
                this.dom.txEditView.classList.add('hidden');
                this.currentEditingTxId = null;
            },

            /**
             * Handle clicking a transaction in the history list
             */
            handleTransactionClick(e) {
                const li = e.target.closest('[data-tx-id]');
                if (!li) return;

                const txId = parseInt(li.dataset.txId);
                const tx = this.transactions.find(t => t.id === txId);
                if (!tx) return;

                this.currentEditingTxId = tx.id;
                this.dom.editTxId.value = tx.id;
                this.dom.editTxDate.value = tx.date;
                
                // --- BUG FIX ---
                const isTransferIn = tx.amount < 0;
                this.dom.editTxAmount.value = Math.abs(tx.amount); // Use absolute value
                this.dom.editTxAmount.disabled = isTransferIn; // Disable editing amount for inflows
                // --- END FIX ---

                this.dom.editTxNotes.value = tx.notes || '';

                this.dom.txHistoryView.classList.add('hidden');
                this.dom.txEditView.classList.remove('hidden');
            },

            /**
             * Handle saving an edited transaction
             */
            async onUpdateTransaction(e) {
                e.preventDefault();
                const id = this.currentEditingTxId;
                let amount = parseFloat(this.dom.editTxAmount.value); // Use 'let'
                const date = this.dom.editTxDate.value;
                const notes = this.dom.editTxNotes.value;
                
                const originalTx = this.transactions.find(t => t.id === id);
                if (!originalTx) return;

                // --- BUG FIX ---
                const isTransferIn = originalTx.amount < 0;

                // Re-apply negative sign if it was an inflow
                if (isTransferIn) {
                    // Amount field was disabled, so we trust the original amount's absolute value
                    // which is what's in the form. We just re-apply the sign.
                    amount = -amount; 
                }
                
                // Allow saving if it's an inflow (amount < 0), but not if it's a 0 amount expense
                if (!id || isNaN(amount) || (amount === 0) || !date) {
                    this.showToast(i18n.t('toastInvalidAmountDate'));
                    return;
                }
                // --- END FIX ---

                const updatedTx = { id, amount, date, notes, categoryId: originalTx.categoryId };

                await dbStore.updateTransaction(updatedTx);

                this.transactions = this.transactions.map(t => t.id === id ? updatedTx : t);

                this.showToast(i18n.t('toastTxUpdated'));
                this.hideTransactionHistory();
                this.renderDashboard();
            },

            /**
             * Handle deleting an edited transaction
             */
            async onDeleteTransaction() {
                const id = this.currentEditingTxId;
                if (!id) return;

                await dbStore.deleteTransaction(id);
                
                this.transactions = this.transactions.filter(t => t.id !== id);
                
                this.showToast(i18n.t('toastTxDeleted'));
                this.hideTransactionHistory();
                this.renderDashboard();
            },

            // --- NEW: Edit/Delete Goal Transaction Handlers ---

            /**
             * Handle clicking a transaction in the goal history list
             */
            handleGoalTransactionClick(e) {
                const li = e.target.closest('[data-tx-id]');
                if (!li) return;

                const txId = parseInt(li.dataset.txId);
                const tx = this.goalTransactions.find(t => t.id === txId);
                if (!tx) return;

                this.dom.editGoalTxId.value = tx.id;
                this.dom.editGoalTxDate.value = tx.date;
                this.dom.editGoalTxAmount.value = tx.amount;
                this.dom.editGoalTxNotes.value = tx.notes || '';
                
                // Update currency symbol
                document.getElementById('edit-goal-tx-currency-symbol').textContent = i18n.currency;

                // Hide list, show edit form
                this.dom.goalHistoryView.classList.add('hidden');
                this.dom.goalEditView.classList.remove('hidden');
            },

            /**
             * Show the list view in the goal history modal
             */
            showGoalHistoryList() {
                this.dom.goalHistoryView.classList.remove('hidden');
                this.dom.goalEditView.classList.add('hidden');
                this.dom.editGoalTxForm.reset();
            },

            /**
             * Handle saving an edited goal transaction (Date and Notes ONLY)
             */
            async onUpdateGoalTransaction(e) {
                e.preventDefault();
                const id = parseInt(this.dom.editGoalTxId.value);
                const date = this.dom.editGoalTxDate.value;
                const notes = this.dom.editGoalTxNotes.value;
                
                const originalTx = this.goalTransactions.find(t => t.id === id);
                if (!originalTx) return;

                if (!date) {
                    this.showToast(i18n.t('toastInvalidDate'));
                    return;
                }

                // Create updated object, keeping original amount and type
                const updatedTx = { ...originalTx, date, notes };

                // Update DB
                // We re-use addGoalTransaction here because it's a simple 'put' operation
                await dbStore.addGoalTransaction(updatedTx); 
                
                // Update state
                this.goalTransactions = this.goalTransactions.map(t => t.id === id ? updatedTx : t);

                this.showToast(i18n.t('toastTxUpdated'));
                this.hideGoalHistoryModal();
                this.renderDashboard(); // Re-render to show any potential changes
            },

            /**
             * Handle deleting a goal transaction (reverses the action)
             */
            async onDeleteGoalTransaction() {
                const id = parseInt(this.dom.editGoalTxId.value);
                const tx = this.goalTransactions.find(t => t.id === id);
                if (!tx) return;
                
                // 1. Find the envelope to give money back to
                const envelope = this.envelopes.find(e => e.categoryId === tx.categoryId);
                if (envelope) {
                    envelope.balance += tx.amount;
                    await dbStore.saveEnvelope(envelope);
                    // Update local state
                    this.envelopes = this.envelopes.map(e => e.categoryId === envelope.categoryId ? envelope : e);
                }
                
                // 2. If it was a 'transfer', delete the associated variable transaction
                if (tx.type === 'transfer' && tx.associatedTxId) {
                    try {
                        await dbStore.deleteTransaction(tx.associatedTxId);
                        // Update local state
                        this.transactions = this.transactions.filter(t => t.id !== tx.associatedTxId);
                    } catch (e) {
                        console.error("Could not delete associated transaction:", e);
                    }
                }
                
                // 3. Delete the goal transaction itself
                await dbStore.deleteGoalTransaction(id);
                
                // Update local state
                this.goalTransactions = this.goalTransactions.filter(t => t.id !== id);
                
                this.showToast(i18n.t('toastTxDeleted'));
                this.hideGoalHistoryModal();
                this.renderDashboard();
            },


            // --- NEW: Goal Hub Functions (Task 3) ---

            /**
             * Handle clicking on a goal card
             */
            handleGoalCardClick(e) {
                const card = e.target.closest('.goal-card-clickable');
                if (!card) return;

                const categoryId = parseInt(card.dataset.categoryId);
                const categoryName = card.dataset.categoryName;
                this.showGoalHistoryModal(categoryId, categoryName);
            },

            /**
             * Show the goal history modal
             */
            async showGoalHistoryModal(categoryId, categoryName) {
                this.dom.goalHistoryTitle.textContent = categoryName;
                this.dom.goalHistoryList.innerHTML = '';
                
                // Find the envelope to get current balance
                const envelope = this.envelopes.find(e => e.categoryId === categoryId);
                const currentBalance = envelope ? envelope.balance : 0;
                this.dom.goalHistoryBalance.textContent = this.formatCurrency(currentBalance);
                
                // Store categoryId in the withdraw button for later
                this.dom.goalHistoryWithdrawBtn.dataset.categoryId = categoryId;
                this.dom.goalHistoryWithdrawBtn.dataset.categoryName = categoryName;
                this.dom.goalHistoryWithdrawBtn.dataset.balance = currentBalance;

                // Disable withdraw button if balance is zero
                if (currentBalance <= 0) {
                    this.dom.goalHistoryWithdrawBtn.disabled = true;
                    this.dom.goalHistoryWithdrawBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    this.dom.goalHistoryWithdrawBtn.disabled = false;
                    this.dom.goalHistoryWithdrawBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }

                // Get goal transactions
                // --- FIX: Use the local state instead of fetching from DB ---
                const transactions = this.goalTransactions
                    .filter(tx => tx.categoryId === categoryId)
                    .sort((a, b) => b.date.localeCompare(a.date));

                if (transactions.length === 0) {
                    this.dom.goalHistoryEmpty.classList.remove('hidden');
                    this.dom.goalHistoryModal.classList.remove('hidden');
                    this.dom.goalHistoryModal.classList.add('flex');
                    return;
                }
                
                this.dom.goalHistoryEmpty.classList.add('hidden');
                
                transactions.forEach(tx => {
                    const li = document.createElement('li');
                    // --- ADDED: cursor-pointer, hover:bg-pink-100, and data-tx-id ---
                    li.className = "flex justify-between items-center p-3 cursor-pointer hover:bg-pink-100";
                    li.dataset.txId = tx.id;
                    // ---
                    
                    let notesHTML = tx.notes ? `<span class="block text-sm text-gray-500 truncate italic">${tx.notes}</span>` : '';
                    let amountColor = tx.type === 'transfer' ? 'text-blue-600' : 'text-red-600';
                    let amountSign = tx.type === 'transfer' ? 'â†’' : '-';

                    li.innerHTML = `
                        <div class="flex-1 min-w-0"> <span class="block font-medium ${amountColor}">${amountSign} ${this.formatCurrency(tx.amount)}</span>
                            <span class="block text-sm text-gray-600">${this.formatDate(tx.date)}</span>
                            ${notesHTML}
                        </div>
                    `;
                    this.dom.goalHistoryList.appendChild(li);
                });

                this.dom.goalHistoryModal.classList.remove('hidden');
                this.dom.goalHistoryModal.classList.add('flex');
            },

            /**
             * Hide the goal history modal
             */
            hideGoalHistoryModal() {
                this.dom.goalHistoryModal.classList.add('hidden');
                this.dom.goalHistoryModal.classList.remove('flex');
                // --- ADD THIS ---
                // Reset to list view in case we were on edit view
                this.showGoalHistoryList(); 
            },

            /**
             * Handle clicking the "Withdraw" button from the history modal
             */
            onOpenWithdrawModal() {
                const btn = this.dom.goalHistoryWithdrawBtn;
                const categoryId = parseInt(btn.dataset.categoryId);
                const categoryName = btn.dataset.categoryName;
                const balance = parseFloat(btn.dataset.balance);
                
                // --- NEW: Check for penalty ---
                const category = this.categories.find(c => c.id === categoryId);
                let penaltyApplies = false;
                
                if (category && category.goalDate) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // Normalize today to midnight
                    
                    // Parse 'YYYY-MM-DD' string as UTC to avoid timezone issues
                    const goalDateParts = category.goalDate.split('-');
                    const goalDate = new Date(Date.UTC(goalDateParts[0], goalDateParts[1] - 1, goalDateParts[2]));
                    
                    if (goalDate > today) {
                        penaltyApplies = true; // The goal date is in the future
                    }
                }
                // --- End Penalty Check ---
                
                this.hideGoalHistoryModal();
                this.showWithdrawGoalModal(categoryId, categoryName, balance, penaltyApplies);
            },
            
            /**
             * Show the withdraw/transfer modal
             */
            showWithdrawGoalModal(categoryId, categoryName, balance, penaltyApplies) {
                // Set the hidden ID
                this.dom.withdrawGoalCategoryId.value = categoryId;
                // --- NEW: Store penalty status ---
                this.dom.withdrawGoalCategoryId.dataset.penalty = penaltyApplies;
                
                // --- NEW: Show/Hide Warning ---
                if (penaltyApplies) {
                    this.dom.withdrawGoalPenaltyWarning.textContent = i18n.t('penaltyWarning');
                    this.dom.withdrawGoalPenaltyWarning.classList.remove('hidden');
                } else {
                    this.dom.withdrawGoalPenaltyWarning.classList.add('hidden');
                }
                
                // Reset and default to 'spend' tab
                this.dom.goalSpendForm.reset();
                this.dom.goalTransferForm.reset();
                this.switchWithdrawGoalTab('spend');
                
                // Set dates to today
                this.dom.goalSpendDate.valueAsDate = new Date();
                this.dom.goalTransferDate.valueAsDate = new Date();
                
                // Set max spend/transfer amount
                this.dom.goalSpendAmount.max = balance;
                this.dom.goalTransferAmount.max = balance;
                
                // Populate transfer category dropdown
                this.dom.goalTransferCategory.innerHTML = '';
                const spendableTypes = ['envelope', 'variable'];
                const variableCategories = this.categories.filter(c => spendableTypes.includes(c.type));
                variableCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    this.dom.goalTransferCategory.appendChild(option);
                });
                
                // Update currency symbols
                document.getElementById('goal-spend-currency-symbol').textContent = i18n.currency;
                document.getElementById('goal-transfer-currency-symbol').textContent = i18n.currency;

                this.dom.withdrawGoalModal.classList.remove('hidden');
                this.dom.withdrawGoalModal.classList.add('flex');
            },
            
            /**
             * Hide the withdraw/transfer modal
             */
            hideWithdrawGoalModal() {
                this.dom.withdrawGoalModal.classList.add('hidden');
                this.dom.withdrawGoalModal.classList.remove('flex');
            },
            
            /**
             * Switch tabs in the withdraw modal
             */
            switchWithdrawGoalTab(tabName) {
                const spendTab = this.dom.modalGoalTabSpend;
                const transferTab = this.dom.modalGoalTabTransfer;
                const spendForm = this.dom.goalSpendFormContainer;
                const transferForm = this.dom.goalTransferFormContainer;

                if (tabName === 'spend') {
                    spendTab.classList.add('active', 'border-pink-500', 'text-pink-600');
                    spendTab.classList.remove('border-transparent', 'text-gray-500');
                    transferTab.classList.remove('active', 'border-pink-500', 'text-pink-600');
                    transferTab.classList.add('border-transparent', 'text-gray-500');
                    spendForm.classList.remove('hidden');
                    transferForm.classList.add('hidden');
                } else {
                    spendTab.classList.remove('active', 'border-pink-500', 'text-pink-600');
                    spendTab.classList.add('border-transparent', 'text-gray-500');
                    transferTab.classList.add('active', 'border-pink-500', 'text-pink-600');
                    transferTab.classList.remove('border-transparent', 'text-gray-500');
                    spendForm.classList.add('hidden');
                    transferForm.classList.remove('hidden');
                }
            },
            
            /**
             * Handle "Spend from Goal" form submission
             */
            async onSpendFromGoal(e) {
                e.preventDefault();
                
                const categoryId = parseInt(this.dom.withdrawGoalCategoryId.value);
                const amount = parseFloat(this.dom.goalSpendAmount.value);
                const date = this.dom.goalSpendDate.value;
                const notes = this.dom.goalSpendNotes.value;
                
                const envelope = this.envelopes.find(e => e.categoryId === categoryId);
                
                if (!envelope || isNaN(amount) || amount <= 0 || !date) {
                    this.showToast(i18n.t('toastInvalidAmountDate'));
                    return;
                }
                
                if (amount > envelope.balance) {
                    this.showToast(i18n.t('toastWithdrawLimit'));
                    return;
                }
                
                // 1. Create goal transaction
                const goalTx = { categoryId, type: 'spend', amount, date, notes };
                // --- FIX: Get the new ID and add it to the local state ---
                const newGoalTxId = await dbStore.addGoalTransaction(goalTx);
                this.goalTransactions.push({ id: newGoalTxId, ...goalTx });
                // --- End Fix ---
                
                // 2. Update envelope balance
                envelope.balance -= amount;
                await dbStore.saveEnvelope(envelope);
                this.envelopes = this.envelopes.map(e => e.categoryId === categoryId ? envelope : e);
                
                // --- NEW: Apply Penalty ---
                const penaltyApplies = this.dom.withdrawGoalCategoryId.dataset.penalty === 'true';
                if (penaltyApplies) {
                    await this.applyCoinPenalty(-5, 'Early withdrawal');
                }
                
                this.hideWithdrawGoalModal();
                this.showToast(i18n.t('toastExpenseLogged'));
                this.renderDashboard();
            },
            
            /**
             * Handle "Transfer from Goal" form submission
             */
            /**
             * NEW: Applies a coin penalty and updates UI
             */
            async applyCoinPenalty(amount, reason) {
                const month = this.getCurrentMonthString();
                const coinEntry = {
                    month: month,
                    coins: amount, // e.g., -5
                    rollover: 0,
                    reason: reason // This field is for our future reference
                };
                
                try {
                    const newId = await dbStore.saveBunnyCoins(coinEntry);
                    this.bunnyCoins.push({ id: newId, ...coinEntry });
                    this.renderBunnyCoins(); // Update header
                    this.showToast(i18n.t('penaltyToast'));
                } catch (e) {
                    console.error("Failed to apply coin penalty:", e);
                }
            },

            async onTransferFromGoal(e) {
                e.preventDefault();
                
                const categoryId = parseInt(this.dom.withdrawGoalCategoryId.value);
                const targetCategoryId = parseInt(this.dom.goalTransferCategory.value);
                const amount = parseFloat(this.dom.goalTransferAmount.value);
                const date = this.dom.goalTransferDate.value;
                const notes = this.dom.goalTransferNotes.value;
                
                const goalEnvelope = this.envelopes.find(e => e.categoryId === categoryId);
                
                if (!goalEnvelope || !targetCategoryId || isNaN(amount) || amount <= 0 || !date) {
                    this.showToast(i18n.t('toastInvalidTransfer'));
                    return;
                }
                
                if (amount > goalEnvelope.balance) {
                    this.showToast(i18n.t('toastWithdrawLimit'));
                    return;
                }
                
                // --- This is the corrected logic ---
                
                // 1. Create a NEGATIVE expense transaction to "add" money to the variable envelope
                const transferNote = `Transfer from goal: ${notes}`;
                const newTx = { categoryId: targetCategoryId, amount: -amount, date, notes: transferNote };
                const newId = await dbStore.addTransaction(newTx);
                this.transactions.push({ id: newId, ...newTx }); // Update local state
                
                // 2. Create goal transaction, NOW LINKING the new transaction ID
                const goalTx = { categoryId, type: 'transfer', amount, date, notes, targetCategoryId, associatedTxId: newId };
                const newGoalTxId = await dbStore.addGoalTransaction(goalTx);
                this.goalTransactions.push({ id: newGoalTxId, ...goalTx }); // Update local state
                
                // 3. Update goal envelope balance (subtract)
                goalEnvelope.balance -= amount;
                await dbStore.saveEnvelope(goalEnvelope);
                // --- End Fix ---
                
               // 4. Update local envelope state
                this.envelopes = this.envelopes.map(e => e.categoryId === categoryId ? goalEnvelope : e);
                
                // 5. Apply Penalty
                const penaltyApplies = this.dom.withdrawGoalCategoryId.dataset.penalty === 'true';
                if (penaltyApplies) {
                    await this.applyCoinPenalty(-5, 'Early withdrawal');
                }
                
                this.hideWithdrawGoalModal();
                this.showToast(i18n.t('toastFundsTransferred'));
                this.renderDashboard();
            },


            // --- Calculations & Formatting ---

            /**
             * Update the budget summary (Assigned vs Remaining) on the Budget page
             */
            updateBudgetSummary() {
                const inputs = this.dom.budgetForm.querySelectorAll('.budget-input');
                let totalAssigned = 0;
                inputs.forEach(input => {
                    totalAssigned += parseFloat(input.value) || 0;
                });

                const calculations = this.calculateBudget();
                const remaining = calculations.moneyToBudget - totalAssigned;

                this.dom.budgetTotalAssigned.textContent = this.formatCurrency(totalAssigned);
                this.dom.budgetRemaining.textContent = this.formatCurrency(remaining);
                this.dom.budgetRemaining.classList.toggle('text-red-500', remaining < 0);
                this.dom.budgetRemaining.classList.toggle('text-green-600', remaining >= 0);
            },

            /**
             * Perform all major budget calculations
             * @returns {object} - A calculations object
             */
            calculateBudget() {
                // 1. Calculate total fixed costs
                const totalFixed = this.categories
                    .filter(c => c.type === 'bill') // NEW: Simplified to one type
                    .reduce((sum, c) => sum + (c.amount || 0), 0);

                // 2. Calculate total income
                const otherIncomeTotal = this.otherIncome.reduce((sum, income) => sum + income.amount, 0);
                const totalIncome = this.salary + otherIncomeTotal + this.lastMonthRollover;

                // 3. Calculate money to budget
                const moneyToBudget = totalIncome - totalFixed;

                // 4. Calculate total budgeted (assigned this month to envelopes/goals/debt)
                const totalBudgeted = this.budget
                .filter(b => ['envelope', 'saving', 'debt'].includes(b.type))
                .reduce((sum, b) => sum + (b.amount || 0), 0);

                // 5. Calculate spending per category
                const outflowsPerCategory = {};
                const inflowsPerCategory = {};
                let totalVariableSpent = 0; // This will ONLY track positive spending
                
                this.transactions.forEach(tx => {
                    const id = tx.categoryId;
                    if (tx.amount > 0) {
                        outflowsPerCategory[id] = (outflowsPerCategory[id] || 0) + tx.amount;
                        totalVariableSpent += tx.amount; // Add to total
                    } else {
                        // Inflows are stored as positive numbers
                        inflowsPerCategory[id] = (inflowsPerCategory[id] || 0) + Math.abs(tx.amount);
                    }
                });

                // --- NEW: Calculate a true total spent ---
                const totalSpent = totalFixed + totalVariableSpent;

                return {
                    totalIncome,
                    otherIncomeTotal,
                    moneyToBudget,
                    totalFixed,
                    totalBudgeted,
                    totalVariableSpent,
                    totalSpent, // <-- ADD THIS
                    outflowsPerCategory,
                    inflowsPerCategory
                };
            },

            /**
             * Get the current month as 'YYYY-MM'
             */
            getCurrentMonthString() {
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                return `${year}-${month}`;
            },

            /**
             * Format a number as currency, using locale-aware separators.
             * @param {number} amount - The number to format
             */
            formatCurrency(amount) {
                if (typeof amount !== 'number') {
                    amount = 0;
                }
                
                const formattedNumber = new Intl.NumberFormat(i18n.formattingLocale, {
                    style: 'decimal',
                    minimumFractionDigits: i18n.fractionDigits,
                    maximumFractionDigits: i18n.fractionDigits
                }).format(amount);
                
                return `${i18n.currency}${formattedNumber}`;
            },

            /**
             * Format a date string (YYYY-MM-DD) to a readable format
             * @param {string} dateString
             */
            formatDate(dateString) {
                const date = new Date(dateString);
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                const adjustedDate = new Date(date.getTime() + userTimezoneOffset);
                
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return adjustedDate.toLocaleDateString(i18n.lang, options);
            },

            /**
             * Show a toast notification
             * @param {string} message - The message to display
             */
            showToast(message) {
                // NEW: Clear any existing "hide" timer
                if (this.toastTimeout) {
                    clearTimeout(this.toastTimeout);
                }

                this.dom.toastMessage.textContent = message;
                this.dom.toast.classList.remove('opacity-0', 'translate-y-4'); // Show toast

                // NEW: Store the new timer
                this.toastTimeout = setTimeout(() => {
                    this.dom.toast.classList.add('opacity-0', 'translate-y-4'); // Hide toast
                    this.toastTimeout = null; // Clear the timer ID
                }, 2000);
            },

            /**
             * NEW: Calculates the number of months between now and a goal date
             * @param {string} goalDateString - 'YYYY-MM-DD'
             * @returns {number} - Number of months
             */
            getMonthsRemaining(goalDateString) {
                if (!goalDateString) return 0;
                
                try {
                    const today = new Date();
                    // Set today to the 1st of the month for clean comparison
                    const start = new Date(Date.UTC(today.getFullYear(), today.getMonth(), 1));
                    
                    // Parse goal date, accounting for timezone issues
                    const parts = goalDateString.split('-');
                    const goal = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));

                    if (goal <= start) return 0; // Goal is in the past or this month

                    const yearDiff = goal.getFullYear() - start.getFullYear();
                    const monthDiff = goal.getMonth() - start.getMonth();

                    const totalMonths = (yearDiff * 12) + monthDiff;
                    return totalMonths + 1; // +1 to include the current month
                } catch (e) {
                    console.error("Error parsing goal date:", e);
                    return 0;
                }
            },

            /**
             * NEW: Calculates the suggested monthly contribution
             * @param {object} cat - The category object
             * @returns {string} - HTML string for the suggestion
             */
            calculateSuggestedContribution(cat) {
                if (!cat.goalAmount || !cat.goalDate) {
                    return ''; // Not enough info
                }
                
                const goalAmount = cat.goalAmount;
                const envelope = this.envelopes.find(e => e.categoryId === cat.id);
                const currentBalance = envelope ? envelope.balance : 0;
                
                const remainingToSave = goalAmount - currentBalance;
                if (remainingToSave <= 0) {
                    return ''; // Goal is already met
                }
                
                const monthsRemaining = this.getMonthsRemaining(cat.goalDate);
                if (monthsRemaining <= 0) {
                    return ''; // Goal date is in the past
                }

                const suggestedAmount = remainingToSave / monthsRemaining;
                
                return `<p class="text-sm text-gray-500">${i18n.t('suggestedContribution')}: ${this.formatCurrency(suggestedAmount)}</p>`;
            },

            // --- NEW STATS PAGE FUNCTIONS (MOVED TO CORRECT LOCATION) ---

            /**
             * Renders the Bunny Coins section of the stats page (The original renderStatsPage logic)
             */
            renderStatsBunnyCoins() {
                const totalCoins = this.bunnyCoins.reduce((sum, entry) => sum + entry.coins, 0);
                this.dom.statsTotalCoins.textContent = `ðŸª™ ${totalCoins}`;
                
                this.dom.statsHistoryList.innerHTML = '';
                
                if (this.bunnyCoins.length === 0) {
                    this.dom.statsHistoryEmpty.classList.remove('hidden');
                    return;
                }
                
                this.dom.statsHistoryEmpty.classList.add('hidden');
                
                const sortedHistory = [...this.bunnyCoins].sort((a, b) => b.month.localeCompare(a.month));
                
                sortedHistory.forEach(entry => {
                    const [year, month] = entry.month.split('-');
                    const date = new Date(year, month - 1, 1);
                    const monthName = date.toLocaleString(i18n.lang, { month: 'long', year: 'numeric' });
                    
                    const li = document.createElement('li');
                    li.className = "p-3 bg-gray-50 rounded-lg flex justify-between items-center";
                    li.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800">${monthName}</span>
                            <span class="block text-sm text-gray-500">${entry.coins} ${i18n.t('statsEntry')} ${this.formatCurrency(entry.rollover)}</span>
                        </div>
                        <span class="font-bold text-lg text-pink-600">ðŸª™ ${entry.coins}</span>
                    `;
                    this.dom.statsHistoryList.appendChild(li);
                });
            },

            /**
             * Formats a 'YYYY-MM' string to 'Mon YYYY'
             */
            formatMonthYear(monthString) {
                try {
                    const [year, month] = monthString.split('-');
                    // Use UTC date to avoid timezone issues
                    const date = new Date(Date.UTC(year, month - 1, 1));
                    return date.toLocaleString(i18n.lang, { month: 'short', year: 'numeric', timeZone: 'UTC' });
                } catch (e) {
                    return monthString;
                }
            },

            /**
             * Renders the snapshot analysis charts
             */
            renderStatsSnapshots() {
                if (this.snapshots.length === 0) {
                    this.dom.statsSnapshotEmpty.classList.remove('hidden');
                    this.dom.statsOverviewContainer.classList.add('hidden');
                    this.dom.statsCategoryDrilldown.classList.add('hidden');
                    return;
                }

                this.dom.statsSnapshotEmpty.classList.add('hidden');
                this.dom.statsOverviewContainer.classList.remove('hidden');
                this.dom.statsCategoryDrilldown.classList.remove('hidden');

                // 1. PRE-FILTER THE DATA based on the selected range
                const allSortedSnaps = [...this.snapshots].sort((a, b) => a.month.localeCompare(b.month));
                
                // Get the last N months. (e.g., if 3M, get the last 3 items)
                const filteredSnaps = allSortedSnaps.slice(-this.statsDateRange); 
                
                const labels = filteredSnaps.map(s => this.formatMonthYear(s.month));

                // 2. Render the main overview chart with *filtered* data
                this.renderOverviewChart(filteredSnaps, labels);
                
                // 3. Populate the category dropdown (only needs to happen once)
                // Check if it's already populated to avoid re-running
                if (this.dom.statsCategorySelect.options.length <= 1) {
                    this.populateStatsCategorySelect();
                }

                // 4. Render the category chart with *filtered* data
                this.renderCategoryChart();
            },

            /**
             * Renders the main "Income vs Spend vs Savings" overview chart
             */
            renderOverviewChart(sortedSnaps, labels) {
                if (this.overviewChart) {
                    this.overviewChart.destroy();
                }

                const incomeData = sortedSnaps.map(s => s.calculations.totalIncome);
                const spendingData = sortedSnaps.map(s => s.calculations.totalFixed + s.calculations.totalVariableSpent);
                const savingsData = sortedSnaps.map(s => s.totalRollover);

                this.overviewChart = new Chart(this.dom.statsOverviewChart.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                type: 'line',
                                label: 'Total Income',
                                data: incomeData,
                                borderColor: 'rgba(236, 72, 153, 1)', // Pink
                                backgroundColor: 'rgba(236, 72, 153, 0.1)',
                                fill: true,
                                tension: 0.1,
                                order: 1,
                                pointRadius: 4, // <-- Make dot visible
                                pointHitRadius: 15 // <-- Make dot easy to tap
                            },
                            {
                                type: 'bar',
                                label: 'Total Spending',
                                data: spendingData,
                                backgroundColor: 'rgba(107, 114, 128, 0.7)', // Gray
                                order: 2
                            },
                            {
                                type: 'bar',
                                label: 'Savings (Rollover)',
                                data: savingsData,
                                backgroundColor: 'rgba(16, 185, 129, 0.7)', // Green
                                order: 3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom', 
                                labels: {
                                    padding: 20 
                                }
                            },
                            // --- FIX: Mobile-friendly Zoom Options ---
                            zoom: {
                                pan: {
                                    enabled: true, // Allow panning (drag)
                                    mode: 'x',
                                    threshold: 5,
                                },
                                zoom: {
                                    wheel: {
                                        enabled: false, // <-- Disable wheel zoom
                                    },
                                    pinch: {
                                        enabled: false // <-- Disable pinch zoom
                                    },
                                    mode: 'x',
                                }
                            }
                            // --- END NEW ZOOM OPTIONS ---
                        },
                        scales: {
                            x: {
                                stacked: true,
                                ticks: {
                                    autoSkip: true, 
                                    maxRotation: 0, 
                                }
                            },
                            y: {
                                beginAtZero: true,
                                stacked: true
                            }
                        }
                    }
                });
            },

            /**
             * Populates the category select dropdown with all unique categories from all snapshots
             */
            populateStatsCategorySelect() {
                const categoryMap = new Map();
                
                // Collect all unique categories by name across all snapshots
                for (const snapshot of this.snapshots) {
                    for (const cat of snapshot.categories) {
                        if (!categoryMap.has(cat.name)) {
                            categoryMap.set(cat.name, cat.type);
                        }
                    }
                }

                // Create a sorted list
                const allCategories = Array.from(categoryMap.entries()).map(([name, type]) => ({ name, type }))
                    .sort((a, b) => a.name.localeCompare(b.name));

                // Group them by type for <optgroup>
                const grouped = {
                    bill: [],
                    envelope: [],
                    saving: [],
                    debt: [],
                    // Keep these just in case, though they are likely unused
                    fixed: [],
                    'debt-payment': [],
                    'sinking-bill': []
                };

                for (const cat of allCategories) {
                    if (grouped[cat.type]) {
                        grouped[cat.type].push(cat);
                    }
                }

                this.dom.statsCategorySelect.innerHTML = `<option value="none">${i18n.t('statsSelectCategory')}</option>`;

                // Helper to create optgroups
                const createOptgroup = (label, categories) => {
                    if (categories.length === 0) return '';
                    const options = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                    return `<optgroup label="${label}">${options}</optgroup>`;
                };
                
                this.dom.statsCategorySelect.insertAdjacentHTML('beforeend', createOptgroup('Bills', grouped.bill));
                this.dom.statsCategorySelect.insertAdjacentHTML('beforeend', createOptgroup('Envelopes', grouped.envelope));
                this.dom.statsCategorySelect.insertAdjacentHTML('beforeend', createOptgroup('Savings', grouped.saving));
                this.dom.statsCategorySelect.insertAdjacentHTML('beforeend', createOptgroup('Debts', grouped.debt));
            },

            /**
             * Renders the drill-down chart for a single selected category
             */
            renderCategoryChart() {
                if (this.categoryChart) {
                    this.categoryChart.destroy();
                }

                const selectedCategoryName = this.dom.statsCategorySelect.value;
                if (selectedCategoryName === 'none') {
                    this.dom.statsCategoryChart.classList.add('hidden');
                    return;
                }
                
                this.dom.statsCategoryChart.classList.remove('hidden');

                // --- NEW: Filter data based on state ---
                const allSortedSnaps = [...this.snapshots].sort((a, b) => a.month.localeCompare(b.month));
                const filteredSnaps = allSortedSnaps.slice(-this.statsDateRange);
                const labels = filteredSnaps.map(s => this.formatMonthYear(s.month));
                
                const categoryData = filteredSnaps.map(snapshot => { // Use filteredSnaps
                    const cat = snapshot.categories.find(c => c.name === selectedCategoryName);
                    if (!cat) return 0;

                    const catId = cat.id;
                    const catType = cat.type;

                    switch (catType) {
                        case 'envelope': // RENAMED
                            return snapshot.transactions
                                .filter(t => t.categoryId === catId && t.amount > 0)
                                .reduce((sum, t) => sum + t.amount, 0);
                        case 'bill': // RENAMED
                            return cat.amount || 0;
                        case 'saving': // RENAMED
                        case 'debt': // RENAMED
                            const budgetItem = snapshot.budget.find(b => b.id === `${catType}-${catId}`);
                            return budgetItem ? budgetItem.amount : 0;
                        default:
                            return 0;
                    }
                });
                const snapshotWithCat = this.snapshots.find(s => s.categories.some(c => c.name === selectedCategoryName));
                const catInfo = snapshotWithCat ? snapshotWithCat.categories.find(c => c.name === selectedCategoryName) : null;
                
                let chartLabel = selectedCategoryName;
                if (catInfo && catInfo.type === 'envelope') {
                    chartLabel = `${i18n.t('statsChartSpentIn')} ${selectedCategoryName}`;
                } else if (catInfo && (catInfo.type === 'saving' || catInfo.type === 'debt')) {
                    chartLabel = `${i18n.t('statsChartSavedIn')} ${selectedCategoryName}`;
                } else {
                    chartLabel = `${i18n.t('statsChartPaidFor')} ${selectedCategoryName}`;
                }



                this.categoryChart = new Chart(this.dom.statsCategoryChart.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: chartLabel,
                                data: categoryData,
                                borderColor: 'rgba(236, 72, 153, 1)', 
                                backgroundColor: 'rgba(236, 72, 153, 0.1)',
                                fill: true,
                                tension: 0.1,
                                pointRadius: 4, // <-- Make dot visible
                                pointHitRadius: 15 // <-- Make dot easy to tap
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom', 
                                labels: {
                                    padding: 20
                                }
                            },
                            // --- FIX: Mobile-friendly Zoom Options ---
                            zoom: {
                                pan: {
                                    enabled: true, // Allow panning (drag)
                                    mode: 'x',
                                    threshold: 5,
                                },
                                zoom: {
                                    wheel: {
                                        enabled: false, // <-- Disable wheel zoom
                                    },
                                    pinch: {
                                        enabled: false // <-- Disable pinch zoom
                                    },
                                    mode: 'x',
                                }
                            }
                            // --- END NEW ZOOM OPTIONS ---
                        },
                        scales: {
                            x: {
                                ticks: {
                                    autoSkip: true, 
                                    maxRotation: 0, 
                                }
                            },
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            },
            /**
             * NEW: Handle clicks on the +/- zoom buttons
             */
            handleChartZoom(chart, zoomLevel) {
                if (chart) {
                    chart.zoom(zoomLevel);
                }
            },
            
            /**
             * NEW: Handle clicks on the Reset zoom button
             */
            handleChartReset(chart) {
                if (chart) {
                    chart.resetZoom();
                }
            },

            /**
             * NEW: Creates a backup of all user data.
             */
            async onBackupData() {
                try {
                    const backupObject = await this.createBackupObject();
                    const jsonString = JSON.stringify(backupObject, null, 2);
                    
                    const now = new Date();
                    const dateString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                    const filename = `bunny_budget_backup_${dateString}.json`;
                    
                    this.triggerDownload(jsonString, filename);
                    this.showToast(i18n.t('toastBackupSuccess'));
                } catch (e) {
                    console.error("Backup failed:", e);
                    this.showToast("Backup failed. See console for details.");
                }
            },

            /**
             * NEW: Gathers all data from IndexedDB stores into a single object.
             */
            async createBackupObject() {
                // List of ALL stores to back up
                const storesToBackup = [
                    'categories', 'transactions', 'settings', 'budget',
                    'otherIncome', 'envelopes', 'bunnyCoins', 'goalTransactions',
                    'monthlySnapshots'
                ];
                
                const backupData = {
                    version: dbStore.version, // Store the DB version
                    exportDate: new Date().toISOString(),
                    data: {}
                };

                // Use a single transaction to read all stores
                return new Promise((resolve, reject) => {
                    const transaction = dbStore.db.transaction(storesToBackup, 'readonly');
                    transaction.onerror = (event) => reject(transaction.error);

                    let storesCompleted = 0;
                    
                    storesToBackup.forEach(storeName => {
                        const store = transaction.objectStore(storeName);
                        const request = store.getAll();
                        
                        request.onsuccess = () => {
                            backupData.data[storeName] = request.result;
                            storesCompleted++;
                            
                            if (storesCompleted === storesToBackup.length) {
                                resolve(backupData);
                            }
                        };
                        request.onerror = (event) => reject(event.target.error);
                    });
                });
            },

            /**
             * MODIFIED: Triggers a file download in the browser.
             * Now accepts a MIME type for CSV or JSON.
             */
            triggerDownload(content, filename, mimeType = 'application/json') {
                const a = document.createElement('a');
                const blob = new Blob([content], { type: mimeType });
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            },

            /**
             * NEW: Initiates the restore process by creating a file input.
             */
            onRestoreData() {
                // Create a hidden file input
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json,application/json';
                fileInput.style.display = 'none';
                
                // Add listener for when a file is selected
                fileInput.addEventListener('change', (e) => this.onRestoreFileSelected(e));
                
                document.body.appendChild(fileInput);
                fileInput.click(); // Trigger the file picker
                document.body.removeChild(fileInput); // Clean up
            },
            
            /**
             * NEW: Handles the selected file for restore.
             */
            onRestoreFileSelected(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const json = e.target.result;
                        await this.processRestoreData(json);
                        
                        this.showToast(i18n.t('toastRestoreSuccess'));
                        // Reload the app to apply all restored data
                        setTimeout(() => window.location.reload(), 1500);
                        
                    } catch (err) {
                        console.error("Restore failed:", err);
                        this.showToast(i18n.t('toastRestoreError'));
                    }
                };
                reader.onerror = () => {
                    console.error("Failed to read file");
                    this.showToast(i18n.t('toastRestoreError'));
                };
                reader.readAsText(file);
            },
            
            /**
             * NEW: Migrates a backup object (in memory) from an older version
             * to the current database version.
             */
            migrateBackupData(backupObject, backupVersion, currentVersion) {
                let data = backupObject.data;

                // This is a "fall-through" switch. It runs all required
                // migration steps in order.
                // e.g., A v7 backup needs to run case 7, case 8, case 9, etc.
                
                switch (backupVersion) {
                    // case 1:
                    //    // M_igrations from v1 to v2
                    //    break;
                    // case 2:
                    //    // M_igrations from v2 to v3
                    //    break;
                    
                    // --- HYPOTHETICAL EXAMPLE ---
                    // Let's say in v8, we renamed 'bunnyCoins' to 'coinLedger'
                    // and added a 'reason' field.
                    /*
                    case 7:
                        console.log("Applying v7 -> v8 migration...");
                        // 1. Rename the store
                        data.coinLedger = data.bunnyCoins.map(coinEntry => {
                            // 2. Add the new 'reason' field with a default
                            return {
                                ...coinEntry,
                                reason: coinEntry.rollover > 0 ? "Monthly rollover" : "Unknown"
                            };
                        });
                        // 3. Delete the old store data
                        delete data.bunnyCoins;
                        
                        // We fall through to the next case...
                    
                    case 8:
                        console.log("Applying v8 -> v9 migration...");
                        // e.g., Maybe we split 'transactions' into 'inflows' and 'outflows'
                        // data.inflows = data.transactions.filter(t => t.amount < 0);
                        // data.outflows = data.transactions.filter(t => t.amount >= 0);
                        // delete data.transactions;
                        break; // This was the last migration
                    */
                    
                    default:
                        // This case (e.g., v7) has no migrations *yet*,
                        // but the structure is here for when we need it.
                        console.log("No migration path defined... proceeding.");
                }

                // Return the modified object
                backupObject.data = data;
                backupObject.version = currentVersion; // Mark it as migrated
                return backupObject;
            },

            /**
             * NEW: Wipes the DB and repopulates it from the backup object.
             */
            async processRestoreData(jsonString) {
                let backupObject = JSON.parse(jsonString); // Use 'let'

                // Basic validation
                if (!backupObject.data || !backupObject.version) {
                    throw new Error("Invalid backup file format.");
                }
                
                const backupVersion = backupObject.version;
                const currentVersion = dbStore.version;

                // --- NEW MIGRATION LOGIC ---
                if (backupVersion > currentVersion) {
                    // This is an error. The user can't restore a "future" backup.
                    throw new Error(`Backup version (${backupVersion}) is newer than app version (${currentVersion}). Please update your app.`);
                
                } else if (backupVersion < currentVersion) {
                    // We need to migrate the backup data *in memory*
                    console.log(`Migrating backup from v${backupVersion} to v${currentVersion}...`);
                    try {
                        backupObject = this.migrateBackupData(backupObject, backupVersion, currentVersion);
                    } catch (e) {
                        console.error("Migration failed:", e);
                        throw new Error(`Failed to migrate backup data: ${e.message}`);
                    }
                }
                // --- END MIGRATION LOGIC ---

                // 1. Clear all existing data
                await dbStore.clearAllData();

                // 2. Get list of stores from the backup
                const storesToRestore = Object.keys(backupObject.data);

                // 3. Create a single write transaction
                return new Promise((resolve, reject) => {
                    // Ensure we're targeting all stores, even if backup is partial
                    const allStoreNames = [
                        'categories', 'transactions', 'settings', 'budget',
                        'otherIncome', 'envelopes', 'bunnyCoins', 'goalTransactions',
                        'monthlySnapshots'
                    ];
                    
                    const transaction = dbStore.db.transaction(allStoreNames, 'readwrite');
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject(transaction.error);

                    storesToRestore.forEach(storeName => {
                        if (backupObject.data[storeName]) {
                            const store = transaction.objectStore(storeName);
                            const items = backupObject.data[storeName];
                            
                            // Add each item back to the store
                            items.forEach(item => {
                                // Use 'put' to handle objects with or without keys
                                store.put(item); 
                            });
                        }
                    });
                });
            },

            /**
             * NEW: Handles the "Export Monthly Summaries" button click.
             */
            async onExportSummariesCSV() {
                try {
                    const csvContent = await this.createSummariesCSV();
                    
                    const now = new Date();
                    const dateString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                    const filename = `bunny_budget_summaries_${dateString}.csv`;
                    
                    this.triggerDownload(csvContent, filename, 'text/csv;charset=utf-8;');
                    this.showToast(i18n.t('toastExportSummariesSuccess'));
                } catch (e) {
                    console.error("CSV Export failed:", e);
                    this.showToast(i18n.t('toastExportError'));
                }
            },

            /**
             * NEW: Fetches all monthly snapshots and formats them as a CSV string.
             */
            async createSummariesCSV() {
                // We can just use the in-memory state 'this.snapshots'
                // which is loaded on the Stats page.
                const snapshots = this.snapshots.sort((a, b) => a.month.localeCompare(b.month));
                
                // Define CSV Header
                const header = [
                    "Month",
                    "Total Income",
                    "Total Spending",
                    "Total Savings (Rollover)"
                ];
                let csvRows = [header.join(',')]; // Add header row

                snapshots.forEach(s => {
                    const month = s.month;
                    const income = s.calculations.totalIncome || 0;
                    const spending = (s.calculations.totalFixed || 0) + (s.calculations.totalVariableSpent || 0);
                    const savings = s.totalRollover || 0;
                    
                    const row = [
                        this.escapeCSV(month),
                        this.escapeCSV(income),
                        this.escapeCSV(spending),
                        this.escapeCSV(savings)
                    ];
                    
                    csvRows.push(row.join(','));
                });
                
                return csvRows.join('\n');
            },

            /**
             * NEW: Handles the "Export Categories & Goals" button click.
             */
            async onExportCategoriesCSV() {
                try {
                    const csvContent = await this.createCategoriesCSV();
                    
                    const now = new Date();
                    const dateString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                    const filename = `bunny_budget_categories_${dateString}.csv`;
                    
                    this.triggerDownload(csvContent, filename, 'text/csv;charset=utf-8;');
                    this.showToast(i18n.t('toastExportCategoriesSuccess'));
                } catch (e) {
                    console.error("CSV Export failed:", e);
                    this.showToast(i18n.t('toastExportError'));
                }
            },

            /**
             * NEW: Fetches all categories and formats them as a CSV string.
             */
            async createCategoriesCSV() {
                // Fetch the data we need
                const categories = await dbStore.getCategories();
                const envelopes = await dbStore.getEnvelopes();
                
                // Create a Map for quick balance lookup
                const envelopeMap = new Map(envelopes.map(env => [env.categoryId, env.balance]));
                
                // Define CSV Header
                const header = [
                    "Category Name", 
                    "Type", 
                    "Monthly Planned Amount", 
                    "Total Goal Amount", 
                    "Current Balance (Saved/Paid)",
                    "Goal Date"
                ];
                let csvRows = [header.join(',')]; // Add header row

                // Sort categories by type, then name for a clean sheet
                categories.sort((a, b) => {
                    if (a.type !== b.type) {
                        return a.type.localeCompare(b.type);
                    }
                    return a.name.localeCompare(b.name);
                });

                categories.forEach(cat => {
                    const balance = envelopeMap.get(cat.id) || 0;
                    
                    const row = [
                        this.escapeCSV(cat.name),
                        this.escapeCSV(cat.type),
                        this.escapeCSV(cat.amount || 0),
                        this.escapeCSV(cat.goalAmount || 0),
                        this.escapeCSV(balance),
                        this.escapeCSV(cat.goalDate || "")
                    ];
                    
                    csvRows.push(row.join(','));
                });
                
                return csvRows.join('\n');
            },


            /**
             * NEW: Handles the "Export to CSV" button click.
             */
            async onExportTransactionsCSV() {
                try {
                    const csvContent = await this.createTransactionsCSV();
                    
                    const now = new Date();
                    const dateString = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                    const filename = `bunny_budget_transactions_${dateString}.csv`;
                    
                    // We can re-use the triggerDownload function, just with a different MIME type
                    this.triggerDownload(csvContent, filename, 'text/csv;charset=utf-8;');
                    this.showToast(i18n.t('toastExportSuccess'));
                } catch (e) {
                    console.error("CSV Export failed:", e);
                    this.showToast(i18n.t('toastExportError'));
                }
            },

            /**
             * NEW: Fetches all transactions and formats them as a CSV string.
             */
            async createTransactionsCSV() {
                const categories = await dbStore.getCategories();
                const transactions = await dbStore.getTransactions();
                
                // Create a Map for quick category name lookup
                const categoryMap = new Map(categories.map(cat => [cat.id, cat.name]));
                
                // Define CSV Header
                const header = ["Date", "Category", "Amount", "Notes"];
                let csvRows = [header.join(',')]; // Add header row

                // Loop through transactions and create rows
                transactions.forEach(tx => {
                    const date = tx.date;
                    // Find the category name, default to "Unknown" if not found
                    const category = categoryMap.get(tx.categoryId) || "Unknown";
                    const amount = tx.amount;
                    const notes = tx.notes || "";
                    
                    // Create an array of values, escaping each one
                    const row = [
                        this.escapeCSV(date),
                        this.escapeCSV(category),
                        this.escapeCSV(amount),
                        this.escapeCSV(notes)
                    ];
                    
                    csvRows.push(row.join(','));
                });
                
                return csvRows.join('\n');
            },

            /**
             * NEW: Helper function to correctly escape values for CSV.
             * This wraps the value in quotes and doubles any internal quotes.
             */
            escapeCSV(value) {
                if (value == null) {
                    return '""'; // Handle null or undefined
                }
                const stringValue = String(value);
                // Replace any quote (") with a double-quote ("")
                const escapedValue = stringValue.replace(/"/g, '""');
                return `"${escapedValue}"`; // Wrap the entire string in quotes
            },
            
            /**
             * MODIFIED: Update triggerDownload to accept a MIME type
             */
            triggerDownload(content, filename, mimeType = 'application/json') {
                const a = document.createElement('a');
                const blob = new Blob([content], { type: mimeType });
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            },

            /**
             * NEW: Handle clicks on the 3M/6M/12M filter buttons
             */
            onStatsDateRangeChange(e) {
                const btn = e.target.closest('.stats-filter-btn');
                if (!btn) return;

                const months = parseInt(btn.dataset.months);
                if (months === this.statsDateRange) return; // No change

                this.statsDateRange = months;

                // Update active state
                this.dom.statsFilterButtons.querySelectorAll('.stats-filter-btn').forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');

                // Re-render the charts with the new date range
                this.renderStatsSnapshots();
            }
        };

        // --- App Entry Point ---
        document.addEventListener('DOMContentLoaded', () => {
            //window.dbStore = dbStore; // NEW: Expose DB for testing
            app.init();
        });

    </script>
    <script>
    // Show release notes once per SW version
    (function () {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('message', (e) => {
        const { type, version, note } = e.data || {};
        if (type !== 'SW_ACTIVATED' || !version) return;
        const key = 'bb-announced-' + version;
        if (!localStorage.getItem(key) && note) {
            // Use your existing toast, or create a simple banner
            if (window.app && app.showToast) {
            app.showToast(note);
            } else {
            // Accessible, multiline toast with close button and smart duration
            const id = 'bb-toast-container';
            let container = document.getElementById(id);
            if (!container) {
                container = document.createElement('div');
                container.id = id;
                container.style.cssText = `
                position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
                display: flex; flex-direction: column; gap: 10px;
                z-index: 2147483647; pointer-events: none; width: min(92vw, 720px);
                `;
                document.body.appendChild(container);
            }

            const wrap = document.createElement('div');
            wrap.setAttribute('role', 'status');
            wrap.setAttribute('aria-live', 'polite');
            wrap.style.cssText = `
                pointer-events: auto;
                background: rgba(17,17,17,0.96);
                color: #fff;
                padding: 14px 18px 14px 16px;
                border-radius: 14px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.35);
                font-size: 15px; line-height: 1.5; letter-spacing: .2px;
                max-width: 100%; word-wrap: break-word; overflow-wrap: anywhere;
                display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: start;
                opacity: 0; transition: opacity 180ms ease;
            `;

            const text = document.createElement('div');
            text.textContent = note;
            wrap.appendChild(text);

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.ariaLabel = 'Dismiss';
            btn.textContent = 'Ã—';
            btn.style.cssText = `
                appearance: none; border: 0; background: transparent; color: #fff;
                font-size: 22px; line-height: 1; cursor: pointer; margin-left: 8px;
                opacity: .9;
            `;
            btn.addEventListener('click', () => {
                wrap.style.opacity = '0';
                setTimeout(() => wrap.remove(), 180);
            });
            wrap.appendChild(btn);

            container.appendChild(wrap);
            // Fade in
            requestAnimationFrame(() => { wrap.style.opacity = '1'; });

            // Auto-duration scales with message length (min 6s, max 20s)
            const dur = Math.max(6000, Math.min(20000, String(note).length * 70));
            const timer = setTimeout(() => btn.click(), dur);

            // Pause on hover for readability
            wrap.addEventListener('mouseenter', () => clearTimeout(timer), { once: true });
            }

            localStorage.setItem(key, '1');
        }
        });
    }
    })();
    </script>
    <script>
    // Ask the active SW for its current version/note on load
    if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(reg => {
        // If thereâ€™s an active SW, ask for its status (covers the â€œapp was closedâ€ case)
        reg.active?.postMessage({ type: 'PING' });
    });

    // If a new SW takes control while the app is open, ask again
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        navigator.serviceWorker.ready.then(reg => {
        reg.active?.postMessage({ type: 'PING' });
        });
    });

    // Handle SW_STATUS replies (show toast once per version)
    navigator.serviceWorker.addEventListener('message', (e) => {
        const { type, version, note } = e.data || {};
        if (type !== 'SW_STATUS') return;
        const key = 'bb-announced-' + version;
        if (!localStorage.getItem(key) && note) {
        if (window.app && app.showToast) { app.showToast(note); }
        else {
            const n = document.createElement('div');
            n.textContent = note;
            n.style.cssText='position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:14px 18px;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35);z-index:2147483647;max-width:min(92vw,720px);';
            document.body.appendChild(n); setTimeout(()=>n.remove(),8000);
        }
        localStorage.setItem(key, '1');
        }
    });
    }
    </script>

</body>

</html>
